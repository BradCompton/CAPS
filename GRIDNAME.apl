    ∇ Z←P GRIDNAME N;G;head;K;T;Q;tablepath;S;Y;O[1]   ⍝Return name of grid ⍵ from inputs.par; prepend path if 1⊃⍺; use replacement file 2⊃⍺.par (default = inputs.par)[2]   ⍝Simply return ⍵ if ⍺[1]=¯1[3]   ⍝Give mosaic out-of-date error if ⍺[1]=¯2[4]   ⍝Replace #'s with timestep (##, ###, and #### indicate number of digits; # indicates no zero padding)[5]   ⍝Replace % with year (same deal as #'s), and [scenario] with scenario[6]   ⍝Can supply alternate grid names in inputs.par for time step 0, ≥1[7]   ⍝B. Compton, 25 Feb 2009[8]   ⍝3 Nov 2011: strip path when looking up grids[9]   ⍝9 Dec 2011: substitute time steps; 4 Jan 2012: also do years and scenarios[10]  ⍝6 Jan 2012: separate inputs.par and results.par[11]  ⍝9 Apr 2012: use path instead of pathI if pathI doesn't exist, for compatability with Habit@; 12 Apr 2012: more on pathI/tablepath for TABLE[12]  ⍝5 Mar 2013: replace variables in brackets with values (instead of just [scenarios])[13]  ⍝13 Mar 2013: be robust to timestep and year not set[14]  ⍝2 Jan 2014: go to if-else structure[15]  ⍝9 Jan 2014: if no drive letter in inputs.par, get it from path; if usemosaics, substitute mosaic with suffix '_m' if it exists and isn't outdated[16]  ⍝28 Jan 2014: ?[17]  ⍝13 Feb 2014: if ⍺[1]=¯2, called from READ, so give error if _m mosaic is outdated[18]  ⍝20 Mar 2014: don't do _m mosaic substitution for results![19]  ⍝10 Apr 2014: do a quick and dirty check right up front on _m substitution to make sure the thing isn't already a mosaic[20]  ⍝9 Sep 2014: use cached inputs.par and results.par[21]  [22]  [23]  [24]   ⍎(0=⎕NC'P')/'P←0'[25]  [26]   :if 2≤≡N                               ⍝If argument is nested,[27]      Z←(⊂P) GRIDNAME¨N                   ⍝   recurse[28]      →0[29]   :end[30]  [31]   ⍎(2>≡P)/'P←P '''''[32]   ⍎((S←0)≠⎕NC'timestep')/'S←timestep'[33]   ⍎((Y←0)≠⎕NC'year')/'Y←year'[34]   Z←N ⋄ →((0∊⍴N)∨P[1]=¯1)/0              ⍝Bail if ⍺[1]=¯1[35]   P[1]←P[1]×~O←P[1]≡¯2                   ⍝Set out-of-date error flag and clear P[1][36]   P[2]←(P[2]) (⊂inputspar)[1+0∊⍴2⊃P][37]  [38]   Z←TOLOWER N[39]   :if 0≠⎕NC 'pathI'                      ⍝If pathI doesn't exist, use path[40]      Q←pathI[41]   :else[42]      Q←path[43]   :end[44]  [45]   :if (T←inputspar resultspar⍳P[2])∊⍳2   ⍝If reading from inputs.par or results.par,[46]   :andif 0≠⎕NC T←T⊃'inputsP' 'resultsP'  ⍝   and it's already cached,[47]      G←⍎T                                ⍝   use it[48]   :elseif IFEXISTS (tablepath←Q) PATH (2⊃P),'.par'[49]      G←1 0 TABLE 2⊃P[50]   :end[51]   :if 0≠⎕NC'G'[52]      :if ~G≡1 1⍴⊂''                      ⍝If inputs.par exists,[53]         G[;2]←(FRDBL¨T\(T←⊃,/('\'=1↑¨LJUST¨G[;2])^0=⍴¨STRIPDRIVE¨G[;2])/(1↑⍴G)⍴⊂STRIPDRIVE path),¨G[;2]  ⍝If no drive letter, get it from path[54]         Z←⊃(G[;2],⊂Z)[(TOLOWER¨G[;1])⍳⊂FRDBL STRIP Z]  ⍝   get alternate grid name[55]         :if '¦'∊Z                        ⍝If alternate grid names supplied,[56]            Z←FRDBL¨↓'¦' MATRIFY Z        ⍝   first is time step 0, second is time step 1, ..., last is time step ≥ alternatives supplied[57]            Z←((⍴Z)⌊S+1)⊃Z[58]         :end[59]      :end[60]   :end[61]  [62]   :if '#'∊Z                              ⍝If time steps,[63]      K←⊃,/'.',¨'####' '###' '##' '#',¨'.',¨(,¨('ZI4' 'ZI3' 'ZI2') ⎕FMT¨S),⊂⍕S[64]      Z←K TEXTREPL Z                      ⍝   Insert time steps[65]   :end[66]   :if '%'∊Z                              ⍝If years,[67]      K←⊃,/'.',¨'%%%%' '%%%' '%%' '%',¨'.',¨(,¨('ZI4' 'ZI3' 'ZI2') ⎕FMT¨(10*4 3 2)×T-⌊T←Y÷10*4 3 2 ),⊂⍕Y[68]      Z←K TEXTREPL Z                      ⍝   Insert years[69]   :end[70]   :if '['∊Z                              ⍝If variables in brackets,[71]      Z←⍎'''',('.[.'',(⍕.].),''' TEXTREPL Z),''''    ⍝   replace with values[72]   :end[73]   :if ~(0∊⍴Z)∨~1⊃P                       ⍝If prepending path (only if grid has a name!)[74]      Z←pathG PATH Z[75]   :end[76]   →(0∊⍴Z)/0[77]  [78]  ⍝⎕←'***** GRIDNAME: ',N,' *****' ⋄ FLUSH[79]  [80]   :if mosaics^substmosaics^~resultspar≡2⊃P⍝If mosaics and substituting mosaics (but not for results!),[81]   :andif ~IFEXISTS Z,'\mosaicdescrip.txt'⍝   do a quick and dirty check to avoid getting a lock[82]   :andif 0=⍴⊃MOSAICINFO Z                ⍝   and original grid is not a mosaic,[83]   :andif 0≠⍴⊃MOSAICINFO Q←(FRDBL Z),'_m' ⍝   and a '_m' mosaic exists in same directory,[84]      :if 2≠FRISKMOSAICS ⊂Q               ⍝   and the source isn't out of date,[85]         Z←Q                              ⍝      use the mosaic[86]      :elseif O                           ⍝      but if source is out of date and called from READ,[87]         ⎕ERROR 'Error: mosaic out-of-date with respect to source grid: ',Q[88]      :end[89]   :end    ∇