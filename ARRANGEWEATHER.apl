    ∇ ARRANGEWEATHER X;S;D;H;V;M;I;J;K;Y;Q;W;L;Z;P;head[1]   ⍝Rearrange NOAA weather data and arrange into a reasonable format[2]   ⍝Use: READWEATHER ⋄ newweather←ARRANGEWEATHER weather[3]   ⍝B. Compton, 28 Jan 2009[4]   [5]   [6]    L←8                                    ⍝Number of leading station-specific columns to keep[7]    H←FRDBL¨↓LJUST ⎕TCHT MATRIFY weatherhead[8]    D←H⍳⊂'YEARMO'[9]    V←((T⍳T)=⍳⍴T)/T←X[;H⍳⊂'ELEM']          ⍝Weather variables[10]   S←((T⍳T)=⍳⍴T)/T←X[;H⍳⊂'STATION']       ⍝stations[11]   M←((T⍳T)=⍳⍴T)/T←X[;H⍳⊂'YEARMO']        ⍝levels of year+month[12]   ⎕←'Arranging weather for ',(⍕⍴S),' stations...' ⋄ FLUSH[13]  [14]  [15]   I←0[16]  L1:→((⍴S)<I←I+1)/L6                     ⍝For each station,[17]   ⎕←'Station: ',⊃S[I] ⋄ FLUSH[18]   Z←⍳J←0[19]  L2:→((⍴M)<J←J+1)/L7                     ⍝   For each year+month,[20]   Y←((X[;H⍳⊂'STATION']≡¨S[I])^X[;H⍳⊂'YEARMO']≡¨M[J])⌿X[21]   →(0∊⍴Y)/L2[22]   W←(31,(4×⍴V))⍴¯9999[23]   K←0[24]  L3:→((1↑⍴Y)<K←K+1)/L4                   ⍝      For each element,[25]   Q←31 4⍴(H⍳⊂'YEARMO')↓Y[K;][26]   Q[;1]←Q[;1]-100×⌊Q[;1]÷100             ⍝         hour for this element[27]   W[;(⍳4)+4×¯1+V⍳Y[K;H⍳⊂'ELEM']]←Q       ⍝         values for this element[28]   →L3[29]  L4:W←(31⌿Y[,1;⍳L]),0,(⌊M[J]÷100),(M[J]-100×⌊M[J]÷100),(⍳31),W     ⍝   Complete record for this station+year+month[30]   W[;L+1]←(W[;L+2]×1E4)+(W[;L+3]×100)+W[;L+4]                      ⍝   YMD in format: 20100128[31]   W←(~^/W[;¯1+(1↓⍴W)-4×¯1+⍳⍴V]≡¨⊂,'M')⌿W ⍝      Drop all missing days[32]   →(0∊⍴W)/L2[33]   →(~0∊⍴Z)/L5                            ⍝      If we don't have Z yet,[34]   Z←(((⍴M)×31),1↓⍴W)⍴¯9999               ⍝         create result for this station[35]   P←0                                    ⍝         pointer into Z[36]   head←TOLOWER 1↓⊃,/⎕TCHT,¨(L↑H),('YMD' 'year' 'month' 'day'),,V∘.,'.hr' '' '.f1' '.f2'[37]  L5:Z[P+⍳1↑⍴W;]←W                        ⍝      Else, save results[38]   P←P+1↑⍴W[39]   →L2[40]  [41]  L7:Z←(P,1↓⍴Z)↑Z                         ⍝Drop excess rows at end[42]   Z←(×/T←⍴Z)⍴Z ⋄ Z[(Z∊¯9999 ¯99999)/⍳⍴Z]←⊂'' ⋄ Z←T⍴Z[43]   →(I>1)/L8[44]   Z TMATOUT 'g:\capsdocs\settings\weather\newweather.txt'[45]    →L1[46]  L8:Z TMATAPPEND 'g:\capsdocs\settings\weather\newweather.txt'   ⍝Write out results after finishing each station[47]   →L1[48]  [49]  L6:⎕←'ARRANGEWEATHER finished.  Results have been written to g:\capsdocs\settings\weather\newweather.txt.' ⋄ FLUSH    ∇