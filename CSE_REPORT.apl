    ∇ P CSE_REPORT V;X;D;Q;R;T;S;W;I;H;Y;head;A;rpath;L;E;Z;U;C[1]   ⍝Gather data for generating CSB report and call cse.report in R do generate it[2]   ⍝Parameters:[3]   ⍝   ⍺       project path[4]   ⍝   1⊃⍵     scenario names[5]   ⍝   1⊃2⊃⍵      project name[6]   ⍝   2⊃2⊃⍵      user name[7]   ⍝   3⊃2⊃⍵      user email[8]   ⍝   4⊃2⊃⍵      user message[9]   ⍝   5⊃2⊃⍵      sent date[10]  ⍝   6⊃2⊃⍵      list of metrics run[11]  ⍝Globals:[12]  ⍝   changed     info for text description of project, from CSE_BUFFERS and CSE_MODIFY[13]  ⍝The email file, report, and zip files all use a unique 8 digit id based on the date and[14]  ⍝time to prevent collisions and make it impossible for nefarious people to guess web[15]  ⍝links. There's no year in the id, so we'll have to clear files out every month or twelve.[16]  ⍝Writes ⍺\post\control.txt and descrip.txt[17]  ⍝Creates ⍺\post\ [    ].zip[18]  ⍝Writes email.txt[19]  ⍝Calls R to generate report. See cse.report.r for details.[20]  ⍝B. Compton, 14-21 Aug 2012[21]  ⍝23 Apr 2013: now called from CSA instead of CSE so I don't have to put MiKTeX on more than one cluster machine[22]  ⍝26 Apr 2013: use ID for email, zip, and report link, a few small changes.[23]  ⍝29 Apr 2013: use control file model\resultgrids.par to control which results are saved[24]  ⍝30 Apr 2013: more fixes to results[25]  ⍝7 Jun 2013: deal properly with changes to multiple landcover types[26]  ⍝18 Jun 2013: ' → \' so we don't blow contractions[27]  ⍝24 Jun 2013: report mitigation discount[28]  ⍝7 Jan 2014: convert _ to space in titles so Sweave doesn't fuck them up[29]  [30]  [31]  [32]   S V ← V[33]   R←'.\./' TEXTREPL P                                    ⍝Convert to R-style path[34]   C←,⊃,/(⊂'ZI2')⎕FMT¨1↓5↑⎕TS   ⍝Unique report/results id (month day hour min)[35]  [36]  ⍝Put together text description of project[37]   W←0 ',' MATIN pathS,'towns.txt'                        ⍝Town name index[38]   W[;2]←TOTITLE¨TOLOWER¨(⊂'.''.') TEXTREPL¨W[;2][39]   H←↓'|' MATRIFY 'change% to culverts/bridges|change% to dams|change% to terrestrial passage structures|change% to tidal restrictions|mile% of new roads'[40]  [41]   Q←'This project consists of ',(⍕⍴S),' scenario',((1<⍴S)/'s'),' in '[42]   Q←Q OVER (5 'several towns' ONETWOMANY ↓T[⎕AV⍋T←MIX W[W[;1]⍳UNIQUENZ⊃,/changed[;1];2];]),','[43]   Q←Q OVER 'involving changes to '[44]   T←(∨⌿0≠changed[;1+⍳7])⌿'|' MATRIFY 'culverts/bridges|dams|terrestrial passage structures|tidal restrictions|roads|roads|land cover'[45]   T←(∨/T≠' '⍪¯1 0↓T)⌿T                                   ⍝drop redundant 'roads'[46]   Q←Q OVER (ONETWOMANY ↓T),'.'[47]   Q←Q OVER reportonly/'\\textbf{(Sample report without results, generated because reportonly = ''yes''.)}'[48]   Q←Q OVER '\\begin{changemargin}{.25in}'[49]  [50]   I←0[51]  L1:→((1↑⍴changed)<I←I+1)/L2                             ⍝For each scenario, ----- Create report -----[52]   Q←Q OVER ' '[53]   Q←Q OVER '\\textbf{Scenario ',(⍕I),'}, ',(TOTITLE I⊃S),', in '[54]   Q←Q OVER (ONETWOMANY ↓T[⎕AV⍋T←MIX W[W[;1]⍳⊃,/changed[I;1];2];]),','[55]   Q←Q OVER 'consists of '[56]   Y←(⍕¨1 ROUND T←changed[I;2 3 4 5 6]),¨' ',¨H[57]   Y←(T≠0)/((⊂'.%'),¨(1+T≠1)↑¨⊂'.s') TEXTREPL¨Y[58]   Y←Y,⊂(T≠0)/'approximately ',(⍕1 ROUND T),' mile',((1≠1 ROUND T←changed[I;7])/'s'),' of modified roads'[59]   T←TOLOWER ONETWOMANY ,(landcover[;2],⊂'')[landcover[;1]⍳⊃,/⎕FI¨↓','MATRIFY ⍕⊃changed[I;9]][60]   Y←Y,⊂(T≠0)/(⍕1 ROUND T←changed[I;8]),' acres of landcover change to ',T[61]   Q←Q OVER (ONETWOMANY Y),'.'[62]   :if ~0∊⍴T←⊃changed[I;10]                               ⍝   If mitigation discount was used,[63]      Q←Q OVER ((1+1≠⍴T)⊃'A m' 'M'),'itigation discount',((1≠⍴T)/'s'),' of ',(ONETWOMANY (⍕¨T[⍋T]),¨⊂'\\%'),' ',((1+1≠⍴T)⊃'was' 'were'),' used.'[64]   :end[65]   →L1[66]  [67]  L2:Q←Q OVER '\\end{changemargin}'[68]   Q←Q OVER ''[69]   Q←Q OVER 'The following CAPS metric',((1+1<⍴6⊃V)⊃' was' 's were'),' run:'[70]   Q←Q OVER (ONETWOMANY ↓MATRIFY ⊃V[6]),'.'[71]   Q NWRITE P,D←'descrip.txt'                             ⍝Write project description[72]  [73]  [74]   X←'# control.txt for project ',(2⊃V),'/',1⊃V[75]   X←X OVER '# Generated by CSE_REPORT in the CAPS workspace, ',NOW[76]   X←X OVER ''[77]  [78]   X←X OVER 'user <- ''',('._. ' TEXTREPL TOTITLE 2⊃V),''''[79]   X←X OVER 'proj <- ''',('._. ' TEXTREPL TOTITLE 1⊃V),''''[80]   X←X OVER 'submitted <- ''',(CONVDATE 5⊃V),''''[81]   T←FRDBL 4⊃V[82]   T←(TOUPPER 1↑T),1↓T←T,(~(0∊⍴T)∨¯1↑T∊'.?!')/'.'         ⍝Add period to end of user message if necessary[83]   T←'.''.\''.\.\\' TEXTREPL T                            ⍝Double backslashes and add backslashes to single quotes[84]   X←X OVER 'message <- ''',T,''''[85]   X←X OVER 'descrip <- paste(readLines(''',R,D,''', warn = FALSE), collapse = ''\n'')'[86]   X←X OVER 'impact <- read.csv(''',R,'impact-grouped.csv'', skip = 1)'[87]   X←X OVER 'deltaIEI <- read.csv(''',R,'deltaIEI-grouped.csv'', skip = 1)'[88]   X←X OVER 'delta.metrics <- read.csv(''',R,'delta-metrics.csv'', skip = 1)'[89]   X NWRITE P,'control.txt'[90]  [91]   →(~reportonly)/L3                                      ⍝If reportonly,[92]   head←⎕TCNL,'community',⊃,/',',¨S                       ⍝   create bogus .csvs so report can run through[93]   Q←(1,1+⍴S)⍴(⊂'groups'),(⍴S)⍴0[94]   Q CMATOUT P,'impact-grouped.csv'[95]   Q CMATOUT P,'deltaIEI-grouped.csv'[96]   head←⎕TCNL,'scenario,metrics'[97]   Q←S,[1.5]0[98]   Q CMATOUT P,'delta-metrics.csv'[99]  [100] L3:⍎'.=.←' TEXTREPL (VTOM ⎕TCNL,A)[(VTOM FIRSTCOL A←NREAD pathA,'config.txt') MATIOTA 'rpath';] ⍝Read rpath from Anthill's config.txt[101]  ⎕←'Calling R to write report...' ⋄ FLUSH[102]  1 ⎕CMD rpath,' ',csedir,'do.cse.report.RData --sdi --args ',P      ⍝Genearate report in R using Sweave[103]  3 ⎕CMD 'rename "',(P,'CSB results for ',('._. ' TEXTREPL 1⊃V),'.pdf'),'" "',(T←C,' CSB results for ',(1⊃V),'.pdf'),'"'  ⍝Copy .pdf to csb\reports\ to archieve it[104]  3 ⎕CMD 'xcopy "',P,T,'" ',csedir,'reports\ /y'         ⍝Copy .pdf to csb\reports\ to archieve it[105]  3 ⎕CMD 'xcopy "',P,T,'" ',csedir,'tosend\ /y'          ⍝and to tosend\[106]  ⎕←'---> Report has been archived in ',P,T[107] [108] [109]  ftplink←'.÷./' TEXTREPL ftplink                        ⍝----- Generate zip file -----[110]  Z←'csb\results\',C,'_',Q←('. ._' TEXTREPL 1⊃V),'_results'[111]  MAKEDIR Q←P,Q,'\'                                      ⍝Make results directory for zip file[112]  COPY_RESULTS P Q S                                     ⍝Copy .csvs and result grids[113] [114]  T←'This folder contains GIS data and tabular results for project ',(1⊃V),'.'[115]  T←T OVER 'Numbers used in grid names for each scenario:' OVER ⍕(⍳⍴S),⎕TCHT,MIX S[116]  T NWRITE Q,'readme.txt'[117]  (¯1↓Q) 1 ZIP Q,'*.*'[118]  3 ⎕CMD 'rename "',(¯1↓Q),'.zip" ',T←'"',C,'_',(STRIP ¯1↓Q),'.zip"'[119]  3 ⎕CMD 'xcopy ',(STRIPPATH ¯1↓Q),T,' "',ftppath,'" /y'[120] [121] [122]  Q←NREAD csedir,'model\email.txt'                       ⍝----- Generate email -----[123]  U←FRDBL¨↓MATRIFY '%project %user %email %date %data %doc'[124]  L←ftplink,'.\./' TEXTREPL Z,'.zip'                     ⍝Link to .zip file of data[125]  E←ftplink,'csb/CSB_results.pdf'                        ⍝Link to documentation[126]  W←V[⍳3],(CONVDATE 5⊃V) L E[127]  Q←(⊃,/'⎕',¨U,¨'⎕',¨W) TEXTREPL Q[128]  Q NWRITE P,C,' email.txt'[129]  3 ⎕CMD 'xcopy "',(T←P,C,' email.txt'),'" "',csedir,'tosend\" /y'[130] [131] ⍝ 3 ⎕CMD 'xcopy "',(Q←P,C,' CSB results for ',(1⊃V),'.pdf'),'" ',csedir,'tosend\ /y'[132]  ⎕←'---> email & report have been copied to ',csedir,'tosend\',T,' and ',V    ∇