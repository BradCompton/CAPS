    ∇ A CONNECT S;X;J;I;R;Z;K;L;D;G;E;B;V;Y;buffer;head;crossscores;C;H;connect;transparent;T;M;F;O;E1;O1;T1;T2;X2;sr;srt;sd;sdt;Y2;N;correct;Q;Z2[1]   ⍝CAPS 3.0 connectedness metric for groups ⍵[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer) (include grid)[3]   ⍝Parameters:[4]   ⍝   multiplier      multiplier on contrast to get resistance[5]   ⍝   bandwidth       bandwidth (h) in m[6]   ⍝   search          search distance in s.d.[7]   ⍝   resist          resistance value by cover type[8]   ⍝   density         build kernels every nth cell (use density = 1 for normal, slower results)[9]   ⍝   linkages        called from LINKAGES or FINDPATHS: if ≠0, passed grids & return result; if =1, use square kernels[10]  ⍝   masktocore      clip results to core mask[11]  ⍝   conductance     if 1, calculate and write conductance too[12]  ⍝B. Compton, 6 Dec 2007 & 7-8 Jan 2008[13]  ⍝Note: mask is ignored for this metric, because we need to run for cells outside of mask to get kernel values[14]  ⍝28 Mar 2008: Result is volume of kernel[15]  ⍝9 Apr 2008: Gaussian scaling[16]  ⍝29 Apr 2008: Optional left argument lists grids for timesteps or scenarios; mask grid[17]  ⍝29 Sep 2008: multiple grids allows multiple settings grids, specifies result file or path[18]  ⍝3 Oct 2008: bug--missing resistance list gave all resistances = 1E6[19]  ⍝19 Dec 2008: incorporate Edi's C functions[20]  ⍝16 Jan 2009: Use GETINFO scheme[21]  ⍝11 Feb 2009: Add EXAMPLE scheme (replacing KERNTEST)[22]  ⍝26 Feb 2009: pull cellsize× out of matrix operation - cleaner, faster, and doesn't overflow SPREAD[23]  ⍝2 Mar 2009: Added chatter for TNC; probably want general sophisticated chatter: facility to do this in FRISK[24]  ⍝5 May 2009: Bugs: values from resistance table gave 2 for types not in table; max kernel was offset by 1[25]  ⍝21 May 2010: allow mask to be numeric, no save to facilitate LINKAGES[26]  ⍝24 May 2010: parameters are global for this function, to allow LINKAGES to set them.  Sigh.[27]  ⍝27 May 2010: two kinds of masks: grid, the old way, and variable, for LINKAGES[28]  ⍝31 Aug 2010: add link_example, which gives kernels for points (when called by LINKAGES)[29]  ⍝23 Sep 2010: guinea pig metric for new INCLUDE function to simplify which cells to run for; pull LINKEXAMPLE to subroutine[30]  ⍝20 Oct 2010: now sets up to modify settings for bridges & culverts[31]  ⍝12-18 Nov 2010: include isolation and conductivity; modifications to SETTINGS; use new CONNECT_RESCALE and CONNECT_RESCALE_SUM[32]  ⍝11-12 and 16 Feb 2011: adjust for edge effects in isolate and conduct.  Revolution in Egypt![33]  ⍝18 Feb 2011: Always set anthro settings to zero for focal cell[34]  ⍝26 May 2011: Drop old connectedness and conductance; this is new connectedness (formerly known as isolation).  Old version is in CONNECT_3[35]  ⍝20 Jul 2011: modifications for new version of LINKAGES[36]  ⍝25 Jul 2011: drop unused score table header for CROSSINGSMOD[37]  ⍝4-5 Aug 2011: standardize across values of search (results = old version with search = 3); restrict to circle with radius = search[38]  ⍝16 Aug 2011: Drop call to LINKEXAMPLE - it's handled in LINKAGES[39]  ⍝23 Sep 2011: if called from LINKAGES, do square kernels; 26 Sep 2011 drop this!; 27 Sep: use it, don't use it, use it![40]  ⍝28 Sep 2011: Edge correction needs to include cells in buffer![41]  ⍝27 Oct 2011: 2 sets of weights for settings variables and other changes for new SETTINGS[42]  ⍝4 Nov 2011: use ECODIST and drop ecodistpower[43]  ⍝8 Feb 2012: quick & dirty conductance, using parameter conductance = yes; 5 Mar 2012: remove it; 7 Aug 2014: put it back in![44]  ⍝10 Feb 2012: work properly with clipped landscapes: use includefull, and skip unnecessary edge correction in buffer; ignore mask[45]  ⍝30 Apr 2012: Add denisty option to do sparse runs[46]  ⍝15 Aug 2012: bug in edge correction if window was all MV[47]  ⍝16 Aug 2012: thanks to maskbits, go back to using mask, and use regular include, dropping includefull (undo changes from 10 Feb 2012)[48]  ⍝21 Aug 2012: prevent tile boundary artifacts caused by density not being a factor of tile size[49]  ⍝17-21 Sep 2012: clip results to core mask if masktocore = yes; 7 Jun 2013: do it properly[50]  ⍝22 Oct 2012: if linkages=2, don't use square kernels[51]  ⍝29 Nov 2012: if called from linkages or findpaths, READPARS is done by calling function; unlocalize parameters[52]  ⍝20 May 2013: add correct: if correct = no, don't do edge correction (for CSB)[53]  ⍝29 Oct 2013: allow bankcrossings to be a vector mosaic[54]  ⍝4 Dec 2013: pass header of crossings table and score column to SETTINGS[55]  ⍝3 Jan 2014: use GRIDNAME on READBLOCK; 15 Jan: do it right[56]  ⍝1 Apr 2014: turn off density when example is set[57]  ⍝7 Aug 2014: put conductance back in![58]  ⍝19 Sep 2014: return nodata for masked/not included cells[59]  ⍝9 Mar 2018: don't do old-style edge correction in EXAMPLE! It screws up CLSB comparisons, and isn't used for actual metric anyway[60]  [61]  [62]  [63]   ⍎(0=⎕NC'linkages')/'linkages←0'    ⍝Global linkages; if set, skip edge correction, grid reading, and grid saving[64]   buffer←B←4⊃A[65]   →(linkages=0)/L1                   ⍝If called from linkages,[66]   masktocore←correct←0 ⋄ density←1   ⍝   hardwire these when called from LINKAGES or FINDPATHS[67]   X Y ← 1⊃linkgrids                  ⍝   we've been passed land and mask[68]   Z←(⍴X)⍴0[69]   sr srt sd sdt ← 2⊃linkgrids        ⍝   we've been passed settings grids too[70]   →L2                                ⍝Else, normal call[71]  L1:READPARS ME[72]   density←(1+~0∊⍴example) ⊃ density 1⍝Turn off density if running an example[73]   X←READ 1⊃A[74]   Z←(⍴X)⍴0[75]   T←S (GRIDNAME 'include') 0 (masktocore/'connect_core')[76]   Y←T INCLUDE X                      ⍝   Which cells to run for?[77]   :if masktocore[78]      Y N ← Y[79]      →(0∊⍴N)/0[80]   :end[81]   →(0∊⍴Y)/L10[82]   T←density|(block[1 2]×block[4 5]-1)⍝   Correction to prevent tile boundary artifacts[83]   Y[((1↑⍴Y)⍴T[1]⌽((density-1)⍴1),0)/⍳1↑⍴Y;]←0     ⍝   given density option, only build kernels for every nth cell[84]   Y[;((1↓⍴Y)⍴T[2]⌽((density-1)⍴1),0)/⍳1↓⍴Y]←0[85]   Q←READVEC bankcrossings            ⍝   Load terrestrial crossings table[86]   C←TABLE pathM PATH crossscores     ⍝   Get formula for crossing scores[87]  [88]   sr srt sd sdt ← (C (Q,⊂'terrestrial')) SETTINGS (2⊃A) 'anthro1 anthro2' 'resist dist'   ⍝   Get ecological settings and tables for resistance and distance[89]  [90]  L2:V←LOOKUP resist                  ⍝Get resistance values set by cover type, not ecolgical distance[91]   V←(V⍪1)[V[;1]⍳X;2]                 ⍝Cover types not on list get no resistance (was 1E6 for Kevin's frag protocol)[92]  [93]   T←⌈bandwidth×3÷cellsize[94]   E←SPREAD (bandwidth×3÷cellsize) (T+1) (T+1) ((2⍴1+2×T)⍴1) (linkages≠1)  ⍝Maximum possible kernel given search = 3[95]   E←(E≠0)×ZDENSITY 0⌈3-E÷bandwidth÷cellsize[96]   E←E÷(+/,E←(2⍴T-B)↓(-2⍴T-B)↓E)÷+/,E ⍝Scale to search = 3[97]  [98]   D←(⍳1+2×B)-B+1                     ⍝Maximum radius possible to travel[99]   O←1E6×B<DIST 1+B×2                 ⍝Circle mask for search < 3[100] [101]  M←(⍴X)⍴1                           ⍝Build edge correction matrix -----[102]  →((linkages≠0)∨(~correct)∨~0∊⍴example)/L5     ⍝If doing edge correction, and neither called from linkages or doing example,[103]  X2←READBLOCK (⊂GRIDNAME 1⊃A),(4↑THISBLOCK),2×B  ⍝   Read giant landcover grid--tile + 2×buffer (ugh!)[104]  Y2←READBLOCK (⊂pathG PATH GRIDNAME 'include'),(4↑THISBLOCK),2×B  ⍝   Read giant (potentially masked) include grid[105]  →(~MV∊X2)/L5                       ⍝   Only have to do this if missing values in grid,[106]  F←E÷+/,E                           ⍝   Kernel summing to 1[107]  I←B[108] L3:→(((1↑⍴X2)-B)<I←I+1)/L5          ⍝   For each row,[109]  BREAKCHECK[110]  →((^/Y2[I;]∊0,MV)∨^/MV=B↓(-B)↓X2[I;])/L3[111]  J←B[112] L4:→(((1↓⍴X2)-B)<J←J+1)/L3          ⍝      For each column,[113]  →((Y2[I;J]∊0,MV)∨X2[I;J]=MV)/L4    ⍝         Skip if cell is missing[114]  K←I+D ⋄ L←J+D[115]  →((^/(,F≠0)/,X2[K;L]=MV)∨~MV∊X2[K;L])/L4    ⍝         Skip if all MV or no MVs in window[116]  M[I-B;J-B]←÷+/,F×X2[K;L]≠MV        ⍝         Get edge correction factor for this cell[117]  →L4[118] [119] [120] L5:I←C←B×linkages=0                                         ⍝Linkages runs for all cells--there's no avoided buffer[121]  E1 O1 ← E O[122]  :if conductance[123]     Z2←Z[124]  :end[125] [126] L6:→(((1↑⍴X)-C)<I←I+1)/L10                                  ⍝For each row, -----[127]  BREAKCHECK[128]  →(~∨/Y[I;])/L6                                             ⍝   If empty row, skip it[129]  J←C[130] L7:→(((1↓⍴X)-C)<J←J+1)/L6                                   ⍝   For each column,[131]  →(~Y[I;J])/L7                                              ⍝      If we're doing this cell,[132]  K←I+D ⋄ L←J+D[133]  →(linkages=0)/L71                                          ⍝         If called from linkages,[134]  K←(T1←(K>0)^K≤1↑⍴X)/K                                      ⍝            Trim indices at edges[135]  L←(T2←(L>0)^L≤1↓⍴X)/L[136]  E←T1⌿T2/E1[137]  →(search≥3)/L71[138]  O←T1⌿T2/O1[139] L71:R←V[K;L][140]  →(0∊⍴sr)/L8                                                ⍝         If we have ecological settings for resistance[141]  R←1+multiplier×(srt[;2]×sr[;I;J]) EUDIST sr[;K;L]          ⍝            Resistance values for focal cell I,J.  Focal cell is always 0 for anthro settings.[142]  R←1E6 MVREP R (X[K;L]=MV)                                  ⍝            Missing cells get resistance of a million[143]  R←(V[K;L]×V[K;L]≠1)+R×V[K;L]=1                             ⍝            If cover type resistances are supplied, these take precedence[144] L8:→(search≥3)/L81                                          ⍝         If search < 3,[145]  R←R+O                                                      ⍝            Restrict to circle[146] L81:G←SPREAD (bandwidth×3÷cellsize) (K⍳I) (L⍳J) R (linkages≠1)[147]  →((¯1=1↑block)∨0∊⍴example)/L9                              ⍝         If producing intermediate results from example,[148]  EXAMPLE 1000×T←(bandwidth÷cellsize) 3 CONNECT_RESCALE G E ((⍴E)⍴1)[149] ⍝(⍕((I,J,1 FINDCELL tpoint) TRANSECT Z)∘.+,0) NWRITE 'C:\TEMP\transect.txt'  ⍝Write transect file for Scott's examples[150]  LOG '⊢[connect] Point at ',(⍕⌊.5+FINDPOINT I J-B),' =',4⍕+/,T[151]  →L7[152] L9:G←(bandwidth÷cellsize) 3 CONNECT_RESCALE G E ((⍴E)⍴1)    ⍝         Rescale, but DON'T do edge correction like old connectedness![153]  →(linkages=2)/L12                                          ⍝         If normal call,[154]  R←(sdt[;2]×sd[;I;J]) ECODIST sd[;K;L]                      ⍝            Get ecological distance for focal cell I,J[155]  Z[K;L]←Z[K;L]+(density*2)×M[K;L]×G×0 MVREP (1-R) (X[K;L]=MV)  ⍝            weight kernel by 1-ecological distance and adjust for density and edge correction[156]  :if conductance[157]     Z2[K;L]←Z2[K;L]+(density*2)×M[K;L]×G×X[K;L]≠MV          ⍝            for conductance, no weighting, but adjust for density and edge correction[158]  :end[159]  →L7[160] L12:Z[K;L]←Z[K;L]+(density*2)×G                             ⍝         Else, called from FINDPATHS: adjust for density, but not edges nor ecological distance[161]  →L7[162] [163] L10:→(linkages=0)/L11               ⍝If called by linkages,[164]  res←X REMV Z                       ⍝   return result instead of writing grid[165]  →0[166] [167] L11:transparent←2                   ⍝Write transparently/summed[168]  →(0∊⍴Y)/0[169]  ⍎(0=⎕NC'N')/'N←Y'[170]  ⍎masktocore/'X←MVREP X (~N)'[171]  (MVREP Z ((X=MV)∨Y=MV)) WRITE 1⊃3⊃A[172]  :if conductance[173]     (MVREP Z2 (X=MV)) WRITE 2⊃3⊃A[174]  :end[175]  →0[176] [177] [178] what:CAPS resiliency[179] type:standard[180] direction:positive                  ⍝Integrity metric - higher is bettter[181] info:('land') ('settings') ('connect' 'conduct') (⌈bandwidth×search÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[182] check:CHECKVAR 'multiplier bandwidth search bankcrossings density masktocore correct conductance'[183] check:CHECKCOVER 'resist'[184] check:pathT CHECKFILE bankcrossings[185] check:pathM CHECKFILE 'crossscores'[186] check:CHECKFILE pathT PATH scales    ∇