    ∇ A COMPACT S;M;buffer;targets;W;block;X;F;maskv;ocean;transparent;Z;Q;C;Y;I;B;L;J;K;N;T[1]   ⍝Calculate compactness metric for big watersheds (used in hydrologic alterations)[2]   ⍝Tiny watersheds are done in companion metric COMPACTB[3]   ⍝Number of rows to run MUST be 1 in metrics.par[4]   ⍝inflows_land are d8accum sampled at inflows_land--points where streams flow into landcover (downstream from[5]   ⍝inflows.shp, which is at the edge of wider DEM).[6]   ⍝For inflows, compactness is estimated as compact←*2.08089-0.12568×⍟inflow (in cells) from compactfit.r[7]   ⍝B. Compton, 11-23 Dec 2014 (from WATERSHED)[8]   ⍝4 Feb 2015: estimate values for inflows from regression (compactfit.r) and take running minimum (not needed in COMPACTB)[9]   ⍝17 Feb 2015: use inflows_land; I was adjusting block backwards when dropping subwatersheds[10]  ⍝23 Feb 2015: do inflows right[11]  [12]  ⍝Note: must run COMPACTB as a companion, at the same time[13]  [14]  [15]  [16]   READPARS ME[17]   buffer←0[18]   M←0 1 TABLE pathT PATH targets                 ⍝Read big watershed table (use bigwatersheds4csb.txt--version with full MER for watersheds with subwatersheds)[19]   ⎕ERROR (1≠2⊃⊃S)/'Error: block must be 1 in metrics.par!'[20]   W←,M[⊃⊃S;]                                     ⍝Item we're doing[21]  [22]   W[5 6 7 8]←MER2CELLS W[5 6 7 8]                ⍝Convert MER to cells[23]   W[3 4]←buffer+1+(FINDCELL W[3 4])-W[5 6]       ⍝Watershed outflow in terms of grid[24]   block←¯1,W[5 6 7 8],buffer                     ⍝set block to our current window[25]  [26]  [27]  ⍝First: read input data & check mask[28]   X←READ 1⊃1⊃A                                   ⍝Read landcover[29]   X←MVREP X (X∊⊃,/LOOK¨FRDBL¨↓','MATRIFY ocean)  ⍝Ocean cells → MV; this will blank ocean out of flow & prevent errors when outflows cross islands & capes[30]  [31]   maskv←C←1=READ 2⊃1⊃A                           ⍝Read streams grid...we'll run for stream centerlines...[32]   →(0∊⍴('*',0 0 0 1) INCLUDE X)/0                ⍝Which cells to run for? Pretty much all of them, including developed!  Bail if all masked out; otherwise ignore mask[33]   F←READ 3⊃1⊃A                                   ⍝Flow[34]   F←0 MVREP F (X=MV)                             ⍝if it's not in landcover, we don't want to flow through it![35]   N←READ 4⊃1⊃A                                   ⍝Read inflows [36]   N←(9999×N≤1)+*2.08089-0.12568×⍟N⌈1             ⍝Use regression to convert inflows to estimated compactness (or a very large number if no inflow)[37]  [38]   Z←(⍴X)⍴MV[39]   ⎕←'Getting watershed for outflow...' ⋄ FLUSH[40]   Z[W[3];W[4]]←(⌊/(,Q)/,N)⌊COMPACTNESS Q←F POINTSHED W[3 4]  ⍝Get watershed and compactness for outflow cell (include min of inflow)[41]  [42]  ⍝Now delete subwatersheds from our watershed--they'll be done separately[43]   B←(M[;2]=2)^(^/L≥1)^^/L≤((⍴L←↑1 FINDCELL¨↓M[;3 4])⍴⍴X)    ⍝Subwatershed outflows that fall in our MER[44]   L←(B\Q SCATI B⌿L)⌿L                            ⍝Those that actually fall in our watershed[45]   L←↑(↓L)~⊂W[3 4]                                ⍝But not this watershed, if it's a sub![46]   ⎕←'Removing ',(⍕1↑⍴L),' subwatersheds...' ⋄ FLUSH[47]   I←0[48]  L1:→((1↑⍴L)<I←I+1)/L2                           ⍝For each subwatershed,[49]   Q←Q×~F POINTSHED L[I;]                         ⍝   Delete subwatershed[50]   →L1[51]  [52]  L2:J K ← CLIP Q                                 ⍝Clip to mainstem, excluding subwatersheds for speed-up[53]   F←F[J;K] ⋄ Z←Z[J;K] ⋄ C←C[J;K] ⋄ Q←Q[J;K] ⋄ N←N[J;K][54]   W[3 4]←1+W[3 4]-1⊃¨J K[55]   block[2 3]←¯1+block[2 3]+⊃¨J K[56]   block[4 5]←⍴Z[57]  [58]  L5:Y←↑(↓INDICES C×Q)~⊂W[3 4]                    ⍝Targets are stream centerlines in watershed (excluding subwatersheds, and outflow, which we've already done)[59]   ⎕←'Now getting watersheds for ',(⍕1+1↑⍴Y),' cells...' ⋄ FLUSH[60]   I←0[61]  L3:→((1↑⍴Y)<I←I+1)/L4                           ⍝For each target cell,[62]   :if (I÷20)=⌊I÷20[63]      ⎕←(⍕ROUND 100×I÷1↑⍴Y),'%' ⋄ FLUSH ⋄ BREAKCHECK[64]   :end[65]   Z[Y[I;1];Y[I;2]]←(⌊/(,T)/,N)⌊COMPACTNESS T←F POINTSHED Y[I;] ⍝   Get compactness (include min of inflow)[66]   →L3[67]  [68]  L4:transparent←1[69]   (MVREP Z (F=MV)) WRITE pathG PATH 3⊃A          ⍝Write results[70]   →0[71]  [72]  [73]  [74]  what:data prep[75]  type:table[76]  info:((⊂'land'),(⊂pathS) PATH¨'streams' 'flow' 'inflows_land') '' (path,'ha\compact') (0) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[77]  check:CHECKVAR 'targets ocean'[78]  check:1 CHECKCOVER 'ocean'[79]  check:pathT CHECKFILE targets    ∇