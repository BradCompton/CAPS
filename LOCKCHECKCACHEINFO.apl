    ∇ LOCKCHECKCACHEINFO M;X;cache;Y;Z;ci;T;A;lock;cluster;I;Q[1]   ⍝Check for discrepancies between cacheinfo.txt and grid sizes in the cache; if ⍵ isn't empty, get lock and stop[2]   ⍝There's a bug somewhere that makes these wildly disagree[3]   ⍝B. Compton, 7 Nov 2017[4]   ⍝10 Nov 2017: be robust to missing directories, and log errors instead of getting locks[5]   [6]   [7]   [8]    cluster←1                                      ⍝Always get a cluster lock![9]    GETCACHECONFIG[10]  [11]   :if 0∊⍴M                                       ⍝If called manually,[12]      lock←LOCKFILE GETNAME,' cache'              ⍝   Get a lock on cacheinfo[13]   :end[14]  [15]   X←⎕LIB 2⊃cache                                 ⍝Get cache directory[16]   X←(^/X∊' 0123456789\')⌿X[17]   X←cache[2],¨FRDBL¨↓((RJUST X)[;''⍴1↓⍴X]='\')⌿X    [18]  [19]   Y←LIB¨X[20]   Y←X,¨⊃,/NINFO¨Y[21]   Z←+/⊃¨1↑¨FILEINFO¨Y                            ⍝File info on all grids, but not info folders[22]   ci←,0 MATIN (2⊃cache),'index\cacheinfo.txt'    ⍝Read cacheinfo[23]   Q←NOW,', ',(FRDBL GETNAME),': ',((0≠⍴M)/'(',M,') '),'cacheinfo.txt = ',(FRDBL,'CI12' ⎕FMT ci[2]),' MB; actual = ',(FRDBL,'CI12' ⎕FMT Z),' MB; ratio = ',⍕3 ROUND Z÷ci[2] ⋄ FLUSH[24]   :if ~(T>0.99)^(T←ci[2]÷Z)<1.01[25]      Q←Q,'   ERROR!   ERROR!   ERROR!   ERROR!   ERROR!'[26]   :end[27]  [28]   ⎕←Q ⋄ FLUSH[29]   [30]   :if 0∊⍴M[31]      UNLOCKFILE lock                             ⍝return cacheinfo lock[32]   :else[33]      'x:\anthill\cacheinfo.log' WRITE2LOG Q[34]   :end    ∇