    ∇ Z←R FOCALMEANC X;C;M;I;L;N;K;J;Q;U;V;T;Y[1]   ⍝Calculate focal mean of 1⊃⍵ with radius ⍺ cells, ignoring values other than 1 in optional value mask 2⊃⍵, and returning results only for cells in optional focal cell mask 3⊃⍵[2]   ⍝Cells with MV are never included in mean.  [3]   ⍝Cells that are 0 in value mask are set to MV.[4]   ⍝If focal cell mask is excluded, results are returned only for cells with data.[5]   ⍝(To include the 2nd mask but not the first, use 1 for the 1st mask, e.g. 5 FOCALMEANC data 1 focalcells [6]   ⍝B. Compton, 3-4 Sep 2014[7]   ⍝6 Oct 2014: aargh! I forgot the circle![8]   ⍝4 Nov 2014: and I completely screwed up the circle!  (Election day: republican rampage expected)[9]   ⍝1 Jun 2017: add focal cell mask to target only selected cells. (Trump not impeached yet...)[10]  [11]  [12]  [13]   :if 1≥≡X[14]      X←X ((⍴X)⍴1)[15]   :end[16]   X M Y ← 3↑X,⊂MV≠⊃X[17]   M←0 MVREP (⍴X)⍴M ⋄ Y←0 MVREP (⍴X)⍴Y[18]   X←MVREP X (M≠1)[19]   Z←(⍴X)⍴MV[20]   C←R≥DIST 1+2×R                         ⍝Circle of radius R cells[21]   N←(-⌽⍳R),0,⍳R                          ⍝Indices into neighboring cells[22]   I←0[23]  L1:→((1↑⍴X)<I←I+1)/0                    ⍝For each row in result,[24]   →(~∨/Y[I;])/L1[25]   FLUSH[26]   J←0[27]  L2:→((1↓⍴X)<J←J+1)/L1                   ⍝   For each column[28]   →(~Y[I;J])/L2[29]   K←(U←(K>0)^K≤1↑⍴X)/K←I+N               ⍝      indices into neighbors[30]   L←(V←(L>0)^L≤1↓⍴X)/L←J+N[31]   Z[I;J]←(+/,X[K;L]×Q)÷+/,Q←(X[K;L]≠MV)×U⌿V/C ⍝      focal mean of circle[32]   :if ~∨/,Q                              ⍝      If no data in circle, then return MV[33]      Z[I;J]←MV[34]   :end[35]   →L2    ∇