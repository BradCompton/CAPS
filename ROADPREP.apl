    ∇ A ROADPREP S;buffer;E;M;R;C;H;V;trafficthreshold;clover;size;pertile;expressway;screenwindow;screenthreshold;L;Q;Z;F;pairmax;T;head;G[1]   ⍝Do data prep for Critical Linkages I roads[2]   ⍝Source:[3]   ⍝   settings\raw\traffic    Gibbs-scaled traffic rate[4]   ⍝   source\roads            Road class grid[5]   ⍝   source\roadlines.txt    Road linework (for finding intersections)[6]   ⍝Parameters (and suggested values):[7]   ⍝   screenwindow = 34       ; radius for focal mean screening (cells). Set to 0 to skip screening.[8]   ⍝   screenthreshold = 0.2   ; maximum road density in window for screening[9]   ⍝   trafficthreshold = 0.25 ; minimum Gibbs traffic rate for screening[10]  ⍝   clover = 20 0.08        ; cloverleaf parameters (cell radius of focal mean) (threshold)[11]  ⍝   size = 300              ; Approximate length of each blob (m)[12]  ⍝   pairmax = 500           ; Max distance (m) to pair expressway blobs (must be < 3rd order centriods and < cloverleaf fragments)[13]  ⍝   pertile = 2000          ; Maximum number of units per tile (to avoid collisions)[14]  ⍝   expressway = 1          ; Numeric classes of expressways/motorways in road class grid[15]  ⍝Result:[16]  ⍝   source\roadscli         Grid with road units[17]  ⍝   source\roadscli_d       Display version of road units modulo 1000[18]  ⍝   working\roadpairs.txt   Diagnostic point file of paired centroids[19]  ⍝[20]  ⍝Roads are prepared for CL I roads in several steps. First, roads are screened for maximum traffic density[21]  ⍝and minimum traffic rates. Then cloverleaves are removed from expressways (where expressway density is[22]  ⍝high). Then blobs are built for expressways, and the blobs are paired across divided sections.[23]  ⍝Next, blobs are built for other roads. Finally, expressways and other roads are merged.[24]  ⍝Note: because of tiling, there will be smaller blobs at tile edges.  Who cares.  Blobs <5 cells are dropped,[25]  ⍝as these are primary due to errors in roads data....there are lots of these in LCC data.[26]  ⍝Calibrating: pairmax determines the max distance for pairing divided expressways. If this is too large[27]  ⍝relative to size and clover, blobs will be incorrectly paired at junctions. Have a look at roadpairs.txt[28]  ⍝in ArcMap (load as a point file).[29]  ⍝*** After running, make sure you haven't blown out pertile! (You'll get an error if you do)[30]  ⍝B. Compton, 9-23 Oct 2014 (from roadscreen.txt, ROADBLOBS, and ROADPAIRS)[31]  ⍝3 Nov 2014: drop blobs with 4 or fewer cells (election day tomorrow: will Repubs grab the senate? probably.)[32]  ⍝21 Nov 2014: respect mask properly[33]  [34]  [35]  [36]   READPARS ME[37]   buffer←4⊃A[38]  [39]   F←READ 1⊃1⊃A                               ⍝Read Gibbs road traffic[40]   R←READ 2⊃1⊃A                               ⍝And road class[41]   V←READVEC pathS PATH 'roadlines.txt'       ⍝Get vector roads[42]  [43]   M←(⍴F)⍴1[44]   :if ~0∊⍴mask                               ⍝If mask grid supplied,[45]      M←~(READ mask)∊0,MV                     ⍝   read mask[46]   :end[47]  [48]   :if screenwindow≠0                         ⍝If screening,[49]      ⎕←'Screening by road density' ⋄ FLUSH[50]      E←screenwindow FOCALMEANC (R>0) M       ⍝   Take focal mean of road density to build road screen[51]   :else[52]      E←(⍴F)⍴0[53]   :end[54]   C←M×R×(E≤screenthreshold)^F≥trafficthreshold ⍝Roads that are screened in[55]  [56]   ⎕←'Making expressway blobs' ⋄ FLUSH[57]   H←MAKEBLOBS C=expressway[58]  [59]   ⎕←'Dropping cloverleaves' ⋄ FLUSH[60]   H←DECLOVER H                               ⍝Drop cloverleaves[61]  [62]   ⎕←'Pairing expressways' ⋄ FLUSH[63]   H←(pairmax÷cellsize) ROADPAIRS H           ⍝Pair them[64]  [65]   ⎕←'Making blobs for other roads' ⋄ FLUSH[66]   L←V MAKEBLOBS C×C≠expressway               ⍝Now build road blobs for other road classes[67]   Z←⌊H+L[68]  [69]   Q←4 FINDPATCH Z                            ⍝Now drop tiny blobs--they are junk from messy road data[70]   G←+/(T←UNIQUENZ ,Q)∘.=(,Q≠0)/,Q[71]   Z←Z×Q∊(G≥5)/T                              ⍝Only keep blobs with ≥5 cells[72]  [73]   ⎕←'Writing results' ⋄ FLUSH[74]   (MVREP (⌊Z) (Z=0)) WRITEI 1⊃3⊃A[75]   (MVREP (⌊1+100|Z) (Z=0)) WRITEI 2⊃3⊃A      ⍝Write display version, modulo 100[76]   →0[77]  [78]  [79]  [80]  what:data prep[81]  type:standard[82]  init:head←1↓⎕TCHT MTOV MATRIFY 'id x y distance' ⋄ (0 0⍴'') TMATOUT pathW,'roadpairs.txt'[83]  info:((pathU,'traffic') (pathS,'roads')) ('') ((⊂pathS),¨'roadscli' 'roadscli_d') (clover[1]) 'luwet'      ⍝Source grid, settings table, result grid, buffer size, and include grid[84]  check:CHECKVAR 'screenwindow screenthreshold trafficthreshold clover size pertile expressway pairmax'    ∇