    ∇ A BEACHPEDS S;H;D;Z;I;T;search;buffer;B;J;D;K;Y;self;X;Q;house_bandwidth;public_bandwidth;E;P;M;V;R;W;G;resist;carsrvs;peoplecarsrvs;beach;weights;F;beach_bandwidth;transparent[1]   ⍝CAPS beach peds metric[2]   ⍝Source:[3]   ⍝   land                landcover[4]   ⍝   beadpeds            from makebeachpeds.aml.  1 = public beaches, 100 + size (ha) = parking (cars),[5]   ⍝                       and 200 + size = parking (rvs)[6]   ⍝Parameters:[7]   ⍝   house_bandwidth     how far do people walk from residential to private beaches?[8]   ⍝   weights             weight table; how many daily beach visits per cell of each residential class?[9]   ⍝   public_bandwidth    how far do people walk from residential to public beaches[10]  ⍝   beach_bandwidth     how far do people walk along a beach?[11]  ⍝   carsrvs             number of cars, rvs per ha[12]  ⍝   peoplecarsrvs       number of daily beach visits from each car, rv[13]  ⍝   beach               cover type of beaches[14]  ⍝   resist              resistances for public beach, private beach, other[15]  ⍝   search              search distance[16]  ⍝Results:[17]  ⍝   beachpeds           beachpeds metric, just for beaches[18]  ⍝B. Compton, 25 Jan and 3 Feb 2011, from BEACHORVS[19]  [20]  [21]  [22]   READPARS ME[23]   buffer←B←4⊃A[24]   Z←0×X←READ 1⊃1⊃A                       ⍝Get landcover[25]   →(0∊⍴Y←S '' INCLUDE X)/L3              ⍝Which cells to run for?  Ignore include.[26]   D←0 MVREP READ pathG PATH 2⊃1⊃A        ⍝Read beaches & parking lots[27]   →(^/,(2⍴B)↓(-2⍴B)↓D=0)/L3[28]  [29]   E←LOOKUP weights                       ⍝First, build house kernels[30]   R←(E[;2],0)[E[;1]⍳X]                   ⍝Get landcover weights[31]   Z←house_bandwidth KERN R               ⍝Build kernels[32]   Z←(-T)↓(T←.5×(⍴Z)-⍴D)↓Z                ⍝and drop border[33]   Z[(⍳B),(1+1↑⍴Z)-⌽⍳B;]←0                ⍝Don't spread into buffer, though[34]   Z[;(⍳B),(1+1↓⍴Z)-⌽⍳B]←0[35]  ⍝ transparent←2 ⋄ (X REMV Z) WRITE pathW PATH 'houses'       ⍝Temp: kernels for housing[36]  [37]   F←SPREAD T (⌈T+1) (⌈T+1) ((2⍴1+2×⌈T←beach_bandwidth×search÷cellsize)⍴1)   ⍝Benchmark for public beach spread[38]   F←(F≠0)×ZDENSITY search-F÷beach_bandwidth÷cellsize[39]  [40]   P←((,D>1)/,⍉(⌽⍴D)⍴⍳1↑⍴D),[1.5](,D>1)/,(⍴D)⍴⍳1↓⍴D       ⍝Now do parking-based stuff.  Parking lots...[41]   P←((^/P>B)^^/P≤((⍴P)⍴⍴X)-B)⌿P                          ⍝but not in buffer[42]   H←((,D=1)/,⍉(⌽⍴D)⍴⍳1↑⍴D),[1.5](,D=1)/,(⍴D)⍴⍳1↓⍴D       ⍝and public beaches[43]  [44]   V←⌈public_bandwidth×search÷cellsize                    ⍝Kernel for houses near public beach access[45]   M←ZDENSITY (cellsize×DIST 1+2×V)÷public_bandwidth[46]   M←M÷+/,M←M×M≥M[⌈.5×1↑⍴M;1]                             ⍝Avoid square artifacts; standardize volume to 1[47]  [48]   G←X=LOOK beach                         ⍝Beaches in general (=1)[49]   G←G⌈2×D=1                              ⍝Public beaches (=2), everything else =0[50]   G←resist[3-G]                          ⍝Look up public beaches [1], private beaches [2], and everything else [3] in resistance[51]  [52]   I←0[53]  L1:→((1↑⍴P)<I←I+1)/L3                   ⍝For each parking lot,[54]   J←((J≥1)^J≤1↑⍴X)/J←P[I;1]+T←(⍳T)-.5×1+T←(''⍴⍴M)⌈''⍴⍴F[55]   K←((K≥1)^K≤1↓⍴X)/K←P[I;2]+T[56]   W←+/,ROUND  M×R[J;K]                   ⍝   Residential weights[57]   T←D[P[I;1];P[I;2]]                     ⍝   This parking lot (100 = cars, 200 = RV) + size[58]   W←W+(carsrvs×peoplecarsrvs)[⌊T÷100]×⌊/|T-100 200   ⍝   Visits/day from cars or RVs in parking lot[59]   Q←(+/(H-(⍴H)⍴P[I;])*2)*.5              ⍝   Find closest beach cell[60]   →((cellsize×⌊/Q)>2×beach_bandwidth)/L1 ⍝   If no beach close to beach parking lot, bail on this one[61]   Q←((Q=⌊/Q)⌿H)[1;]                      ⍝   here it is (take them in row-major order if ties)[62]   Q←Q-¯1+J[1],K[1]                       ⍝   and rejigger Q[63]  [64]   Y←SPREAD (beach_bandwidth×search÷cellsize) (Q[1]) (Q[2]) (G[J;K])[65]   Y←W×(Y≠0)×(ZDENSITY search-Y÷beach_bandwidth÷cellsize)÷+/,F×MV≠T↓(-T←.5×((⍴J),⍴K)-⍴F)↓X[J;K][66]   Z[J;K]←Z[J;K]+Y[67]   →L1[68]  [69]  L3:Z←Z×X∊LOOK beach                     ⍝Return results only for beaches[70]   transparent←2                          ⍝Results are summed across blocks[71]   (X REMV Z) WRITE pathR PATH 3⊃A[72]    →0[73]  [74]  what:CAPS coastal[75]  type:standard[76]  info:('land' 'beachpeds') ('') ('beachpeds') (20+(⌈/house_bandwidth,public_bandwidth,beach_bandwidth)×search÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[77]  check:CHECKVAR 'house_bandwidth public_bandwidth beach_bandwidth weights carsrvs peoplecarsrvs beach resist search'[78]  check:1 CHECKCOVER beach[79]  check:CHECKCOVER 'weights'    ∇