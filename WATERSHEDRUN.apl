    ∇ Z←K WATERSHEDRUN W;N;C;Q;block;noread;Z;I;B;L;G;V;R;S;E;J;T;U;M;O;head;futuregrids;futurepath[1]   ⍝Sets up calls for CAPS watershed metrics for scenario name ⍺ and matrix of metrics and systems ⍵[2]   ⍝Call consists of (1) Watershed #, (2) full or subwatershed, (3) scenario name, (4) common input grids, (5) settings grids,[3]   ⍝   (6) repeating 4-element list of metric, system, result grids and metric-specific input grids[4]   ⍝B. Compton, 12-13 Aug 2009[5]   ⍝24 Feb 2011: skip subwatersheds; set up to call tiny watersheds in WATERSHEDB (up in the air, on the way to San Diego)[6]   ⍝24 May 2011: Set up calls for Anthill[7]   ⍝22 Jun 2011: pass override_pars; 24 Jun: use override_pars to pass watershedcall; 11 Aug put it in run\temp\[8]   ⍝27 Mar 2012: typo fixed[9]   ⍝17 May 2012: create subwatersheds file[10]  ⍝23 May 2012: use bigwatersheds table; don't have to deal with tiny watersheds any more[11]  ⍝7 Apr 2014: never scramble subtasks!  Ordering is important![12]  ⍝12 Nov 2014: If no big watersheds, don't call WATERSHED! (This can happen in CSB)[13]  ⍝8 Jun 2015: allow multiple results[14]  [15]  [16]  [17]   S E R B Q ← GETINFO 'WATERSHED'        ⍝Read source names, settings table, result names, buffer size, and include grid name from WATERSHED function[18]   V←GETINFO¨W[;1]                        ⍝Read the same from watershed metric functions[19]   S E ← GRIDNAME¨ S E                    ⍝Replace source grids names where available[20]   R ← 0 resultspar GRIDNAME R[21]  [22]   ⍎(0=⎕NC'override_pars')/'override_pars←'''''[23]   V←(W[;1 2]),(R←3⊃¨V),[1.5]1⊃¨V                         ⍝Metric, system, result grid, and specific input grids[24]   override_pars←override_pars,⎕TCNL,'[watershedb]',⎕TCNL,'watershedcall←',(⍕⍴V),'⍴',⊃,/,BUILDPAR¨V   ⍝Save call for the sake of WATERSHEDB[25]   MAKEDIR pathP,'temp\'[26]   override_pars NWRITE O←pathP,'temp\temp',(FRDBL 15 0⍕?1E5),'.tmp'    ⍝Write override_pars[27]  [28]   :if (1 1⍴MV)≡TABLE pathT PATH bigwatersheds            ⍝If no big watersheds, don't call WATERSHED[29]      Z←0 3⍴0[30]      →0[31]   :end[32]  [33]   Q←'function!:''',O,''' WATERSHEDREPS ''',(pathT PATH bigwatersheds),''''[34]  [35]  L0:→(~0∊⍴K)/L1                                          ⍝If no scenarios,[36]   Z←,¨,⊂LJUST MIX (⊂'WATERSHEDCALL '),¨⊂' ',DEB⍕(''''''),⊂(BUILDPAR S),(BUILDPAR E),(,BUILDPAR¨V),BUILDPAR O[37]   ⍎(2≤≡R)/'R←⊃OVER/MIX¨R'                                ⍝Flatten result list (allow multiple results, as from NPK)[38]   →L2[39]  [40]  L1:G←1 TABLE K                                          ⍝Else, read scenario names[41]   Z←(⊂BUILDPAR K),MIX BUILDPAR¨S MAKENAMES G[;1]         ⍝   Scenario, common input grid names[42]   Z←(RJUST ⍕Z),' ',MIX BUILDPAR¨E MAKENAMES G[;2]        ⍝   Settings grids (not currently used for watershed metrics)[43]   R←M←0 0⍴''[44]   J←0[45]  L3:→((1↑⍴G)<J←J+1)/L4                                   ⍝   For each scenario,[46]   T←⊃V[;3] MAKENAMES G[J;3]                              ⍝      Result grids for this scenario[47]   R←R OVER MIX T[48]   U←⊃¨(V[;4]) MAKENAMES¨ ⊂G[J;1]                         ⍝      Metric-specific input grids for this scenario[49]   M←M OVER DEB,⍕BUILDPAR¨V[;⍳2],T,[1.5]U[50]   →L3[51]  L4:Z←DEB LJUST Z,M[52]   Z←(⊂'WATERSHEDCALL '),¨FRDBL¨↓Z[53]   Z←Z,¨⊂' ',BUILDPAR O[54]  [55]  L2:Z←Z,[1.5]⊂Q[56]   Z←Z,⊂(⍕1↑⍴W),' watershed metric',(1≠1↑⍴W)/'s'[57]   resultgrids←resultgrids OVER (pathR,'progress') OVER MIX (~0∊⍴R)/(⊂pathR)PATH¨↓R[58]  [59]   head←0 0⍴'' ⋄ (0 0⍴'') TMATOUT pathI PATH 'subwatersheds.txt'   ⍝Create new, empty subwatersheds file    ∇