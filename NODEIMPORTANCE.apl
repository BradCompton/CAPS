    ∇ A NODEIMPORTANCE H;N;T;D;Z;I;V;J;Q;S;R;head;U;Y;M;B;C[1]   ⍝Assess the importance of each node and link (unless ⍺=0) for network connectivity, given bandwidth(s) ⍵ (km)[2]   ⍝If ⍺=2, just do relative link importance[3]   ⍝Source, in pathQ\tables\[4]   ⍝   nodes.txt                Table of nodes[5]   ⍝   nodevalues.txt           Table with value of each node[6]   ⍝   distance<bandwidth>.txt  Probability matrix for each bandwidth[7]   ⍝Results, in pathQ\results\[8]   ⍝   nodeimportance.txt	     Table of node id, centroid-x, centroid-y, name, iei, importance for each bandwidth[9]   ⍝                            (import<bandwidth>), and relative importance for each bandwidth[10]  ⍝                            (relimport<bandwidth>)[11]  ⍝   linkimportance.txt	     Table of id, node1, node2, direct probability for each bandwidth (P<bandwidth>),[12]  ⍝                            stepping-stone probability for each bandwidth (Ps<bandwidth>), importance[13]  ⍝                            for each bandwidth (import<bandwidth>), [or, if ⍺=2, relative importance for each  [14]  ⍝                            bandwidth (relimport<bandwidth>)], and ranks for the importance scores[15]  ⍝   linklines.txt            Generate file for drawlines.aml (use &r drawlines linklines)[16]  ⍝In GIS, join linklines with linkimportance.txt on ID[17]  ⍝B. Compton, 15 Mar 2013 (from SINGLELINKS)[18]  ⍝21 Mar 2013: renamed from DROPNODES; also do link importance[19]  ⍝1 Apr 2013: incorporates DRAWLINKS: [7-8 Feb 2013 (Feb 8: Monster nor'easter on its[20]  ⍝   way!); and 11 Feb 2013: new path scheme (we got about 20" with lots of drifting)];[21]  ⍝   substantial rewrite for multiple distance matrices, allow skipping links, which are very very slow[22]  ⍝25-26 Feb 2015: also give importance ranks[23]  ⍝23 Apr 2015: If ⍺=2, just do relative link importance[24]  [25]  [26]  [27]   ⍎(0=⎕NC'A')/'A←1'[28]   SETPATHS[29]   N←0 1 TABLE pathQ,'tables\nodes.txt'           ⍝List of all nodes[30]   N[;4]←(N[;4]≠¨'''') SLASHEACH N[;4]            ⍝Drop quotes left by Arc[31]   T←0 1 TABLE pathQ,'tables\nodevalues.txt'      ⍝and get IEI-weighted size of each node[32]   N[;5]←T[T[;4]⍳N[;1];5]                         ⍝which we'll use for node importance[33]  [34]   :if A=2                                        ⍝If ⍺=2, do relative link importance[35]      N[;5]←1[36]   :end    [37]  [38]   Z←N[;⍳5],((1↑⍴N),2×⍴H←,H×1000)⍴0               ⍝Results for nodes: id, x, y, name, iei, node importances; convert bandwidth to m[39]  [40]   I←0[41]  L1:→((⍴H)<I←I+1)/L5                             ⍝For each bandwidth,[42]   BREAKCHECK[43]   ⎕←'Bandwidth = ',⍕H[I] ⋄ FLUSH[44]   D←MATIN pathQ,'tables\distance',(⊃KNAMES H[I]),'.txt'  ⍝   Read distance matrix for this bandwidth[45]   :if I=1                                        ⍝   On first iteration, set up results for link importance[46]      Y←(,⍉(⍴D)⍴N[;1]),(,(⍴D)⍴N[;1]),(,D),[1.5],⍉D⍝      Results for edges: from-node, to-node, distance one way, distance the other way   TAKE MEAN.....[47]      Y←(B←,(⍳1↑⍴D)∘.<⍳1↑⍴D)⌿Y                    ⍝      Just take upper triangle[48]      Y←(Y[;2]+Y[;1]×1000),Y                      ⍝      First colum is id (fffttt)[49]      Y←Y[;⍳3],0.5×+/Y[;4 5]                      ⍝      and take mean P(connect | bandwidth[1])[50]      Y←((⍴Y)+0,2+3×¯1+⍴H)↑Y                      ⍝      make Y big enough[51]   :else[52]      Y[;4+3×I-1]←B/,D                            ⍝      Direct probabilities[53]   :end[54]   Y[;5+3×I-1]←B/,C←FLOYD D                       ⍝   Stepping stone probabilities[55]  [56]   V←N[;1 5] PC C                                 ⍝   Fill out probability matrix and calculate P(D) for unmodified landscape[57]   U←(N[;,1],1) PC C                              ⍝   do it with all nodes the same value[58]  [59]   →(A=0)/L3                                      ⍝   Skip edge importance if ⍺=0[60]   J←0                                            ⍝   First, do edge importance[61]  L2:→((1↑⍴Y)<J←J+1)/L3                           ⍝   For each edge,[62]   →(Y[J;5+3×I-1]=0)/L2                           ⍝      only if nonzero[63]   ⍎((J÷1000)=⌊J÷1000)/'⎕←⎕TCNL,(⍕J),'' of '',⍕1↑⍴Y' ⍝      chatter every 1000 iterations[64]   DOT[65]   M←D[66]   →(0=M[N[;1]⍳Y[J;2];N[;1]⍳Y[J;3]]+M[N[;1]⍳Y[J;3];N[;1]⍳Y[J;2]])/L2      ⍝      If edge is nonzero,[67]   M[N[;1]⍳Y[J;2];N[;1]⍳Y[J;3]]←M[N[;1]⍳Y[J;3];N[;1]⍳Y[J;2]]←0            ⍝         Set P(connect) for edge to 0 (in both directions)[68]   Y[J;6+3×I-1]←(÷V)×V-N[;1 5] PC 0 5 FLOYD M     ⍝         normalized delta P(D) given this edge being dropped (this is SLOW - round to 5 digits for speedup)[69]   →L2[70]  [71]  L3:→(A=2)/L6[72]   J←0                                            ⍝Now do node importance[73]  L4:→((1↑⍴N)<J←J+1)/L1                           ⍝   For each node,[74]   Q←(÷V)×V-(N[;,1],N[;5]×J≠⍳1↑⍴N) PC C           ⍝      normalized delta P(D) given this node being dropped[75]   Q←Q,(÷U)×U-(N[;,1],J≠⍳1↑⍴N) PC C               ⍝      again, with all nodes being treated as equal[76]   Z[J;(3+⍳2)+I×2]←Q[77]   →L4[78]  [79]  [80]  L5:⎕←''[81]   head←1↓⎕TCHT MTOV MATRIFY 'id centroid-x centroid-y name iei ',(⊃,/' ',¨,⍉'import' 'relat'∘.,KNAMES H),' ',⊃,/' ',¨,⍉'rank' 'relrank'∘.,KNAMES H[82]   Z[;5↓⍳1↓⍴Z]←4 ROUND Z[;5↓⍳1↓⍴Z]                ⍝Round probabilities a bit (before ranking)[83]   Z←Z,⍉↑RANK¨↓[1]Z[;5↓⍳1↓⍴Z]                     ⍝add ranks for importance scores[84]   Z TMATOUT T←pathQ,'results\nodeimportance.txt'[85]   ⎕←'Node results written to ',T[86]  [87]  ⍝⍝ T←Y[1;][88]  ⍝⍝ Y←T⍪((1↓⍴Y)↑5↑T)⍪Y                             ⍝but keep 2 short links 1→1 to trick ArcView into scaling 0 to 1      ??????[89]  [90]  [91]  L6:Y[;4 5]←Y[;4 5]×Y[;4 5]≠1E6                  ⍝Zero out all distance of 1E6[92]   Y[;3↓⍳1↓⍴Y]←4 ROUND 0 3↓Y                      ⍝round all probabilities a bit[93]   Y←(∨/0≠0 3↓Y)⌿Y                                ⍝and drop all rows with no connections[94]   head←1↓⎕TCHT MTOV MATRIFY 'id node1 node2 ',⊃,/' ',¨,⍉'P' 'Ps' (((A=2)/'rel'),'import')∘.,KNAMES H[95]   Y TMATOUT T←pathQ,'results\linkimportance',((A=2)/'_rel'),'.txt'[96]   ⎕←'Link results written to ',T[97]  [98]   Q←((2×1↑⍴Y),3)⍴(Y[;1],N[N[;1]⍳Y[;2];2 3]),(Y[;1],N[N[;1]⍳Y[;3];2 3])[99]   Q[2 4;3]←Q[2 4;3]+1                            ⍝2 short links so ArcView scales 0 to 1      ???????[100]  (pathQ,'results\linklines.txt') GENLINES Q[101] [102] [103] ⎕←'Now in Arc, w ',pathQ,'results\ and &r drawlines linklines, then join coverage linklines with ',pathQ,'results\linkimportance.txt.'    ∇