    ∇ Z←V MAKEBLOBS X;R;M;B;I;N;U;Q;KK8;T;S;Y[1]   ⍝Make blobs for roads ⍵, vector roads ⍺[2]   ⍝Guts of ROADBLOBS, called by ROADBLOBS and ROADPREP[3]   ⍝Inputs:[4]   ⍝   X       binary road grid[5]   ⍝   V       vector roads[6]   ⍝Globals:[7]   ⍝   size      Approximate length of each blob (m)[8]   ⍝   rate      Minimum traffic rate to include[9]   ⍝   pertile   Maximum number of units per tile (to avoid collisions)[10]  ⍝B. Compton, 9 Oct 2014 (from ROADBLOBS)[11]  ⍝16 Oct 2014: merge tiny blobs with previous blob[12]  [13]  [14]   :if 0=⎕NC'V'                                   ⍝If vector roads not supplied, don't worry about intersections[15]      R←0 2⍴0[16]   :else[17]      R←((2×1↑⍴⊃V),2)⍴⌊(⊃V)[;1+⍳4]+.5             ⍝   Take just road endpoints and use integers[18]      M←(1 FINDPOINT 0 0),1 FINDPOINT 1+2↑block   ⍝   x-min, y-min, x-max, y-max in vector terms (expand 1 cell)[19]      R←((R^.≥M[1 4])^R^.≤M[3 2])⌿R               ⍝   Just take road points in our block[20]      B←(1↑⍴R)⍴0[21]      :for I :in ⍳1↑⍴R                            ⍝   For each road point,[22]         B[I]←2<+/R^.=R[I;]                       ⍝      if more than 2 points here, it's an intersection[23]      :end[24]      R←↑1 FINDCELL¨↓B⌿R                          ⍝   Road intersections in terms of cells[25]   :end[26]  [27]   KK8←4 2⍴¯1 0 1 0 0 ¯1 0 1                      ⍝Use 4-neighbor rule (doesn't matter much)[28]   X←0⍪(0,X,0)⍪0                                  ⍝Expand by 1 cell so we can do quick buffering in GROW[29]  [30]   N←size÷CELLSIZE                                ⍝Convert size from m to cells[31]   U←1 2⍴1+(1 0+⍴B)⊤¯1+(,B←X≠0)⍳1                 ⍝Seed cell[32]  [33]   Z←(⍴X)⍴0[34]   I←pertile×¯1+block[5]+(block[4]-1)×block[7]    ⍝Figure out first blob number[35]  L1:→(^/,X=0)/L2                                 ⍝Until no roads left undone,[36]   FLUSH[37]   U←(0≠X SCATI U)⌿U                              ⍝   Drop any seeds we've already dealt with[38]   →(0≠1↑⍴0)/L3                                   ⍝   If out of seeds (because of disjunct roads),[39]   U←1 2⍴1+(1 0+⍴B)⊤¯1+(,B←X≠0)⍳1                 ⍝      get another seed[40]  L3:Q←X GROW N (U[1;])                           ⍝   grow up a blob from seed[41]   U←(1 0↓U)⍪INDICES (~Q)^(X≠0)^FOCALMAX Q        ⍝   get more seeds at blob edges[42]   Y←I←I+1[43]   :if (N÷2)≥+/,Q                                 ⍝   If we've ended up with a tiny blob,[44]      S←Q[1⊃T;2⊃T←1 CLIP Q][45]      T←(0≠T)/T←,Z[1⊃T;2⊃T←1 CLIP Q]×(1⌽S)∨(¯1⌽S)∨(1⊖S)∨¯1⊖S[46]      Y←''⍴T,I                                    ⍝      replace it with a neighbor if possible[47]   :end[48]   Z←Z+Q×Y[49]   X←X×~Q[50]   →L1[51]  [52]  L2:⎕ERROR (pertile<1↑⍴Z)/'Too many blobs (',(⍕1↑⍴Z),') in tile ',(⍕block[4]),',',(⍕block[5]),' - pertile is only ',⍕pertile[53]   Z←Z×~Z∊(Q≠0)/Q←Z SCATI R+1                     ⍝Drop all blobs with intersections in them[54]   Z←1 1↓¯1 ¯1↓Z    ∇