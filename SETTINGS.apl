    ∇ Z←C SETTINGS A;F;X;I;S;T;G;W;N;Q;M;K;Z;Y;head;H;ss[1]   ⍝Read ecological settings grids named in table 1⊃⍵; deal with crossings if ⍺ exists[2]   ⍝Arguments (1⊃⍵ is required; the rest are optional):[3]   ⍝   1⊃⍵     name of settings table[4]   ⍝   2⊃⍵     list of settings groups to include (space-delimited; always includes 'natural')[5]   ⍝   3⊃⍵     weight column(s) to use (space-delimited; default is 'dist')[6]   ⍝   1⊃⍺     crossings score table (score, function to modify each settings variable)[7]   ⍝   2⊃⍺     crossings table (x, y, score, other stuff) (header) (name of score column)[8]   ⍝Globals:[9]   ⍝   scales  name of file with settings variable, raw-min, raw-max to use for rescaling settings variables, created by MAKESETTINGS/GETRANGES[10]  ⍝Returns repeating 2 element vector of the following for each set of weights in ⍵[3][11]  ⍝   1) p×n×m array of settings weighted and scaled such that maximum distance is 1[12]  ⍝   2) matrix with row for each settings variable, containing:[13]  ⍝       a) settings variable name[14]  ⍝       b) bit vector with 1 for natural settings[15]  ⍝       c) weight of settings variable[16]  ⍝Note: Settings variables are rescaled so that max possible distance is 1.0, except for column = 'dist' which is scaled so[17]  ⍝      max natrual distance is 1.0, thus max anthropogenic distance may be more.  When calculating distances to anthropogenic[18]  ⍝      cells (as in SIM), include anthropogenic weights in column 'dist' and take 1⌊ecological distance.[19]  ⍝B. Compton, 6 Dec 2007[20]  ⍝Modified 21 May 2010: call SETTINGSMOD[21]  ⍝19 Oct 2010: do crossings[22]  ⍝15 Nov 2010: work with settings groups; rescales to max distance = 1; do scaling internally; returns scale for natural only[23]  ⍝18 Feb 2011: return vector marking non-anthro settings[24]  ⍝21 Jul 2011: drop SETTINGSMOD call, because LINKAGES now deals with this itself; return S, settings variable names and weights[25]  ⍝25 Jul 2011: drop unused score table header[26]  ⍝15 Aug 2011: return weight vector for LINKAGES to pass to LINKAGEMOD[27]  ⍝19 Aug 2011: add alternate grid names[28]  ⍝27 Oct 2011: revise for multiple columns in settings.par; scale & return grids separately; rearrange arguments and results[29]  ⍝3 Nov 2011: when column = dist, exclude anthropogenic settings when rescaling[30]  ⍝15 Nov 2011: allow passing in settings table or name of table as before[31]  ⍝19 Dec 2011: settings variables are unscaled on disk--we do it here (finished the new chicken coop yesterday)[32]  ⍝25 Jan 2012: strip '1l' from ss[33]  ⍝1 Jul 2013: use GRIDNAME when dealing with '1l' grids[34]  ⍝4 Dec 2013: pass header of crossings table![35]  ⍝28 Apr 2014: do PATH before GRIDNAME to save one useless lock[36]  ⍝23 Oct 2014: drop 1l crap, as we're using the pairing approach in the new ROADPREP for CL-I roads[37]  [38]  [39]  [40]   ⍎(0=⎕NC'C')/'C←⍳0'[41]   A G K ← 3↑((1+1≥≡A)⊃A (⊂A)),2⍴⊂''[42]   ss←MATIN pathT PATH scales                             ⍝Get original settings variable scales[43]   K←MATRIFY K,(0∊⍴K)/'dist'[44]   head←2⊃2↑A[45]   →(2≤≡S←1⊃A)/L1                                         ⍝If table name (rather than table) is passed,[46]   S←TABLE A                                              ⍝   Read settings table[47]  L1:Z←4⍴⊂⍳0 ⋄ →(S≡1 1⍴MV)/0                              ⍝Bail out if empty table[48]   K←(H←',' MATRIFY head) MATIOTA K                       ⍝Point to columns[49]   S[;K]←S[;K]×S[;K]≠MV                                   ⍝Missing weights are really zero-weighted[50]   S←(∨/S[;K]≠0)⌿S                                        ⍝Drop any zero-weighted ecological settings variables[51]   Y←2⍴⊂⍳0 ⋄ →((0∊⍴S)∨S≡1 1⍴MV)/0                         ⍝If empty setttings, bail out[52]   G←'natural' OVER MATRIFY TOLOWER G                     ⍝Always include 'natural' group[53]   M←S←((TOLOWER S[;2])∊FRDBL¨↓G)⌿S                       ⍝Only include requested groups[54]  [55]   F←TOLOWER MIX S[;1][56]   ss←ss[(TOLOWER MIX ss[;1]) MATIOTA F;]                 ⍝Reorder settings scales to match our settings variables[57]   X←READ GRIDNAME pathN PATH F[1;]                       ⍝Read first grid[58]   Y←((1↑⍴F),⍴X)⍴0[59]   Y[1;;]←MVREP ((X-ss[1;2])÷-/ss[1;3 2]) (X=MV)          ⍝Rescale it[60]   I←1[61]  L3:→((1↑⍴F)<I←I+1)/L4                                   ⍝For each subsequent grid,[62]   BREAKCHECK[63]   X←READ GRIDNAME pathN PATH F[I;]                       ⍝   Read it[64]   Y[I;;]←MVREP ((X-ss[I;2])÷-/ss[I;3 2]) (X=MV)          ⍝   and rescale it from 0 to 1[65]   →L3[66]  [67]  L4:→(0∊⍴C)/L5                                           ⍝If dealing with crossings,[68]   →(0∊⍴1⊃2⊃C)/L5[69]   Y←((2↑C),⊂M[;1]) CROSSINGSMOD Y                        ⍝   Modify settings values at road/stream crossings[70]  [71]  L5:T←⍉(~(⊂'dist')≡¨FRDBL¨↓H[K;])∘.∨S[;2]≡¨⊂'natural'    ⍝For column = dist, rescale to natural weights only[72]   W←S[;K]÷((1↑⍴S),⍴K)⍴(+⌿T×S[;K]*2)*.5                   ⍝Rescale settings so maximum natural distance = 1[73]   Z←(2×⍴K)⍴0[74]  [75]   I←0[76]  L6:→((⍴K)<I←I+1)/0                                      ⍝For each set of weights,[77]   T←(W[;I]≠0)/⍳1↑⍴W                                      ⍝   only want settings variables with nonzero weights[78]   Z[¯1+I×2]←⊂Y[T;;] REMV Y[T;;]×⍉(⌽(⍴T),1↓⍴Y)⍴W[T;I]     ⍝   rescale settings by weights and return stack of grids[79]   Z[I×2]←⊂(M[;1],((TOLOWER M[;2])∊⊂'natural'),W[;,I])[T;]⍝   and return matrix of settings variable name, 1 if natural, and weight[80]   →L6    ∇