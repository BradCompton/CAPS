    ∇ CL50;X;E;S;P;X_;head;E_;S_;T;K;B;Q;C;input;proportion[1]   ⍝Prepare crossings data for Scott's CL50% project[2]   ⍝Inputs:[3]   ⍝   crossings.txt       standard crossings file[4]   ⍝   mass-3-20-14crossingpred.aquatic.oob.txt[5]   ⍝                       Ethan's bad crossings file from April 2014,[6]   ⍝                       with estimates for all crossings (fields:[7]   ⍝                       id, aquaticest)[8]   ⍝   scottscrossings.txt Scott's selected crossings to survey (fields:[9]   ⍝                       id, keepsurvey)[10]  ⍝Results:[11]  ⍝   crossingscl50.txt   new crossings file with several new aquatic[12]  ⍝                       fields, one for each scenario:[13]  ⍝	  aquatic        original aquaitc score, estimated or surveyed (100% run)[14]  ⍝	  aquaticest     estimated score for all (0% run)[15]  ⍝	  aquaticscott   Scott's scores, estimated or surveyed (S50% run)[16]  ⍝	  aquaticrandom  random 50% estimated or surveyed (R50% run)[17]  ⍝     aquaticpermute crossings permuted across the state[18]  ⍝[19]  ⍝When running LINKAGES, set crossings = 'crossingscl50.txt' and[20]  ⍝aquaticcol = one of the columns above.[21]  ⍝B. Compton, 3 Nov 2014[22]  ⍝4 Nov 2014: revise random point selection: pick 50% of crossings in each watershed, but only from surveyed crossings (unless you pick too many!)[23]  ⍝6 Nov 2014: add permuted crossings[24]  ⍝14 Nov 2014: work for proportions other than 50%[25]  [26]  [27]  [28]   input←'scottscrossings'[29]   proportion←0.5[30]  [31]   INIT[32]   P←path,'more\CL50\source\'[33]   X←0 1 1 TABLE pathT,'crossings.txt'                ⍝Read crossings[34]   X_←',' MATRIFY head[35]   E←0 1 1 TABLE P,'mass-3-20-14crossingpred.aquatic.oob.txt'     ⍝and estimated crossings[36]   E_←',' MATRIFY head[37]   S←0 1 1 TABLE P,input,'.txt'                       ⍝and Scott's crossings[38]   S_←',' MATRIFY head[39]  [40]  ⍝Join estimated crossings to standard crossings[41]   X←X,3 ROUND E[E[;E_ COL 'id']⍳X[;X_ COL 'id'];E_ COL 'aquaticest'][42]   X_←X_ OVER MATRIFY 'aquaticest'[43]  [44]  ⍝Select 50% of points for random surveys[45]   Q←S[;S_ COL 'watershed id surveyed'][46]   Q←Q[⍒Q[;,3],(1↑⍴Q)?1↑⍴Q;]                          ⍝Shuffle crossings, surveyed first[47]   Q←Q[⍋MIX Q[;1];]                                   ⍝Then sort by watersheds[48]   B←~Q[;1]≡¨¯1↓' ',Q[;1]                             ⍝Partition by watershed[49]   C←⌈proportion×B pSUM (1↑⍴Q)⍴1                      ⍝Targets for each watershed[50]   Q←⊃,/C↑¨B⊂Q[;2]                                    ⍝Selected crossings[51]   S←S,S[;S_ COL 'id']∊Q                              ⍝Light them up[52]   S_←S_ OVER 'randomsurvey'[53]  [54]  ⍝Join Scott's crossings.[55]   T←0        ⍝Crossings not specified by Scott's are estimated (T=0)[56]   X←X,(S⍪T)[S[;S_ COL 'id']⍳X[;S_ COL 'id'];S_ COL 'watershed keepsurvey randomsurvey'][57]   X_←X_ OVER MATRIFY 'watershed keepsurvey randomsurvey'[58]   X[(X[;X_ COL 'watershed']≡¨0)/⍳1↑⍴X;X_ COL 'watershed']←⊂''[59]  [60]  ⍝Select (potentially) surveyed or estimated for Scott's selected crossings[61]   X←X,((X[;X_ COL 'keepsurvey'])⌽X[;X_ COL 'aquaticest aquatic'])[;1][62]   X_←X_ OVER 'aquaticscott'[63]  [64]  ⍝And for random crossings[65]   X←X,((X[;X_ COL 'randomsurvey'])⌽X[;X_ COL 'aquaticest aquatic'])[;1][66]   X_←X_ OVER 'aquaticrandom'[67]  [68]  ⍝Add permuted crossings[69]   X←X,X[(1↑⍴X)?1↑⍴X;X_ COL 'aquatic'][70]   X_←X_ OVER 'aquaticpermute'[71]  [72]  ⍝Only keep these columns[73]   K←'id x-coord y-coord group groupsize surveyed keepsurvey randomsurvey aquaticest aquatic aquaticscott aquaticrandom aquaticpermute watershed'[74]   X_←(B←0≠(MATRIFY K) MATIOTA X_)⌿X_[75]   X←B/X[76]  [77]  ⍝Write results[78]   head←1↓⎕TCHT MTOV X_[79]   X TMATOUT T←path,'more\CL50\source\crossingsCL50x.txt'[80]  [81]   ⎕←'Table ',T,' written. Ready to run LINKAGES'    ∇