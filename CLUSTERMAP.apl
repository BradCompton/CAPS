    ∇ A CLUSTERMAP N;X;Q;J;I;R;Z;D;B;buffer;Y;V;sd;sdt;C;H;head[1]   ⍝Build cluster map for gradient post-processing (step 3)[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer)[3]   ⍝⍵ = number of clusters (not groups, as usual in metrics)[4]   ⍝Source:[5]   ⍝   post\settingsclusters<n>.txt    results from cluster.settings()[6]   ⍝   settings.par                    table of settings and weights[7]   ⍝   grids\settings\...              settings variables[8]   ⍝Paramters:[9]   ⍝   none[10]  ⍝Result:[11]  ⍝   grids\clusters<n>               cluster map of undeveloped land[12]  ⍝[13]  ⍝B. Compton, 15-16 Nov 2011 (from SIM)[14]  ⍝6-7 Feb 2012: call from CLUSTERS; passed N[15]  [16]  [17]  [18]   READPARS ME[19]   buffer←B←4⊃A[20]  [21]   C←TABLE pathE PATH 'settingsclusters',N,'.txt'[22]   H←FRDBL¨↓2 0↓',' MATRIFY head[23]   D←⍉(1,0 ¯2+⍴C)⍴0 2↓C[24]  [25]   V←X←READ 1⊃A[26]   →(0∊⍴Y←'*' INCLUDE X)/0                ⍝Which cells to run for?[27]   Q←TABLE 2⊃A[28]   Q←(Q[;1]∊H)⌿Q                          ⍝Drop excluded settings variables and send the table to SETTINGS[29]   sd sdt ← SETTINGS (Q head) '' 'dist'   ⍝Get ecological settings and tables for distance[30]  [31]   J←↓[1](⍉(⌽⍴X)⍴⍳1↑⍴X),[.5](⍴X)⍴⍳1↓⍴X    ⍝Index matrix[32]   J←(,Y)/,J[33]   X←(,Y)/,X[34]   Z←(⍴X)⍴0[35]  [36]   I←0[37]  L1:→((1↑⍴X)<I←I+1)/L2                   ⍝For each cell,[38]   ⍎((I÷1E4)=⌊I÷1E4)/'BREAKCHECK'[39]   R←,sd[;1⊃I⊃J;2⊃I⊃J] ECODIST D          ⍝   Get ecological distance for focal cell I,J to each cluster[40]   Z[I]←⌊1↑(R=⌊/R)⌿C[;1]                  ⍝   Pick closest cluster (in case of ties, earlier cluster #s win)[41]   →L1[42]  [43]  L2:Z←(⍴Y)⍴(,Y)\Z[44]   (V REMV Z) WRITEI (3⊃A),N[45]   →0[46]  [47]  what:auxiliary[48]  type:standard[49]  info:('postland') ('settings') (pathG PATH 'clusters') 0 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[50]  check:CHECKVAR ''    ∇