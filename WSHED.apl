    ∇ W WSHED M;V;G;H;L;B;D;P;inf;suminf;mininf;wsize;mstart;S;I;Q;Y;Z;QQ;part;F;pu;pd;J;T;X;wu;K;R;O[1]   ⍝Build one-time (quick) resistant FD8 watershed for metric parameters ⍵, starting at outflow ⍺[3 4][2]   ⍝Global parameters:[3]   ⍝   dem      Depressionless DEM (use FILL in Arc/Grid) ← If not depressionless, all bets are off![4]   ⍝   d8flow   D8 flow direction grid (from FLOWDIRECTION in Arc/Grid)[5]   ⍝   d8accum  D8 flow accumulation grid (from Arc)[6]   ⍝   lc       landcover[7]   ⍝   resist   aquatic resistance grid[8]   ⍝   M - metric parameters[9]   ⍝Returns Z[I;J;...]:[10]  ⍝   Z[1;;]      influence of cell[11]  ⍝   Z[2;;]     PRODUCT OF P AND R BELOW CELL⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ sum of influence above cell[12]  ⍝   Z[3;;]      minimum influence value above cell (to edge of watershed)[13]  ⍝   Z[4;;]      watershed size for cell[14]  ⍝   Z[5;;]      proportion of flow from cell that ends up in the watershed[15]  ⍝And, for each metric:[16]  ⍝   Z[mstart+2×metric;;]    sum of metric values above cell[17]  ⍝   Z[1+mstart+2×metric;;]  sum of influence × metric value above cell[18]  ⍝Reference: Wilson and Gallant (2000)[19]  ⍝B. Compton, 9-16 Dec 2009, yet another new version (from NEWFLOW, QSHED, and FLOWACCUM)[20]  [21]  ⍝Note: partial cells at the edge of the watershed are not additively independent (if that's the term)[22]  ⍝In other words, you can add 1000 to the influence grid after the fact and it's the same at starting with[23]  ⍝1000+ for the spread value....but this won't work for the partial cells--you'll need to know the cumulative[24]  ⍝proportion of each that flows into the watershed.  This may become important when I do the magic run-once[25]  ⍝from the bottom cell thing, which would require keeping a grid of joint probabilities for edge cells.[26]  ⍝Okay: this is in Z[5;;].  SO: when going from spread value of 0 to spread value of 1000 (for instance),[27]  ⍝take Z[1;;]+1000×Z[5;;].[28]  [29]  [30]  OBSOLETE.  SEE QSHED.[31]  [32]   V←1.1                      ⍝Flow concentration constant[33]   dem←(1+⌈/,dem) MVREP dem   ⍝Nodata DEM cells are higher than landscape--edges flow inwards[34]   G←(2*0,⍳7)∘.=d8flow        ⍝D8 flow directions (from Arc flow grid)[35]  [36]  ⍝Step one: calculate flow directions using FD8[37]  ⍝This is split up to keep from filling memory; it can be done in tiles[38]   H←dem-1⌽dem                ⍝Flow from focal to east[39]   H←H,[.5]dem-1⌽1⊖dem        ⍝   southeast[40]   H←H⍪dem-1⊖dem              ⍝   south[41]   H←H⍪dem-¯1⌽1⊖dem           ⍝   southwest[42]   H←H⍪dem-¯1⌽dem             ⍝   west[43]   H←H⍪dem-¯1⌽¯1⊖dem          ⍝   northwest[44]   H←H⍪dem-¯1⊖dem             ⍝   north[45]   H←H⍪dem-1⌽¯1⊖dem           ⍝   northeast[46]   L←∨⌿H=0                    ⍝   Mark flat cells--we'll use D8 for them[47]   L←L∨d8accum≥d8threshold    ⍝   Mark streams with large watersheds--we'll use D8 for these too[48]  ⍝ L[1,1↑⍴L;]←L[;1,1↓⍴L]←0   ⍝   but not borders       *** NOT SURE WHAT I'M DOING WITH BORDERS...MAY DROP THIS[49]  ⍝ H[;1,1↑⍴dem;]←H[;;1,1↓⍴dem]←0⍝   and clear borders in flow[50]   H←H÷⍉(⌽⍴H)⍴1 2*.5          ⍝   Slope is less steep at corners, because it's farther![51]   H←((0⌈H)÷cellsize)*V[52]   H←H DIV(⍴H)⍴+⌿H[53]  [54]  ⍝Step two: replace cells in perfectly flat areas and higher-order streams with D8 flows[55]   H←,H[56]   H[B]←(,G)[B←((8××/⍴dem)⍴L)/⍳×/⍴H][57]   H←(8,⍴dem)⍴H[58]  [59]  ⍝Step three: read specific source grids for metrics[60]   S←FLATTEN M[;4]            ⍝Unique source grid names[61]   I←0[62]  L1:→((⍴S)<I←I+1)/L2         ⍝For each input grid,[63]   Q←READBLOCK (⊂pathG PATH I⊃S),W[5 6 7 8]       ⍝   read it[64]   ⍎(I⊃S),'←Q'[65]   →L1[66]  [67]  ⍝Step four: work up the watershed, accumulating influence values[68]  ⍝Bookkeeping variables:[69]  ⍝   pu - pending up[70]  ⍝   pd - pending down (list of pending cells for downflow[71]  ⍝   wu - upflow waiting (list of cells that flow into watershed but aren't resolved)[72]  ⍝   D - done up, down[73]  ⍝   F - flows: inflow to focal cell, outflow from focal cell  XXX NOT USED I THINK XXX[74]  [75]  L2:D←F←(2,⍴dem)⍴0           ⍝done[up, down] and flows[in, out][76]   O←(⍴dem)⍴0[77]   wu←pd←0⌿pu←1 2⍴W[3 4]      ⍝up-waiting, down-pending and up-pending lists[78]   Z←((5+1↑⍴M),⍴dem)⍴0        ⍝Result[79]  Z[2;W[3];W[4]]←1⍝⍝STARTIJNG CELL[80]  L3:→(0∊⍴pu)/L41             ⍝Loop: if any up-pending cells,[81]   I J←pu[1;] ⋄ pu←1 0↓pu     ⍝   focal cell is first on up-pending list[82]  [83]  Z[1;I;J]←qqq              ⍝   Calculate influence value for focal cell   THIS LINE IS JUST HERE FOR TESTING; STARTING SPREAD WILL BE ZERO[84]   Z[5;I;J]←1                 ⍝   100% of outflow cell is in watershed, by definition[85]   →(0∊⍴Q←OUTFLOWS I J)/L31   ⍝   If no outflows, we're at focal cell, otherwise...[86]   T←(3 3⍴0) SCATR (2+Q-(⍴Q)⍴I J) (Z[1;;] SCATI Q)    ⍝   Influence values in neighborhood[87]   R←0 MVREP (0⍪0,(resist,0)⍪0)[1+I+¯1 0 1;1+J+¯1 0 1]⍝   Resistance of neighboring cells[88]  ⍝ R←R×(3 3⍴0) SCATR (2+Q-(⍴Q)⍴I J) 1                 ⍝   Only want this where we have inflowing[89]   R←R×3 3⍴2 1 2 1 1 1*.5                             ⍝   Correction for diagonal cells[90]   R←.5×R+R[2;2]                                      ⍝   Resistance from center of focal cell to center of neighboring cell[91]   P←1 OUTFLOWS I J           ⍝   Proportion of flow from focal cell[92]   ⍝⍎((I=3)^J=8)/'÷0'[93]  ⍝⍎(^/I J=1 5)/'HERE!'[94]       P←P×(3 3⍴0) SCATR (2+Q-(⍴Q)⍴I J) ((~O) SCATI Q)        ⍝Only count flows into watershed![95]  ⍝ Z[1;I;J]←+/,P×T-R          ⍝   Influence value for focal cell    WAS P×T-R, BUT DOESN'T TREAT RESISTANCE PROPORTIONATELY[96]  [97]   Z[1;I;J]←+/,P×T÷(R+1)*÷xxx          ⍝   Influence value for focal cell[98]   ⍝New approach: DIVIDE by resistance to the 1/nth power.  n is an arbitrary spread value, set empirically.  Minimum resistance must be 1.[99]   S←(3 3⍴0) SCATR (2+Q-(⍴Q)⍴I J) (Z[2;;] SCATI Q)    ⍝   product of P and R below cell[100] ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍎(^/,S=0)/'S←3 3⍴1'  ⍝FOR FIRST CELL[101]  Z[2;I;J]←+/,(P)×S×(R+1)*÷xxx ⍝[102]  Z[5;I;J]←+/,P×(3 3⍴0) SCATR (2+Q-(⍴Q)⍴I J) (Z[5;;] SCATI Q)    ⍝   Proportion of cell that flows into watershed[103] ⍝ Z[1;I;J]←Z[5;I;J]×+/,P×T-R⍝⍝⍝⍝Z[5;I;J]×(+/,T)-R[2;2]   ⍝⍝⍝⍝⍝I DON'T KNOW WHAT TO DO HERE !!!!!!!!!!! ******************* !!!!!!!!!!!!!!!!!!![104] L31:D[1;I;J]←1              ⍝   done with upflow for focal cell[105]  wu←↑(↓wu)~⊂I J             ⍝   drop from waiting list[106] [107] [108]  Q←INFLOWS I J              ⍝   cells that flow into focal cell[109]  →(0∊⍴Q)/L5                 ⍝   If no inflowing cells, flow down from this cell[110]  pu←pu⍪T←(^/¨(⊂D[1;;]) SCATI¨OUTFLOWS¨↓Q)⌿Q   ⍝   only done ones are pending[111]  wu←(↑(↓wu)~↓T)⍪↑((↓Q)~↓T)~↓wu  ⍝   to waiting list[112]  DISP[113]  →L3                        ⍝   next up-pending[114] [115] L41:→(0∊⍴wu)/L4                       ⍝If we haven't found partial cells yet,[116]  K←0                                ⍝At this point, clean up cells that flow partially into watershed[117] ⍝We look for entire contributing watershed of cells in wu (waiting list), and add them to eu (edge list)[118] ⍝Then we'll go back to step four, but only cells in eu will count[119] L42:→((1↑⍴wu)<K←K+1)/L43            ⍝For each upflow waiting cell,[120]  I J←wu[K;][121]  wu←wu⍪↑(↓INFLOWS I J)~↓wu          ⍝   Find inflowing cells and add them to wu[122]  →L42[123] [124] L43:O←D[1;;][125]  D[1;;]←((⍴dem)⍴1) SCATR wu 0       ⍝Mark all cells that are either done or outside of the watershed[126]       p←D[1;;]=0  ⍝TEMPORARILY MARK PARTIAL CELLS FOR TESTING[127]  O←D[1;;]^~O                        ⍝Mark cells outside of the watershed[128] [129]  pu←(^/¨(⊂D[1;;]) SCATI¨OUTFLOWS¨↓wu)⌿wu ⍝pending cells flow into done cells or out of watershed[130] DISP[131]  wu←0⌿wu[132]  →L3                                ⍝Now go back up and finish off partial cells[133] [134] [135] [136] ⍝Step five (interleaved with four): work back down the watershed, accumulating metric values[137] L4:→(0∊⍴pd)/L3      ⍝   If nothing down-pending, back to next up-pending[138]  I J←pd[1;] ⋄ pd←1 0↓pd     ⍝   Focal cell is 1st down-pending[139] [140] L5:Q←INFLOWS I J                                     ⍝Cells flowing into focal cell[141]  P←1 INFLOWS I J                                   ⍝Proportion of flow into focal cell[142] [143] ⍝ Z[2;I;J]←Z[1;I;J]++/P×Z[2;;] SCATI Q      ⍝Sum of influences above focal cell[144] ⍝ Z[3;I;J]←Z[1;I;J]⌊⌊/Z[3;;] SCATI Q      ⍝Minimum influence above focal cell[145]  Z[4;I;J]←1++/P×Z[4;;] SCATI Q             ⍝Size of focal cell's watershed[146] [147]  ⍝CALCULATE METRIC VALUES![148] [149]  D[2;I;J]←1                                        ⍝Done for downflow[150] [151]  Q←OUTFLOWS I J             ⍝   Cells that this cell flows into[152]  Q←(~O SCATI Q)⌿Q           ⍝   but not cells that flow out of the watershed![153]  →(0∊⍴Q)/L9                 ⍝   If no outflow, this is source cell and we're done   THIS IS THE ONLY WAY TO BE DONE, RIGHT?[154] ⍝⍝ ONLY WANT CELLS IN Q FOR WHICH ALL INFLOWS ARE DONE[155]  pd←pd⍪(^/¨(⊂D[2;;]) SCATI¨INFLOWS¨↓Q)⌿Q    ⍝   only want them if all of their inflows are done[156] DISP[157]   →L4[158] [159] L9:⎕←ROUND Z[1;;] ⋄ →[160] Z[1;;] WRITEBLOCK (⊂pathR PATH 'influence'),W[5 6 7 8],0 1[161] [162] DONE WITH ALL CELLS[163] [164] [165] [166] [167] [168] [169] [170] [171] [172] [173] [174] [175] [176] [177] [178] [179] [180] ---OLD STUFF TO IGNORE---[181] ⍝Step four: recurse up watershed[182] L2X:inf part suminf mininf wsize ← ⍳5 ⋄ mstart←5-1     ⍝Pointers into result[183]  Y←((1+mstart+2×1↑⍴M),⍴dem)⍴0  ⍝Intermediate results: inf, part, suminf, mininf, wsize, then 2 grids for each metric[184]  ⍝MAY WANT TO FILL Y WITH MV, BUT Y[inf;;] MUST BE 0[185]  Z←((1↑⍴M),⍴dem)⍴MV         ⍝Result[186]  D←P←(⍴dem)⍴0               ⍝Done & pending flags to catch infinite loops due to D8 flow errors[187] [188]  0 WSHED2 W[3 4]            ⍝Call recursive flow accumulation function[189]   Y[inf;;] WRITEBLOCK (⊂pathR PATH 'influence'),W[5 6 7 8],0 1[190] →0[191] [192]  Z←MVREP Z D  ⍝UNVISITED CELLS → NODATA ***[193] [194] [195]  Q←⎕EX¨S                    ⍝Clear input grids now that we're done with them[196] [197] [198] ---[199] THE FOLLOWING GOES IN WATERSHED, AND IS DONE FOR EACH CELL AND EACH METRIC[200] FOR EACH FOCAL CELL IN WATERSHED,[201]    FOR EACH METRIC,[202]       FINISH METRIC:[203]       T←(1,⍴lc)⍴0[204]       m←5 6 ⋄ T[1;;]←(Z[m[2];;]-Z[mininf;;]×Z[m[1];;]) DIV Z[suminf;;]-Z[mininf;;]×Z[wsize;;]        ⍝SCALED TO WATERSHED AREA[205]    EXT METRIC[206] NEXT FOCAL CELL    ∇