    ∇ Z←HA2;C;V;I;J;E;head;F;N;X;A;W;Q;area_km;V2;V3;V4;V5;V6;V7;V8;V9;V10;V11;V12;V13;V1;T;area_kmi;O[1]   ⍝CAPS 3.0 hydrologic alterations metric, part 2 (calculate results)[2]   ⍝Global variables (set by WATERSHED/WATERSHEDB):[3]   ⍝   flowaccum_v Watershed area, in cells (includes inflows!)[4]   ⍝   humidity_v  Sum of humidity[5]   ⍝   ppt_dec_v   Sum of December precipitation[6]   ⍝   sand_v      Sum of percent sand[7]   ⍝   impervi_v   Sum of percent impervious[8]   ⍝   damstore_v  Sum of dam storage[9]   ⍝   discharge   Sum of water discharges (omitted outside of Massachusetts)[10]  ⍝   nedinflow_v Sum of watershed area, including out-of-state inflows from 2015 NED   [11]  ⍝Reads ha\source\NEDaccum, which breaks frisking.  Whatever.  Needs to be same flowaccum values as those used to create variables![12]  ⍝Requires regression parameters from Homa et al. (2013) in caps\project\ha_betas.txt.[13]  ⍝   Header is coefficient names; 1st column is exceeedance probabilities[14]  ⍝B. Compton, 23-24 Mar 2015[15]  ⍝27 Mar 2015: drop second stage--Betsy rolled it into betas[16]  ⍝1-3 Apr 2015: adjust input variables as needed and add more test code (***)[17]  ⍝13 Apr 2015: need to use flowaccum, not size for divisor, to handle size correctly[18]  ⍝4 May 2015: match offsets to final version (in APPLYHAFLOW); drop tmax, eastness, and withdraw[19]  ⍝5 May 2015: set everything outside of watershed to 0[20]  ⍝14 May 2015: use NEDaccum instead of flowaccum. New (2015) version if NED is significantly different; was breaking inflows. Also drop compact--it sucks.[21]  ⍝19 May 2015: use nedinflow instead, and do accumulation within WATERSHED/WATERSHEDB[22]  ⍝26 May 2015: rename original development version to HA2full and delete temporary and testing code and drop intermediate results[23]  ⍝8 Jun 2015: exclude Cape & islands[24]  [25]  [26]  [27]   C←TABLE path,'project\ha_betas.txt'            ⍝Read betas (these are combined betas and gammas from Table 2 of Homa et al. (2013)[28]   E←C[;1] ⋄ C←0 1↓C                              ⍝Exceedence probabilities[29]   V←1 0↓TOLOWER ',' MATRIFY head                 ⍝Variable names[30]   W←V MATIOTA MATRIFY 'impervi damstore discharge'  ⍝Anthropogenic variables[31]  [32]   X←(1↑⍴V)⍴0                                     ⍝Vector for transformed variables[33]   area_km←size×(cellsize*2)÷1E6                  ⍝size is wateshed size in cells, area_km is in km*2[34]   area_kmi←nedinflow_v×(cellsize*2)÷1E6          ⍝area_kmi includes inflows--it's the full watershed size[35]  [36]   O←size≠MV                                      ⍝To set everything outside of watershed to zero (prevents LIMIT ERRORS later)[37]  [38]   X[1]←⊂O×(⍴size)⍴1                              ⍝Intercept[39]   X[2]←⊂O×LN area_kmi                            ⍝Watershed area, in km*2[40]   X[3]←⊂O×LN ¯66+|LONGITUDE                      ⍝Longitude at each cell.  Offset is ¯66.[41]   X[4]←⊂O×LN humidity_v÷nedinflow_v              ⍝Mean humidity[42]   X[5]←⊂O×LN ppt_dec_v÷nedinflow_v               ⍝Mean December precipitation[43]   X[6]←⊂O×LN sand_v÷nedinflow_v                  ⍝Mean percent sand[44]   X[7]←⊂O×LN 1+impervi_v÷nedinflow_v             ⍝Mean imperviousness; +1 for anthro[45]   X[8]←⊂O×LN 1+damstore_v÷area_kmi               ⍝Dam storage/km*2; +1 for anthro[46]   X[9]←⊂O×LN 1+discharge_v÷area_km               ⍝Water discharges/km*2/y (no inflow!); +1 for anthro[47]  [48]   Z←(⍴size)⍴0                                    ⍝Ecochange result[49]   I←0[50]  L2:→((⍴E)<I←I+1)/L5                             ⍝For each exceeedance probability,[51]   A←N←(⍴size)⍴0                                  ⍝   Fresh anthro and natural predictions for this exceeedance[52]  [53]   J←0[54]  L3:→((1↑⍴V)<J←J+1)/L4                           ⍝   For each variable,[55]   :if J∊W                                        ⍝      If anthropogenic variable,[56]      A←A+C[I;J]×J⊃X                              ⍝      add to anthro prediction[57]   :else                                          ⍝      Else, natural variable[58]      N←N+T←C[I;J]×J⊃X                            ⍝      add to natural prediction[59]      A←A+T                                       ⍝      and to anthro prediction[60]   :end[61]   →L3[62]  [63]  L4:Z←Z+100×(÷⍴E)×|((*A)-*N) DIV *N              ⍝   Add to percent ecochange for this exceeedance - delta over natural[64]   →L2[65]  [66]  L5:Z←MVREP Z ((capeless=MV)∨(~streams)∨size=MV) ⍝Replace missing values and only return values for streams; exclude Cape & islands    ∇