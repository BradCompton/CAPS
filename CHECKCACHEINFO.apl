    ∇ CHECKCACHEINFO M;X;cache;Y;Z;ci;A;lock;cluster;I;Q;C;D;D_;J;E;S;U;T;G[1]   ⍝Check for discrepancies between cacheinfo.txt and grid sizes in the cache; if ⍵ isn't empty, get lock and stop[2]   ⍝There's a bug somewhere that makes these wildly disagree[3]   ⍝B. Compton, 7 Nov 2017[4]   ⍝10 Nov 2017: be robust to missing directories, and log errors instead of getting locks[5]   ⍝16 Nov 2017: bugs; reconcile with directory if there's an error[6]   ⍝20 Nov 2017: work properly when some directories are empty or otherwise unexpected[7]   [8]   [9]   [10]   cluster←1                                      ⍝Always get a cluster lock![11]   GETCACHECONFIG[12]  [13]   :if 0∊⍴M                                       ⍝If called manually,[14]      INIT[15]      lock←LOCKFILE GETNAME,' cache'              ⍝   Get a lock on cacheinfo[16]   :end[17]  [18]   X←⎕LIB 2⊃cache                                 ⍝Get cache directory[19]   X←(^/X∊' 0123456789\')⌿X[20]   X←cache[2],¨FRDBL¨↓((RJUST X)[;''⍴1↓⍴X]='\')⌿X    [21]  [22]   Y←LIB¨X[23]   X←(~0∊⍴¨Y)⌿X ⋄ Y←(~0∊⍴¨Y)/Y[24]   Y←⊃,/X NINFO¨Y[25]   Z←+/C←⊃¨1↑¨FILEINFO¨Y                          ⍝File info on all grids, but not info folders[26]   ci←,0 MATIN (2⊃cache),'index\cacheinfo.txt'    ⍝Read cacheinfo[27]   Q←NOW,', ',(FRDBL GETNAME),': ',((0≠⍴M)/'(',M,') '),'cacheinfo.txt = ',(FRDBL,'CI12' ⎕FMT ci[2]),' MB; actual = ',(FRDBL,'CI12' ⎕FMT Z),' MB; ratio = ',⍕3 ROUND Z÷ci[2] ⋄ FLUSH[28]   :if G←~(T>0.99)^(T←ci[2]÷Z)<1.01[29]      Q←Q,'   ERROR!   ERROR!   ERROR!   ERROR!   ERROR!'[30]   :end[31]  [32]   ⎕←Q ⋄ FLUSH[33]   [34]  [35]   :if G            ⍝If error, do reconciling...[36]      ⎕←⎕TCNL,'Reconciling...' ⋄ FLUSH[37]      D D_ ← GETCACHEINFO[38]      ⎕←''[39]      I←(MIX ⍕¨D[;D_ COL 'cache']) MATIOTA MIX ¯1↓¨Y[40]      J←(MIX ¯1↓¨Y) MATIOTA MIX ⍕¨D[;D_ COL 'cache'][41]      ⎕←'In directory but not on disk (',(⍕+/J=0),'):'[42]      ⎕←(J=0)⌿D[43]      ⎕←'On disk but not in directory (',(⍕+/I=0),'):'[44]      ⎕←(I=0)⌿Y,[1.5]C[45]      E←((J≠0)⌿D[;D_ COL 'cache size']),C[(J≠0)/J]        ⍝directory and disk sizes[46]      ⎕←'Ratio of directory:disk = ',⍕÷/+⌿E[;2 3][47]      U←(S<0.95)∨(S←÷/E[;2 3])>1.05    [48]      ⎕←'Grids more than 5% off (',(⍕+/U),'):'[49]      ⎕←U⌿E,S[50]      FLUSH[51]      [52]      :if 1∊U[53]         STOP[54]      :end[55]   :end [56]   [57]   :if 0∊⍴M[58]      UNLOCKFILE lock                             ⍝return cacheinfo lock[59]   :else[60]      'x:\anthill\cacheinfo.log' WRITE2LOG '[',name,'.',(⍕thread),'] ',Q[61]   :end    ∇