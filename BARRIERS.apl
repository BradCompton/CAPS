    ∇ A BARRIERS S;buffer;X;R;L;N;Z;Y;traintracks;roads;dams;crossings;D;height;notracks;Q;V;min;max;C;I;score;T;M;U;F;fd;J;MIN;MAX;G;H;B;W[1]   ⍝Create terrestrial & aquatic barrier settings grids for CAPS 3.0[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer)[3]   ⍝Parameters:[4]   ⍝   traintracks     vector of scores for # of train tracks; set to tbarrier score for trains if no track data[5]   ⍝   roads           vector of scores for road classes[6]   ⍝   dambar          score as function of dam structural height (m) or barrier score[7]   ⍝   crossings       score as function of aquatic crossing score[8]   ⍝Source data:[9]   ⍝  source\[10]  ⍝   land            landcover grid[11]  ⍝   roads           road class grid[12]  ⍝   trains          train class grid[13]  ⍝   *ntracks        grid with number of train tracks (optional)[14]  ⍝   grids\dams      dams grid[15]  ⍝   streams         stream centerlines grid[16]  ⍝   flow            D8 flow grid[17]  ⍝   crossings.txt   table of crossing scores[18]  ⍝Results:[19]  ⍝   settings\raw\:[20]  ⍝       tbarriers   terrestrial barriers[21]  ⍝       txbarriers  terrestrial barriers with crossings burned in, for documentation purposes only[22]  ⍝       abarriers   aquatic barriers[23]  ⍝B. Compton, 6-7 Dec 2010[24]  ⍝3 Feb 2011: use land as include grid, since we're looking for developed cells[25]  ⍝28 Feb 2011: Move aquatic crossings to nearest centerline cell for abarriers[26]  ⍝8 Aug 2011: Widen dams and culverts to prevent diagonal bypass in AQCONNECT[27]  ⍝19 Aug 2011: Make tbarriers1l for a single lane of divided highways[28]  ⍝13 Oct 2011: don't widen dams and culverts for AQCONNECT--it now follows streamflow[29]  ⍝3 Feb 2012: allow no track count, no one-lane traffic[30]  ⍝9 Jul 2012: dams now in grids\[31]  ⍝7 May 2012: return 0, not nodata as background for abarriers[32]  ⍝22 Nov 2013: don't use LOAD--it interacts among runs![33]  ⍝31 Dec 2013: use READVEC[34]  ⍝12 and 28 Mar 2014: use 'dambar' as dams input, to allow treatment separately from DAMINT[35]  ⍝23 Oct 2014: drop 1l crap, as we're using the pairing approach in the new ROADPREP for CL-I roads[36]  ⍝28 Sep 2015: write txbarriers to support DSL documentation--it is NOT used for anything[37]  [38]  [39]  [40]   READPARS ME[41]   buffer←4⊃A[42]   X←READ 1⊃1⊃A                               ⍝Land cover[43]   R←READ 2⊃1⊃A                               ⍝Roads[44]   L←READ 3⊃1⊃A                               ⍝Railroads[45]   N←1 ⋄ →(1=⍴,traintracks)/L1                ⍝If we have multiple track counts,[46]   N←READ 4⊃1⊃A                               ⍝   Number of tracks[47]  L1:D←READ 5⊃1⊃A                             ⍝and dams[48]   S←1=READ 6⊃1⊃A                             ⍝also stream centerlines[49]   F←READ 7⊃1⊃A                               ⍝flow grid[50]   G←READVEC 'crossings.txt'                  ⍝finally, get crossings table[51]  [52]  ⍝First do terrestrial barriers[53]   Q←(~L∊0,MV,notracks)×N                     ⍝Number of tracks where there are railroads that aren't abandoned[54]   Q←(0,traintracks,¯1↑traintracks)[(0,⍳⍴traintracks←,traintracks)⍳Q]  ⍝Score from number of tracks[55]   V←(roads,0)[(⍳⍴roads)⍳R]                   ⍝Score from road class[56]   Z←Q⌈V                                      ⍝Terrestrial score is max of tracks & roads[57]  [58]  [59]  [60]  ⍝Now do a version of terrestrial barriers with terrestrial crossings burned in[61]  ⍝This is NOT used in CAPS, but is distributed as part of the DSL package[62]  ⍝It does not use bankcrossings, so original bridge cells are modified for display purposes rather than modeling[63]  ⍝Result grid is written to rawsettings\txbarriers[64]  [65]   Q←TABLE pathM PATH 'crossscores'           ⍝Get formula for terrestrial crossing scores[66]   Q←⊃(Q[;1]≡¨⊂'tbarriers')/Q[;2]             ⍝Grab formula for tbarriers[67]  [68]   H←(1⊃G)[;(2⊃G) COL 'x-coord y-coord terrestrial']          ⍝Locations and terrestrial crossing scores[69]   H[;1 2]←↑1 FINDCELL¨↓H[;1 2]               ⍝Convert locations to cells[70]   H←H[⍋H[;1 2];]                             ⍝Sort locations...[71]   B←∨/H[;1 2]≠¯1 0↓0⍪H[;1 2]                 ⍝Find duplicates in cells[72]   H←(B⌿H[;1 2]),score←B pMIN H[;3]           ⍝and take worst crossing for each cell[73]   [74]   W←Z SCATI H[;1 2]                          ⍝Barriers at crossings[75]   ⍎'U←W',REPLACESYM Q                        ⍝Modify scores based on terrestrial crossing formula (note: assume barrier scores range from 0...n, and formula is multiplicitive)[76]   U←Z SCATR (H[;1 2]) U                      ⍝Replace in grid[77]   (X REMV U) WRITE 3⊃3⊃A                     ⍝Write terrestrial barriers with bridges[78]  [79]  [80]  [81]  ⍝Then aquatic barriers[82]   T←⎕DEF 'Z←A MIN B' OVER 'Z←A⌊B'[83]   T←⎕DEF 'Z←A MAX B' OVER 'Z←A⌈B'[84]   height←0 MVREP D[85]   Y←0 MVREP (⍎dams) (D=MV)                   ⍝Dam score[86]  [87]   I←(FRDBL¨↓TOLOWER 2⊃G)⍳'x-coord' 'y-coord' 'aquatic'    ⍝Indices into crossings table[88]   C[;I[1 2]]←↑1 FINDCELL¨↓(C←1⊃G)[;I[1 2]]   ⍝Crossing locations in terms of cells[89]   C←(^/(C[;I[1 2]]>buffer)^C[;I[1 2]]≤((1↑⍴C),2)⍴(⍴X)-buffer)⌿C    ⍝Clip to extent of current block, excluding buffer[90]   →(0∊⍴C)/L9                                 ⍝Bail out if no crossings[91]  [92]   M←~S SCATI C[;I[1 2]]                      ⍝Crossings that miss centerlines[93]   N←((4×+/M),2)⍴T←(M⌿C)[;8⍴I[1 2]]+((+/M),8)⍴¯1 0 0 1 1 0 0 ¯1   ⍝Othogonal neighbors (N, E, S, W)[94]   N←((2×+/^\~((+/M),4)⍴S SCATI N)⌽(T,0),0)[;⍳2]                  ⍝Pick neighbor with stream (or 0 if no neighboring streams)[95]   C[M/⍳1↑⍴C;I[1 2]]←N                        ⍝Replace with neighboring centerline[96]   C←(C[;I[1]]≠0)⌿C                           ⍝Drop crossings with no centerlines (I think these are bogus edge crossings)[97]  [98]   C←C[⍋C[;I[1 2]];]                          ⍝Sort crossings[99]   Q←∨/C[;I[1 2]]≠¯1 0↓0⍪C[;I[1 2]]           ⍝And find multiple crossings in the same cell[100]  C←(Q⌿C[;I[1 2]]),Q pMIN C[;I[3]]           ⍝Take worst-case of multiple crossings[101]  score←C[;3][102]  C←C,⍎crossings                             ⍝Crossings score[103]  Q←(⍴Y)⍴0[104]  Q←Q SCATR (C[;1 2]) (C[;4])                ⍝Culvert into matrix[105]  Y←Y⌈Q                                      ⍝Aquatic score is worst-case of dams and culverts[106] [107] L9:(X REMV Z) WRITE 1⊃3⊃A                   ⍝Write terrestrial barriers[108]  (X REMV Y) WRITE 2⊃3⊃A                     ⍝and aquatic barriers[109]  →0[110] [111] [112] what:data prep[113] type:standard[114] info:((⊂'land'),(((⊂pathS),¨'roads' 'trains' '*ntracks'),(⊂pathG,'dambar'),(⊂pathS),¨'streams' 'flow')) ('') ((⊂pathU),¨'tbarriers' 'abarriers' 'txbarriers') (1) ('land')    ⍝Source grid, settings, result grid, buffer size, and include grid[115] check:CHECKVAR 'traintracks notracks roads dams crossings'[116] check:pathT CHECKFILE 'crossings.txt'    ∇