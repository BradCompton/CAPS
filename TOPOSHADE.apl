    ∇ Z←X TOPOSHADE A;W;R;P;I;J;E;H;Y[1]   ⍝Calculate topographic shading for each cell in DEM 1⊃⍺ where 1=2⊃⍺ when sun is at azimuth & elevation ⍵[2]   ⍝Returns a grid for each solar position, with 1 for shading[3]   ⍝Globals:[4]   ⍝   interval    Sensitivity vs. speed.  How many sample points per cell?[5]   ⍝   sunwindow   How far can shadows reach?  Determine this with dem SUNWINDOW SUNDIR earliest-time[6]   ⍝               sunwindow determines the buffer size when running in tiles[7]   ⍝Example run:[8]   ⍝   dem TOPOSHADE SUNDIR 14 15 16.5    ⍝Shading today at 2, 3, and 4:30 pm[9]   ⍝B. Compton, 27 Feb 2008 and 6 Mar 2008[10]  ⍝1 Apr 2011: pay attention to include grid (several inches in April Fool's Nor'easter!)[11]  [12]  [13]  [14]   ⍎(0=⎕NC'interval')/'interval←3'        ⍝Default interval is 3/cell[15]   X Y ← X[16]   W←buffer×cellsize                      ⍝Window size (m): maximum distance highest mountain could shade a point[17]   P←CELLSIZE÷interval                    ⍝Point interval along rays[18]   R←2 1 3⍉(P×⍳⌈W÷P)∘.×⍉1 2∘.○RAD A[;1]   ⍝Points along azimuth rays (ray×interval×x,y)[19]   H←⍉(P×⍳⌈W÷P)∘.×⍉1○RAD A[;2]            ⍝Elevations along azimuth rays (ray×interval) (ignore curvature of the earth!)[20]  [21]  [22]   Z←((1↑⍴A),⍴X)⍴MV[23]   I←buffer[24]  L1:→(((1↑⍴X)-buffer)<I←I+1)/0           ⍝For each row,[25]   BREAKCHECK[26]   →(~∨/Y[I;])/L1                         ⍝   If empty row, skip it[27]   J←buffer[28]  L2:→(((1↓⍴X)-buffer)<J←J+1)/L1          ⍝   For each column,[29]   →((~Y[I;J])∨X[I;J]=MV)/L2              ⍝      If we're doing this cell,[30]   E←(2↑⍴R)⍴X BILINEAR ((×/2↑⍴R),2)⍴R+(⍴R)⍴FINDPOINT I,J      ⍝Elevations at sample points along rays[31]   Z[;I;J]←∨/E>X[I;J]+H[32]   →L2    ∇