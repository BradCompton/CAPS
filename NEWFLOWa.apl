    ∇ Z←O NEWFLOWa E;F;V;M;H;D;L;I;G;P;A[1]   ⍝Calculate flow accumulation for DEM, D8 flow direction, and D8 flow accumulation ⍵ using FD8 (multiple flow path) algorithm, starting at outflow ⍺[2]   ⍝Parameters:[3]   ⍝   Depressionless DEM (use FILL in Arc/Grid) ← If not depressionless, all bets are off![4]   ⍝   D8 flow direction grid (from FLOWDIRECTION in Arc/Grid)[5]   ⍝Reference: Wilson and Gallant (2000)[6]   ⍝Possible extension: use D8 (or mix with FD8 with accumulation gets higher (i.e., in stream channels)[7]   ⍝B. Compton, 24 Sep-28 Oct 2009 (from FLOWACCUM in TOPO, 7-13 Mar 2008)[8]   [9]   [10]   E F A ← E[11]   V←1.1                   ⍝Flow concentration constant[12]   E←(1+⌈/,E) MVREP E      ⍝Nodata DEM cells are higher than landscape--edges flow inwards[13]   G←(2*0,⍳7)∘.=F          ⍝D8 flow directions (from Arc flow grid)[14]  [15]  ⍝Step one: calculate flow directions using FD8[16]  ⍝This is split up to keep from filling memory; it can be done in tiles[17]   H←E-1⌽E                 ⍝Flow from focal to east[18]   H←H,[.5]E-1⌽1⊖E         ⍝   southeast[19]   H←H⍪E-1⊖E               ⍝   south[20]   H←H⍪E-¯1⌽1⊖E            ⍝   southwest[21]   H←H⍪E-¯1⌽E              ⍝   west[22]   H←H⍪E-¯1⌽¯1⊖E           ⍝   northwest[23]   H←H⍪E-¯1⊖E              ⍝   north[24]   H←H⍪E-1⌽¯1⊖E            ⍝   northeast[25]   L←∨⌿H=0                 ⍝   Mark flat cells--we'll use D8 for them[26]   L←L∨0⍪0,((A≥d8threshold),0)⍪0    ⍝   Mark streams with large watersheds--we'll use D8 for these too[27]   L[1,1↑⍴L;]←L[;1,1↓⍴L]←0 ⍝   but not borders[28]   H[;1,1↑⍴E;]←H[;;1,1↓⍴E]←0⍝   and clear borders in flow[29]   H←H÷⍉(⌽⍴H)⍴1 2*.5       ⍝   Slope is less steep at corners, because it's farther![30]   H←((0⌈H)÷cellsize)*V[31]   H←H DIV(⍴H)⍴+⌿H[32]  [33]  ⍝Step two: replace cells in perfectly flat areas and higher-order streams with D8 flows[34]   H←,H[35]   H[I]←(,G)[I←((8××/⍴E)⍴L)/⍳×/⍴H][36]   H←(8,⍴E)⍴H[37]  [38]  ⍝Step three: rotate flow grids to represent flow into each focal cell[39]   H[1;;]←¯1⌽H[1;;]       ⍝Flow from west to focal[40]   H[2;;]←¯1⊖¯1⌽H[2;;]    ⍝   northwest[41]   H[3;;]←¯1⊖H[3;;]       ⍝   north[42]   H[4;;]←¯1⊖1⌽H[4;;]     ⍝   northeast[43]   H[5;;]←1⌽H[5;;]        ⍝   east[44]   H[6;;]←1⊖1⌽H[6;;]      ⍝   southeast[45]   H[7;;]←1⊖H[7;;]        ⍝   south[46]   H[8;;]←1⊖¯1⌽H[8;;]     ⍝   southwest[47]  [48]  ⍝Step four: calculate flow accumulation[49]   Z←(⍴E)⍴1               ⍝Result (with borders)[50]   D←P←(⍴E)⍴0             ⍝Done & pending flags to catch infinite loops due to D8 flow errors[51]   FLOW O+1               ⍝Call recursive flow accumulation function[52]   Z←MVREP Z (~D)         ⍝UNVISITED CELLS → NODATA[53]   Z←1 1↓¯1 ¯1↓Z    ∇