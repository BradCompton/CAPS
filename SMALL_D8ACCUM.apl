    ∇ Z←W SMALL_D8ACCUM X;Q;I;C[1]   ⍝Do D8 flow accumulation for flow grid ⍵ and optional weight grid ⍺[2]   ⍝Test for FLOWLOOPS[3]   ⍝15 Jul 2010[4]   ⍝11 Dec 2013: renamed from D8ACCUM to make way for new tiled version[5]   ⍝5 Jan 2015: allow MVs in flow and add optional weight grid[6]   [7]   [8]    [9]    ⍎(0=⎕NC'W')/'W←(⍴X)⍴1'[10]   X←0 MVREP X[11]  [12]   Q←(⍴X)⍴0                                       ⍝Mark cells that flow out of edges[13]   Q[1;]←X[1;]∊32 64 128[14]   Q[1↑⍴Q;]←X[1↑⍴X;]∊8 4 2[15]   Q[;1]←Q[;1]∨X[;1]∊32 16 8[16]   Q[;1↓⍴Q]←Q[;1↓⍴Q]∨X[;1↓⍴X]∊128 1 2[17]  [18]   Q←Q∨(¯1⊖X=0)^X=64                              ⍝Mark cells that flow into 0/missing cells                           [19]   Q←Q∨(1⌽X=0)^X=1                                [20]   Q←Q∨(1⊖X=0)^X=4                                [21]   Q←Q∨(¯1⌽X=0)^X=16                                [22]  [23]   Q←Q∨(1⌽¯1⊖X=0)^X=128[24]   Q←Q∨(1⌽1⊖X=0)^X=2[25]   Q←Q∨(¯1⌽1⊖X=0)^X=8[26]   Q←Q∨(¯1⌽¯1⊖X=0)^X=32                           [27]  [28]   Q←((,Q)/,⍉(⌽⍴Q)⍴⍳1↑⍴Q),[1.5](,Q)/,(⍴Q)⍴⍳1↓⍴Q   ⍝Indices into target cells[29]   Z←(⍴X)⍴MV[30]   X←0,(0⍪X⍪0),0[31]   Q←Q+1[32]   I←0[33]  L1:→((1↑⍴Q)<I←I+1)/0                            ⍝For each target cell,[34]   SMALL_D8ACCUM2¨↓Q[I;][35]   →L1    ∇