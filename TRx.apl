    ∇ Z←A TRx Y;X;V;weights;E;R;S;F;c;B;q;dams;I[1]   ⍝CAPS tidal restriction metric for landcover and other grids ⍵[2]   ⍝⍺ = (input grids) (settings) (outflow cell) (block parameters)[3]   ⍝Prepare data with maketides.aml and OTHER STUFF[4]   ⍝Global: tr, trx[5]   ⍝B. Compton, 8, 12 Apr 2010[6]   ⍝Changes, 7 May 2010[7]   ⍝7 Jul 2010: Start with a result grid full of zeros (must be created in arc before running)[8]   ⍝24 Jan 2011: changes to make it work with CAPS 3.0[9]   ⍝7 Feb 2011: Calculate unrestricted tides here, to avoid rounding errors from Arc-generated TIDES setting[10]  [11]  NO NO NO[12]  [13]   X E R S ← Y[14]   READPARS ME[15]   dams←LOOK 'dam'[16]   q←(⍴X)⍴MV[17]   →(^/,X∊1,MV)/0                                                             ⍝If any tidally-influenced cells,[18]   I←↑(FINDCELL¨↓trx⌿tr[;⍳2])-⊂window[1 2]-1[19]   c←((⍴X)⍴0) SCATR I (trx/tr[;3])                                            ⍝   create TR grid for this watershed[20]  [21]   X←1-÷1+*-(lrpars[1]×B/,0 MVREP E)+(lrpars[2]×B/,R)+lrpars[3]×(B←,R≠MV)/,S  ⍝   Tides, unrestricted[22]   X←MVREP ((⍴R)⍴B\X) (R=MV)[23]  [24]   0 TRr 3⊃A                                                                  ⍝   Follow watershed up, taking max restriction along the way[25]   R←MVREP (0⌈R-q) ((X=MV)∨(E=MV)∨q=MV)                                    ⍝   Subtract restriction from tidal range[26]   Z←1-÷1+*-(lrpars[1]×B/,E)+(lrpars[2]×B/,R)+lrpars[3]×(B←,R≠MV)/,S          ⍝   Logistic regression to tidal regime setting   1-LR b/c TIDES is backwards[27]   Z←MVREP ((⍴R)⍴B\Z) (R=MV)                                                       ⍝   Expand and replace missing values[28]   Z←MVREP (X-Z) (Z=MV)                                                            ⍝   Difference from tides setting variable is tidal restriction metric    ∇