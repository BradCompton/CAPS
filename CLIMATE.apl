    ∇ A CLIMATE S;buffer;X;Y;C;settingscentroids;sd;sdt;Z;G;C_;I;B;W;Q;D;ss;T;resultscale;climate0scale;L[1]   ⍝CAPS Climate Stress metric[2]   ⍝Global variables:[3]   ⍝   timestep    timestep of run - do prep if timestep = 0[4]   ⍝   settings    table of settings variables[5]   ⍝   groups      name of file listing groups to use (default = '': use all landcover types)[6]   ⍝Parameters:[7]   ⍝   settingscentroids = 'settingsmeans.txt'	    Name of table with settings centroids (created by SETTINGSMEANS)[8]   ⍝   climate0scale = 100                         value to multiply climate0 by before rounding[9]   ⍝   resultscale = 1000                          value to multiply result by before rounding[10]  ⍝B. Compton, 2-16 Aug 2013[11]  ⍝27 Aug 2013: add groups option (Entergy announces they will shut down Vermont Yankee!)[12]  [13]  [14]  [15]  OBSOLETE[16]  [17]   READPARS ME[18]   buffer←0[19]   X←READ 1⊃A[20]   →(0∊⍴Y←S INCLUDE X)/0                    ⍝Which cells to run for?[21]   :if 0≠⍴groups                                  ⍝If groups is supplied,[22]      L←TABLE pathI PATH groups                   ⍝   Read groups file[23]      L←(⍳1↑⍴L),L                                 ⍝   and assign pseudo-landcover classes to groups for internal use[24]      Q←LOOK¨L[;2]                                ⍝   remap landcover classes to group #s[25]      Q←(⊃,/Q),[1.5](⊃,/⍴¨Q)/L[;1][26]      X←(Q[;2],MV)[Q[;1]⍳X]                       ⍝   communities not in any groups go to missing[27]   :end[28]  [29]   sd sdt ← SETTINGS (2⊃A) '' 'climate'       ⍝Get ecological settings and tables for climate[30]   C←TABLE settingscentroids                  ⍝Read centroids of settings variables for each community[31]   C_←FRDBL¨↓',' MATRIFY head[32]   :if 0≠⍴groups                              ⍝If running with groups,[33]      C[;1]←L[;1]                             ⍝   use group #s[34]      D←⍳0[35]   :else                                      ⍝Else,[36]      C[;1]←(LOOKUP (⍳1↑⍴C),C[;,1])[;1]       ⍝   look up settings centroids cover types in landcover[37]      C←(~C[;1]∊D←(0 'groups.par' LOOKUP 1 2⍴0,'developed')[;1],⊃,/LOOK¨FRDBL¨↓','MATRIFY exclude)⌿C[38]   :end[39]   C_←(B←1,1↓(C_∊sdt[;1]))/C_[40]   C←B/C                                      ⍝Centroids: keep only natrual communities and climate settings[41]  [42]   ss←MATIN pathT PATH scales                 ⍝Now rescale centroids from 0 to 1.  Get original settings variable scales[43]   ss←ss[(TOLOWER¨ss[;1])⍳1↓C_;]              ⍝Reorder settings scales to match centroids[44]   C[;1↓⍳1↓⍴C]←((0 1↓C)-T⍴ss[;2])÷(T←(1↑⍴C),¯1+1↓⍴ss)⍴-/ss[;3 2]    ⍝Rescale 0 to 1 to match results from SETTINGS[45]  [46]   W←sdt[(1↓C_)⍳sdt[;1];3]                    ⍝Settings weights corresponding to columns of C[47]   sd←((1↑⍴sd),×/1↓⍴sd)⍴sd                    ⍝Reshape settings variables to ravel across landcover[48]   Z←(⍴X)⍴0[49]  [50]   I←0[51]  L1:→((1↑⍴C)<I←I+1)/L2                       ⍝For each community,[52]   →(~∨/B←,X=C[I;1])/L1                       ⍝   Cells in this community - if there are none, skip ahead[53]   Q←,(1↓C[I;]) EUDIST ((1↑⍴sd),(+/B),1)⍴B/sd ⍝   Euclidean distance from centroids[54]   Z←Z+(⍴Z)⍴B\Q[55]   →L1[56]  [57]  L2:[58]   :if timestep=0                             ⍝If timestep = 0, set up for later timesteps[59]      (MVREP (⌊.5+Z×climate0scale) (X∊MV,D)) WRITEI GRIDNAME pathG PATH 'climate0'    ⍝   write base climate info[60]      Z←(⍴X)⍴0                                ⍝   return all zeros for current timestep[61]   :else                                      ⍝Else, run for future timestep[62]      G←READ GRIDNAME pathG PATH 'climate0'   ⍝   read base climate distance[63]      Z←0⌈Z-G÷climate0scale                   ⍝   result is climate<current> - climate<base>, only positive cells[64]  ⍝    (MVREP (1000×Z-G) (X∊MV,D)) WRITE 'X:\TEMP\CLIMATEDEL' ⍝JUST FOR TESTING[65]   :end[66]  [67]   (MVREP (⌊.5+Z×resultscale) (X∊MV,D)) WRITEI 3⊃A               ⍝Write result grid[68]   →0[69]  [70]  what:CAPS stressor[71]  type:standard[72]  info:('land') ('settings') ('climate') 0 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[73]  check:CHECKVAR 'settingscentroids climate0scale resultscale'[74]  check:CHECKFILE settingscentroids[75]  check:CHECKFILE pathT PATH scales    ∇