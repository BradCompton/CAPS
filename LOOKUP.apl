    ∇ Z←W LOOKUP X;N;Q;I;T;M;E;C;R;S;B;Z2[1]   ⍝Look up cover types in ⍵[;2] in community table, return grid codes, ⍵[;1][2]   ⍝If ⍺[1], call WARN with missing types[3]   ⍝⍺[2] identifies synonyms file; default is 'synonyms.par'[4]   ⍝Return global lookedup, with code, class[5]   ⍝6 Oct 2008: change in behavior: allow looking up all cover types, not just developed[6]   ⍝25 Feb 2009: Use new landcover file and synonyms file[7]   ⍝14 Apr 2010: Don't expand existing communities as synonyms--has implications for lumping[8]   ⍝16 Sep 2011: If communities are already in list and also come in as synonyms, drop synonym version[9]   ⍝4 Jan 2012: give error when multiple instances of the same community occur with different weights; remove[10]  ⍝   duplicates if weights don't differ; 19 Jan 2012: oops--it has to work for text values too[11]  ⍝6 Feb 2012: Sep 16 bug fix broke finding missing communities. Leave them in and let dup checking find them.[12]  ⍝25 Feb 2014: drop excess columns in ⍵; format error right[13]  ⍝12 Jul 2016: return global lookedup[14]  [15]  [16]  [17]   ⍎(0=⎕NC'W')/'W←0'[18]   W←2↑W,⊂synonymspar[19]   Z←0 2⍴0[20]   →((0∊⍴X)∨X≡1 1⍴MV)/0       ⍝If TABLE is null or it read an empty file, we're out of here[21]   E←' '[22]   R←'Ill-formed table'[23]   →(2≠⍴⍴X)/L5[24]   →((⍴X)[2]<2)/L5[25]   →(~' '=1↑0⍴⊃X[1;2])/L5[26]  [27]   X←X[;⍳2]                                     ⍝Drop excess columns[28]   C←landcover[29]   M←TOUPPER MIX C[;2][30]   B←0=M MATIOTA TOUPPER MIX X[;2]              ⍝If it's in community table, don't expand as synonym![31]   X←((~B)⌿X)⍪(B⌿X) SYNONYMS pathI PATH 2⊃W     ⍝Read & apply synonyms file[32]   E←''[33]   I←0[34]  L1:→((1↑⍴X)<I←I+1)/L3       ⍝For each row,[35]    T←((T⍳T)=⍳⍴T)/T←((TOUPPER ⊃X[I;2]) MATIOTA M)/C[;1][36]   Z←Z⍪T,[1.5]X[I;1][37]   →(~0∊⍴T)/L1[38]   E←E,X[I;2][39]   →L1[40]  [41]  L3:→(0∊⍴E)/L6[42]   R←'Community types not in landcover.par:'[43]   S←'LOOKUP: Missing community type'[44]   →L5[45]  [46]  L6:Z2←Z[;,1],X[;2]          ⍝Make table of code, class[47]   Z2←Z2[⍋Z2[;1];][48]  [49]   Z←Z[⍋Z[;1];][50]   B←Z[;1]≠0,¯1↓Z[;1]         ⍝Find duplicate community classes[51]   Q←(~(B pMIN Q)=B pMAX Q←Z[;2]⍳Z[;2])/B/Z[;1]   ⍝   these have differing values = error[52]   Z←B⌿Z                      ⍝drop duplicates[53]   lookedup←B⌿Z2[54]  [55]   →(0∊⍴Q)/0[56]   R←'Multiple instances of a community with different weights (thanks to synonyms?):'[57]   S←'LOOKUP: Multiple instances of a community with different weights (thanks to synonyms?)'[58]   E←C[C[;1]⍳Q;2][59]  [60]  L5:→W[1]/L4                 ⍝If normal mode, report errors[61]   C←ifchat ⋄ ifchat←1[62]   LOG '*** ERROR: ',R[63]   LOG MTOV ' ',' ',' ', (⎕PW-3) TELPRINT MIX E[64]   LOG ''[65]   ifchat←C[66]   ⎕ERROR S[67]   →0[68]  L4:R WARN MIX E             ⍝Else, in warn mode    ∇