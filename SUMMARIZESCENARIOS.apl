    ∇ A SUMMARIZESCENARIOS S;N;H;I;Z;M;X;U;landcover;Q;G;B;head;blocksize;includemetrics;compare;change;scenarios;gradient;postland;model;source;results;resultpath;landtypes;checkland;mixmetrics;alt;friskonly;threshold;usegroups;Y;E;transpose;V;D;C;P;R;summary;T;scenarios_;pathTables[1]   ⍝Build aspatial summaries of scenario deltas[2]   ⍝Source (in model\):[3]   ⍝   deltatables.sf          written by SCENARIODELTAS[4]   ⍝   mapcolors.par           gives higher-level groups of communities (also used by CAPSMAPS)[5]   ⍝   post\community-count.csv community count table (written by BENCH)[6]   ⍝Results (in deltas\):[7]   ⍝   impact.csv              impact (IEI×∆IEI) by community[8]   ⍝   impact-grouped.csv      impact (IEI×∆IEI) by group (if usegroups supplied) - this summarizes across scenarios, so only useful if doing reps of the same thing![9]   ⍝   deltaIEI.csv            ∆IEI by community[10]  ⍝   deltaIEI-grouped.csv    ∆IEI by by group (if usegroups supplied)[11]  ⍝   delta-metrics.csv       ∆metrics (these are indirect change only!)[12]  ⍝   impact summary table.txt, impact summary table (grouped).txt[13]  ⍝                           impact summary tables for LCC.  Paste into Word, convert to table, change # to ^l, and format[14]  ⍝B. Compton, 18 Feb 2012 (some from CAPSMAPS)[15]  ⍝11 Apr 2012: .csv files go to post\[16]  ⍝28 Sep 2012: drop groups that never occur in landscape[17]  ⍝7 Oct 2012: write impact summary tables for LCC; 10 Oct 2012: all in ha, look for community-count in the right place[18]  ⍝25 Apr 2013: use new version of PATIENTTIE, which uses lock server instead of APL file locking[19]  ⍝27 Jun 2013: use synonyms.par to fill out groups[20]  ⍝2 Jul 2013: spectacular: I was reading the last record of deltatables.sf over and over[21]  ⍝8 May 2017: get path for tables from parameters file[22]  [23]  [24]  [25]   READPARS 'scenarios'[26]  [27]   scenarios←1 TABLE scenarios                        ⍝Read scenarios file[28]   scenarios_←(',',⎕TCHT) MATRIFY '.".' TEXTREPL head ⍝and get header[29]   scenarios←((⍴scenarios)⌈0,1↑⍴scenarios_)↑scenarios,⊂''[30]   pathTables←FRDBL ⊃scenarios[1;scenarios_ COL 'deltas']     ⍝Get path for table results, if supplied[31]   MAKEDIR pathTables←pathE PATH pathTables[32]   [33]  [34]   N←PATIENTTIE Q←pathI,'deltatables.sf'[35]   H←⎕FREAD N,1                               ⍝Read headers[36]   Z←⎕FREAD N,2                               ⍝And first record[37]   M←(⎕FSIZE N)[2]-1                          ⍝Number of records[38]   I←2[39]  L1:→(M<I←I+1)/L2                            ⍝For each record,[40]   Z←Z+⎕FREAD N,I[41]   →L1[42]  [43]  L2:⎕FUNTIE N[44]   RETURNLOCK Q[45]   landcover←¯1 TABLE landcoverpar[46]   E←'scenario' 'community'[1+V←transpose][47]  [48]   C←TABLE pathE,'community-count.csv'        ⍝Read community count table (written by BENCH)[49]  [50]   →(0∊⍴usegroups)/L3                         ⍝If using groups,[51]   X←1 0 TABLE pathI PATH usegroups[52]   X[;1]←FRDBL¨↓LJUST (⍴T)↑(+/^\'('≠T)⌽((⍴T)⍴' '),T←MIX X[;1]   ⍝   Drop stuff in parentheses in groups[53]   X[;1]←X[⌈\Q\(Q←~X[;1]≡¨⊂'')/⍳1↑⍴X;1]       ⍝   Fill in first column[54]   X←(0≠⊃,/⍴¨X[;2])⌿X                         ⍝   drop empty rows[55]   T←((⍳1↑⍴X),X[;,2]) SYNONYMS pathI PATH synonymspar[56]   X←X[T[;1];1],T[;,2]                        ⍝   use synonyms.par to fill out groups[57]   D←X[X[;2]⍳C[;1];1],C[;,2]                  ⍝   grouped version of community counts[58]   U←((X[;1]⍳X[;1])=⍳1↑⍴X)/X[;1]              ⍝   Unique groups[59]   X[;1]←U⍳X[;1]                              ⍝   Group # (in order)[60]   Q←LOOKUP X[61]   G←Q[Q[;1]⍳2⊃H;2]                           ⍝   Community group headers[62]   U←((⍳⍴U)∊G)⌿U                              ⍝   Drop groups that never occur in landscape[63]   Y←Z[;⍋G;]                                  ⍝   Sort by community/group[64]   G←G[⍋G][65]   B←G≠0,¯1↓G[66]  [67]  ⍝Write 2 grouped tables[68]   head←'"Impact (IEI x delta IEI) for scenarios"'[69]   (V TRANSPOSE (E,↓1⊃H),(U,⊂'Total')⍪ROUND (⍉B pSUM ⍉Y[;;2]),+/Y[;;2]) CMATOUT pathTables,'impact-grouped.csv'[70]  [71]   head←'"Delta IEI for scenarios"'[72]   (V TRANSPOSE (E,↓1⊃H),(U,⊂'Total')⍪ROUND (⍉B pSUM ⍉Y[;;1]),+/Y[;;1]) CMATOUT pathTables,'deltaIEI-grouped.csv'[73]  [74]  [75]  ⍝Write grouped impact summary table (for LCC)[76]   →(~summary)/L3[77]   Y←⍉B pSUM ⍉Y[;;2][78]   D←(U⍳D[;1]),D                              ⍝Index into community group[79]   D←D[⍋D[;1];][80]   B←D[;1]≠0,¯1↓D[;1][81]   D←(B⌿D[;1 2]),B pSUM D[;3]                 ⍝Summed ha for each group that exists on landscape[82]   T←(~(⍳⍴U)∊D[;1])/⍳⍴U                       ⍝Fill in groups not in landscape (to be dropped later, sigh)[83]   D←D⍪T,U[T],[1.5]0[84]  [85]   D←D[⍋D[;1];2 3][86]   Q←IMPACTSUMMARY D U Y (4⊃H) 1 cellsize[87]   Q TMATOUT pathTables,'impact summary table (grouped).txt'[88]  [89]  [90]  L3:U←landcover[landcover[;1]⍳2⊃H;2]         ⍝In any case, do it by community too[91]   G←2⊃H[92]   Y←Z[;⍋G;]                                  ⍝Sort by community/group[93]   G←G[⍋G][94]   B←G≠0,¯1↓G[95]  [96]   →(~summary)/L5[97]   Q←IMPACTSUMMARY C U (Y[;;2]) (4⊃H) 0 cellsize  ⍝Write impact summary table (for LCC)[98]   Q TMATOUT pathTables,'impact summary table.txt'[99]  [100] [101] ⍝Write 2 by-community tables, and delta metrics table[102] L5:head←'"Impact (IEI x delta IEI) for scenarios"'[103]  (V TRANSPOSE (E,↓1⊃H),(U,⊂'Total')⍪2 ROUND (⍉B pSUM ⍉Y[;;2]),+/Y[;;2]) CMATOUT pathTables,'impact.csv'[104] [105]  head←'"Delta IEI for scenarios"'[106]  (V TRANSPOSE (E,↓1⊃H),(U,⊂'Total')⍪2 ROUND (⍉B pSUM ⍉Y[;;1]),+/Y[;;1]) CMATOUT pathTables,'deltaIEI.csv'[107] [108]  head←'"Delta metrics for scenarios"'[109]  (((⊂'scenario'),↓1⊃H),(2↓3⊃H)⍪2 ROUND +/[2]0 0 2↓Y) CMATOUT pathTables,'delta-metrics.csv'[110] [111]  LOG 'SCENARIOS is done.'[112]  →0[113] [114] what:auxiliary[115] type:standard[116] info:('') ('') ('') (0) ''      ⍝Source grid, settings table, result grid, buffer size, and include grid    ∇