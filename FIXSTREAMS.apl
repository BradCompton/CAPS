    ∇ A FIXSTREAMS S;D50;DS;weights;X;F;B;Z;I;J;fd;K;L;C;O;head;Q;U;iteration[1]   ⍝Fix broken streams grid--there are breaks at Jo's watershed tiles, and places where streams[2]   ⍝don't make it to the edge of a watershed. Here, we extend the streams grid to nodata in flow,[3]   ⍝XXXXXXXXXXXXstopping if we hit uplandsXXXXXXXXXXXX.[4]   ⍝Parameters:[5]   ⍝   iteration               iteration number. Start with 1, increment each time until changedstreams<iteration>.tab is empty[6]   ⍝Results:[7]   ⍝   newstreams<iteration>   grid with updated stream centerlines[8]   ⍝Note: this must be run iteratively until changedstreams.tab is empty - update parameter iteration each time[9]   ⍝B. Compton, 10 Aug 2017[10]  ⍝11 Dec 2017: complete rewrite because the old version was fairly useless[11]  [12]  [13]  [14]   READPARS ME[15]   X←READ 1⊃1⊃A                   ⍝Read landcover (streams on top of roads)[16]   F←READ 2⊃1⊃A                   ⍝and flow grid[17]   Z←C←READ 3⊃1⊃A                 ⍝and stream centerlines[18]  ⍝ U←(X=MV)∨~(C=1)∨X∊⊃,/LOOK¨'Open water' 'Estuarine Intertidal' 'Marine Intertidal' 'Roads' 'Trains' 'Dam' 'Culvert/bridge'  ⍝1's mark nodata or other than open water, roads, railroads, dams, or culverts[19]   U←X=MV ⍝1's mark nodata [20]  [21]   fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1 [22]   [23]   O←INDICES (C=1)^0=F UPFLOW C=1 ⍝Indices of stream origins (also includes cells after erroneous breaks)[24]   I←0[25]  L1:→((1↑⍴O)<I←I+1)/L4           ⍝For each stream origin,[26]   DOT[27]   K←O[I;][28]  L2:K←,F NEXTFLOW K              ⍝   Flow downstream from origin[29]   →(0∊K)/L1                      ⍝      until we reach the edge of the grid or...[30]   →(U[K[1];K[2]])/L1             ⍝      ...or nodata or uplands[31]   Z[K[1];K[2]]←1                 ⍝      set this cell to a stream centerline[32]   →L2[33]  [34]  [35]  L4:Q←↑1 FINDPOINT¨↓INDICES Z≠C  ⍝Points where we've changed streams[36]   Q LOCKWRITE pathG,'fixedstreams',(⍕iteration),'.tab'[37]   Z WRITEI 3⊃A[38]   →0[39]  [40]  [41]  what:auxillary[42]  type:standard[43]  init:head←1↓⎕TCHT MTOV MATRIFY 'x y' ⋄ (0 0⍴'') TMATOUT pathG,'fixedstreams',(⍕iteration),'.tab'[44]  info:('lands' 'flow' ((1+iteration≠1)⊃'streams' ('fixstreams',⍕iteration-1))) ('') (pathG PATH 'fixstreams',⍕iteration) (1) ''      ⍝Source grid, settings table, result grid, buffer size, and include grid[45]  check:CHECKVAR 'iteration'    ∇