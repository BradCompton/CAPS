    ∇ A TRB_DSL S;I;M;J;X;lc;result;d8flow;transparent;buffer;head;ocean;cross;Y;sm;psm;saltmarsh;tr;asm;apsm;O;cutoff;d8accum;excluded;keepresults;result2;Q[1]   ⍝Block version of CAPS tidal restriction metric - DSL version for whole northeast[2]   ⍝We don't trust DSL dams, so ignore them[3]   ⍝⍺ and ⍵ = usual metric arguments[4]   ⍝   targets         Table for tidal restriction watersheds[5]   ⍝   saltmarsh       Class for salt marshes[6]   ⍝   excluded        Systems to exclude: everything wetter than salt marsh (open water, etc.)[7]   ⍝   keepresults     Systems to keep results for; those in model + developed and grasslands[8]   ⍝   cutoff          Flowaccum cutoff for bridges too big to be a TR[9]   ⍝   buffer              buffer (km), as in [watershedb][10]  ⍝RUN AT THE SAME TIME AS TR_DSL![11]  ⍝B. Compton, 2-13 Sep 2016, from TRB[12]  ⍝23 Sep 2016: exclude not just open water but anything wetter; only give results for systems that will include them in model[13]  ⍝3 Oct 2016: write regular CAPS raw metric results, and trkeep, with 1's for keepresults and trmask, MVs elsewhere[14]  ⍝7 Oct 2016: get it right[15]  ⍝12 Oct 2016: bail on edges so we don't get partial watersheds in results[16]  [17]  [18]  [19]   READPARS ME[20]   buffer←4⊃A[21]  [22]   X←READ 1⊃1⊃A                                   ⍝Tides[23]   →(^/,X∊0,MV)/0                                 ⍝Bail if no tidally-influenced cells[24]   lc←READ 2⊃1⊃A                                  ⍝Landcover[25]   d8flow←READ 3⊃1⊃A                              ⍝D8 flow direction[26]   d8accum←READ 4⊃1⊃A                             ⍝D8 flow accumulation[27]   Y←0 MVREP READ 5⊃1⊃A                           ⍝Tiny outflows[28]  [29]   d8flow←d8flow×~lc∊LOOK 'Freshwater tidal riverine'  ⍝Stop when we get to freshwater tidal[30]   cross←lc=LOOK 'Culvert/bridge'                 ⍝Crossing cells[31]   O←~EXPAND lc∊⊃,/LOOK¨FRDBL¨↓','MATRIFY excluded⍝Excluded types from denominator (open water and wetter stuff)[32]   sm←O^lc∊⊃,/LOOK¨FRDBL¨↓','MATRIFY saltmarsh    ⍝Salt marsh cells[33]   psm←O^(X≥0.5)   ⍝^~lc∊'Open water'             ⍝Potential salt marsh cells (predicted by tides variable), but not in open water[34]   tr←(⍴X)⍴0                                      ⍝For values at restrictions[35]   result←(⍴X)⍴MV                                 ⍝Result grid[36]  [37]  [38]   I←0            [39]  L1:→((1↑⍴X)<I←I+1)/L3                           ⍝For each row,[40]   BREAKCHECK[41]   →(~∨/Y[I;])/L1[42]   J←0[43]  L2:→((1↓⍴X)<J←J+1)/L1                           ⍝   For each column,[44]   →(~Y[I;J])/L2[45]  [46]  ⍝TRr expects globals: result, trs, d8flow, dams[47]   Q←TRr1 I,J                                     ⍝      Follow watershed up and back down, summing salt marsh and potential salt marsh cells[48]   →(Q≡⍳0)/L2                                     ⍝      If we hit an edge, we're done with this watershed--another tile will pick it up[49]   0 TRr2 I,J                                     ⍝      Follow watershed up taking worst restriction below each cell[50]   →L2[51]  [52]  L3:transparent←1[53]  [54]   Q←(,tr≠0)⌿(,⍉(⌽⍴tr)⍴(⍳1↑⍴tr)),(,(⍴tr)⍴⍳1↓⍴tr),[1.5],tr[55]   Q[;1 2]←↑1 FINDPOINT¨↓Q[;1 2][56]   Q LOCKWRITE pathR PATH 'tiderestrict.txt'     ⍝      Write tidal restriction points[57]  [58]  [59]  ⍝⍝⍝⍝⍝FOR TESTING[60]   Q←Q,((1↑⍴Q),2)⍴block[4 5][61]   Q LOCKWRITE pathR PATH 'ZZINFO.txt'     ⍝      Write tidal restriction points[62]  ⍝⍝⍝⍝⍝[63]  [64]   result←6 ROUND MVREP result ((X=MV)∨X<0.1)     ⍝Don't write results where tides are missing or tides < 0.1[65]   result WRITE pathR PATH 1⊃3⊃A                  ⍝Write results transparently[66]   result←MVREP result ((MV=READ 5⊃1⊃A)∨(~lc∊⊃,/LOOK¨FRDBL¨↓','MATRIFY keepresults))   ⍝write separate version for a reasonable stand-alone metric[67]   result WRITEI pathR PATH 2⊃3⊃A[68]   →0[69]  [70]  [71]  [72]  what:CAPS coastal[73]  type:block[74]  info:((pathU PATH 'tides') 'dslland' 'flow' 'd8accum' 'tinytr' 'trmask') ('') ('TR' 'tideres') (⌈1000×buffer÷cellsize)       ⍝Metric-specific source grids, settings table, result grid, buffer size, and include grid[75]  check:CHECKVAR 'buffer saltmarsh cutoff excluded keepresults'    ∇