    ∇ Z←N SPLITUNITS X;C;E;P;D;P1;P2;S;H;Q;L;Y;J;M;B;T;O[1]   ⍝Split patch ⍺[1] in ⍵ in two, setting new patch to ⍺[2][2]   ⍝Return (new patch grid) (n×2 matrix of patch #, size)[3]   ⍝B. Compton, 5-7 Jun 2012[4]   [5]   [6]   [7]    C←((+/(⍳1↑⍴X)×+/Q),+/(⍳1↓⍴X)×+⌿Q)÷+/,Q←X=N[1]              ⍝Centroid[8]    E←(N[1]=X)^(N[1]≠1⌽X)∨(N[1]≠¯1⌽X)∨(N[1]≠1⊖X)∨N[1]≠¯1⊖X     ⍝Edge cells[9]    P←(,E)⌿(,⍉(⌽⍴X)⍴⍳1↑⍴X),[1.5],(⍴X)⍴⍳1↓⍴X                    ⍝Edge points[10]   D←(+/(P-(⍴P)⍴C)*2)*.5                                      ⍝Distance from centroid to each edge point[11]   P1←P[D⍳⌈/D;]                                               ⍝Farthest point form centroid[12]   D←(+/(P-(⍴P)⍴P1)*2)*.5                                     ⍝Distance from P1 to each edge point[13]   P2←P[D⍳⌈/D;]                                               ⍝Farthest point from P1[14]   H←.5×P1+P2                                                 ⍝Halfway between P1 and P2[15]   S←-÷/P1-P2+.000001                                         ⍝Slope of line perpendicular to P1-P2[16]  [17]   Q←((D←.2)×⍳5×⌈/⍴X)∘.×2↑(2×1<|S)⌽1,S,÷S                     ⍝Make at least five points per cell[18]   L←(((⍴Q)⍴H)+Q)⍪H⍪((⍴Q)⍴H)-Q                                ⍝Run pependicular line through midpoint of P1-P2[19]   C←(⌊L)⍪(⌈L)⍪((⌊L[;,1]),⌈L[;2])⍪(⌈L[;,1]),⌊L[;2]                                                    ⍝Round to cells[20]   C←(^/(C≥1)^C≤(⍴C)⍴⍴X)⌿C                                    ⍝Clip to window[21]  [22]   Y←(X=N[1])×((⍴X)⍴1) SCATR C (O←1+⌈/,X)                     ⍝Run line through single focal patch[23]  [24]   Z←FINDPATCH Y                                              ⍝Build patches[25]   Z←(0,Q←N[1],N[2]+⍳¯1+⌈/,Z)[Z+1]                            ⍝Our patch is original number, new numbers; all else 0[26]   Z←((X=N[1])⊖X,[.5]Z)[1;;][27]   Q←Q,[1.5]+/¨(⊂,Z)=¨Q[28]  [29]   T←((T⍳T)=⍳⍴T)/T←(T≠0)/T←,Z×Y=O                             ⍝Patches in line[30]   M←((Q[;1]∊T)∨Q[;2]<minimum×5×1E4÷cellsize*2)/Q[;1]         ⍝New patches that are too small or are part of line[31]    J←0[32]  L1:→((⍴M)<J←J+1)/L2                                         ⍝For each small patch,[33]   E←(~Z∊0,M[J])^(M[J]=1⌽Z)∨(M[J]=¯1⌽Z)∨(M[J]=1⊖Z)∨(M[J]=¯1⊖Z)∨(M[J]=1⌽1⊖Z)∨(M[J]=¯1⌽1⊖Z)∨(M[J]=1⌽¯1⊖Z)∨M[J]=¯1⌽¯1⊖Z     ⍝   Adjacent patches[34]   N←(,E)/,Z[35]   N←N[⍋N][36]   N←(B/N),[1.5](B←N≠¯1,¯1↓N) pSUM (⍴N)⍴1[37]   N←N[⍒N[;2];][38]   Z←Z+(Z=M[J])×N[1;1]-M[J]                                   ⍝   Change this patch to most adjacent patch[39]   →L1[40]  [41]  L2:Q[;2]←+/¨(⊂,Z)=¨Q[;1]        ⍝Recalculate areas[42]   Q←(Q[;2]≠0)⌿Q                  ⍝And drop merged patches[43]   Z←Z Q                          ⍝Return grid and table of new patch numbers and sizes    ∇