    ∇ A BUILDUNITS S;X;R;W;B;E;N;C;buffer;traffic;transparent;minimum;large;L;pertile;head;I;Q;Y;J;excluded;M;mask;secured;P;K;O;D[1]   ⍝Build conservation units out of roadless/undeveloped blocks (runs as a CAPS metric)[2]   ⍝Input grids:[3]   ⍝   land                landcover[4]   ⍝   source\roadtraffic  traffic (original units)[5]   ⍝   source\trains       railroads[6]   ⍝   *grids\secured      secured land (optional)[7]   ⍝Results:[8]   ⍝   units               integer grid of unit numbers[9]   ⍝   units.txt           list of units and their area (ha)[10]  ⍝   unitspertile.txt    list of tile row, column, and number of units[11]  ⍝Parameters:[12]  ⍝   traffic = 20        minimum traffic rate to consider unit-forming[13]  ⍝   excluded = 'excluded'    ; landcover types to exclude (use synonyms.par); '' to just do roadless blocks[14]  ⍝   minimum = 1         size of minimum unit (ha)[15]  ⍝   large = 300         size of maximum unit (ha).  Set to 0 to leave large blocks intact.[16]  ⍝   buffer = 48         buffer size (km).  This should be no smaller than the largest roadless block in your landscape.[17]  ⍝   pertile = 10000     maximum number of units per tile (to avoid collisions)[18]  ⍝   mask = ''           optional mask, for excluding buffer[19]  ⍝   secured = yes       if yes, defines blocks (of any size) from secured land.  They're non-splittable.[20]  ⍝B. Compton, 4-8 Jun 2012[21]  ⍝14 Jun 2012: change 'developed' to 'excluded', use mask, use secured land to help define units[22]  ⍝15 Jun 2012: do centroids 500 at a time for 20x speedup[23]  ⍝22 Aug 2012: deal with ginormous patches by arbitrarily splitting them[24]  [25]  [26]  [27]   READPARS ME[28]   buffer←4⊃A[29]   M←1[30]   →(0∊⍴mask)/L5                                      ⍝If a mask grid is supplied,[31]   M←~(READ GRIDNAME mask)∊0,MV[32]  L5:Y←READ 1⊃1⊃A                                     ⍝Read land cover[33]   →(~1∊X←M^~Y∊MV,⊃,/LOOK¨FRDBL¨↓','MATRIFY exclude)/0⍝Exclude missing and excluded cells (ocean)[34]   →(excluded≡'')/L0                                  ⍝If development or other exclusions are being used,[35]   →(~1∊X←X^~Y∊⊃,/LOOK¨FRDBL¨↓','MATRIFY excluded)/0  ⍝   Undeveloped cells (bail if none)[36]  L0:R←READ 2⊃1⊃A                                     ⍝Road traffic[37]   X←X^R<traffic                                      ⍝Roadless cells below traffic threshold[38]   R←READ 3⊃1⊃A                                       ⍝Railroads[39]   X←X^R=MV[40]   P←(⍴X)⍴0[41]   →(~secured)/L4                                     ⍝If using secured land,[42]   P←0 MVREP READ 4⊃1⊃A                               ⍝   read grid[43]   X←(X≠0)×X⌈P×2                                      ⍝   secured patches will be separate[44]  [45]  L4:X←FINDPATCH X                                    ⍝Build patches[46]  [47]   B←UNIQUENZ,(2⍴buffer)↓(-2⍴buffer)↓X                ⍝Patches in tile proper[48]   →(0∊⍴B)/0                                          ⍝If nothing in tile proper, quit[49]   D←UNIQUENZ (,X[;1,buffer]),,X[1,buffer;]           ⍝Patches that reach edge of buffer[50]   D←(D∊B)/D                                          ⍝Patches that are in tile proper and reach edge of buffer: we always keep these[51]  [52]   W←((W⍳W)=⍳⍴W)/W←,X[;⍳buffer]                       ⍝Patches in west buffer[53]   E←((E⍳E)=⍳⍴E)/E←,((1↑⍴X),-buffer)↑X                ⍝Patches in east buffer[54]   N←((N⍳N)=⍳⍴N)/N←,X[⍳buffer;⍳(1↓⍴X)-buffer]         ⍝Patches in north buffer proper (excluding northeast quadrant)[55]   S←((S⍳S)=⍳⍴S)/S←,((-buffer),1↑⍴X)↑X                ⍝Patches in south buffer[56]   X←X×~X∊W~D                                         ⍝Drop any patches that occur in west buffer[57]   X←X×~X∊N~D                                         ⍝Drop patches in north proper[58]   X←X×~X∊((E,S)~B)~D[59]   →(^/,X=0)/0[60]  [61]   C←C[⍋C←(,X≠0)/,X]                                  ⍝Get size of each patch[62]   C←(B/C),[1.5](B←C≠¯1,¯1↓C) pSUM (⍴C)⍴1             ⍝Patch #, size[63]   C←C,(,P)[(,X)⍳C[;1]]                               ⍝1's mark secured patches[64]   X←X×X∊(C←(C[;3]∨C[;2]≥(minimum×1E4)÷cellsize*2)⌿C)[;1]   ⍝Drop small unsecured patches[65]   ⎕ERROR (pertile<1↑⍴C)/'Too many units (',(⍕1↑⍴C),') in tile ',(⍕block[4]),',',(⍕block[5]),' - pertile is only ',⍕pertile[66]   →(^/,X=0)/0[67]  [68]  ⍝Now split large patches[69]   L←(large≠0)/((~C[;3])^C[;2]>(large×1E4)÷cellsize*2)/C[;1]   ⍝Get list of large unsecured patches[70]   ⍞←(0<⍴L)/'Splitting ',(⍕⍴L),' units...' ⋄ FLUSH[71]   I←0[72]  L1:→((⍴L)<I←I+1)/L2                                 ⍝For each large patch,[73]   J←1 CLIP X=L[I]                                    ⍝   Clip out current patch[74]   Y Q ← L[I] (⌈/C[;1]) SPLITUNITS X[1⊃J;2⊃J]         ⍝   Split it in two[75]   X[1⊃J;2⊃J]←Y                                       ⍝   Replace it[76]   C←((C[;1]≠L[I])⌿C)⍪Q,0                             ⍝   Add patch #s and size to list[77]   L←L,(Q[;2]>(large×1E4)÷cellsize*2)/Q[;1]           ⍝   And add to list of large patches if necessary[78]   DOT[79]   →L1[80]  [81]  L2:⎕←⎕TCNL,'Split ',(⍕⍴L),' units, including multiple splits.' ⋄ FLUSH[82]   ⎕ERROR (pertile<1↑⍴C)/'Too many units (',(⍕1↑⍴C),') in tile ',(⍕block[4]),',',(⍕block[5]),' - pertile is only ',⍕pertile[83]   B←pertile×¯1+block[5]+(block[4]-1)×block[7]        ⍝Allow <pertile> patches per tile[84]   X←MVREP (B+C[;1]⍳X) (X=0)                          ⍝Renumber patches[85]   C←(B+⍳1↑⍴C),[1.5]C[;2]×(cellsize*2)÷1E4            ⍝Rebuild patch index[86]   C←C,2×(,P)[(,X)⍳C[;1]]                             ⍝2's mark secured patches (Marxan wants 2 here)[87]   C←(C,0),0[88]  [89]   →(~centroids)/L8                                   ⍝If getting centroids,[90]   ⍞←'Finding centroids' ⋄ FLUSH[91]   K←500                                              ⍝   500 at a time seems to be the sweet spot[92]   I←0[93]  L7:O←(O≤1↑⍴C)/O←I+⍳K                                ⍝   Repeat for K units at a time[94]   DOT[95]   C[O;4 5]←↑1 FINDPOINT¨(⊂¯1+⊃¨J)+CENTROID¨(⊂X[1⊃J;2⊃J←CLIP X∊C[O;1]])=¨C[O;1]   ⍝      get centroid[96]   →((1↑⍴C)>I←I+K)/L7                                 ⍝   until we're done[97]  [98]  L8:transparent←1[99]   X WRITEI 3⊃A[100]  C LOCKWRITE pathR PATH 'units.txt'                 ⍝File has unit id, size (ha), 2 if secured, and centroid x & y (using Marxan's names)[101]  (block[4 5],1↑⍴C) LOCKWRITE pathR PATH 'unitspertile.txt'[102]  ⎕←'Done' ⋄ FLUSH[103]  →0[104] [105] [106] what:data prep[107] type:standard[108] info:('land' (pathS PATH 'roadtraffic') (pathS PATH 'trains') '*secured') ('') ('units') (⌈1000×buffer÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[109] check:CHECKVAR 'traffic excluded minimum large buffer pertile mask secured'[110] init:head←1↓⎕TCHT MTOV MATRIFY 'id cost status xloc yloc' ⋄ (0 0⍴'') TMATOUT pathR PATH 'units.txt'[111] init:head←1↓⎕TCHT MTOV MATRIFY 'row column units' ⋄ (0 0⍴'') TMATOUT pathR PATH 'unitspertile.txt'    ∇