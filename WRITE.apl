    ∇ X WRITE G;Y;I;T;L;Q;blockid;grids;D;C;W;B[1]   ⍝Save CAPS results ⍺ in grid ⍵[2]   ⍝If transparent=1, write in buffer zone too, and write transparently[3]   ⍝Based loosely on SAVEHAB[4]   ⍝B. Compton, 3 Dec 2007[5]   ⍝15 Jan 2009: from SAVECAPS; modified to work with C gridio package[6]   ⍝10 Apr 2009: Let WRITEBLOCK drop buffer (6 dog playdate)[7]   ⍝16 Nov 2009: force floating point for CAPS results[8]   ⍝2-4 Jun 2010: add transparent; 17 Nov add transparent = 2[9]   ⍝18 Feb 2011: do arbitrary block writes if block[1]=¯1, like READ already does[10]  ⍝24 Feb 2011: oops...use transparent in aribtrary block writes[11]  ⍝7 Mar 2011: Use block[3], not buffer; 26 May 2011: use buffer if block is 0; 16 Jun 2011: oops[12]  ⍝11 Jul 2014: oops--shouldn't drop buffer in transparent mode when writing arbitrary blocks[13]  [14]  [15]  [16]   ⍎(0=⎕NC'transparent')/'transparent←0'                  ⍝If global transparent isn't defined, we want 0[17]  ⍝ ADD2ASSEMBLE G[18]  [19]   →(¯1 0=1↑block)/L2,L3                                  ⍝If doing a block write,[20]   →(aplc=2)/L0                                           ⍝   If writing .asc grids,[21]   G←(T←(D↑G),blockid),((D←¯1+G⍳'.')↓G),'.zzz'            ⍝      Add block id to filename[22]  L0:W←THISBLOCK+(transparent≠0)×block[3]×¯1 ¯1 2 2 ¯1    ⍝   Block parameters[23]   W[⍳4]←W[⍳4]+1 1 ¯1 ¯1×4⍴C←0⌈1-W[1 2]                   ⍝   Trim if transparent buffer extends below orgin of grid[24]   X←C↓X                                                  ⍝   (WRITEBLOCKc deals with extension beyond tail of grid)[25]  [26]   X WRITEBLOCK (⊂pathR PATH G),W,transparent,1           ⍝   write to current block.  Force floating point.[27]   →0[28]  [29]  L2:B←1↓block                                            ⍝Else, arbitrary block write.[30]   :if transparent≠0                                      ⍝   Don't drop buffer if transparent[31]      B[⍳4]←B[⍳4]+¯1 ¯1 2 2×B[5][32]      B[5]←0[33]   :end[34]   X WRITEBLOCK (⊂pathR PATH G),B,transparent,1           ⍝Else, arbitrary block write. Force floating point.[35]   →0[36]  [37]  L3:⍎(0≠⎕NC'buffer')/'B←buffer'[38]   B←(1+0≡block) ⊃ ((3↑block)[3]) B[39]   (D↓(-D←2⍴buffer)↓X) WRITEGRID pathR PATH G             ⍝Else, drop buffer and write whole thing    ∇