    ∇ A RESIL_IMPACT_OLD S;buffer;loop;test;noread;grids;ffile;tilesize;tilemapinclude;skiptilemap;E;scenarios;scenarios_;head;I;N;lc0;Y;Q;V;t0;t1;G;ecogeo;benchpath;bench1;bench2;B;J;R;D;M;diversity;P;Z;diversemin;resilience;resilmin[1]   ⍝Resilience impact for one or more alternate scenarios[2]   ⍝Parameters:[3]   ⍝   scenarios           scenarios file (same as used for SCENARIOS)[4]   ⍝   benchpath           path to benchmark files for Z-scoring traversability (bench_traverse) and resilience (bench_resil)[5]   ⍝   usegroups           supply an optional group file to additionally summarize by ecological system groups (formations)[6]   ⍝   ecogeo              path to ecogeo grid (reclassed from 1..n)[7]   ⍝   diversity           path to base landscape diversity grid, z-scored by strata ecogeo (from TNC)[8]   ⍝   diversemin          minimum value for base z-scored diversity, to allow shifting to 0-n[9]   ⍝   resilmin            minimum value for base z-scored resilience[10]  ⍝   resilience          path to base final resilience z-scored by strata ecogeo (our version)[11]  ⍝   tilesize            size of tiles (in cells)[12]  ⍝   targets = '1:1'     needs to be in parameters.par to run a single thread[13]  ⍝Source:[14]  ⍝[15]  ⍝   diversity           diversity, z-scored stratified by ecogeo, with minimum added so it ranges from 0 to n (from TNC)[16]  ⍝[17]  ⍝Results:[18]  ⍝   resdelta            delta grid, written to deltas[I]           [19]  ⍝   resimp              impact grid[20]  ⍝   resil_impact.txt    delta and impact summary table, written to deltas[1][21]  ⍝   resil_impact_grouped.txt    ditto, grouped by formation[22]  ⍝Runs as a CAPS metric, but only uses one thread.  It'll be fastest if you set host = 'w00'.[23]  ⍝B. Compton, 26 May-26 Jun 2017[24]  [25]  [26]  [27]   READPARS ME[28]   buffer←4⊃A[29]  [30]  [31]   loop←test←noread←0 ⋄ grids←0 0⍴''   ⍝Silly junk for BLOCK, etc.[32]   ffile←'RESIL_IMPACT '[33]   BLOCK (2⍴tilesize),buffer[34]   SETTILE[35]   tilemapinclude←0[36]   skiptilemap←0              ⍝Don't let DEBUG sabotage this[37]   E←TILEMAP '' tilesize 0 0  ⍝Get tilemap, building it if necessary. This will only help if there's mask grid.[38]  [39]  [40]   scenarios←1 TABLE scenarios                        ⍝Read scenarios file[41]   scenarios_←(',',⎕TCHT) MATRIFY '.".' TEXTREPL head ⍝and get header[42]   scenarios←((⍴scenarios)⌈0,1↑⍴scenarios_)↑scenarios,⊂''[43]  [44]   bench1←MATIN benchpath PATH 'bench_traverse.txt'    ⍝Read benchmark files[45]   bench2←MATIN benchpath PATH 'bench_resil.txt'[46]  [47]  [48]   I←1                 [49]  L1:→((1↑⍴scenarios)<I←I+1)/L9                       ⍝For each scenario,[50]   ⎕←'Doing scenario ',(⊃scenarios[I;scenarios_ COL 'name']),' (',(⍕I-1),' of ',(⍕¯1+1↑⍴scenarios),')' ⋄ FLUSH[51]   Z←0 3⍴0[52]   [53]   N←0[54]  L2: →(~E[N←N+1])/L3                                 ⍝   Repeat: read tile (1st time through tiles), skip if not in tilemap    --- For each tile ---[55]      BREAKCHECK [56]      DOT   [57]      lc0←READ GRIDNAME ⊃scenarios[1;scenarios_ COL 'land']    ⍝      Read base landcover grid [58]      →(0∊⍴Y←S INCLUDE lc0)/L2                 ⍝      Exclude development & excluded systems[59]      [60]      Q←READ GRIDNAME ⊃scenarios[I;scenarios_ COL 'land']      ⍝      Read alternate landcover grid [61]      V←READ GRIDNAME diversity                                ⍝      Read base diversity (standardized)[62]      V←0 MVREP (V-diversemin) (V=MV)                          ⍝      rescale so diversity goes from 0 to 7; are MVs for roads in TNC data but not ours[63]      ⍝*** MAYBE SHOULD FILL MISSING ROADS DATA WITH FOCALMEAN?[64]  [65]      V←V×lc0≠Q                                       ⍝      Lost diversity in new scenario, where landcover has changed with new development[66]  [67]  [68]      t0←READ GRIDNAME (⊃scenarios[1;scenarios_ COL 'results']),'traverse0Z'      ⍝Read base traversability (scaled)[69]      t1←READ GRIDNAME (⊃scenarios[I;scenarios_ COL 'results']),'traverse0'     ⍝And alternate traversability (raw)[70]  [71]   [72]      G←READ GRIDNAME ecogeo                                   ⍝      Read ecoregion by geophysical setting grid[73]      Y←Y^G≠MV[74]      [75]      R←READ GRIDNAME resilience[76]      R←MVREP (R-resilmin) (R=MV)                     ⍝      shift resilience to 0-n[77]  [78]      ⍝Now z-score alternate traversability, stratified, using benchmarks[79]      B←,Y^~(lc0∊MV)∨(G∊MV)∨(t1∊MV)∨(R∊MV)∨lc0∊LOOK 'developed'  ⍝      Missing, developed, or excluded anywhere → missing[80]       [81]      J←bench1[;1]⍳B/,G                               ⍝      Index of benchmark for ecogeo setting[82]      t1←((B/,t1)-bench1[J;2])÷bench1[J;3]            ⍝      Standardize[83]      t1←MVREP ((⍴lc0)⍴B\t1) ((⍴lc0)⍴~B)              ⍝      back to original matrix[84]  [85]      D←((t1-t0)-V)÷2                                 ⍝      delta resilience = ((alt traverse - base traverse) - lost diversity)÷2[86]  [87]  ⍝    ⍝Now zscore resilience using benchmarks 2        WRONG!!![88]  ⍝    J←bench2[;1]⍳B/,G                               ⍝      Index of benchmark for ecogeo setting[89]  ⍝    D←((B/,D)-bench2[J;2])÷bench2[J;3]              ⍝      Standardize[90]  ⍝    D←MVREP ((⍴lc0)⍴B\D) ((⍴lc0)⍴~B)                ⍝      back to original matrix[91]  [92]      D←MVREP D ((⍴lc0)⍴~B)                           ⍝      deal with missing values[93]      M←MVREP (D×R) ((⍴D)⍴~B)                         ⍝      Impact = base resilience × delta[94]      [95]       P←⊃scenarios[I;scenarios_ COL 'deltas'][96]      (5 ROUND D) WRITE P,'resdelta'[97]      (5 ROUND M) WRITE P,'resimpact'[98]      [99]      ⍝Do aspatial summary of tile[100]     lc0←B/,lc0                                      ⍝      Compressing missing values out of landcover, deltas, and impact[101]     lc0←lc0[P←⍋lc0][102]     D←(B/,D)[P]×1E¯4×cellsize*2                     ⍝      and convert delta to delta ha[103]     M←(B/,M)[P]×1E¯4×cellsize*2                     ⍝      convert impact to impact ha[104]     B←lc0≠0,¯1↓lc0                                  ⍝      mark unique values of landcover[105]     Z←Z⍪(B/lc0),(B pSUM D),[1.5]B pSUM M            ⍝      take sums of delta & impact for each landcover class[106]  L3: →(0≠NEXTBLOCK)/L2                              ⍝   Until no more tiles[107] [108] [109]  Z←Z[⍋Z;]                                           ⍝   summaries across tiles[110]  B←Z[;1]≠0,¯1↓Z[;1][111]  Z←(B/Z[;1]),(B pSUM Z[;2]),[1.5]B pSUM Z[;3][112] [113]  P←⊃scenarios[1;scenarios_ COL 'deltas'][114]  E←'. ._' TEXTREPL ⊃scenarios[I;scenarios_ COL 'name'][115] [116]  ⍝Write aspatial summary for landscape[117]  Q←(landcover[landcover[;1]⍳Z[;1];2]),0 1↓Z[118]  head←1↓⎕TCHT MTOV MATRIFY 'system resil_delta resil_impact'[119]  Q TMATOUT P,'\resil_impact_',E,'.txt'[120]  [121]  ⍝Write summary by groups[122]  Z←GROUPSUMMARY Z[123]  →(0∊⍴Z)/L1[124]  head←1↓⎕TCHT MTOV MATRIFY 'formation resil_delta resil_impact'[125]  Z TMATOUT P,'\resil_impact_grouped_',E,'.txt'[126]  →L1                                                ⍝Next scenario[127] [128] [129] L9:⎕←''[130]  LOG 'RESIL_IMPACT is done.'[131]  →0[132] [133] [134] [135] what:auxiliary[136] type:table[137] info:('') ('') ('') 0 ''      ⍝Source grid, settings table, result grid, buffer size, and include grid[138] check:CHECKVAR 'scenarios benchpath usegroups ecogeo diversity diversemin resilmin resilience tilesize targets'    ∇