    ∇ A TRAVERSE S;X;J;I;R;Z;K;L;D;G;E;B;Y;buffer;T;O;sr;srt;sd;sdt;resist;bandwidth;multiplier;search;focalresist;Q;X2;melissa;runfor;source;density;samples;patches;result;adjust;F;Y2;V;exclude[1]   ⍝CAPS traversability metric for groups ⍵ (= old connectedness)[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer) (include grid)[3]   ⍝Parameters:[4]   ⍝   source          source grid, either land to use landcover with separate resistance table, or name of resistance grid to use it directly[5]   ⍝   result          name of result grid (end of grid name is forced to 0, as this is raw traversability)[6]   ⍝   multiplier      multiplier on contrast to get resistance (skip settings variables if 0)[7]   ⍝   bandwidth       bandwidth (h) in m[8]   ⍝   search          search distance in s.d.[9]   ⍝   density         build kernels every nth cell (use density = 1 for normal, slower results)[10]  ⍝   focalresist     if 1, subtract focal cell's resistance when building kernel.  Default = 0 (old behavior).[11]  ⍝   melissa         if 1, treat resistances as 10×resist, as Melissa Clark does it[12]  ⍝   adjust[1]       cellsize adjustment multiplier. When running with 90 m cells, use 3 to get the same result as 30 m cells; when[13]  ⍝                   running at 30 m and trying to match 90 m cells, use 1/3.[14]  ⍝   adjust[2]       arbitrary adjustment for resistance when trying to match other grains. Have to calibrate by trial & error.[15]  ⍝   runfor          max resistance value to run for (Melissa uses 91; I typically use 1)[16]  ⍝Note: with adjust = 0.33333333 0.45, correlation with TNC's 2016 raw traverse (at 90 m) is 0.9536 (n = 350,345).  Okay![17]  ⍝B. Compton, 13 Feb 2013, from CONNECT[18]  ⍝Drop linkages, density, crossings, masktocore, etc. Keep settings variables. Take sum of kernel at each cell.[19]  ⍝2 Jun 2014: add focalresist for Brad McRae and skip settings variables if multiplier=0[20]  ⍝17 Aug 2015: allow input grid to consist of resistance values for Melissa[21]  ⍝10 Jan 2017: add edge correction, working properly for islands. Have new propane heater.[22]  ⍝24 May 2017: add source, melissa, and runfor options for TNC runs[23]  ⍝25 May 2017: speedups: do edge correction only if necessary; add density option to sample every nth cell and interpolate[24]  ⍝2 Jun 2017: add adjust to allow changing cellsize while getting similar results (yesterday, President Shithead pulled out of Paris Accord)[25]  ⍝5 Jun 2017: more changes to make adjust work properly[26]  ⍝6 Jun 2017: add adjust[2] to calibrate resistance (cold & rainy, still burning fires most days!)[27]  ⍝19 Jun 2017: when interpolating, run for all sampled cells that fall in include, regardless of resistance, then zero out developed/high-resistance after interpolating[28]  ⍝21 Jun 2017: when interpolating, run for ALL sampled cells, far enough into buffer[29]  ⍝17 Jul 2017: I screwed up resistance variable; and again--need bigger window[30]  ⍝9 Mar 2018: don't do old-style edge correction in EXAMPLE! It screws up CLSB comparisons, and isn't used for actual metric anyway[31]  [32]  [33]  [34]   buffer←B←4⊃A[35]   READPARS ME[36]   density←(1+~0∊⍴example) ⊃ density 1⍝Turn off density if running an example[37]  [38]   X←READ 1⊃A[39]   Z←(⍴X)⍴0[40]   Y2←(⍴X)⍴1[41]   :if multiplier≠0                                                   ⍝If multiplier supplied,[42]      Y←(S (GRIDNAME 'include') 0 '') INCLUDE X                       ⍝   which cells to run for? Here, source is landcover, so okay to use INCLUDE normally.[43]      sr srt sd sdt ← SETTINGS (2⊃A) 'anthro1 anthro2' 'resist dist'  ⍝   Get ecological settings and tables for resistance and distance[44]   :else                                                              ⍝else, fixed resistance values,[45]      :if ~0∊⍴resist                                                  ⍝   If resistance table supplied,[46]        Y←(S (GRIDNAME 'include') 0 '') INCLUDE X                     ⍝      which cells to run for? Here, source is landcover, so okay to use INCLUDE normally.[47]        V←LOOKUP resist                                               ⍝      Get resistance values set by cover type, not ecolgical distance[48]        X←(V⍪1)[V[;1]⍳X;2]                                            ⍝      Cover types not on list get no resistance[49]      :else                                                           ⍝   else,[50]         exclude←''[51]         Y←('*' (GRIDNAME 'include') 0 '') INCLUDE X                  ⍝   which cells to run for? Here, source is resistance, so don't use exclude or groups.[52]         →(0∊⍴Y)/0[53]         :if melissa                                                  ⍝      if run for Melissa,[54]            X←MVREP (X÷10) (X=MV)                                     ⍝         input grid has resistance values × 10[55]         :end[56]         Y←Y^Y2←X≤runfor                                              ⍝         run for cells with resistance < runfor (Melissa uses 91)[57]     :end[58]   :end[59]  [60]   :if density>1                                                      ⍝If interpolating,[61]      Y←(⍴X)⍴1                                                        ⍝   will run for all cells, including developed[62]      T←⍳B-density×2[63]      Y[T,(1↑⍴Y)-T;]←0                                                ⍝   but don't run in buffer beyond 2×density out[64]      Y[;T,(1↓⍴Y)-T]←0[65]      T←density|block[1 2]×block[4 5]-1                               ⍝   Correction to prevent tile boundary artifacts[66]      Y[((1↑⍴Y)⍴T[1]⌽((density-1)⍴1),0)/⍳1↑⍴Y;]←0                     ⍝   given density option, only build kernels for every nth cell[67]      Y[;((1↓⍴Y)⍴T[2]⌽((density-1)⍴1),0)/⍳1↓⍴Y]←0[68]   :end[69]   [70]   →(0∊⍴Y)/0[71]   [72]   →(~1∊Y)/L10[73]   T←⌈bandwidth×3÷cellsize[74]   E←SPREAD (0.0001⌈(bandwidth×3÷cellsize)-focalresist) (T+1) (T+1) ((2⍴1+2×T)⍴1)  ⍝Maximum possible kernel given search = 3[75]   E←(E≠0)×ZDENSITY 0⌈3-E÷bandwidth÷cellsize[76]   E←(adjust[1]*2)×E÷(+/,E←(2⍴T-F)↓(-2⍴T-F←B-density+1)↓E)÷+/,E       ⍝Scale to search = 3[77]   D←(⍳1+2×F)-F+1                                                     ⍝Maximum radius possible to travel[78]   O←1E6×F<DIST 1+F×2                                                 ⍝Circle mask for search < 3[79]  [80]  [81]   I←F←B-density+1[82]  L6:→(((1↑⍴X)-F)<I←I+1)/L10                                  ⍝For each row, -----[83]   BREAKCHECK[84]   →(~∨/Y[I;])/L6                                             ⍝   If empty row, skip it[85]   J←F[86]  L7:→(((1↓⍴X)-F)<J←J+1)/L6                                   ⍝   For each column,[87]   →(~Y[I;J])/L7                                              ⍝      If we're doing this cell,[88]   DOT[89]   K←I+D ⋄ L←J+D[90]   R←X[K;L][91]   →(multiplier=0)/L8[92]   →(0∊⍴sr)/L8                                                ⍝         If we have ecological settings for resistance[93]   R←1+multiplier×(srt[;2]×sr[;I;J]) EUDIST sr[;K;L]          ⍝            Resistance values for focal cell I,J.  Focal cell is always 0 for anthro settings.[94]   R←1E6 MVREP R (X[K;L]=MV)                                  ⍝            Missing cells get resistance of a million[95]   R←(X[K;L]×X[K;L]≠1)+R×X[K;L]=1                             ⍝            If cover type resistances are supplied, these take precedence[96]  L8:→(search≥3)/L81                                          ⍝         If search < 3,[97]   R←R+O                                                      ⍝            Restrict to circle[98]  L81:G←SPREAD (0.0001⌈(adjust[1]×bandwidth×3÷cellsize)-focalresist×R[K⍳I;L⍳J]×adjust[1]) (K⍳I) (L⍳J) (R×adjust[2])[99]   →((¯1=1↑block)∨0∊⍴example)/L9                              ⍝         If producing intermediate results from example,[100]  EXAMPLE 1E6×T←(bandwidth÷cellsize) 3 CONNECT_RESCALE G E ((⍴E)⍴1)[101]  LOG '⊢[connect] Point at ',(⍕⌊.5+FINDPOINT I J-B),' =',4⍕+/,T[102]  →L7[103] L9:[104]  :if MV∊X[K;L]                                              ⍝         If any missing values,[105]     Q←FINDPATCH X[K;L]≠MV                                   ⍝            Do edge correction, making sure islands are isolated[106]     X2←MVREP (X[K;L]) (Q≠Q[T;T←⌈.5×''⍴⍴Q])[107]  :else[108]     X2←X[K;L][109]  :end[110]  Z[I;J]←(bandwidth÷cellsize) 3 CONNECT_RESCALE_SUM G E X2   ⍝            Traversability is proportion of maximum volume possible[111]  →L7[112] [113] L10:→(0∊⍴Y)/0[114]  ⎕←''[115]  :if density≠1                                              ⍝If interpolating from samples,[116]     samples←Y[117]     patches←X≠MV[118]     ⎕←'Interpolating' ⋄ FLUSH[119]     Z←5 2 INTERPOLATE Z[120]  :end[121] [122]  Z←Z×Y2                                                     ⍝Zero out cells of developed (high resistance) stuff AFTER interpolation                           [123]  (X REMV Z) WRITE (3⊃A),('0'≠¯1↑FRDBL 3⊃A)/'0'              ⍝Result grid always ends in 0, as this is raw traversability[124]  →0[125] [126] [127] what:CAPS resiliency[128] type:standard[129] direction:positive                  ⍝Integrity metric - higher is bettter[130] info:(source) ('settings') (result) (⌈(2×density)+bandwidth×search÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[131] check:CHECKVAR 'source result multiplier bandwidth search resist focalresist density melissa adjust runfor'[132] check:CHECKCOVER 'resist'[133] check:CHECKFILE pathT PATH scales    ∇