    ∇ R MAKEMOSAIC P;D;S;M;C;Z;F;Y;I;X;Q;W;V;T;U;head;oc[1]   ⍝Create mosaic ⍵[2] from grid ⍵[1] using panemap or reference ⍵[3] with pane size ⍺[2]   ⍝   ⍵[1] source     path and name of existing grid[3]   ⍝   ⍵[2] mosaic     path and name of new mosaicked grid[4]   ⍝   ⍵[3] panemap    (optional) string with compressed binary vector[5]   ⍝                   (e.g., '001010') indicating which panes contain data[6]   ⍝    or  reference  (optional) a reference grid used to populate panemap[7]   ⍝   ⍺[1] rowsize    number of cell rows in each pane[8]   ⍝   ⍺[2] colsize    number of cell columns in each pane (optional; if omitted,[9]   ⍝                   rowsize is used)[10]  ⍝If neither panemap nor reference are supplied, the panemap is generated[11]  ⍝from the source grid.[12]  ⍝Also writes template gridservers.txt.[13]  ⍝Sample calls:[14]  ⍝   5000 MAKEMOSAIC 'd:\caps\grids\land' 'd:\caps\mosaics\land'[15]  ⍝   5000 MAKEMOSAIC 'd:\caps\grids\dem' 'd:\caps\mosaics\dem' PANEMAP ('d:\caps\grids\land')[16]  ⍝   2500 3000 MAKEMOSAIC 'd:\caps\grids\land' 'd:\caps\mosaics\land' '1'[17]  ⍝B. Compton, 5-30 Sep 2013[18]  ⍝11 Oct 2013: use WRITEMOSAICINFO[19]  ⍝18 Nov 2013: D'oh! Don't exclude windows with 0s--only exclude MVs.[20]  ⍝21 Nov 2013: Format xll and yll to a zillion digits; 25 Nov 2013: and cellsize[21]  ⍝16 Dec 2013: get a lock when writing mosaicinfo[22]  ⍝10 Sep 2014: use date of sta.adf for derived grids, not whole folder[23]  ⍝31 Aug 2016: write mosaic name[24]  [25]  [26]  [27]   S M P ← 3↑P,⊂''        ⍝Source, mosaic, and panemap/reference[28]   R←2⍴R[29]  [30]   ⎕ERROR (IFEXISTS M,'\')/'Folder ',(M←TOLOWER FRDBL M),' already exists'[31]  [32]   oc ← SAVECONNECTIONS   ⍝Save existing connections so we don't mess them up[33]  [34]   0 GRIDINIT ''[35]   D←GRIDDESCRIBE S[36]   C←⌈D[2 1]÷R            ⍝Number of pane rows and columns[37]   Y←(×/C)⍴1              ⍝Empty panemap[38]   F←0                    ⍝panemap flag: 0 = no map, 1 = panemap, 2 = reference[39]   :if 0≠⍴P←,⍕P           ⍝If panemap or reference supplied,[40]     F←2[41]     :if ^/P∊'01 '        ⍝   If panemap[42]         F←1              ⍝      Set flag and use it[43]         :if P≡,'1'       ⍝      If panemap is '1', treat map as all 1's[44]            P←(⍴Y)⍴1[45]         :else[46]            Y←⎕FI((2×⍴P)⍴1 0)\P[47]         :end[48]     :end                 ⍝   Otherwise, it's a reference grid[49]   :end[50]   MAKEDIR M[51]  [52]   U←0 5⍴0                ⍝List of good windows[53]   I←0[54]  L1:→((⍴Y)<I←I+1)/L2     ⍝For each potential pane,[55]   BREAKCHECK[56]   DOT[57]   W V ← D PANEWINDOW R,I ⍝   Get pane window and cell window in source mosaic[58]   0 GRIDINIT ''[59]   MAKEWINDOW 5↑D         ⍝   set window to source[60]   :if F=2                ⍝   If reference grid supplied,[61]      X←∆READBLOCK (⊂P),V ⍝      read tile from reference grid[62]      Y[I]←∨/,~X=MV       ⍝      set panemap from this tile[63]   :end[64]   →(Y[I]=0)/L1           ⍝   If panemap = 0, next[65]   X←∆READBLOCK (⊂S),V    ⍝   read tile from source grid[66]   :if F=0                ⍝   If neither panemap nor source were supplied,[67]      Y[I]←∨/,~X=MV       ⍝      set panemap from this tile[68]   :end[69]   →(Y[I]=0)/L1           ⍝   If panemap = 0, next[70]   0 GRIDINIT ''[71]   MAKEWINDOW W           ⍝   Set window to pane[72]   MAKEDIR STRIPPATH T←PANEPATH M (STRIP M) I (⍴Y)[73]   X WRITEBLOCK (⊂T),1 1,V[3 4],0,0,D[7]-1    ⍝   write pane, matching original type[74]   U←U⍪W[75]   →L1[76]  [77]  L2:Q←LOCKFILE M[78]   M WRITEMOSAICINFO (STRIP M) 'derived' S (2⊃FILEINFO S,'\sta.adf') (D[⍳7]) (R[1]) (R[2]) (C[1]) (C[2]) Y[79]   UNLOCKFILE Q[80]  [81]   ⎕←⎕TCNL,'Mosaic ',M,' created from ',S,'.'[82]  [83]   U←(⊂''),(⊂''),(⊂''),1,U,⊂''[84]   head←1↓⎕TCHT MTOV MATRIFY 'drive server port active ncol nrow xll yll cellsize landscape comment'[85]   U[;7 8 9]←FMTALL U[;7 8 9]                 ⍝Format xll, yll, and cellsize to a zillion digits[86]   U TMATOUT (STRIPPATH M),'gridservers.txt'[87]   CLEANUP[88]  [89]   RESTORECONNECTIONS oc    ∇