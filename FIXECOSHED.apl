    ∇ A FIXECOSHED S;B;E;X;W;buffer;Y;Q;D;I;J;K;L;T;M;R;Z;V[1]   ⍝Fix ecoregion and watershed grids for misalignment with landcover in CAPS 3.0[2]   ⍝Runs as a blcok metric[3]   ⍝Source (created by fixecoshed.aml, in working\):[4]   ⍝   trouble         1's mark missing ecoregion & watersheds for non-ocean landcover cells[5]   ⍝   ecogrid         gridded ecoregions[6]   ⍝   watergrid       watersheds[7]   ⍝Results (grids\):[8]   ⍝   ecoregions[9]   ⍝   watersheds[10]  ⍝Paramters:[11]  ⍝   window          How far (m) to look for closest ecoregion/watershed?  3000 m seems like enough.[12]  ⍝B. Compton, 3 Feb 2011[13]  [14]  [15]  [16]   READPARS ME[17]   buffer←B←4⊃A[18]   X←READ 1⊃1⊃A                                       ⍝Get trouble[19]   →(0∊⍴Y←S (5⊃A) INCLUDE X)/0                        ⍝Which cells to run for?  Note alternate include grid.[20]   Z←E←READ 2⊃1⊃A                                     ⍝and ecoregions[21]   V←W←READ 3⊃1⊃A                                     ⍝and watersheds[22]  [23]   D←DIST 1+B×2                                       ⍝Distances[24]  [25]   R←2⍴0[26]   I←B[27]  L1:→(((1↑⍴X)-B)<I←I+1)/L3                           ⍝For each row,[28]   BREAKCHECK[29]   →(~∨/Y[I;])/L1                                     ⍝   Skip empty rows[30]   J←B[31]  L2:→(((1↓⍴X)-B)<J←J+1)/L1                           ⍝   For each column,[32]   →(~Y[I;J])/L2                                      ⍝      If we're doing this cell,[33]   K←((K≥1)^K≤1↑⍴X)/K←I+T←(⍳1+2×B)-B+1[34]   L←((L≥1)^L≤1↓⍴X)/L←J+T[35]  [36]   Q←D×~E[K;L]∊0,MV                                   ⍝         Distances to ecoregion cells[37]   M←⌊/(,Q≠0)/,Q                                      ⍝         Distance to closest ecoregion cell[38]   Z[I;J]←1↑((E[I;J]=MV)↓E[I;J]),((,Q=M)/,E[K;L]),MV  ⍝         Closest ecoregion.  If ties, arbitrarily favor 1st one in row-major order[39]   R[1]←R[1]+Z[I;J]=MV[40]  [41]   Q←D×~W[K;L]∊0,MV                                   ⍝         Same for watershed[42]   M←⌊/(,Q≠0)/,Q[43]   V[I;J]←1↑((W[I;J]=MV)↓W[I;J]),((,Q=M)/,W[K;L]),MV  ⍝         and closest watershed[44]   R[2]←R[2]+V[I;J]=0[45]   →L2[46]  [47]  L3:Z WRITEI 1⊃3⊃A[48]   V WRITEI 2⊃3⊃A[49]   →(^/R=0)/0[50]   LOG 'Warning: window in FIXECOSHED is too small for ',(⍕R[1]),' ecoregion cells and ',(⍕R[2]),' watershed cells.'[51]   →0[52]  [53]  what:data prep[54]  type:standard[55]  info:((⊂pathW) PATH¨ 'trouble' 'ecogrid' 'watergrid') ('') ((⊂pathG) PATH¨'ecoregions' 'watersheds') (window÷cellsize) (pathW PATH 'trouble')   ⍝input and result grids, buffer size, and include grid[56]  check:CHECKVAR 'window'[57]  init:(pathW PATH 'ecogrid') GRIDCOPY pathS PATH 'ecoregions'        ⍝Copy ecoregion & watershed grids so we don't have to visit non-troubled blocks[58]  init:(pathW PATH 'watergrid') GRIDCOPY pathS PATH 'watersheds'    ∇