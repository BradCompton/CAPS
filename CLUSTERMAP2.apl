    ∇ CLUSTERMAP2;X;Q;J;I;R;W;Z;K;L;D;T;E;M;buffer;D50;DS;Y;V;sd;sdt;C;H;head;loop;test;noread;grids;ffile;blocksize;ifchat;pars;fn;postland;result;mask;exclude[1]   ⍝Build cluster map for gradient post-processing (step 3)[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer)[3]   ⍝Source:[4]   ⍝   post\settingsclusters.txt   results from cluster.settings()[5]   ⍝   grids\settings              settings variables[6]   ⍝   settings.par                table of settings and weights[7]   ⍝Paramters:[8]   ⍝[9]   ⍝Result:[10]  ⍝   post\clusterland            cluster map of undeveloped land[11]  ⍝[12]  ⍝B. Compton, 15 Nov 2011 (from SIM)[13]  [14]  [15]  THIS IS A NON-METRIC IMPLEMENTATION, MAKES IT EASIER TO CALL IN A POSTG FUNCTION, BUT TOO MUCH EXTRA JUNK,[16]  PLUS, WHEN WE HAVE 1000 CLUSTERS, IT'LL SPEND A FAIR AMOUNT OF TIME IN EUDIST, SO BEST TO BE ABLE TO RUN[17]  IN PARALLEL.  TRASH THIS VERSION.[18]  [19]  [clustermap][20]  blocksize = 1000		; block size to use[21]  postland = 'postland'[22]  result = 'clusterland'[23]  [24]  [25]  [26]   INIT[27]   (pathP PATH 'caps.log') LOG '--- Starting run of CLUSTERMAP, ',NOW,' ---'[28]   ifchat←0[29]   pars←NREAD pathI PATH 'parameters.par'[30]  [31]   READPARS fn←'caps'[32]   READPARS fn←'clustermap'[33]  [34]   buffer←0[35]  [36]   C←TABLE pathE PATH GRIDNAME 'settingsclusters.txt'[37]   H←FRDBL¨↓2 0↓',' MATRIFY head[38]   D←⍉(1,0 ¯2+⍴C)⍴0 2↓C[39]  [40]  [41]   loop←test←noread←0 ⋄ grids←0 0⍴''  ⍝Silly junk for BLOCK, etc.[42]   mask←exclude←''[43]   ffile←'CLUSTERMAP'[44]   BLOCK 2⍴blocksize[45]  [46]  L0:V←X←READ postland[47]   DOT[48]   →(0∊⍴Y←'#' INCLUDE X)/0                ⍝Which cells to run for?[49]   Q←TABLE 'settings'[50]   Q←(Q[;1]∊H)⌿Q                          ⍝Drop excluded settings variables and send the table to SETTINGS[51]   sd sdt ← SETTINGS (Q head) '' 'dist'   ⍝Get ecological settings and tables for distance[52]  [53]   J←↓[1](⍉(⌽⍴X)⍴⍳1↑⍴X),[.5](⍴X)⍴⍳1↓⍴X    ⍝Index matrix[54]   J←(,Y)/,J[55]   X←(,Y)/,X[56]   Z←(⍴X)⍴0[57]  [58]   I←0[59]  L1:→((1↑⍴X)<I←I+1)/L3                   ⍝For each cell,[60]   ⍎((I÷1E4)=⌊I÷1E4)/'BREAKCHECK'[61]   R←,sd[;1⊃I⊃J;2⊃I⊃J] ECODIST D          ⍝   Get ecological distance for focal cell I,J to each cluster[62]   Z[I]←1↑(R=⌊/R)⌿C[;1]                   ⍝   Pick closest cluster (in case of ties, earlier cluster #s win)[63]   →L1[64]  [65]  L3:Z←(⍴Y)⍴(,Y)\Z[66]   (V REMV Z) WRITE pathE PATH result[67]   →(0≠NEXTBLOCK)/L0[68]  [69]   ⎕←''[70]   LOG 'CLUSTERMAP is done.'    ∇