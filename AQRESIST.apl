    ∇ A AQRESIST S;X;J;I;R;Z;K;L;D;G;Y;buffer;head;O;P;fd;Q;sr;srt;bandwidth;search;multiplier;Q;B[1]   ⍝Calculate natural aquatic resistance for graph linkages project[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer)[3]   ⍝Parameters:[4]   ⍝   multiplier      multiplier on contrast to get resistance[5]   ⍝   bandwidth       bandwidth (h) in m[6]   ⍝   search          search distance in s.d.[7]   ⍝This version doesn't do edge correction, and has no example facility. It is used to create natural resistance grid for LINK2GRAPH.[8]   ⍝Note: we don't use diagonals in WETSPREAD, because it gives goofy results...diagonal distances are farther, but we're also building kernels[9]   ⍝at a lower density, so treating all steps as 1 gives consistent results.[10]  ⍝Another note: mask is ignored for this metric, because we need to run for cells outside of mask to get kernel values[11]  ⍝B. Compton, 27 Jul-7 Aug 2017 (from AQCONNECT)[12]  ⍝25 Aug 2017: I screwed up the scaling![13]  [14]  [15]  [16]   buffer←B←4⊃A[17]   READPARS ME[18]   X←READ 1⊃1⊃A                       ⍝Read landcover with streams[19]   Z←(⍴X)⍴MV[20]   Y←S (GRIDNAME 'include') 0 INCLUDE X                      ⍝Which cells to run for?[21]   ⍎(0∊⍴Y)/'Y←(⍴X)⍴0'[22]   X←MVREP X (1≠Q←READ 2⊃1⊃A)         ⍝Read stream centerlines - all land off centerlines is treated as missing[23]   →(^/,0=Y←Y^X≠MV)/L5                ⍝We're only running for stream centerline cells![24]   P←(Q=1)×READ 3⊃1⊃A                 ⍝Read flow grid - only need it for centerline cells[25]  [26]   sr srt ← SETTINGS (2⊃A) 'aquatic' 'resist'     ⍝ Get ecological settings and tables for resistance but not distance[27]   ⎕←'abarriers weight = ',(⍕+⌿(~Q)⌿srt[;3]),'; other weights = ',⍕+⌿(Q←~(TOLOWER¨srt[;1])≡¨⊂'abarriers')⌿srt[;3][28]   sr←Q⌿sr ⋄ srt←Q⌿srt                ⍝drop aquatic barriers, as we're only interested in natural resistance here[29]  [30]   fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1[31]  [32]   D←(⍳1+2×B)-B+1                     ⍝Maximum radius possible to travel[33]   O←1E6×B<DIST 1+B×2                 ⍝Circle mask[34]  [35]  [36]   I←B[37]  L1:→(((1↑⍴X)-B)<I←I+1)/L5                                   ⍝For each row, -----[38]   BREAKCHECK[39]   →(~∨/Y[I;])/L1                                             ⍝   If empty row, skip it[40]   J←B[41]  L2:→(((1↓⍴X)-B)<J←J+1)/L1                                   ⍝   For each column,[42]   →(~Y[I;J])/L2                                              ⍝      If we're doing this cell,[43]   K←I+D ⋄ L←J+D[44]   R←1+multiplier×(srt[;2]×sr[;I;J]) EUDIST sr[;K;L]          ⍝         Resistance values for focal cell I,J.  Focal cell is always 0 for anthro settings.[45]   R←0 MVREP R (X[K;L]=MV)                                    ⍝         Missing cells get resistance of zero--they're rare errors, so just ignore them[46]  L3:→(search≥3)/L4                                           ⍝         If search < 3,[47]   R←R+O                                                      ⍝            Restrict to circle[48]  [49]  L4:G←(O=0)×WETSPREAD (bandwidth×search÷cellsize) (K⍳I) (L⍳J) ((⍴R)⍴1) (P[K;L]) ⍝         Build a non-resistant kernel through streamflow grid[50]   G←G÷+/,G←(G≠0)×ZDENSITY 3-(G÷bandwidth÷cellsize)×3÷search  ⍝         Weighted Gaussian-scaled stream distance[51]   Z[I;J]←+/,R×G                                              ⍝         Gaussian kernel-distance-weighted ecological distance to cells in the neighborhood[52]  →L2[53]  [54]  L5:(X REMV Z) WRITE 3⊃A[55]   →0[56]  [57]  [58]  [59]  what:auxiliary[60]  type:standard[61]  info:('lands' (pathS PATH 'streams') (pathS PATH 'flow')) ('settings') ('aqresist') (⌈bandwidth×search÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[62]  check:CHECKVAR 'multiplier bandwidth search'[63]  check:CHECKFILE pathT PATH scales    ∇