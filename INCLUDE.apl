    ∇ Z←S INCLUDE X;Q;A;M;N;C;Y;T;L[1]   ⍝Determine which cells to run current metric for, give block of land ⍵, groups 1⊃⍺, and buffer 2⊃⍺[2]   ⍝Ignore include if ⍺[3]='', or use specified alternate[3]   ⍝Skip mask if ⍺[4][4]   ⍝Return a second mask for maskbits group ⍺[5] if it's not empty[5]   ⍝If ⍺[6], treat maskv as binary and don't use MASKBITS on it[6]   ⍝Input grids:[7]   ⍝   include     include grid, or alternative specified in ⍺[3][8]   ⍝Globals:[9]   ⍝   example     example points[10]  ⍝   le          examples for LINKAGES[11]  ⍝   mask        name of mask grid[12]  ⍝   maskv       mask variable[13]  ⍝   exclude     list of cover classes to exclude (comma-delimited)[14]  ⍝[15]  ⍝   Mask rules when running CAPS for a clipped landscape:[16]  ⍝   To find buffers for metrics, initialize with[17]  ⍝       SETPATHS ⋄ pars←NREAD pathI PATH 'parameters.par' ⋄ READPARS 'CAPS'[18]  ⍝   then type GETBUFFER 'connect' 'cats' 'traffic' to get buffer sizes[19]  ⍝      1. For connect and aconnect, mask is landscape + buffer + (buffer again if running in LINKAGES or CSE situation)[20]  ⍝      2. For watershed metrics, mask is full watershed above anything in landscape[21]  ⍝      3. For other metrics, mask is landscape + max buffer for metrics[22]  ⍝[23]  ⍝Note: normally passed land, but if groups include streams, need to use lands to get streams on top of roads[24]  ⍝B. Compton, 23-24 Sep 2010[25]  ⍝3 Feb 2011: allow specifiying alternate include grid[26]  ⍝18 Feb 2011: don't bomb on duplicate synonyms[27]  ⍝10 Feb 2012: allow skipping mask; 16 Feb oops[28]  ⍝15 and 21 Aug 2012: add maskbits facility (applies to both mask grid and mask variable); 16 Aug 2012: document mask rules[29]  ⍝17-18 and 24 Sep 2012: return a second mask (for the core) for ⍺[5][30]  ⍝26 Sep 2012: do everything to second mask in parallel (grr).  Obama up by 9 and 10 in Florida and Ohio.[31]  ⍝Add option to treat maskv as binary, for watershed metrics[32]  ⍝6-7 Jun 2013: masks were returned in reversed order! 1st mask is complete, second is core[33]  ⍝10 Jun 2013: if ⍺[5] (2nd mask), don't zero out buffer in EXAMPLEINIT - it screws up CONNECT[34]  ⍝25 Nov 2014: it's possible to not initally set Y - make sure it exists (Back on Glyptemys after Dell tech trashes Alosa. Sigh.)[35]  ⍝21 Jun 2017: oops--we were using global buffer, not buffer passed in to metric! (summer solstice)...[36]  ⍝22 Jan 2018: Drop buffer arg, as we actually want to use the global buffer, as this function is always called after the block is set. I changed EXAMPLEINIT to use block[3].[37]  [38]  [39]  [40]   S A M C L ← 5↑S,0 0 0 0                        ⍝Groups, ignore include, skip mask, return 2nd mask, treat maskv as binary[41]   ⍎(C≡0)/'C←'''''[42]   ⍎(A≡0)/'A←GRIDNAME ''include'''                ⍝Default include grid is 'include'[43]   Y←1[44]   →(0∊⍴Z←EXAMPLEINIT 0≠⍴C)/L8                    ⍝Check for example points (buffer is zeroed out here unless two masks)[45]   →(0=⎕NC'maskv')/L1                             ⍝If mask variable supplied,[46]   →(0∊⍴maskv)/L1[47]   Z←Z^0≠((~L)/CALLINGMETRIC) MASKBITS maskv      ⍝   mask with it, using appropriate mask for metric if maskbits facility is in use[48]   →(0∊⍴C)/L1                                     ⍝   If second mask requested,[49]   Y←C MASKBITS maskv                             ⍝      get it (it's a subset)[50]  [51]  L1:→(M∨0∊⍴mask)/L2                              ⍝If mask grid supplied and we're not skipping it,[52]   N←READ mask                                    ⍝   read mask[53]   N←0 MVREP N ((N=MV)∨N<0)[54]   Z←Z^0≠CALLINGMETRIC MASKBITS N                 ⍝   if maskbits facility is in use, use appropriate mask for metric[55]   :if ~0∊⍴C                                      ⍝   If second mask requested,[56]      Y←C MASKBITS N                              ⍝      get it (it's a subset)[57]   :endif[58]  [59]  L2:Z←Z^X≠MV                                     ⍝Exclude missing cells in land[60]   :if ~0∊⍴C                                      ⍝   If second mask requested,[61]      Y←Y^X≠MV[62]   :endif[63]   →('#*×'∊S)/L3                                  ⍝If not running for all groups,[64]   Z←Z^T←X∊(0 'groups.par' LOOKUP 0,[1.5]((S⍳S)=⍳⍴S)/S←FRDBL S)[;1]⍝   Land classes to run for[65]   :if ~0∊⍴C                                      ⍝   If second mask requested,[66]      Y←Y^T[67]   :endif[68]  [69]  L3:→(0=⎕NC'exclude')/L4                         ⍝If any cover types are excluded,[70]   →(0∊⍴exclude)/L4[71]   Z←Z^T←~X∊⊃,/LOOK¨FRDBL¨↓','MATRIFY exclude     ⍝   exclude them[72]   :if ~0∊⍴C                                      ⍝   If second mask requested,[73]      Y←Y^T[74]   :endif[75]  [76]  L4:→(~∨/,Z)/L9                                  ⍝If still running for some cells,[77]   →(0∊⍴A)/L8                                     ⍝   If ignoring INCLUDE, get out now[78]   Z←Z^T←0<READ GRIDNAME A                        ⍝   finally, read include grid & exclude all 0 and missing (and any negative values)[79]   :if ~0∊⍴C                                      ⍝   If second mask requested,[80]      Y←Y^T[81]   :endif[82]  [83]   →(∨/,Z)/L8                                     ⍝If not running for any cells in block,[84]  L9:Z←Y←⍳0                                       ⍝   empty result[85]  [86]  L8:[87]   :if ~0∊⍴C                                      ⍝If returning two masks,[88]      ⍎(0=⎕NC'Y')/'Y←Z'[89]      Z←Y Z[90]   :endif    ∇