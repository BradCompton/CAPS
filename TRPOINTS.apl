    ∇ TRPOINTS;F;M;Z;I;D;B;threshold;head;T;pars;W;X;U;C[1]   ⍝Prepare tidal restriction point data for TR metric[2]   ⍝This is Step 1, followed by trpoints.aml, then trpoints().[3]   ⍝Source:[4]   ⍝   \GIS\Coastal\TR\tr_field_points.txt     field-measured TR points (x_coord, y_coord, Rest_ft)[5]   ⍝   source\coastcrossings.txt               modeled TR crossings (x-coord, y-coord)[6]   ⍝   source\troutflow.txt                    outflow points in coastal zone (from findwatersheds.aml)[7]   ⍝   tables\bigwatershedtable.txt            big watersheds[8]   ⍝   tables\tinywatershedtable.txt           tiny watersheds[9]   ⍝Results:[10]  ⍝   working\trdata.txt                      combined dataset (x-coord, y-coord, surveyed, rest_m, snap_distance, site_name)[11]  ⍝   working\trxy.txt                        same thing, but only x and y for sample in AML[12]  ⍝   tables\trbigwatersheds.txt              big watershed table for tidal restrictions metric[13]  ⍝   tables\trtinywatersheds.txt             tiny watershed table for TR[14]  ⍝B. Compton, 19-20 Jan 2011[15]  ⍝14-17 Feb 2011: Also build TR watershed tables[16]  ⍝4 Jun 2012: deal with two separate watershed tables.[17]  [18]  [19]  [20]   threshold←70           ⍝Distance threshold (m) - move field points to nearest modeled crossing within this[21]  [22]   SETPATHS[23]   F←(1,⎕TCHT) MATIN 'd:\GIS\Coastal\TR\tr_field_points.txt'[24]   F←F[;(TOLOWER ⎕TCHT MATRIFY head) MATIOTA MATRIFY 'x_coord y_coord rest_ft site_name'][25]   M←MATIN pathS PATH 'coastcrossings.txt'[26]   M←M[;(TOLOWER MATRIFY head) MATIOTA MATRIFY 'x-coord y-coord'][27]  [28]   F[;3]←F[;3]÷3.28                               ⍝Convert feet to meters[29]   F←F,0                                          ⍝Add column: snap_distance[30]   Z←M,(((1↑⍴M),3)⍴0),⊂''                         ⍝Add columns: surveyed, rest_m, snap_distance, site_name[31]   I←0[32]  [33]  L1:→((1↑⍴F)<I←I+1)/L2                           ⍝For each field point,[34]   D←(((F[I;1]-M[;1])*2)+(F[I;2]-M[;2])*2)*.5     ⍝   Point distances[35]   F[I;5]←''⍴(B←D=⌊/,D)/D                         ⍝   Closest point (take one arbitrarily if multiple)[36]   →(F[I;5]>threshold)/L3                         ⍝   If within threshold distance,[37]   Z[''⍴B/⍳1↑⍴M;3 4 5 6]←1,F[I;3 5 4]             ⍝      Assign to modeled crossing[38]   →L1                                            ⍝   Else,[39]  L3:Z←Z⍪F[I;1 2],1,F[I;3],¯1,F[I;4]              ⍝      Add to modeled points (snap distance = ¯1)[40]   →L1[41]  [42]  L2:⎕←'Distribution of point distances (below threshold of ',(⍕threshold),' m):',⎕TCNL[43]   ⎕←20 50 HIST (Z[;3]≠0)/Z[;5][44]  [45]   head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord rest_m snap_distance site_name'[46]   F[⍒F[;5];] TMATOUT T←pathW,'tr_field_point_distances.txt'[47]   ⎕←'Field points with distances written to ',T[48]   ⎕←'Have a look and adjust threshold as necessary.'[49]   ⎕←''[50]   head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord surveyed rest_m snap_distance site_name'[51]   Z TMATOUT T←pathW,'trdata.txt'[52]   head←''[53]   Z[;1 2] TMATOUT pathW,'trxy.txt'[54]   ⎕←'Merged TR point data written to ',T,'.  Now &r trpoints in Arc.'[55]  [56]  [57]   ⍝Now build trwatershedtable.txt for TR[58]   pars←NREAD pathI PATH 'parameters.par'[59]   READPARS 'watershed'[60]   READPARS 'tr'[61]   X←0 1 TABLE pathT PATH 'bigwatersheds.txt'             ⍝Read big watershed table[62]   C←0 0 TABLE pathS PATH 'troutflow.txt'                 ⍝Read outflow points in coastal zone[63]   X←((X[;1]∊C[;1])^X[;2]=1)⌿X                            ⍝Only want these, for full watersheds only[64]   head←1↓⎕TCHT MTOV MATRIFY 'watershed what x-coord y-coord xmin ymin xmax ymax'[65]   X TMATOUT T←pathT PATH 'trbigwatersheds.txt'[66]  [67]   X←0 1 TABLE pathT PATH 'tinywatersheds.txt'            ⍝Read tiny watershed table[68]   X←(X[;1]∊C[;1])⌿X                                      ⍝Only want these[69]  [70]   head←1↓⎕TCHT MTOV MATRIFY 'watershed x-coord y-coord'[71]   X TMATOUT U←pathT PATH 'trtinywatersheds.txt'[72]  [73]   ⎕←⎕TCNL,'Watershed tables for TR written to ',T,' and ',U,'.  Rerun TRPOINTS if you change tinywatershed threshold.'    ∇