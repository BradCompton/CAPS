    ∇ Z←FIXFLOW2 X;cross;C;B;J;E;P;N;Q;R;Y;T;H;G;F;D[1]   ⍝Fix CAPS road/railroad grid ⍵ where streams run along roads[2]   ⍝Return road/railroad, with bogus crossings dropped and new road running alongside[3]   ⍝Called from DOFIXFLOW[4]   [5]   [6]   OBSOLETE[7]   [8]    FINDCROSS X                  ⍝Find all true road crossings[9]    C←(X≠0)^DOWNFLOW cross       ⍝Mark true crossings[10]   D←B←(~C)^(~X∊0,MV)^0≠strflow ⍝Bogus crossings[11]   R←0≠X+C[12]  [13]   B←B^~T←B^R^1=FOCALSUM4 R     ⍝1-cell cul-de-sacs and dead-ends get dumped[14]   X←X×~T[15]   Z←(⍴X)⍴0[16]  [17]  L1:→(~1∊B)/L2                 ⍝Until fixed them all,[18]   J←1+(1 0+⍴B)⊤¯1+(,B)⍳1       ⍝   Next bogus crossing[19]   Y←B FIND1PATCH J             ⍝   Find bogus patch[20]   E←BUFFER8 Y                  ⍝   Buffer it (8-neighbor rule)[21]   E←E^(strflow=0)^(~flc∊LOOK 'dams')  ⍝   Only allow new roads where no streams or dams[22]   P←FINDPATCH4 E               ⍝   Make patches of potential roads[23]   Q←P×R                        ⍝   Patches falling on roads, railroads, and true crossings[24]   N←(~R)^P∊(,Q≠0)/,Q           ⍝   New road cells = nonroad patches that connect roads[25]  [26]   ⍝Each new patch of roads must be orthogonally adjacent to at least 2 roads/crossings[27]   F←(0≠X)^~B                   ⍝   Roads and not bogus crossings[28]   F←(0,0 ¯1↓F)+((0 1↓F),0)+(0⍪¯1 0↓F)+(1 0↓F)⍪0   ⍝   Focal sum[29]   H←FINDPATCH4 N               ⍝   Road patches[30]   G←(,H),[1.5],F[31]   G←(G[;1]≠0)⌿G[32]   G←G[⍋G;][33]   G←G,G[;1]≠¯1↓0,G[;1][34]   G←(G[;3]⌿G[;,1]),G[;3] pSUM G[;2]  ⍝   Zonal sum[35]   N←N^(G⍪0)[G[;1]⍳H;2]≥2       ⍝   At least 2 adjacent roads[36]  [37]   B←B^~Y                       ⍝   Bogus crossings fixed[38]   Z←Z⌈N[39]   →L1[40]  [41]  L2:⍝Finished modifying roads for bogus crossings.  Now add culverts & bridges[42]   C←C×((LOOK 'culvert')×~T)+(LOOK 'bridge')×T←streams∊LOOK 'things with bridges'     ⍝Culvert or bridge (bridges are on rivers)[43]   X←X+Z×FOCALMAJORITY X        ⍝   Mark new roads with most prevalent road in 3×3 neighborhood[44]   X←X×~D                       ⍝   Knock out bogus road cells[45]   Z←(X×C=0)+C×X≠0    ∇