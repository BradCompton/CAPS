    ∇ A IEISTATS S;buffer;exclude;loop;test;noread;grids;ffile;tilesize;E;Z;N;X;R;R;rangeslice;C;U;tilemapinclude;skiptilemap;range;acores;I;B;Q;head;D;O;V;V2;lookedup;W;source;regions;Y;result;F;omitnodata;flagrange[1]   ⍝Calculate stats for IEI by HUC6 and ecologal system[2]   ⍝Parameters:[3]   ⍝   source              name of source IEI grid, selection index, or binary cores[4]   ⍝   regions             name of region grid (usually HUC6)[5]   ⍝   result              postfix of result file (in working\)[6]   ⍝   omitnodata          if 1, omit omitnodata, if 0, treat omitnodata in source grid as 0 (use this when running for binary cores)[7]   ⍝   flagrange           range of values to flag[8]   ⍝   tilesize            size of tiles (in cells)[9]   ⍝   targets = '1:1'     needs to be in parameters.par to run a single thread[10]  ⍝Runs as a CAPS metric, but only uses one thread.  It'll be fastest if you set host = 'w00'.[11]  ⍝B. Compton, 20 Mar 2017 (from ACORESTATS; 1st day of spring, with plenty of snow on the ground)[12]  ⍝30 Mar 2017: add omitnodata option so I can run this for cores; add flagrange[13]  [14]  [15]  [16]   READPARS ME[17]   buffer←4⊃A[18]   exclude←''[19]   loop←test←noread←0 ⋄ grids←0 0⍴''              ⍝Silly junk for BLOCK, etc.[20]   ffile←'IEISTATS '[21]   BLOCK (2⍴tilesize),buffer[22]   SETTILE[23]  [24]   tilemapinclude←0[25]   skiptilemap←0                                  ⍝Don't let DEBUG sabotage this[26]   E←TILEMAP '' tilesize 0 0                      ⍝Get tilemap, building it if necessary. This will only help if there's mask grid.[27]   ⎕←'Running IEISTATS on ',(⍕+/E),' tiles' ⋄ FLUSH[28]   Z←0 4⍴0                                        ⍝Running summary: [1] HUC; [2] ecological system, [3] count of cells, [4] sum of IEI[29]  [30]  [31]   N←0[32]  L1:→(~E[N←N+1])/L2                              ⍝Repeat: read tile (1st time through tiles), skip if not in tilemap    --- For each tile ---[33]   DOT[34]   BREAKCHECK [35]   X←READ 1⊃1⊃A                                   ⍝   Read landcover grid [36]   R←READ 2⊃1⊃A                                   ⍝   regions grid[37]   Y←READ 3⊃1⊃A                                   ⍝   IEI grid[38]   Y←(MV×omitnodata) MVREP Y                          ⍝   if omitnodata=0, treat omitnodata as 0[39]   [40]   B←,(X≠MV)^(R≠MV)^Y≠MV                          ⍝   drop everything that's missing in any grid (probably just IEI) [41]   Q←B⌿(,R),(,X),[1.5],Y                          ⍝   regions, systems, IEI[42]   Q←Q[⍋Q;][43]   B←∨/Q[;⍳2]≠¯1 0↓0⍪Q[;⍳2][44]   Z←Z⍪(B⌿Q[;⍳2]),(B pSUM (1↑⍴Q)⍴1),[1.5]B pSUM Q[;3]⍝   region, system, count, sum[45]  L2:→(0≠NEXTBLOCK)/L1                            ⍝Until no more tiles[46]   [47]   [48]   Z←Z[⍋Z[;⍳2];]                                  ⍝Sort by region and system[49]   B←∨/Z[;⍳2]≠¯1 0↓0⍪Z[;⍳2][50]   Z←(B⌿Z[;⍳2]),(B pSUM Z[;3]),[1.5]B pSUM Z[;4]  ⍝Summarize by region and system[51]   Z←Z,Z[;4]÷Z[;3]                                ⍝Mean[52]   Z←Z[;⍳2],landcover[landcover[;1]⍳Z[;2];2],0 2↓Z⍝Look up system name [53]   head←1↓⎕TCHT MTOV MATRIFY 'Region Class System Count Sum Mean'[54]   Z TMATOUT F←pathW,'summary_',result,'.txt'[55]   flagrange IEISTATS2 F[56]   LOG 'IEISTATS is done.'[57]   →0[58]  [59]  [60]  what:auxiliary[61]  type:table[62]  info:('dslland' regions source) ('') ('') 0 ''      ⍝Source grid, settings table, result grid, buffer size, and include grid[63]  check:CHECKVAR 'regions source result omitnodata flagrange tilesize targets'    ∇