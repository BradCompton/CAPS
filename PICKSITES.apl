    ∇ S PICKSITES N;X;I;L;H;Q;A;CELLSIZE;pc;head;T;P;R;V;C;Y[1]   ⍝Delineate top ⍵ high-value sites for reserve radius, search distance, and multiplier ⍺[2]   ⍝⍺[1] spread is radius of largest reserve in sea of IEI/HRC/whatever = 1, in meters[3]   ⍝⍺[2] window radius in meters[4]   ⍝Source data (specify with global variables):[5]   ⍝   path        path to sitelocs.txt and default path to value grid[6]   ⍝   pathR       path to result grids[7]   ⍝   pathA       path to smooth.aml[8]   ⍝   value       name of grid with values ranging from 0 to 1; this can be IEI, HRC, or other measure of value[9]   ⍝   contours    one of:[10]  ⍝                   list of 1 or more percent contours (default = 90 95 99)[11]  ⍝                   0, list of 1 or more target reserve sizes in ha (these will be approximate)[12]  ⍝Results:[13]  ⍝   pathR\sitelocs<contour>[14]  ⍝path\sitelocs.txt must be created by picksites.aml, havesites.aml, or by hand[15]  ⍝If there are ties in the sitelocs value field, more than ⍵[1] sites may be selected[16]  ⍝Sites files are written to pathR[17]  ⍝Requires smooth.aml in path[18]  ⍝B. Compton, 29 Jan 2010, from PICKSITE (27-30 Mar 2006, 14 Apr 2006, 5 May 2006, 20 Jul 2009)[19]  ⍝29 Jul 2011: generalize and simplify; allow specifying target size rather than contours[20]  ⍝9 Aug 2011: Expect already-defined resistance grid; don't mess with it; simplify input parameters[21]  [22]  [23]  [24]   ⍎(0=⎕NC'S')/'S←10000 10000'         ⍝Radius, search distance, and multiplier[25]   C←90 95 99 ⋄ ⍎(0≠⎕NC'contours')/'C←contours'[26]   V←path PATH value                  ⍝Value grid[27]   GRIDINIT ''[28]   L←MATIN path PATH 'sitelocs.txt'[29]   SETWINDOW V[30]   S←⌈S÷CELLSIZE                      ⍝Spread and window in terms of cells[31]  [32]   L←L[⍒L[;3];]                       ⍝Sort by IEI[33]   L←(L[;3]≥L[N⌊1↑⍴L;3])⌿L            ⍝Top ⍵ sites[34]   L←L,1 1⍉+\L[;4]∘.=L[;4]            ⍝Rank within ecoregion[35]  [36]   Q←(RJUST MIX ⍕¨L[;5]),MIX T\(T←1≠+/Q)/' ',¨,'#',¨⍕¨1 1 ⍉+\Q←L[;5]∘.≡L[;5]  ⍝Build site names[37]   T←∨/' '≠R←MIX ⍕¨L[;6][38]   Q←FRDBL LJUST HITOLOW (RJUST R),(MIX' ' ' ('[T+1]),LJUST (RJUST Q),' ' ')'[T+1][39]   R←⎕AV[97+⍳27][(A←⎕AV[65+⍳26])⍳T←,Q]⍝Use nice caps for site names[40]   T←(((T∊A)^¯1⌽T∊A)⌽T,[1.5]R)[;1][41]   Q←(⍴Q)⍴'. Wma . WMA . Nwr . NWR . Sf . SF . Sp . SP . Cr . CR ' TEXTREPL T[42]   T←(L,(↓Q),[1.5]⍳1↑⍴L)[;9 7 3 4 1 2 8]   ⍝Site name (from open space + town); rearrange[43]   head←'rank,ecorank,IEI,region,x-coord,y-coord,sitename'[44]   T CMATOUT Q←PATH 'top.txt'[45]   ⎕←'Top sites written to ',Q        ⍝Write sites file (to join with polygon files)[46]  [47]   L←(↑FINDCELL¨↓L[;1 2]),0 2↓L[48]   ⎕←'Building contours (',((C[1]=0)/'sizes ',(⍕1↓C),' ha'),((C[1]≠0)/⍕C),') for top ',(⍕1↑⍴L),' sites...'[49]  [50]   P←(0,(-0=1↑C)+⍴C)⍴⊂''[51]   A←'/* arc.aml - automatically generated by PICKSITES' OVER '&s blank'[52]   I←0[53]  L1:→((1↑⍴L)<I←I+1)/L2                       ⍝For each site,[54]   SETWINDOW V                                ⍝   Make sure we have our window for the input grid[55]   Y←READBLOCK (⊂V),L[I;1 2],1 1,S[2]-1          ⍝   Read IEI[56]   H←1E6 MVREP Y                              ⍝   nodata → 0[57]   ⍝⍝⍝H←1+S[3]×0⌈1-H                             ⍝   rescale IEI into resistance[58]   X←SPREAD (S[1]) (S[2]) (S[2]) H            ⍝   build kernel[59]   X←MVREP X (Y=MV)                           ⍝   cells off of edge of landcover ← nodata[60]   Q←(Q≠MV)/Q←,X[61]   Q←Q[⍒Q][62]   →(C[1]=0)/L5                               ⍝   If contours specified,[63]   Q←Q[+⌿(+\Q)∘.≤(+/Q)×C÷100]                 ⍝      pick contours[64]   →L6                                        ⍝   Else,[65]  L5:Q←Q[(⍴Q)⌊⌈(1E4×1↓C)÷CELLSIZE*2]          ⍝      pick by area[66]  L6:A←A OVER 'grid'[67]   A←A OVER MIX (T←'s',¨(⍕¨I),¨'-',¨(⍕¨(C[1]=0)↓C)),¨'a',¨(⊂' = gridpoly(setnull(site'),¨(⍕¨I),¨(⊂' < '),¨(HITOLOW¨⍕¨Q),¨⊂',1))'[68]   A←A OVER 'q'[69]   A←A OVER MIX (⊂'&r smooth '),¨T,¨(⊂'a '),¨T[70]   A←A OVER MIX (⊂'kill '),¨T,¨'a'[71]   A←A OVER 'tables'[72]   A←A OVER MIX (⊂'additem '),¨T,¨⊂'.pat rank 4 4 i'[73]   A←A OVER MIX (⊂'sel '),¨T,¨(⊂'.pat',⎕TCNL,'calc rank = '),¨⊂⍕I[74]   A←A OVER 'q'[75]   A←A OVER MIX (⊂'tolerance '),¨T,¨⊂' fuzzy 1'[76]   P←P⍪T[77]  [78]   Q←WINDOW[3 4]+CELLSIZE×(L[I;2]-S[2]),1+WINDOW[2]+S[2]-1+L[I;1]+1↑⍴X[79]   MAKEWINDOW (⌽⍴X),Q,CELLSIZE[80]   X WRITEGRID pathR PATH 'site',⍕I[81]   →L1[82]  L2:I←0[83]  L3:→((1↓⍴P)<I←I+1)/L4               ⍝For each countour interval,[84]   A←A OVER 'mapjoin sitelocs',⍕C[I+C[1]=0][85]   A←A OVER MIX P[;I][86]   A←A OVER '⋄' MATRIFY '%blank%⋄y⋄y⋄⋄/* done'[87]   →L3[88]  L4:⍝A←A OVER 'q' OVER 'del arc.aml'[89]   (MTOV A) NWRITE pathR PATH 'finish.aml'   ⍝   Write out arc.aml and run it[90]   ⎕←'Site grids and contours written to ',pathR,'.  Finish off by in Arc with:'[91]   ⎕←'   &r ',pathR,'finish'    ∇