    ∇ A MAKEMIXWATER S;buffer;B;X;P;C;F;I;transparent;Z;J;M;D;T;Q;K;R;V;W;N;L;offset;E;Y;U;O;window;mixwater;head;fd;lotic;power;H[1]   ⍝Set up data for MIXWATER[2]   ⍝Runs as a CAPS block metric.[3]   ⍝Inputs (all in source\):[4]   ⍝   lands           Land use/wetlands, streams (on top), and roads/railroads[5]   ⍝   pondids         Grid of IDs for each pond[6]   ⍝   streams         Stream centerline & off-centerline cells[7]   ⍝   flow            D8 flow grid[8]   ⍝   fd8accum        FD8 flow accumulation grid[9]   ⍝   tables\biglakes.txt    table of lakes[10]  ⍝Parameters:[11]  ⍝   mixwater.par    Table with 'pond' or 'river' for each cover type in luwet[12]  ⍝   window          How far (in cells) to search for centerlines in river mixing? (<=buffer!) 26 is good.[13]  ⍝   buffer          Edge buffer[14]  ⍝   power           Power for inverse weighting stream size to pick centerlines for river mixing. Use 0 to omit stream size (old[15]  ⍝                   behavior), 1 to weight by ln(stream size), and higher power to increase influence of stream size.[16]  ⍝Results:[17]  ⍝   source\mixwater         Encoded water mixing grid[18]  ⍝   tables\mixfringes.txt   Table of fringing wetlands[19]  ⍝Must also run companion table metric, MAKEMIXLAKES, simultaneously (to avoid killing shared result grid)[20]  ⍝Notes:[21]  ⍝   1. No need to mix small streams (those in streams but not luwet), as they're only 1 cell wide[22]  ⍝   2. buffer should be >> (big lake threshold in makemixpond.aml × 1E4)*.5[23]  ⍝   3. window must be ≤ buffer[24]  ⍝   4. Maximum centerline offset is 50 cells[25]  ⍝   5. When there are rivers without centerlines, you'll get *** Warning: skipped n river cells.  This is okay;[26]  ⍝      MIXWATER will take focal mean of adjacent lotic (8 neighbor rule) for these cells.  Have a look to see[27]  ⍝      if buffer is too small with the following in Arc/grid.  If points are on edge of centerline rivers, window is too small[28]  ⍝         trouble = gridpoint(setnull(not(..\grids\land == 51 & isnull(..\source\mixwater) & isnull(..\source\streams)),1))[29]  ⍝   6. Fringing wetland basins on edges of rivers get flow from the river, unless the river centerline flows into them or they[30]  ⍝      flow to the river via centerlines.  Note that this does not happen for lakes, but only for smaller wetland basins.[31]  ⍝B. Compton, 1-3 and 10 Sep 2010[32]  ⍝23 Sep 2010: use land, not luwet[33]  ⍝12 Oct 2010: mix centerline flow from adjacent river for fringing wetlands[34]  ⍝14 Oct 2010: target inflowing cells just outside of wetland instead of cells within wetlands[35]  ⍝19 Oct 2010: bug when flowing out of landscape and make sure we have proper contributing cells[36]  ⍝25 Oct 2010: round percent contribution so I don't get hammered by rounding errors[37]  ⍝11 Feb 2011: use lands to keep streams on top[38]  ⍝19 Feb 2011: write inflows for watershed metrics[39]  ⍝18 Jul 2011: bug: when 100% of flow came from one cell, we got an integer, thus encoded as centerline mixing[40]  ⍝19 Oct 2011: drop writing inflows - they're not used by watershed metrics any more, and I had a name collision[41]  ⍝20 Jan 2012: Don't allow same flow path to repeatedly visit pond[42]  ⍝16 May 2014: When mixing fringing wetlands, drop centerline cells that are IN our basin--in some cases, double-mixing was happening; rewrite MIXTROUBLE[43]  ⍝27 May 2014: add weighting by stream size when picking centerlines, but not for isolated off-centerlines; 2 Jun: don't get stymied by negative logs and fractional powers[44]  ⍝26 Jun 2015: fix rare ÷0 when weighting by power[45]  [46]  [47]  [48]   READPARS ME[49]   buffer←B←4⊃A[50]   X←READ 1⊃1⊃A                               ⍝Get land (streams on top),[51]   →(^/,MV=(B,B)↓(-B,B)↓X)/0                  ⍝If all missing, bail out[52]   P←0 MVREP READ 2⊃1⊃A                       ⍝pond ids,[53]   C←1=0 MVREP READ 3⊃1⊃A                     ⍝stream centerlines,[54]   F←READ 4⊃1⊃A                               ⍝D8 flow,[55]   W←READ 5⊃1⊃A                               ⍝and FD8 flow accumulation[56]   M←LOOKUP mixwater[57]   M[;2]←'pond' 'river'⍳M[;2]                 ⍝1 = ponds, 2 = rivers, 3 = other[58]   D←P∊(TABLE pathT PATH 'biglakes.txt')[;1]  ⍝Done flag (for pond mixing); start with all big lakes[59]   E←2⍴0[60]   U←(-⌽⍳window),0,⍳window                    ⍝Window offsets for river mixing[61]   Y←Y×window≥Y←DIST 1+2×window               ⍝Distance window for river mixing[62]   Z←(⍴X)⍴MV[63]   fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1[64]  [65]   I←B[66]  L1:→(((1↑⍴X)-B)<I←I+1)/L7                           ⍝For each row,[67]   BREAKCHECK[68]   →(^/X[I;]=MV)/L1                                   ⍝   Skip this row if it's all missing[69]   J←B[70]  L2:→(((1↓⍴X)-B)<J←J+1)/L1                           ⍝   For each column,[71]   →(D[I;J]∨~X[I;J]∊M[;1])/L2                         ⍝      If already done or not in list, on to next cell[72]   →(L3,L5,L2)[M[M[;1]⍳X[I;J];2]]                     ⍝      Case pond, river, or no mixing,[73]  L3:O←1 CLIP P=P[I;J]                                ⍝      POND MIXING. Indices into rectangle enclosing pond + 1 adjacent cell[74]   Q←P[1⊃O;2⊃O]×P[1⊃O;2⊃O]=P[I;J][75]   E[1]←E[1]+T←∨/0≠(,Q[1,1↑⍴Q;]),,Q[;1,1↓⍴Q][76]   →(~T)/L22[77]   LOG '** Pond ',(⍕P[I;J]),' on edge of block. It may be covered by an adjacent block.'[78]   →L4[79]  [80]  L22:R←((0≠2 BUFFER Q)^Q=0)×F[1⊃O;2⊃O]               ⍝         Ring of flows adjacent to pond[81]   N←W[1⊃O;2⊃O]×R DOWNFLOW Q≠0                        ⍝         Mark cells that flow into our basin[82]   N←N×C[1⊃O;2⊃O]∨(M[;2],0)[M[;1]⍳X[1⊃O;2⊃O]]≠2       ⍝         Don't allow off-centerline lotic to flow in[83]   N←F[1⊃O;2⊃O] MIXTROUBLE N                          ⍝         Don't allow same flow path to repeatedly visit pond[84]   N←N DIV +/,N                                       ⍝         In terms of percent[85]   N←0.9999⌊4 ROUND N                                 ⍝         Only keep 4 significant digits (and don't allow 1.0!)[86]   N←(N≠0)×(1000×(P[I;J]÷1000)-⌊P[I;J]÷1000)+N        ⍝         Encode 3 LSD of pondid, 4 MSD of percent contribution[87]  [88]   Z[1⊃O;2⊃O]←(Z[1⊃O;2⊃O]×N=0)+N                      ⍝         Insert into Z[89]  L4:D[1⊃O;2⊃O]←D[1⊃O;2⊃O]∨Q≠0                        ⍝         Mark entire pond done[90]   →L2[91]  [92]  L5:→(C[I;J]=1)/L2                                   ⍝      RIVER MIXING.  Only do if off-centerline.[93]   K L ← I J + ⊂U                                     ⍝         Indices into window[94]   H←0≠+/,(3 3⍴0 1)×(~C[I+¯1 0 1;J+¯1 0 1])×2=(M⍪0)[M[;1]⍳X[I+¯1 0 1;J+¯1 0 1];2]    ⍝         Want no other lotic off-centerline neighbors, 4-neighbor rule[95]   V←T=⌊/(,T≠0)/,T←(Y×C[K;L])÷(0.01⌈LN W[K;L])*power×H⍝         Closest centerline cell(s), inverse weighted by power of stream size, but not for isolated cells[96]   E[2]←E[2]+T←^/,V=0                                 ⍝         If no centerlines in window, give a warning[97]   Z[I;J]←0                                           ⍝            and set mixwater to 0 (we'll do focal mean for these)[98]   →T/L2                                              ⍝         and bail out[99]   →(1=+/,V)/L6                                       ⍝         If more than one closest centerline,[100]  V←(⌈/,T)=T←V×W[K;L]                                ⍝         Take one with largest flow accumulation[101]  V←(⍴V)⍴(,V)×¯1⌽^\,~V                               ⍝         In the unlikely event there's still a tie, take northwestern-most[102] L6:Q←,((,V)⌿,⍉(⍴V)⍴U),[1.5](,V)/,(⍴V)⍴U             ⍝         Offset[103]  Z[I;J]←100⊥Q+50                                    ⍝         Save encoded offset (decode with ¯50+100 100⊤Z[I;J]) - maximum offset is +/- 50 cells[104]  →L2[105] [106] [107] ⍝Now run rivers into fringing wetlands[108] L7:Y←0 4⍴0[109]  L←((L⍳L)=⍳⍴L)/L←(L≠0)/L←,(2⍴B)↓(-2⍴B)↓P×BUFFER R←X=LOOK lotic       ⍝Unique basin ids adjacent to lotic[110]  I←0[111] L8:→((⍴L)<I←I+1)/L13                                ⍝For each potential fringing basin,[112]  O←(window+1) CLIP P=L[I]                           ⍝   Get our landscape (with maximum river centerline buffer + 1)[113]  Q←P[1⊃O;2⊃O]×L[I]=P[1⊃O;2⊃O]                       ⍝   our basin[114]  M←R[1⊃O;2⊃O]^BUFFER Q≠0                            ⍝   cells of river adjacent to our basin[115]  J←INDICES M                                        ⍝   Indices of adjacent lotic cells[116] [117]  B←(C[1⊃O;2⊃O]SCATI J)∨MV≠Z[1⊃O;2⊃O] SCATI J        ⍝   Bad flag and done flag[118]  B←B^0≠Z[1⊃O;2⊃O] SCATI J                           ⍝   Must be nonzero in case of missing centerlines[119]  N←J←J+((⍴J)⍴2/~C[1⊃O;2⊃O] SCATI J)×⍉¯50+100 100⊤Z[1⊃O;2⊃O] SCATI J   ⍝   Indices to centerlines for adjacent lotic cells[120]  B←B^((↓J)⍳↓J)=⍳1↑⍴J                                ⍝   Drop duplicates[121]  D←B←B^B\0=Q SCATI B⌿J                              ⍝   Drop centerline cells that are IN our basin[122] [123]  K←0[124] L9:→((window+1)<K←K+1)/L10                          ⍝   For number of cells in window,[125]  N←D⍀F[1⊃O;2⊃O] NEXTFLOW D⌿N                        ⍝      flow down[126]  D←D^^/N≠0                                          ⍝      if we've flowed out of landscape, we'll get 0s from NEXTFLOW[127]  B←B^D\~L[I]=Q SCATI D⌿N                            ⍝      if we reach our basin, drop this centerline cell[128]  D←B^D^(^/N≥1)∨^/N≤(⍴N)⍴⍴Q                          ⍝      stop following flows if we reach or basin or flow out of window[129]  →L9[130] L10:J←B⌿J[131]  →(0∊⍴J)/L8                                         ⍝   If no more lotic cells, we're done[132]  N←(⍳1↑⍴J),J[133]  K←0[134] L11:→((window+1)<K←K+1)/L12                         ⍝   For number of cells in window,[135]  →(0∊⍴N←((^/N[;2 3]>1)^^/N[;2 3]<((1↑⍴N),2)⍴⍴Q)⌿N)/L11              ⍝      Don't look at edge cells[136]  N←((⊃¨⍴¨T)/N[;1]),⊃⍪/T←(⊂C[1⊃O;2⊃O]×F[1⊃O;2⊃O]) FLOWINTO¨↓N[;2 3]  ⍝      Follow up centerline cells that flow into our lotic targets[137]  N←(~N[;1]∊(0≠Q SCATI N[;2 3])/N[;1])⌿N             ⍝      Drop cells that flow from our basin[138]  →(~0∊⍴N)/L11[139] [140] L12:J←J[((N⍳N)=⍳⍴N)/N←N[;1];]                       ⍝   Lotic cells still standing[141]  →(0∊⍴J)/L8                                         ⍝   If no more lotic cells, we're done[142] [143]  J←((T=⌈/T←W[1⊃O;2⊃O] SCATI J)⌿J)[1;]               ⍝   Take centerline cell with max flow accumulation[144]  K←INDICES (~Z[1⊃O;2⊃O]∊0,MV)×(BUFFER Q≠0)×(1000×(L[I]÷1000)-⌊L[I]÷1000)=⌊0 MVREP Z[1⊃O;2⊃O]×BUFFER Q≠0    ⍝   Cells contributing to mixing for this basin[145]  N←N÷+/N←W[1⊃O;2⊃O] SCATI K⍪J                       ⍝   Recalculate percentages[146]  N←0.9999⌊4 ROUND N[147]  T←(U←¯1↓N≠0)/¯1↓(1000×(L[I]÷1000)-⌊L[I]÷1000)+N    ⍝   Encode 3 LSD of pondid, percent contribution.  Drop zeros.[148] [149]  Z←Z SCATR (U⌿((⍴K)⍴⊃¨O)+K-1) T                     ⍝   And save percentages of pond cells for mixwater[150]  J←1 FINDPOINT ((⊃¨O)+J-1)                          ⍝   Convert target centerline cell to point[151]  Y←Y⍪L[I],J,N[⍴N]                                   ⍝   Save pond id, target centerline cell, and percent contribution[152]  →L8[153] [154] L13:Y←(Y[;4]≠0)⌿Y                                   ⍝In the unlikely event that any fringing streams contribute 0, drop them[155]  →(0∊⍴Y)/L14[156]  Y LOCKWRITE pathT PATH 'mixfringes.txt'            ⍝Write results to table[157] [158] [159] L14:→(E[1]=0)/L15[160]  LOG '*** Warning: skipped ',(⍕E[1]),' pond',((E[1]≠1)/'s'),' on edge of block; buffer is too small given threshold used for big lakes in makemixpond.aml'[161] L15:→(E[2]=0)/L16[162]  LOG '*** Warning: skipped ',(⍕E[2]),' river cell',((E[2]≠1)/'s'),' because window is too small to reach centerlines (see comments)'[163] [164] L16:transparent←1                                   ⍝Write grid in transparent mode, to not interfere with MAKEMIXLAKES[165]  (X REMV Z) WRITE 3⊃A[166]  →0[167] [168] what:data prep[169] type:standard[170] init:head←1↓⎕TCHT MTOV MATRIFY 'pond x y percent' ⋄ (0 0⍴'') TMATOUT pathT PATH 'mixfringes.txt'                                ⍝Write result table header[171] info:((⊂pathS) PATH¨ (pathG PATH 'lands') 'pondids' 'streams' 'flow' 'fd8accum') ('') (pathS PATH 'mixwater') (⌈buffer÷cellsize) 'luwet'  ⍝Source grid, settings table, result grid, and buffer size[172] check:CHECKVAR 'window buffer lotic power'[173] check:1 CHECKCOVER lotic[174] check:CHECKCOVER 'mixwater'    ∇