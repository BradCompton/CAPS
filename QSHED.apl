    ∇ QSHED C;Q;K;T;I;J;L;S;M[1]   ⍝Quick resistant watershed; recurse up the watershed from cell ⍵[1 2] with influence ⍵[3][2]   ⍝Build influence grid on the way up, and other grids on the way down[3]   ⍝Globals:[4]   ⍝   lc          landcover[5]   ⍝   flow        D8 flow grid[6]   ⍝   resist      watershed resistances[7]   ⍝   <metric>_s  source values for each metric[8]   ⍝   V1          list of _s and _v variables for cumulative values[9]   ⍝   V2          list of _s and _iv for cumulative influenced values[10]  ⍝   subw        matrix of subwatersheds potentially in this watershed (row, column, x, y)[11]  ⍝Returns globals:[12]  ⍝   inf         influence of cell[13]  ⍝   suminf      sum of influence above cell[14]  ⍝   mininf      minimum influence value above cell (to edge of watershed)[15]  ⍝   size        watershed size for cell[16]  ⍝and, for each metric:[17]  ⍝   <metric>_v  sum of metric values above cell[18]  ⍝   <metric>_vi sum of influence × metric value above cell[19]  ⍝Method is the same as the watershed metrics toy (16 Sep 2009), except that this version takes mean resistance of source and[20]  ⍝focal cells, it corrects for diagonals, and the minimum influence value for the watershed above each cell is used for the[21]  ⍝offset, instead of using a standard offset throughout.[22]  ⍝B. Compton, 17 Sep 2009[23]  ⍝19-21 Feb 2011: rewritten for CAPS 3.0[24]  ⍝22 Feb 2011: Use SCATIq to speed up[25]  ⍝24 Feb 2011: drop dam count, because we're not doing old impounded metric[26]  ⍝17-18 May 2012: deal with subwatersheds[27]  ⍝19 Mar 2015: passed variables in V1 and V2; do cumulative and cumulative influenced in separate loops to support HA and NPK[28]  ⍝10 Apr 2015: deal with values from subwatersheds using new scheme[29]  ⍝20 Oct 2015: ugh! I wasn't incrementing M after influenced variable, leading to complete junk for later metrics[30]  [31]  [32]  [33]   I J L ← C                                                  ⍝Cell I, J, influence of current cell[34]   ⍎(0=100|I×J)/'BREAKCHECK'                                  ⍝Check for break at every 10×10 cell[35]  ⍝ ⎕←'QSHED ',⍕I,J ⋄ FLUSH[36]   inf[I;J]←L                                                 ⍝Influence value given resistance[37]  [38]  [39]   →(0∊⍴S←GETSUBWATERSHED I J)/L2                             ⍝If there's a subwatershed,[40]   suminf[I;J]←S[4]+L×S[6][41]   mininf[I;J]←S[5]+L[42]   size[I;J]←S[6][43]  [44]   K←0 ⋄ M←6[45]  L1:→((1↑⍴metrics)<K←K+1)/0                                  ⍝   For each metric, get metric-specific values for outflow cell[46]   T←FLATTEN metrics[K;3]                                     ⍝      metric variables[47]   ⍎⊃,/(⊂' ⋄ '),¨T,¨(⊂'[I;J]←'),¨⍕¨S[M+⍳⍴T]                   ⍝      assign to grids[48]   M←M+⍴T[49]   →(0∊⍴T←FLATTEN metrics[K;4])/L1                            ⍝      influenced variables[50]   ⍎⊃,/(⊂' ⋄ '),¨T,¨(⊂'[I;J]←'),¨(⍕¨S[M+⍳⍴T]),¨(⊂'+L×'),¨⍕¨S[M+(-⍴T)+⍳⍴T] ⍝      assign, adjusting by influence value from full watershed[51]   M←M+⍴T[52]   →L1[53]  [54]  L2:Q←flow FLOWINTO I,J                                      ⍝Else, normal cells. Source cells.[55]   T←1⌈(2*.5)×~+/Q=(⍴Q)⍴I,J                                   ⍝   Distance correction for diagonal flow[56]   L←L-T×.5×resist[I;J]+resist SCATIq Q                       ⍝   New influence[57]  [58]   QSHED¨↓Q,L                                                 ⍝   Recurse up watershed[59]  [60]  ⍝Now accumulate results on the way back down[61]   size[I;J]←1++/size SCATIq Q                                ⍝   Watershed size[62]   suminf[I;J]←inf[I;J]++/suminf SCATIq Q                     ⍝   Sum of influence[63]   mininf[I;J]←(inf[I;J]-.5×resist[I;J])⌊⌊/mininf SCATIq Q    ⍝   Minimum influence: min of contributers & this cell - 1/2 of resistance[64]  [65]   K←0[66]  L3:→((1↑⍴V1)<K←K+1)/L4                                      ⍝   For each cumulative variable,[67]   ⍎(⊃V1[K;2]),'[I;J]←',(⊃V1[K;1]),'[I;J]++/',(⊃V1[K;2]),' SCATIq Q'              ⍝      cumulative metric value[68]   →L3[69]  [70]  L4:K←0[71]  L5:→((1↑⍴V2)<K←K+1)/0                                       ⍝   For each cumulative influenced variable,[72]   ⍎(⊃V2[K;2]),'[I;J]←(inf[I;J]×',(⊃V2[K;1]),'[I;J])++/',(⊃V2[K;2]),' SCATIq Q'   ⍝      cumulative influenced metric value[73]   →L5[74]  [75]  [76]  ⍝More readably,[77]   salt_v[I;J]←salt_s[I;J]++/salt_v SCATIq Q                  ⍝      cumulative metric value[78]   salt_iv[I;J]←(inf[I;J]×salt_s[I;J])++/salt_iv SCATIq Q     ⍝      cumulative influenced metric value    ∇