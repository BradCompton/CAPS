    ∇ A TRB S;I;M;R;J;dams;targets;E;T;tr;trtable;X;tinywatersheds;lc;result;trs;lrpars;d8flow;transparent;buffer;Q;C;B;Z[1]   ⍝Block version of CAPS tidal restriction metric[2]   ⍝⍺ and ⍵ = usual metric arguments[3]   ⍝B. Compton, 4 and 20 Jun 2012, from TR and WATERSHEDB[4]   ⍝16 Nov 2015: was using 0 MVREP for some reason, which wiped out previous results from TR[5]   [6]   [7]   [8]    READPARS 'TR'[9]    READPARS ME[10]   buffer←4⊃A[11]  [12]   X←READ 1⊃1⊃A                                   ⍝   Tides[13]   →(^/,X∊0,MV)/0                                 ⍝   Bail if no tidally-influenced cells[14]   lc←READ 2⊃1⊃A                                  ⍝   Landcover[15]   E←READ 3⊃1⊃A                                   ⍝   DEM[16]   R←READ 4⊃1⊃A                                   ⍝   tiderange[17]   S←READ 5⊃1⊃A                                   ⍝   south[18]   d8flow←READ 6⊃1⊃A                              ⍝   D8 flow accumulation[19]  [20]   tr←TABLE pathT PATH trtable                    ⍝Read tidal restriction points[21]   tr←(tr[;3]>0)⌿tr                               ⍝Tidal restriction of 0 = no restriction, so forget these; also skip empirical negative restrictions[22]   M←0 1 0 TABLE pathT PATH tinywatersheds        ⍝read tiny watershed table for TR (these are coastal only)[23]   Q←(4⍴1 ¯1×cellsize÷2)+(1 FINDPOINT 2⍴buffer),1 FINDPOINT THISBLOCK[3 4]+buffer   ⍝Corners for current block[24]   Q←Q[1 4 3 2]                                   ⍝Rearrange to lower left, upper right[25]   M←((^/M[;2 3]≥((1↑⍴M),2)⍴Q[1 2])^^/M[;2 3]≤((1↑⍴M),2)⍴Q[3 4])⌿M        ⍝Clip watershed outflows for current block[26]   M[;2 3]←↑1 FINDCELL¨↓M[;2 3]                   ⍝Convert outflows to cells[27]   J←↑1 FINDCELL¨↓tr[;⍳2][28]   tr←(C←^/(tr[;⍳2]≥((1↑⍴tr),2)⍴Q[1 2]-buffer×cellsize)^tr[;⍳2]≤((1↑⍴tr),2)⍴Q[3 4]+buffer×cellsize)⌿tr           ⍝TRs in this block[29]   trs←((⍴X)⍴0) SCATR (C⌿J) (tr[;3])              ⍝Create TR grid for this block[30]  [31]  [32]  L1:X←1-÷1+*-(lrpars[1]×B/,0 MVREP E)+(lrpars[2]×B/,R)+lrpars[3]×(B←,R≠MV)/,S ⍝   Tides, unrestricted[33]   X←MVREP ((⍴R)⍴B\X) (R=MV)[34]   dams←lc=LOOK 'dam'[35]   result←(⍴X)⍴MV[36]  [37]   I←0[38]  L2:→((1↑⍴M)<I←I+1)/L3                           ⍝For each watershed,[39]  ⍝ BREAKCHECK                                     ⍝   Do a single watershed[40]  ⍝ ⎕←'Watershed ',(⍕M[I;1]),' (',(⍕I),' of ',(⍕1↑⍴M),')...' ⋄ FLUSH[41]  [42]  ⍝TRr expects globals: result, trs, d8flow, dams[43]   0 TRr M[I;2 3]                                                             ⍝   Follow watershed up from outflow cell, taking max restriction along the way[44]   →L2[45]  [46]  L3:Q←MVREP (0⌈R-result) ((X=MV)∨(E=MV)∨result=MV)                           ⍝   Subtract restriction from tidal range[47]   Z←1-÷1+*-(lrpars[1]×B/,E)+(lrpars[2]×B/,Q)+lrpars[3]×(B←,Q≠MV)/,S          ⍝   Logistic regression to tidal regime setting...1-LR b/trs TIDES is backwards[48]   Z←MVREP ((⍴Q)⍴B\Z) (Q=MV)                                                  ⍝   Expand and replace missing values[49]   Z←MVREP (X-Z) (Z=MV)                                                       ⍝   Difference from tides setting variable is tidal restriction metric[50]   transparent←1[51]   (6 ROUND Z) WRITE pathR PATH 3⊃A                                           ⍝   Write results transparently[52]   →0[53]  [54]  [55]  [56]  what:CAPS coastal[57]  type:block[58]  info:((⊂pathU PATH 'tides'),(⊂'land'),(⊂pathS) PATH¨'dem' 'tiderange' 'south' 'flow' 'zeros') ('') ('TR') (⌈1000×buffer÷cellsize)       ⍝Metric-specific source grids, settings table, result grid, and buffer size[59]  check:CHECKVAR 'tinywatersheds buffer'                               ⍝Logistic regression parameters for dem538, tiderange, south[60]  ⍝c⍝heck:pathT CHECKFILE trtable[61]  check:pathT CHECKFILE tinywatersheds    ∇