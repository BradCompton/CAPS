    ∇ A LINK2GRAPHB S;buffer;head;subpath;X;C;flow;iei;Q;cost;crossdam;anthroweight;multiplier;fd;L;B;M;bigwatersheds;I;nid;nodes;edges;T;internode;excl;E;subs[1]   ⍝Build data for Critical Linkages Scenario Builder - tile version[2]   ⍝Big watersheds are done in companion metric LINK2GRAPHB[3]   ⍝⍺ and ⍵ = usual metric arguments[4]   ⍝Parameters (under [link2graph]):[5]   ⍝   internode       distance (m) between internodes[6]   ⍝   subpath         name of subdirectory in tables\ (or full path) for results--can vary with internode[7]   ⍝   multiplier      multiplier on ecological distance for costs (same as used for AQCONNECT)[8]   ⍝   anthroweight    weight of abarriers, from AQRESIST[9]   ⍝   bigwatersheds   table of big watersheds[10]  ⍝   buffer          buffer (km)--needs to be as large as the longest orthogonal axis of a tiny watershed[11]  ⍝Source data:[12]  ⍝   land            Landcover[13]  ⍝   streams         Stream centerline grid[14]  ⍝   flow            D8 flow direction grid[15]  ⍝   iei             Full IEI[16]  ⍝   aqresist        Aquatic resistance for natural settings (from AQRESIST)[17]  ⍝Results: (in tables\clsb\)[18]  ⍝   CLSBXnodes.txt  nodeid, x, y, cost.  One big table (900k rows with internode = 30) for all tiles.[19]  ⍝   CLSBXedges.txt  node1, node2, length, cost, value (=IEI)[20]  ⍝Node id scheme:[21]  ⍝   1[4-digit watershed][6-digit node id]     [22]  ⍝   2[2-digit tile row][2-digit tile column][6-digit node id][23]  ⍝   *** ARE THERE FEWER THAN 1,000,000 confluences + culverts + internodes in all watersheds?  Mean of <1000 culverts/big watershed...[24]  ⍝To plot edges (for small areas) in ArcMap, use MAPEDGES[25]  ⍝B. Compton, 12-14 Feb 2018 (from LINK2GRAPH and WATERSHEDB)[26]  ⍝19 Feb 2018: round x and y to nearest m[27]  ⍝19 Mar 2018: allow subpath to be a complete path[28]  ⍝2 Apr 2018: failed to deal with ragged western edges, where flow extends beyond landscape[29]  [30]  ⍝Note: must run LINK2GRAPH as a companion[31]  [32]  [33]  [34]   READPARS ME[35]   buffer←B←4⊃A[36]  [37]  [38]  ⍝First: read input data[39]   X←READ 1⊃1⊃A                                   ⍝Read landcover[40]   X←MVREP X (1≠READ 7⊃1⊃A)                       ⍝Need to use the mask to get ragged western edges[41]   E←~X∊MV,(LOOKUP 1,[1.5]FRDBL¨↓',' MATRIFY exclude)[;1]  ⍝excluded and masked stuff[42]   →(~1∊C←E×1=READ 2⊃1⊃A)/0                       ⍝Read streams grid--bail if no centerlines in this tile[43]   flow←READ 3⊃1⊃A                                ⍝And flow[44]   flow←E×0 MVREP flow (C≠1)                      ⍝want flow for stream centerlines only, in non-excluded areas[45]   iei←0 MVREP READ 4⊃1⊃A                         ⍝Read IEI[46]   Q←READ 5⊃1⊃A                                   ⍝And cost of natural resistance (from AQRESIST)[47]   cost←1E6 MVREP Q (Q=MV)                        ⍝Anything missing in aqresist gets super-high resistance--this should just be subtidal            [48]  [49]   crossdam←READ 6⊃1⊃A                            ⍝aquatic barrier score [50]   crossdam←MVREP (crossdam×anthroweight×multiplier) (crossdam=MV)        ⍝Crossings & dams get weighted by anthroweight (from AQRESIST) and multiplier[51]   crossdam←MVREP crossdam (~X∊⊃,/LOOK¨↓MATRIFY'culvert/bridge dam')      ⍝aquatic barrier scores at crossings & dams; MV everywhere else[52]   subs←0 4⍴0                                     ⍝we won't have any subwatersheds for tiny watersheds[53]  [54]  [55]  ⍝Now generate tiny watersheds[56]   L←(block[1 2]+2×B)⍴1                           ⍝Make core mask for finding outflows[57]   L[(⍳B),(1+1↑⍴L)-⍳B;]←0 ⋄ L[;(⍳B),(1+1↓⍴L)-⍳B]←0[58]   fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1[59]   M←flow DOWNFLOW flow=0                         ⍝Find outflows[60]   M←M^(⍴M)↑L                                     ⍝Don't want any in buffer[61]   M←((,M)/,⍉(⌽⍴M)⍴⍳1↑⍴M),[1.5](,M)/,(⍴M)⍴⍳1↓⍴M   ⍝Convert outflows to points[62]   Q←0 1 TABLE pathT PATH bigwatersheds           ⍝Read big watershed table[63]   Q←Q[;(',' MATRIFY head) COL 'x-coord y-coord'][64]   Q←↑1 FINDCELL¨↓Q                               ⍝Convert them to cells[65]   M←(~(↓M)∊↓Q)⌿M                                 ⍝and remove these from our list[66]   M←(~∨/(M≤B)∨M>(⍴M)⍴block[1 2]+B)⌿M             ⍝drop outflows that fall in the buffer[67]   →(0∊⍴M)/0                                      ⍝bail out if no tiny watersheds in this tile[68]   [69]  [70]  ⍝Then do the do[71]   nid←2E10+(block[4]×1E8)+(block[5]×1E6)+1       ⍝Node id is 2[2-digit tile row][2-digit tile column][6-digit node id][72]   nodes←0 4⍴0                                    ⍝nodes starts out empty--we'll add the node in the subroutine[73]   edges←0 5⍴0                                    ⍝edges start out empty[74]  [75]   I←0[76]  L1:→((1↑⍴M)<I←I+1)/L2                           ⍝For each tiny watershed,[77]   BREAKCHECK[78]   DOT[79]   nid 1 LINK2GRAPH_SUB M[I;]                     ⍝   Recursively climb up stream network, collecting nodes and edges[80]   →L1[81]   [82]  L2:→(0∊⍴nodes)/0                                ⍝If we ended up without results for some reason, don't write files[83]   ⎕ERROR (0∊edges[;4])/'Error: zero-cost edges'[84]   nodes[;1]←FRDBL¨(⊂12 0)⍕¨nodes[;1][85]   edges[;1 2]←FRDBL¨(⊂12 0)⍕¨edges[;1 2][86]   nodes[;2 3]←0 ROUND nodes[;2 3][87]  [88]   head←1↓⎕TCHT MTOV MATRIFY 'nodeid x y cost'[89]   nodes TMATAPPEND pathT PATH subpath,'\CLSBXnodes.txt'  ⍝Save results to unique text files for each watershed, replacing old results[90]   head←1↓⎕TCHT MTOV MATRIFY 'node1 node2 length cost value'[91]   edges TMATAPPEND pathT PATH subpath,'\CLSBXedges.txt'[92]   →0[93]  [94]  [95]  [96]  what:data prep[97]  type:block[98]  init:head←1↓⎕TCHT MTOV MATRIFY 'nodeid x y cost' ⋄ (0 0⍴'') TMATOUT pathT PATH subpath,'\CLSBXnodes.txt'    ⍝Create node and edge files on launch[99]  init:head←1↓⎕TCHT MTOV MATRIFY 'node1 node2 length cost value' ⋄ (0 0⍴'') TMATOUT pathT PATH subpath,'\CLSBXedges.txt'[100] info:((⊂'land'),((⊂pathS) PATH¨'streams' 'flow'),(⊂'iei-r'),(⊂pathR PATH 'aqresist'),'abarriers' 'mask') '' ('') (⌈1+(internode+1000×buffer)÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[101] check:CHECKVAR 'internode multiplier anthroweight bigwatersheds subpath'[102] check:pathT CHECKFILE bigwatersheds    ∇