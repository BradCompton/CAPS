    ∇ A MIXWATER S;buffer;B;X;P;C;I;transparent;Z;J;D;T;Q;K;M;E;U;G;H;mixtype;where;L;F;R;limitsum;copy;Y;V;N;background;Y2[1]   ⍝Mix settings variables and metric results within ponds, wetlands, and rivers[2]   ⍝Runs as a CAPS block metric.[3]   ⍝Inputs:[4]   ⍝   source\mixwater         Encoded mixwater targets (≤1 for ponds; >1 for rivers)[5]   ⍝   source\pondids          Grid of IDs for each pond[6]   ⍝   <grids>                 Input grids to mix (in results\, with postfix '0' for metrics; in settings\raw for settings variables)[7]   ⍝   tables\biglakes.txt     table of lakes[8]   ⍝   tables\mixfringes.txt   table of fringing wetlands[9]   ⍝   model\mix<where>.txt    list of grids to process, with mixtype in second column[10]  ⍝   grids\land              (if mixing metrics)[11]  ⍝Parameters:[12]  ⍝   buffer                  Buffer in m[13]  ⍝   where                   Either 'metric' or 'settings'[14]  ⍝   mixtype                 Defines the type of mixing that's being done.  Choices are:[15]  ⍝      'inflows'            Centerline mixing for rivers; wetlands and lentic get weighted mean of inflow cells[16]  ⍝      'sum'                Centerline mixing for rivers; wetlands and lentic get sum of inflow cells[17]  ⍝      'sumlogs'            Centerline mixing for rivers; wetlands and lentic get ⍟sum of *inflow cells (for log-scaled inputs)[18]  ⍝      'pond'               Centerline mixing for rivers; wetlands and lentic get mean of all non-missing cells in basin[19]  ⍝      'none'               No mixing for any cells; values are passed through directly for rescaling[20]  ⍝   background              Path to background version of metrics. If any MVs in metric grid, fill them with same grid in background path. For CSB.[21]  ⍝Results (in results\ for metrics, in grids\settings\mixed\ for settings variables):[22]  ⍝   <grids>                 Result grids[23]  ⍝*** Note: input grids must have values for uplands--they can't be clipped to wetlands or you'll get junk[24]  ⍝*** Must also run companion table metric, MIXLAKES, simultaneously (to avoid killing shared result grid)[25]  ⍝For streams with no centerlines, need to decide what to do.  I'm just skipping them for now.[26]  ⍝B. Compton, 3-14 Sep 2010 (our well goes dry Sep 4) and 12 Oct 2010[27]  ⍝13 Oct 2010: add 'sums' mixing[28]  ⍝14 Oct 2010: revised scheme: mixwater marks cells flowing into wetlands; add sumlogs mixing[29]  ⍝15-18 Oct 2010: include fringing wetlands[30]  ⍝25 Oct 2010: avoid trouble from rounding errors[31]  ⍝20 Jan 2012: if limitsum = yes, for mixtype∊'sum' 'sumlogs', don't allow result to go any higher than landscape-wide maximum[32]  ⍝   This is because, for Massachusetts CAPS, volume in communities below oceanic types could get absurdly high[33]  ⍝23 Jan 2012: If copy = yes, copy unmixed settings grids; otherwise leave them alone[34]  ⍝24 Feb 2012: use lands instead of luwet for include (b/c luwet isn't carried forward for LCC).  Not sure why I used luwet, but this[35]  ⍝   should be okay--it only picks which blocks to run for.[36]  ⍝4 May 2012: don't bother to read grids we're not doing (mixtype = 'none' and copy = no)[37]  ⍝17-20 Sep 2012: call INCLUDE so mask and excluded are respected[38]  ⍝26 Apr 2013: a stupid little bug (sloppy variable name change) that I introduced back in September broke this for streams[39]  ⍝17 May 2013: must use MV in result for big lakes so we don't overwrite MIXLAKES results; don't use include grid--it gives us nodata for developed[40]  ⍝23 May 2013: small bug: was doing all cells in ponds with MVs (no effect); replace all cells in ponds properly (fix bug introduced 20 Sep 2012)[41]  ⍝28 May 2013: add background parameter so we aren't burned by ponds that straddle watersheds when called from CSB. Sigh.[42]  ⍝29 Oct 2013: allow vector mosaics for mixfringes[43]  ⍝28 Mar 2014: if where='metrics', mask out developed and other excluded in results[44]  ⍝7 May 2014: make sure comparison between mixwater and pondid is done with integers![45]  ⍝11 Sep 2014: don't bomb in rare tiles where there is nothing in include (thus INCLUDE returns 0)[46]  ⍝30 Jun 2015: had a bug when copy was true[47]  [48]  [49]  [50]   READPARS ME[51]   T←MIXWATERGRIDS 'S'                        ⍝Get mixtype[52]   buffer←B←4⊃A[53]   X←READ 1⊃1⊃A                               ⍝Get mixwater grid,[54]   →(0∊⍴Y←S '' INCLUDE (⍴X)⍴1)/0[55]   :if where≡'metrics'                        ⍝If doing metrics, we'll mask out developed and other excluded before writing metrics[56]      Y2←S INCLUDE READ 3⊃1⊃A                 ⍝   read land and get include metric[57]   :end[58]   P←0 MVREP READ 2⊃1⊃A                       ⍝pond ids,[59]   C←P∊(TABLE pathT PATH 'biglakes.txt')[;1]  ⍝Done flag (for pond mixing); start with all big lakes[60]   F←⊃READVEC 'mixfringes'                    ⍝Read table of fringing wetlands[61]   G←3↓1⊃A                                    ⍝List of input grids[62]   H←3⊃A                                      ⍝and result grids[63]   ⍎(1=≡H)/'H←,⊂H'                            ⍝Undo scalar disclose from BUILDPAR[64]   G H mixtype ← ((~mixtype≡¨⊂'none')∨copy)⌿¨G H mixtype    ⍝Drop grids we're not doing from list[65]  [66]   M←0[67]  L1:→((⍴G)<M←M+1)/0                          ⍝For each input grid,[68]   BREAKCHECK[69]   ⎕←M⊃G ⋄ FLUSH[70]   V←READ M⊃G                                 ⍝   Read metric grid[71]  [72]   :if (0≠⍴background)^MV∊V                   ⍝   If background is set and there are missing values in metric grid,[73]      N←,READ path PATH background,STRIP M⊃G  ⍝      Read background metric[74]      Q[T]←N[T←((,B BUFFER Y)^(MV=Q)^N≠MV)/⍳⍴Q←,V][75]      V←(⍴V)⍴Q                                ⍝      and replace missing cells with non-missing within buffer of mask[76]   :end[77]  [78]   →(^/,MV=(B,B)↓(-B,B)↓V)/L1                 ⍝   If all missing, bail out[79]   →(~(^/,MV=(B,B)↓(-B,B)↓X)∨'none'≡TOLOWER M⊃mixtype)/L2     ⍝   If no mixwatering to do or mixtype = none,[80]   Z←MVREP V (C∨~Y)[81]   →(copy)/L13                                ⍝      If copy = yes, copy it[82]   →L1                                        ⍝      Else, skip it[83]  [84]  L2:Z←MVREP V (C∨~Y)[85]   E←2⍴0[86]   D←C[87]   I←B[88]  L3:→(((1↑⍴X)-B)<I←I+1)/L11                  ⍝   For each row,[89]   BREAKCHECK[90]   →(^/~Y[I;])/L3                             ⍝      Skip this row if it's all missing[91]   J←B[92]  L4:→(((1↓⍴X)-B)<J←J+1)/L3                   ⍝      For each column,[93]   →(~Y[I;J])/L4[94]   →(D[I;J])/L4                               ⍝         If already done, on to next cell[95]   →(P[I;J]=0)/L10                            ⍝         If pond mixing,[96]   K L←1 CLIP Q←P=P[I;J]                      ⍝            cells in this pond[97]   Q←Q[K;L][98]   U←(⌊X[K;L])=⌊.5+1000×(P[I;J]÷1000)-⌊P[I;J]÷1000⍝            Targets for inflow mixing[99]   U←U×X[K;L]-1000×(P[I;J]÷1000)-⌊P[I;J]÷1000 ⍝            proportion for each target[100]  U←4 ROUND U                                ⍝            trim rounding errors introduced by Arc[101]  U←(T←,U≠0)/,U                              ⍝            list of proportions[102]  U←U÷+/U                                    ⍝            recalculate proportions so +/U≡1.0[103]  R←T/,V[K;L]                                ⍝            corrsponding settings values[104]  →(~P[I;J]∊F[;1])/L5                        ⍝            If fringing wetland,[105]  T←F[F[;1]⍳P[I;J];]                         ⍝               Look up in fringe table[106]  T←T,1 FINDCELL T[2 3][107]  U←U,T[4]                                   ⍝               include this proportion[108]  U←U÷+/U                                    ⍝               recalculate proportions so +/U≡1.0[109]  R←R,V[T[5];T[6]]                           ⍝               and target cell (may be outside of pond window)[110] L5:→((0<+/U)^~'pond'≡TOLOWER M⊃mixtype)/L6  ⍝            If mixing all pond cells (which we'll always do if nothing flows into pond),[111]  U←T DIV +/,T←Q×V[K;L]≠MV                   ⍝               Targets are all nonmissing cells in pond[112]  U←(T←,U≠0)/,U                              ⍝               list of proportions (ignore fringing wetlands for pond mixing)[113]  R←T/,V[K;L]                                ⍝               corrsponding settings values[114]  E[1]←E[1]+T←^/,T=0                         ⍝               If all cells in pond are missing, give error[115]  →L7[116] L6:E[1]←E[1]+T←MV∊R                         ⍝            If any missing values in target cells,[117] L7:→T/L9                                    ⍝               skip this pond[118]  →(~∨/'sum' 'sumlogs'≡¨⊂TOLOWER M⊃mixtype)/L8⍝            If sum or sumlogs mixing,[119]  U←U≠0                                      ⍝               result is sum of inflows[120]  →('sum'≡TOLOWER M⊃mixtype)/L8              ⍝               If sumlogs,[121]  Z[K;L]←(Z[K;L]×~Q)⌈(MV×~Q)+Q×⍟+/*R         ⍝                  treat inputs as logs[122]  →L9[123] L8:Z[K;L]←(Z[K;L]×~Q)⌈(MV×~Q)+Q×+/U×R       ⍝            pond gets weighted sum of target cells[124] L9:D[K;L]←D[K;L]⌈Q                          ⍝            done with this pond[125]  →L4[126] L10:→((X[I;J]=MV)∨X[I;J]≠⌊X[I;J])/L4        ⍝         Else, if nonmissing integer, it's river mixing (otherwise, it's pond edges; we'll get that above)[127]  K←(I,J)+¯50+100 100⊤X[I;J]                 ⍝         Else, take value at nearest centerline.  Cell at offset.[128]  E[2]←E[2]+T←MV=V[K[1];K[2]]                ⍝            If any missing values in target cells,[129]  →T/L4                                      ⍝            skip this cell[130]  Z[I;J]←V[K[1];K[2]]                        ⍝            Assign nearest centerline value to cell[131]  →L4[132] [133] [134] L11:→(^/E=0)/L12[135]  Q←((E[1]≠0)/(⍕E[1]),' pond',((E[1]≠1)/'s')),((^/E≠0)/' and '),(E[2]≠0)/(⍕E[2]),' river cell',((E[2]≠1)/'s')[136]  LOG '*** Warning: missing values where data should be in ',Q,' in ',M⊃G[137] [138] L12:D←D^~C                                  ⍝   ponds we actually did[139]  Z[K;]←Z[K;]⌈MVREP (V[K;]) (~D[K←(⍳B),(1↑⍴V)-⌽¯1+⍳B;])     ⍝   The only thing we write into buffer is lakes that lap the edge[140]  Z[;K]←Z[;K]⌈MVREP (V[;K]) (~D[;K←(⍳B),(1↓⍴V)-⌽¯1+⍳B])[141] L13:transparent←~'none'≡TOLOWER M⊃mixtype   ⍝   Write grid in transparent mode, to not interfere with other blocks and MIXLAKES (unless mixtype=none)[142]  Z←Z⌊(⌈/,Z) ((1 GRIDDESCRIBE M⊃G)[9]) [1+limitsum^∨/'sum' 'sumlogs'≡¨⊂TOLOWER M⊃mixtype][143]  Z←MVREP Z (~Y)[144]  :if where≡'metrics'                        ⍝If doing metrics, we'll mask out developed and other excluded[145]     :if 0∊⍴Y2[146]        Z←(⍴Z)⍴MV[147]     :else[148]        Z←MVREP Z (~Y2)[149]     :end[150]  :end[151]  Z WRITE M⊃H[152]  →L1[153] [154] what:data prep[155] type:standard[156] info:(((⊂pathS),¨'mixwater' 'pondids'),(⊂pathG PATH 'land'), MIXWATERGRIDS 'S') ('') (MIXWATERGRIDS 'M') (⌈buffer÷cellsize)      ⍝Source grid, settings table, result grid, and buffer size[157] check:CHECKVAR 'where buffer limitsum copy'[158] check:pathT CHECKFILE 'biglakes.txt'[159] check:pathT CHECKFILE 'mixfringes.txt'[160] check:(MIXWATERGRIDS 'S') CHECKVALUES 'mixtype inflows sum sumlogs pond none background'    ∇