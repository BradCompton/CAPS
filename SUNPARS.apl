    ∇ A SUNPARS S;B;latlong;R;W;E;Y;hours;months;origin;buffer;Q;sunwindow;maxwindow[1]   ⍝Figure out parameters for solar radiation settings variable[2]   ⍝Figures out hours and sunwindow[3]   ⍝Runs as a CAPS block metric.  → Run on one machine, then check end of log for parameters.[4]   ⍝Relationship among block size, maxwindow, and resulting sunwindow are a little squirrely.  Use large[5]   ⍝blocks and try a few large values for maxwindow.[6]   ⍝If your landscape is huge, use "blocks =" to pick blocks that have steep mountains or deep[7]   ⍝ravines.[8]   ⍝Parameters (all from SUN):[9]   ⍝   origin      - latitude, longitude (decimal degrees), northing, easting (in grid coordinates) of a point[10]  ⍝                 near the center of the landscape.  This allows converting UTM/state plane to degrees with[11]  ⍝                 reasonable accuracy.  For Mass State Plane, I used the NE end of the Rt. 140 causeway[12]  ⍝                 across the Wachusett Reservoir: origin = 42.374  71.778 902657 177047[13]  ⍝   timezone    - timezone offset from UTC, in hours timezone = 4 for EDT (summer time)[14]  ⍝   interval    - Sensitivity vs. speed.  How many sample points per cell?[15]  ⍝   months      - months in growing season[16]  ⍝   hours       - Hours of day to run for, in 24-hour time[17]  ⍝   sunwindow   - How far can shadows reach?  Determine this with dem SUNWINDOW SUNDIR earliest-time[18]  ⍝                 sunwindow determines the buffer size when running in tiles[19]  ⍝and for SUNPARS:[20]  ⍝   maxwindow   - maximum window size to try[21]  ⍝B. Compton, 21 Jun 2010 [summer solstice, appropriately enough], from SUN[22]  [23]  [24]  [25]  FORGET THIS -- IT IS WAY TOO COMPLICATED AND WRONG TO BOOT[26]  INSTEAD, USE THIS:[27]  [28]   A←height of tallest mountain in landscape (relative to lowest area, if you want)[29]   D←lowest sun angle we care about.  10∘ seems reasonable[30]   sunwindow←A÷3○RAD D[31]  [32]  +++++[33]  [34]  [35]  [36]   READPARS ME[37]   READPARS 'SUN'[38]   buffer←B←4⊃A[39]   E←READ 1⊃A                                     ⍝Get DEM,[40]   Y←1 ⋄ →(0∊⍴mask)/L0                            ⍝If mask grid supplied,[41]   Y←0 MVREP READ mask                            ⍝   read it[42]  L0:→((~1∊Y)∨^/,(B,B)↓(-B,B)↓E∊MV)/0             ⍝If block is all missing or masked, just get out now[43]  [44]   latlong←LATLONG FINDPOINT Q[1 2]+CELLSIZE×(Q←THISBLOCK)[3 4]÷2     ⍝Latitude, longitude of block center[45]   latlong[2]←origin[2]                           ⍝We don't care about time of day, so all blocks use standard longitude[46]  [47]   hours←4+⍳18                                    ⍝Candidate hours (N.B. might not be sufficient for very high latitudes)[48]   W←↑(,months,¨⊂15 2010) SUNDIR¨⊂,hours          ⍝Azimuth & elevation of sun by hour for each month (month × hour × 2)[49]   R←0⌈1○RAD W[;;2]                               ⍝Radiation given sun angle (month × hour)[50]   Q←Q÷+/Q←,(months=6)⌿R[51]   hours←(Q←~Q∊(.05≥+\Q[⍋Q])/Q[⍋Q])/hours         ⍝Only keep hours with ≥95% of day's sun[52]   W←((×/2↑⍴W),2)⍴W←Q/[2]W                        ⍝and drop from sun angles[53]  ⍝ W←(W[;2]>0)⌿W←((×/2↑⍴W),2)⍴W                   ⍝Sun must be above horizon - 95% of sun ensures this, I think[54]   E SUNWINDOW 1 2⍴15  ⍝W                                  ⍝Set sunwindow[55]  [56]   maxsunwindow←maxsunwindow⌈sunwindow[57]   sunwindows←sunwindows,sunwindow[58]   →(~=/block[6 11])/0                            ⍝If last block, we have something to say.[59]   LOG ''[60]   LOG ''[61]   LOG '*** Results from SUNPARS ***'[62]   LOG ''[63]   LOG 'hours = ',⍕hours[64]   LOG 'sunwindow = ',⍕maxsunwindow[65]   LOG 'sunwindows (min, mean, max) = ',⍕(⌊/sunwindows),((+/sunwindows)÷⍴sunwindows),⌈/sunwindows[66]   LOG ''[67]   10 40 HIST sunwindows[68]   →0[69]  [70]  [71]  type:standard[72]  infoX:('dem') ('') ('') (⌈maxwindow÷cellsize)    ⍝Source grid, settings table, result grid, and buffer size[73]  check:⍝CHECKVAR 'months origin interval timezone maxwindow'[74]  init:maxsunwindow←0 ⋄ sunwindows←⍳0    ∇