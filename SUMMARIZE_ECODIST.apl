    ∇ SUMMARIZE_ECODIST;C;settings;Q;X;I;S;Y;Z;T;J;K;R;H;landcover;G;M[1]   ⍝Summarize ecological distances using fixed stopgap/sampled settings values[2]   ⍝Inputs:[3]   ⍝   landcover.par       list of all cover types[4]   ⍝   settings.par        list of settings grids[5]   ⍝   stopgap.txt         stopgap settings values[6]   ⍝   sampledsettings.txt median sampled grid settings (stopgap values take priority) [get this from SAMPLEDIST][7]   ⍝   rowscols.txt        list of cover types to include in result, 'r' to include in rows, 'c' to include in columns[8]   ⍝Global:[9]   ⍝   ecodist             if ecodist contains 'l' list settings, 's', give settings, if 'd' give distances, if 'r' give resistance[10]  ⍝Results:[11]  ⍝   distances.csv       median distances among communities, ready to read into Excel[12]  ⍝B. Compton, 15 July 2009 (from STOPGAP and SAMPLEDIST)[13]  ⍝3 Aug 2009: Catch bad cover types in rowscols.txt[14]  ⍝4 Nov 2011: name changed from ECODIST.  Not sure if this is obsolete or not.[15]  [16]  [17]  [18]   ⍎(0=⎕NC'ecodist')/'ecodist←'''''[19]   SETPATHS[20]   C←landcover←TABLE landcoverpar[21]   C←C[⍋C[;1];][22]  [23]   S←settings ← TABLE 'settings'      ⍝Ecological settings file[24]   S[;2]←(S[;2])÷⌈/S[;2]              ⍝scale settings[25]   →(~'l'∊TOLOWER ecodist)/L1[26]   ⎕←'Settings:'[27]   ⎕←' ',' ',' ',⍕settings[28]  [29]  L1:Y←⍕¨(1 ⎕TCHT) MATIN path,'model\stopgap.txt'       ⍝Read stopgap settings[30]   Y←(0,('system')≡FRDBL TOLOWER (⎕TCHT MATRIFY head)[1;])↓Y    ⍝Drop systems column if it exists[31]   H←TOLOWER 2 0↓⎕TCHT MATRIFY head[32]   Y←Y[;1],(⎕FI¨0 1↓Y)+MV×~⎕VI¨0 1↓Y                  ⍝Replace missing values (*) with MV[33]   Q←LOOKUP (⍳1↑⍴Y),Y[;,1][34]   Y←Q[;1],0 1↓Y[Q[;2];][35]   Y←Y[⍋Y[;1];][36]   Y←(⊃¨Y)+⊃¨MV×Y≡¨⊂⍳0                                ⍝and replace missing cells with MV[37]  [38]   Y←MVREP (Y[;1],((0 1↓Y)-1)÷9) (Y=MV)               ⍝Stopgap settings are scaled from 1-10[39]   M←((∨/Y∊MV)∨~C[;1]∊Y[;1])⌿C[;2]                    ⍝missing landcover types[40]   →(0∊⍴M)/L2[41]   C←ifchat ⋄ ifchat←1[42]   LOG '*** ERROR: landcover types missing from stopgap table:'[43]   LOG MTOV ' ',' ',' ', (⎕PW-3) TELPRINT MIX M[44]   →0[45]  [46]  L2:Q←(1 ⎕TCHT) MATIN pathI PATH 'sampledsettings.txt'    ⍝Read sampled settings[47]   G←2 0↓⎕TCHT MATRIFY head[48]   Q←(0,('system')≡FRDBL TOLOWER (⎕TCHT MATRIFY head)[1;])↓Q      ⍝Drop systems column if it exists[49]   T←LOOKUP (⍳1↑⍴Q),Q[;,1][50]   Q←T[;1],0 1↓Q[T[;2];][51]  [52]  [53]   X←((1↑⍴Y),1↑⍴S)⍴0                                  ⍝Make combined settings grid[54]   X[;settings[;1]⍳FRDBL¨↓G]←0 1↓Q                    ⍝Sampled settings[55]   X[;settings[;1]⍳FRDBL¨↓H]←0 1↓Y                    ⍝Stopgap settings (these take precedence)[56]  [57]   Q←(0 ⎕TCHT) MATIN pathI PATH 'rowscols.txt'        ⍝Read rowscols[58]   Q[((⊂⍕MV)≡¨⍕¨Q[;1])/⍳1↑⍴Q;1]←⊂''[59]   Q[;1]←TOLOWER¨Q[;1][60]   R←('r'∊¨Q[;1])/C[;2]⍳Q[;2]                         ⍝Display in rows or columns[61]   K←('c'∊¨Q[;1])/C[;2]⍳Q[;2][62]   →(~∨/(R,K)>1↑⍴C)/L9[63]   ⎕←'*** Error: cover types in rowscols.txt that aren''t in landcover.par'[64]   ⎕←' ',' ',' ',(⎕PW-3) TELPRINT MIX ((C[;2]⍳Q[;2])>1↑⍴C)⌿Q[;2][65]   →0[66]  [67]  L9:→(~'s'∊TOLOWER ecodist)/L3[68]   ⎕←⎕TCNL,'Row settings:'[69]   ⎕←((⊂''),C[R;2]),settings[;1]⍪ROUND X[R;][70]   ⎕←⎕TCNL,'Column settings:'[71]   ⎕←((⊂''),C[K;2]),settings[;1]⍪ROUND X[K;][72]  [73]  L3:X←(⍴X)⍴MVREP (,X×(⍴X)⍴settings[;2]) (,X=MV)      ⍝Weight settings[74]   Z←((⍴R),⍴K)⍴0[75]   I←0[76]  L4:→((⍴R)<I←I+1)/L6                                 ⍝For each row,[77]   J←0[78]  L5:→((⍴K)<J←J+1)/L4                                 ⍝   For each column,[79]   Z[I;J]←X[R[I];] ECODIST ((1↓⍴X),1 1)⍴X[K[J];]       ⍝      Euclidean distance  ***** WAS EUDIST[80]   →L5[81]  [82]  L6:Z←⍕¨SORTMAT((⊂''),C[K;2])⍪C[R;2],T←ROUND Z[83]   →(~'d'∊TOLOWER ecodist)/L7[84]   ⎕←⎕TCNL,'Ecological distances:'[85]   ⎕←Z[86]  L7:→(~'r'∊TOLOWER ecodist)/L8[87]   ⎕←⎕TCNL,'Resistance:'[88]   ⎕←SORTMAT((⊂''),C[K;2])⍪C[R;2],1+T×10[89]  L8:Z CMATOUT Q←pathI PATH 'distances.csv'[90]   ⎕←⎕TCNL,⎕TCNL,'Results written to ',Q    ∇