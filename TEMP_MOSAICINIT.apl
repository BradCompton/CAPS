    ∇ P TEMP_MOSAICINIT M;R;G;T;∆set;rowsize;colsize;rows;cols;panemap;W;extent;Q;B;S;C;L;I;U;V;S_;head;Y;D;O;Q_;J;H[1]   ⍝Defines the mosaic scheme used for all grids given ⍵ and ⍺[2]   ⍝Arguments:[3]   ⍝   ⍵[1] is either:[4]   ⍝    - path to a mosaic[5]   ⍝    - path to a reference grid (must also supply rowsize and colsize)[6]   ⍝   ⍵[2] is either:[7]   ⍝    - path to gridservers.txt (default path: pathA)[8]   ⍝    - vectors of (1) server names (empty to use local server), (2) ports, (3) drives, and (4) windows[9]   ⍝   ⍺[1] - rowsize, cell rows in pane (required unless a mosaic is supplied)[10]  ⍝   ⍺[2] - colsize[11]  ⍝   ⍺[3] - panemap, '00101101' (required unless a mosaic is supplied)[12]  ⍝   ⍺[4] - window, xll, yll, nrow, ncol, cellsize[13]  ⍝Sets:[14]  ⍝   mosaic, mosaic_ - definition of current mosaic scheme:[15]  ⍝      rowsize     cells in each pane row[16]  ⍝      colsize     cells in each pane column[17]  ⍝      rows        pane rows in each mosaic[18]  ⍝      cols        pane columns in each mosaic[19]  ⍝      panes       panes in mosaic (rows x cols)[20]  ⍝      lastrowsize number of rows of cells in bottom pane row[21]  ⍝      lastcolsize number of columns of cells in bottom pane column[22]  ⍝      panemap     string with compressed binary vector (e.g.,[23]  ⍝                  '001010') indicating which panes contain data[24]  ⍝   mosaicwindow - virtual reference window of a mosaic[25]  ⍝    - xll, yll, nrow, ncol, cellsize for entire mosaic[26]  ⍝   connections for each pane[27]  ⍝Sample calls:[28]  ⍝   MOSAICINIT 'd:\caps\mosaics\land' 'gridservers.txt'[29]  ⍝   25E10 25E10 panemap window MOSAICINIT 'd:\caps\grids\land' (servers ports)[30]  ⍝B. Compton, 6 and 12 and 30 Sep 2013[31]  ⍝8 Oct 2013: deal with drives[32]  ⍝15 Oct 2013: count panes properly.  Government still shut down, debt ceiling hit this week?[33]  ⍝1 Nov 2013: use MOSAICINFO instead of cowboying it; only include grid servers with windows that match panes in our mosaic[34]  ⍝14-15 Nov 2013: revise for mosaics + drives[35]  ⍝19 Nov 2013: use GETTABLE[36]  ⍝16 Dec 2013: use MOSAICINFO[37]  ⍝3 Feb 2015: work properly when there is more than one grid server for a window[38]  [39]  [40]  [41]   ⍎(1=≡M)/'M←M '''''[42]   M G ← M        ⍝Reference (mosaic or grid) and grid server info[43]   ⍎(0=⎕NC'P')/'P←⍳0'[44]   P←4↑P          ⍝rowsize, colsize, panemap, window vector (0 if empty)[45]  [46]   O←⍳0[47]   :if 0≠⎕NC 'mosaic'                         ⍝If there's already a mosaic,[48]   :andif ~0∊⍴mosaic[49]      O ← mosaic mosaicwindow                 ⍝   save it[50]   :end[51]  [52]   Q←'rowsize colsize rows cols panes lastrowsize lastcolsize panemap'[53]   mosaic←(⍴mosaic_←FRDBL¨↓MATRIFY Q)⍴0       ⍝set up mosaic and header[54]  [55]   Q Q_ ← MOSAICINFO M                        ⍝Get lock and read mosaic info[56]   :if ~0∊⍴Q                                  ⍝If reference is a mosaic,[57]      mosaic[mosaic_ COL 'rowsize colsize rows cols panemap'] ← Q[Q_ COL 'rowsize colsize rows cols panemap'][58]      W←⊃Q[Q_ COL 'extent'][59]      :if ∨/P[1 2]≠0[60]         ⎕←'Warning: using rowsize and colsize from mosaic; rowsize/colsize arguments ignored'[61]      :end[62]   :else                                      ⍝Else, reference is a grid[63]      ⎕ERROR (~landscapewide)/'Error: landscapewide = no, but a grid was supplied as the mosaic reference--it must be a mosaic'[64]      W←∆GRIDDESCRIBE M                       ⍝   get window from grid[65]      ⎕ERROR (∨/P[1 2]=0)/'Error: must supply rowsize and colsize when reference is a grid'[66]      Q←⌈W[2 1]÷P[1 2]                        ⍝   pane rows and columns[67]      mosaic[mosaic_ COL 'rowsize colsize rows cols panemap'] ← P[1 2],Q,P[3][68]   :end[69]  [70]   mosaic[mosaic_ COL 'lastrowsize lastcolsize'] ← 1+mosaic[mosaic_ COL 'rowsize colsize']|¯1+W[2 1][71]   mosaic[mosaic_ COL 'panes']←×/mosaic[mosaic_ COL 'rows cols'][72]  [73]   mosaicwindow←5↑W[74]   INITCONNECTIONS                            ⍝create connection variables if they don't exist[75]   :if 0∊⍴referencewindow                     ⍝If reference window isn't set, set it[76]      referencewindow←mosaicwindow[77]      workingresolution←mosaicwindow[5][78]   :end[79]  [80]   :if ~0∊⍴O                                  ⍝If a mosaic already exists,[81]   :andif ~O≡mosaic mosaicwindow              ⍝   check to see if new mosiac matches old one[82]      ⎕ERROR 'Warning: Prior mosaic doesn''t match new mosaic.  Dropping prior mosaic'[83]      Q←0=connections[;connections_ COL 'pane'][84]      connections←Q⌿connections               ⍝   drop old mosaic[85]   :end[86]  [87]   :if ~1⊃Q←CHECKWINDOW mosaicwindow 1        ⍝Check against existing window[88]      T←⎕EX 'mosaic'[89]      ⎕ERROR 'Virtual mosaic window doesn''t match existing windows: ',2⊃Q[90]   :end[91]  [92]  ⍝Now add gridsevers for each pane to connections[93]   :if 0∊⍴G                                   ⍝If gridservers list is empty,[94]      L←1                                     ⍝   use local grid server[95]      U←V←D←Y←⊂''[96]   :elseif 1=≡G                               ⍝else, if no depth, it's a path to gridservers.txt[97]      S S_ ← GETTABLE pathA PATH G            ⍝   read gridservers.txt[98]      U V ← ↓[1]S[;S_ COL 'server port']      ⍝   servers, ports,[99]      D←S[;S_ COL 'drive']                    ⍝   drives,[100]     Y←S[;S_ COL 'ncol nrow xll yll cellsize']  ⍝   and windows[101]     L←0                                     ⍝   not local[102]  :else                                      ⍝else, it's a vector of[103]     U V D Y ← G                             ⍝   server names, ports, drives, and windows[104]     L←0[105]  :end[106] [107]  B←⎕FI((2×⍴T)⍴1 0)\T←⊃mosaic[mosaic_ COL 'panemap']                         ⍝Expand panemap to bit vector[108]  W←1⊃¨(⊂mosaicwindow) PANEWINDOW¨B/(⊂mosaic[mosaic_ COL 'rowsize colsize']),¨(⍳mosaic[mosaic_ COL 'panes'])   ⍝Window for each pane with data[109] ⍝⍝ J←(⊂0,(↓Y),0,U,((V,[1.5]0),0),D) FINDCONNECTION¨W,¨⊂STRIPPATH M            ⍝We only want grid servers that match panes in our mosaics[110]  J←⊃,/H←(⊂0,(↓Y),0,U,((V,[1.5]0),0),D) FINDCONNECTION¨(⊂¨W),¨1                   ⍝We only want grid servers that match panes in our mosaics[111]  H←⊃,/⍴¨H[112]  [113]  U←U[J] ⋄ V←V[J] ⋄ D←D[J] ⋄ Y←Y[J;][114]  :if L                                                                      ⍝If local grid server,[115]     D←⊂''[116]     Y←((+/B),2)⍴⊂''[117]  :else                                                                      ⍝else, remote[118]     Y←U[(↓Y)⍳W],[1.5]V[(↓Y)⍳W][119]  :end[120] [121]  C←(H⌿0,W,L,Y,serverlog),(H/B/⍳mosaic[mosaic_ COL 'panes']),[1.5]D                ⍝Data for connections[122]  I←(FRDBL¨↓MATRIFY 'set window local server port log pane drive')⍳connections_    ⍝Index columns of connections[123]  connections←connections⍪C[;I]              ⍝Add to connections[124] [125]  connections[;connections_ COL 'drive']←TOLOWER¨connections[;connections_ COL 'drive']     ⍝Make sure drives are all in same case![126]  Q←↓connections[;connections_ COL 'window drive'][127]  connections←((Q⍳Q)=⍳⍴Q)⌿connections        ⍝Drop duplicates from connections[128] [129]  SETCONNECTION (↓connections[;connections_ COL 'window drive'])⍳⊂C[?''⍴1↑⍴C;connections_ COL 'window drive']  ⍝Set active connection to a random pane in mosaic[130]  SETCACHE 1[131]  ACTIVATECONNECTION    ∇