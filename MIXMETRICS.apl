    ∇ W MIXMETRICS B;X;where;override_metrics;override_pars;metrics;F;T;Q[1]   ⍝Set up CAPS run to mix metric results for block size ⍵.  Wait if ⍺ (default)[2]   ⍝Call as function, not CAPS metric - this launches a CAPS run[3]   ⍝Source data:[4]   ⍝   results\<metrics>0          Raw metric results[5]   ⍝Parameters:[6]   ⍝   model\mixmetrics.txt[7]   ⍝   and parameters for MIXWATER and MIXLAKES[8]   ⍝Results:[9]   ⍝   results\<metrics>           Mixed metrics[10]  ⍝Note: I think it's okay to ignore all the warnings.  In particular, many, many "ponds" are wetlands[11]  ⍝without centerlines, and you'll get a warning for all of these.  Don't worry your little head about it.[12]  ⍝B. Compton, 7 Feb 2011, from MAKESETTINGS[13]  ⍝28 Mar 2011: passed block size, localize overrides[14]  ⍝28 Jun 2011: use new finish mechanism to wait for cluster to finish[15]  ⍝27 Sep 2012: add parent project name to project name[16]  ⍝3 May 2013: make sure there are actually metrics that need mixing (CSB runs often don't need this)[17]  ⍝8 Jan 2014: don't init when called from CAPS[18]  [19]  [20]  [21]   ⍎(0=⎕NC'W')/'W←1'[22]  [23]   :if 0=⎕NC 'calledfromcaps'[24]   :orif ~calledfromcaps[25]      INIT                                    ⍝Only do this if called manually[26]   :end[27]  [28]   →((1 1⍴MV)≡TABLE pathI PATH 'mixmetrics.par')/0        ⍝If no mixable metrics in this run, bail out[29]  [30]   X←1 4⍴'MIXWATER' 'yes' '*' B[31]   X←X⍪'MIXLAKES' 'yes' '*' 20[32]  [33]   override_metrics←X[34]  [35]   F←pathP,'finish',(FRDBL 5 0⍕?1E5)[36]   NDROP F[37]   Q←'' ⋄ ⍎(0≠⎕NC'project')/'Q←(0≠⍴project)/project,'':'''[38]   override_pars←('.|.',⎕TCNL) TEXTREPL '[mixwater]|where = ''metrics''|[mixlakes]|where = ''metrics''|[caps]|project = ''',Q,'mixmetrics''|priority = ',(⍕priority+.1),'|finish = ''SINK FILECREATE ''''',F,''''''''[39]   CAPSx[40]  [41]   :if 0=⎕NC 'calledfromcaps'[42]   :orif ~calledfromcaps[43]      INIT                                    ⍝Only do this if called manually[44]   :end[45]  [46]  [47]   ⎕←⎕TCNL,⎕TCNL,'->>> Okay to change parameter files on disk now <<<-',⎕TCNL ⋄ FLUSH[48]  [49]   →((~W)∨IFEXISTS F)/0[50]   LOG 'Waiting for MIXWATER/MIXLAKES to run on cluster...'[51]  L1:→(IFEXISTS F)/L2[52]   T←⎕DL 10[53]   →L1[54]  L2:LOG '...MIXWATER/MIXLAKES are finished.'    ∇