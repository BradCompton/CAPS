    ∇ S RAMSAMPLE2016 W;E;X;Y;U;D;T;M;qt;qtiles;head;K;B;I;H;V;J;Z;redo;Q[1]   ⍝Process CAPS sampling plots for 2016 season[2]   ⍝RAMSAMPLE 1 → create random points; ⍺ = number of random points[3]   ⍝&r ramsample[4]   ⍝RAMSAMPLE 2 → process results; ⍺ = separation distance, points per bin[5]   ⍝B. Compton, 29 Feb-3 Mar 2008[6]   ⍝28 Apr 2008: allow more points, print table, give blind points with randomly assigned bins[7]   ⍝17 Apr 2009: for 2009 season[8]   ⍝10-11 Apr 2014: for 2014, these changes:[9]   ⍝   do 3 watersheds (Deerfield, Westfield, Housatonic)[10]  ⍝   do fowet and ss (separately)[11]  ⍝   no more stratifying by insults[12]  ⍝4 Aug 2015: create 2015 points; no changes[13]  ⍝2 Dec 2015: create 2016 points[14]  ⍝   do 4 watersheds (Chicopee, Millers, Nashua, Quinebaug)[15]  ⍝   ss only[16]  ⍝   this version uses 2015 CAPS run[17]  ⍝12 Aug 2016: add 'redo'[18]  [19]  [20]  [21]  redo←1      ⍝If set, this is an additional run, so write to 'b' folder and use original bin assignments[22]  [23]  →(1 2=W)/L1,L2[24]  [25]  L1:⍝Create random points for ramsample.aml[26]   ⍎(0=⎕NC'S')/'S←1E6'[27]   head←''[28]   I←0[29]  L11:→(4<I←I+1)/0                    ⍝For each watershed[30]   E←(4 4⍴106887 864828 168584 925646  116404 916566 168121 941635  160116 893920 199405 940161  129781 861372 178760 883071)[I;][31]    X←E[1]+(UNIFORM S)×(E[3]-E[1])[32]   Y←E[2]+(UNIFORM S)×(E[4]-E[2])[33]   (X,[1.5]Y) CMATOUT 'd:\caps\more\ram2016\',(I⊃'chicopee' 'millers' 'nashua' 'quinebaug'),'PTS.TXT'[34]   →L11[35]  [36]  [37]  [38]  [39]  [40]  L2:⍎(0=⎕NC'S')/'S←500 25'           ⍝Separation distance, points per bin[41]   I←0[42]  L21:→(4<I←I+1)/0                    ⍝For each watershed,[43]   H←(I⊃'chicopee' 'millers' 'nashua' 'quinebaug')[44]   ⎕←'Watershed:',H[45]   ⎕←''[46]   X←MATIN 'd:\caps\more\ram2016\',H,'\sample.txt'[47]   X←0 1↓X                            ⍝X is X, Y, IEI, type, insults, verboten (river buffer), capsland[48]   X←(~(FRDBL¨X[;5])≡¨⊂'MISSING')⌿X[49]   X←(~(FRDBL¨X[;4])≡¨⊂'MISSING')⌿X[50]  [51]   X[;3]←⎕FI ,' ',MIX X[;3]           ⍝IEI[52]   X[;4]←⎕FI ,' ',MIX X[;4]           ⍝Type[53]   X[;5]←⎕FI ,' ',MIX X[;5]           ⍝Verboten[54]   X[;6]←⎕FI ,' ',MIX X[;6]           ⍝Community (from grid)[55]   X←(~X[;5])⌿X                       ⍝Drop out points too close to big rivers[56]   X←(X[;3]≠0)⌿X                      ⍝And drop out IEI = 0 - those are developed[57]   X←(((X[;6]=44)^X[;4]=12)∨(X[;6]=41)^X[;4]∊14 15 16)⌿X  ⍝Drop points in the wrong community (poly vs. grid check)[58]   X←X[;⍳4]                           ⍝and get verboten & community columns out of here![59]  [60]  ⍝X has 4 columns: x, y, IEI, community[61]   X[;4]←(X[;4]=12)+2×X[;4]∊14 15 16  ⍝1 = SS, 2 = FOWET[62]   X←(X[;4]≠0)⌿X[63]  [64]   X←X,X[;3]+.001×UNIFORM 1↑⍴X        ⍝Add a tiny random number to prevent ties in quantiles (5th column)[65]   X[;5]←10×10 QUANTILE X[;5]         ⍝Deciles of IEI (0-9)[66]  [67]  ⍝Now X has 5 columns: 1:x, 2:y, 3:IEI, 4:community (1 = SS, 2 = FOWET), 5:decile[68]   V←X[69]   J←0[70]  L6:→(1<J←J+1)/L21                   ⍝For each community,  **** JUST DO SS ****[71]   X←(V[;4]=J)⌿V                      ⍝   Pull out points in this community[72]   ⎕←'   Community: ',J⊃'ss' 'fowet'[73]   Y←X[74]   K←0[75]  [76]  L3:X←Y,UNIFORM 1↑⍴Y                 ⍝Random number (6th column)[77]  ⍝Now X has 6 columns: 1:x, 2:y, 3:IEI, 4:community (1 = SS, 2 = FOWET), 5:decile, 6:random number[78]  [79]   X←X[⍋X[;5 6];]                     ⍝Sort by decile & random number[80]  [81]   U←((X[;5]⍳X[;5])=⍳1↑⍴X)/X[;5]      ⍝Unique bins[82]   X←X,⊃,/⍳¨+⌿X[;5]∘.=U               ⍝Index[83]  ⍝Now X has 7 columns: 1:x, 2:y, 3:IEI, 4:community (1 = SS, 2 = FOWET), 5:decile, 6:random number, 7:index in bin[84]   X←(X[;7]≤S[2])⌿X                   ⍝Pick ⍺[2] points in each bin[85]  [86]   D←(((X[;1]∘.-X[;1])*2)+(X[;2]∘.-X[;2])*2)*.5[87]   D←((⍳1↑⍴X)∘.<⍳1↑⍴X)×D<S[1]         ⍝Points within ⍺[1] m of others[88]   X←(~∨⌿D)⌿X                         ⍝Drop subsequent points that are too close[89]  [90]   :if J=2                            ⍝If doing fowet,[91]      D←(((X[;1]∘.-Z[;1])*2)+(X[;2]∘.-Z[;2])*2)*.5[92]      X←(~∨/D<S[1])⌿X                 ⍝   don't pick points too close to SS[93]   :end[94]  [95]   U←((X[;5]⍳X[;5])=⍳1↑⍴X)/X[;5][96]   X[;7]←⊃,/⍳¨+⌿X[;5]∘.=U             ⍝Re-index[97]   X←(X[;7]≤S[2])⌿X                   ⍝Pick more points[98]  [99]   :if J=2                            ⍝If doing fowet,[100]     D←(((X[;1]∘.-Z[;1])*2)+(X[;2]∘.-Z[;2])*2)*.5[101]     X←(~∨/D<S[1])⌿X                 ⍝   don't pick points too close to SS[102]  :else[103]     Z←X[104]  :end[105] [106]  ⎕←'Number of bins with at least 1, 2, ..., n points: ',⍕T←+⌿X[;7]∘.=⍳S[2][107] [108]  →((20>K←K+1)^B←∨/T<S[2])/L3        ⍝Want at least S[2] points in each bin...may not be able to get it[109]                                     ⍝This will be either because IEI and insults are highly correlated and[110]                                     ⍝there simply aren't enough points, or because I'm asking for too great[111]                                     ⍝a spacing.[112] [113]  ⍞←B/'*** Failed to fill all bins in 20 tries.',⎕TCNL[114] [115]  X←X[;1 2 3 5 1 7]                  ⍝1:x, 2:y, 3:IEI, 4:decile, 5:bin, 6:index[116]  :if redo                           ⍝If adding more points, [117]     Q←(MATIN 'd:\CAPS\more\ram2016\',H,'-',(J⊃'ss' 'fowet'),'-slampoints.txt')[;4 5]  ⍝   Original run, decile and bin[118]     X[;5]←Q[Q[;1]⍳X[;4];2]          ⍝   5:Use original bin assignments[119]  :else                              ⍝Else, 1st run for the season[120]     X[;5]←(10?10)[1+X[;4]]          ⍝   5:Random bin assignments[121]  :end[122]  X←X[⍋X[;5 6];]                     ⍝Sort on bin & index[123] [124]  head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord IEI decile bin index'[125]  X TMATOUT T←'d:\CAPS\more\ram2016',(redo/'b'),'\',H,'-',(J⊃'ss' 'fowet'),'-slampoints.txt'[126]  head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord bin index '[127]  X[;1 2 5 6] TMATOUT T←'d:\CAPS\more\ram2016',(redo/'b'),'\',H,'-',(J⊃'ss' 'fowet'),'-blindpoints.txt'[128] [129]  ⎕←''[130]  ⎕←'Points written to ',T[131]  ⎕←''[132]  ⎕←'Number of ',(J⊃'ss' 'fowet'),' points per bin:',⎕TCNL[133]  ⎕←⍕((⊂'IEI'),'-',0,⍳9),'|','n'⍪'-'⍪(10 1)⍴+⌿X[;4]∘.=0,⍳9[134]  ⎕←''[135]  →L6    ∇