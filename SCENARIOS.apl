    ∇ SCENARIOS;ifchat;refgrid;X;override_metrics;override_pars;blocksize;F;T;postmetrics;weights;names;grid;badnames;head;prettymodel;resultpath;scenarios;scenarios_;mask;M;Q;N;framework;devonly;maxth[1]   ⍝Post-process scenarios[2]   ⍝Run this as a function; it sets up metric calls[3]   ⍝1st scenario in list is treated as base scenario; all others are compared to it[4]   ⍝Parameters (under [scenarios]):[5]   ⍝   scenariosproject  force project name[6]   ⍝   scenarios   Name of scenarios file, with columns[7]   ⍝       name        scenario name (default: row number)[8]   ⍝       land        path to postland (default: grids\postland)[9]   ⍝       results	    path to raw results (default: results\)[10]  ⍝       iei         path to iei (default: post\scaled\iei) (only need for base scenario)[11]  ⍝       deltas      path to where to put deltas for each comparison (not needed for base scenario)[12]  ⍝       metrics     list of metrics for each scenario (overrides includemetrics)[13]  ⍝       mask        optional mask column; use this if each scenario has a different mask[14]  ⍝   blocksize   Size of blocks[15]  ⍝   includemetrics     metrics to include (use include = '' for all metrics)[16]  ⍝   excludemetrics     metrics to exclude (applied after includemetrics)[17]  ⍝   compare     Comparison type: 1st (='base'), in time-step pairs ('paired'), or all against all ('full')[18]  ⍝   change      Type of change: 'direct', 'indirect', or 'both'[19]  ⍝   devonly     if yes, scenarios include ONLY development, so there's no need to supply or generate alt IEI--it's always zero[20]  ⍝   gradient    Do gradient post-processing if yes[21]  ⍝   postland    name of landcover[22]  ⍝   model       post-processing community × metric table with weights[23]  ⍝   source      default path to raw metrics (used if full path not specified in scenarios file); default = pathR[24]  ⍝   results     path to post results (default = pathE,'scaled\')[25]  ⍝   benchpath   path to base benchmark file[26]  ⍝   landtypes   landcover.par file (if omitted, model uses community classes, not names)[27]  ⍝   checkland   check landcover grid for errors (takes a little while)[28]  ⍝   alt         alternate postfix for postland, landtypes, and model, used by LUMP[29]  ⍝   plainname   if yes, don't add scenario # to output grid names (assumes each scenario's results go in a different directory)[30]  ⍝   friskonly   if yes, frisk and exit[31]  ⍝   threshold   threshold for ignoring metrics in models (use 0.001)[32]  ⍝   usegroups   supply an optional group file to create additional delta result files by community groups. If included, must set masks.[33]  ⍝   summary     if yes, produce summary impact tables for LCC[34]  ⍝   futuregrids names of future metrics--these are treated as 0 in base scenario[35]  ⍝   futurepath  alternate path for future metrics[36]  ⍝   regional    benchmarks were created with REGIONALPOST, so include _full_1 in benchmark name[37]  ⍝Also writes <model>.csv with weights expressed as percentage for each community[38]  ⍝→→→ NOTE: this thing is a grid hog, so limit threads or you'll get 90% grid wait ←←←[39]  ⍝B. Compton, 3 Jan 2012[40]  ⍝17 Feb 2012: call SUMMARIZESCENARIOS to compile aspatial summaries[41]  ⍝29 Mar 2012: drop METRICMEANS, use new logistic rescaling[42]  ⍝13 Jul 2012: if called from cse, wait[43]  ⍝24 Aug 2012: set mask[44]  ⍝2 Oct 2012: add plainname[45]  ⍝26 Apr 2013: call MIXMETRICS if there are any metrics that need it (presumably used primarily for CSE); 3 May: no, this is done by CSE_SCENARIOS (or by POST for normal CAPS runs); 20 Apr 2017: put it back in, as I may sometimes need it; 24 Apr 2017: no, the way I did it is fucked and I don't think I really need it anyway[46]  ⍝7 Jun 2013: global scenariosproject forces project name[47]  ⍝24 Jun 2013: add mask column to scenarios.par[48]  ⍝26 Jul 2013: if called from CSE_SCENARIOS, set up to use jointmask with no include in TILEMAP call[49]  ⍝20 Apr 2017: add excludemetrics, regional, futuregrids, and futurepath[50]  ⍝25 Apr 2017: add devonly to facilitate running development-only scenarios without worrying about alt IEI (12 yards of compost delivered!)[51]  ⍝22 May 2017: add maxth parameter, to limit threads, as I'm getting gridwait = 96% on the full cluster[52]  [53]  [54]  [55]   framework←'caps'[56]   SETPATHS[57]   INIT[58]   ifchat←0                                   ⍝Don't chatter all the blocks![59]   refgrid←1 GRIDNAME 'reference'[60]   mask←(IFEXISTS mask,'\')/mask←1 GRIDNAME 'mask'[61]   resultpath←'' ⋄ mixmetrics←mixonly←0[62]   →(1↑POSTFRISK 'scenarios')/0[63]   head←2⊃prettymodel[64]   (3⊃prettymodel) CMATOUT 1⊃prettymodel      ⍝Write model.csv[65]   LOG 'Community model written to ',1⊃prettymodel[66]  [67]   X←1 4⍴'SCENARIODELTAS' 'yes' '*' blocksize[68]   X←X⍪'@wait' '' '' 0[69]   X←X⍪'SUMMARIZESCENARIOS' 'yes' '*' 0[70]  [71]   N←'scenarios' ⋄ ⍎(0≠⎕NC'scenariosproject')/'N←scenariosproject'[72]   override_metrics←X[73]   T←(VALUE 'csewait')/'|finish = ''SINK FILECREATE ''''',pathE,'finishS'''''''    ⍝If called from cse, wait here[74]   override_pars←('.|.',⎕TCNL) TEXTREPL '[scenariodeltas]|[summarizescenarios]|[caps]|project = ''',N,'''',T,'|maxthreads = ',⍕maxth[75]   :if ∨/(,⎕SI) ⎕SS 'CSE_SCENARIOS'           ⍝If called from CSE_SCENARIOS, (yeah, I know this is ugly)[76]      override_pars←override_pars,('.|.',⎕TCNL) TEXTREPL '|tilemapinclude = 0|altmask = ''jointmask'''[77]   :end[78]  [79]   CAPSx    ∇