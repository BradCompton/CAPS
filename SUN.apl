    ∇ A SUN S;buffer;B;E;D;Z;U;W;latlong;timezone;R;Q;hours;months;origin;Y;O;minangle;sunwindow;interval;declination;exclude[1]   ⍝Solar radiation settings variable.  Calculates annual direct incident solar radiation for the[2]   ⍝growing season, taking topographic shading at each hour of the day into account[3]   ⍝Runs as a CAPS block metric.[4]   ⍝Inputs (all in source\ except for luwet):[5]   ⍝   luwet       - landcover, for INCLUDE[6]   ⍝   dem         - all from makedem.aml[7]   ⍝   slope       - percent slope[8]   ⍝   aspect      - aspect (degrees)[9]   ⍝Result (in settings\raw\)[10]  ⍝   sun         - annual direct incident solar radiation[11]  ⍝Parameters:[12]  ⍝   origin      - latitude, longitude (decimal degrees), northing, easting (in grid coordinates) of a point[13]  ⍝                 near the center of the landscape.  This allows converting UTM/state plane to degrees with[14]  ⍝                 reasonable accuracy.  For Mass State Plane, I used the NE end of the Rt. 140 causeway[15]  ⍝                 across the Wachusett Reservoir: origin = 42.374  71.778 902657 177047[16]  ⍝   minangle    - minimum sun angle we care about; allows dropping excess buffer[17]  ⍝   timezone    - timezone offset from UTC, in hours timezone = 4 for EDT (summer time)[18]  ⍝   interval    - Sensitivity vs. speed.  How many sample points per cell?[19]  ⍝   months      - months in growing season[20]  ⍝   hours       - Hours of day to run for, in 24-hour time [obtain from[21]  ⍝   sunwindow   - How far can shadows reach (m)?  Determine this with (max elevation difference)÷3○RAD minangle.[22]  ⍝                 Set this based on heighest mountain in landscape; SUN dynamically shrinks buffer for each block[23]  ⍝                 where possible.  Shadows when the sun is lower than minangle will be lost sometimes.[24]  ⍝   declination - Declination (degrees landscape is rotated clockwise from true north) for skewed projections.[25]  ⍝                 Positive declinations mean the landscape has been rotated clockwise, negative means counterclockwise.[26]  ⍝                 For LCC NER, declination is -12.3652.[27]  ⍝→→→ N.B. This settings variable relies on coarse latitude/longitude conversions, as well as other estimation[28]  ⍝procedures subject to error (see subfunctions for details).  If using somewhere other than Massachusetts,[29]  ⍝need to assess positional accuracy.  LATLONG uses a regression method to allow approximating other projections[30]  ⍝by regression.  Still need to assess accuracy.[31]  ⍝Approach: Start with unshaded direct incident solar radiation (McCune method, uses latitude, slope, aspect).[32]  ⍝Then calculate topographic shading for each hour on the 15th of each month in the growing season.  Shading for[33]  ⍝each hour is weighted by the angle of incidence; months are treated equally.[34]  ⍝Result is annual direct radiation × percent of growing season unshaded[35]  ⍝B. Compton, 9-21 Jun 2010[36]  ⍝10 and 13 Aug 2010: some speedups.  Drops unnecessary buffer for each block. Still takes several days on cluster.[37]  ⍝6 Jan 2011: Use common latitude for block so regression method will work; well-behaved grid paths[38]  ⍝7 Mar 2011: Uses cell-based lat-long for FULLSUN, but still does it by block for SUNDIR/TOPOSHADE.  Error is on the order[39]  ⍝of 0.5% over 1000 cells--this will get lost in the soup of DEM and other errors, so no worries.  Okay to run for blocks of 1000.[40]  ⍝1 Apr 2011: Use INCLUDE to pay attention to mask (several inches in April Fool's Nor'easter!)[41]  ⍝13 Jun 2011: Get missing values right in result[42]  ⍝13 Jul 2011: Allow redirecting luwet to land or dem or whatever in inputs.par[43]  ⍝27 Jan 2014: add declination adjustment; 12 Feb: test & adjust declination[44]  ⍝11 Mar 2014: don't excluded excluded types[45]  [46]  [47]  [48]   READPARS ME[49]   buffer←O←B←4⊃A[50]   Y←READ pathG PATH 1⊃1⊃A                        ⍝Get landcover[51]   exclude←''                                     ⍝We want values for ocean, etc. for this[52]   →(0∊⍴Y←S '' INCLUDE Y)/0                       ⍝Which cells to run for?  Use mask, but not include.[53]   E←READ pathG PATH 1⊃1⊃A                        ⍝Get DEM,[54]   →(^/,MV=(B,B)↓(-B,B)↓E)/0[55]   block[3]←buffer←B←B⌊⌈(÷cellsize)×((⌈/,E)-⌊/(,(B,B)↓(-B,B)↓E)~MV)÷3○RAD minangle          ⍝Figure maximum necessary buffer to represent sun at minangle[56]   Y←(-2⍴O-B)↓(2⍴O-B)↓Y                           ⍝Clip include to match our smaller grid[57]   E←READ pathG PATH 2⊃1⊃A                        ⍝Get smaller DEM[58]   S←READ pathG PATH 3⊃1⊃A                        ⍝slope,[59]   D←READ pathG PATH 4⊃1⊃A                        ⍝and aspect,[60]   Z←(⍴E)⍴MV[61]   latlong←↑LATLONG¨1 FINDPOINT¨↓INDICES (⍴E)⍴1   ⍝Latitude, longitude of each cell in block for FULLSUN[62]  [63]   U←((⍴E)⍴latlong[;1]) declination FULLSUN S D   ⍝Unshaded solar radiation[64]   U←MVREP U (Y=0)[65]   ⍝(E REMV U) WRITE pathR PATH 'fullsun'   ⍝*** TEMPORARY, FOR TESTING[66]   U←(2⍴B)↓(-2⍴B)↓U                               ⍝Drop buffer[67]  [68]   latlong←LATLONG FINDPOINT Q[1 2]+CELLSIZE×(Q←THISBLOCK)[3 4]÷2     ⍝Latitude, longitude of block center for SUNDIR[69]  [70]   W←↑(,months,¨⊂15 2010) SUNDIR¨⊂,hours          ⍝Azimuth & elevation of sun by hour for each month (month × hour × 2)[71]   W[;;1]←W[;;1]-declination                      ⍝Adjust for declination (rotate sun azimuths to align with grid)[72]   R←0⌈1○RAD W[;;2]                               ⍝Radiation given sun angle (month × hour)[73]   R←R÷⍉(⌽⍴R)⍴+/R                                 ⍝Proportion of day's sun (count all growing season months equally)[74]  [75]   Z←E Y TOPOSHADE ((×/2↑⍴W),2)⍴W                 ⍝Topographic shading for each month and hour[76]   Z←(0,2⍴B)↓(0,-2⍴B)↓Z                           ⍝Drop buffer[77]   R←⍉(⌽⍴Z)⍴,R                                    ⍝Rearrange sun per day to match[78]   Z←+⌿R×Z≠1                                      ⍝Total growing season sun given shading (if site were flat)[79]  [80]   block[3]←0                                     ⍝Since we've already dropped buffer for efficiency, don't do it in WRITE[81]   ⍝(MVREP Z (1≠(2⍴B)↓(-2⍴B)↓Y)) WRITE pathR PATH 'shading'      ⍝*** TEMPORARY, WRITE SHADING[82]   Z←MVREP (Z×U) (U=MV)                           ⍝Total solar radiation = unshaded sun × shading[83]   (((2⍴B)↓(-2⍴B)↓E) REMV Z) WRITE pathR PATH 1⊃3⊃A    ⍝Write result grid[84]   →0[85]  [86]  [87]  what:data prep[88]  type:standard[89]  info:((⊂'luwet'),(⊂pathS) PATH¨'dem' 'slope' 'aspect') ('') ((pathU PATH 'sun') 'fullsun' 'shading') (⌈sunwindow÷CELLSIZE) 'luwet'      ⍝Source grid, settings table, result grid, and buffer size[90]  check:CHECKVAR 'months hours sunwindow origin interval timezone minangle declination'    ∇