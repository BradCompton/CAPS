    ∇ Z←R READBLOCKa F;H;L;X;N;I;T;J;B;C;S;P;REST;Q;O;E[1]   ⍝Get tile from ascii grid ⍵.  Get ⍺[3 4] rows & cols, starting at row & col ⍺[1 2][2]   ⍝Also read buffer around rectangle ⍺[5] cells wide[3]   ⍝Row & column are upper left corner (Arc uses lower left)[4]   ⍝B. Compton, 31 Oct 2003[5]   ⍝15 Jan 2009: renamed from GETGRID[6]   [7]   [8]    L←1E5                        ⍝Block size must be >> header + longest line[9]   [10]   E←GRIDDESCRIBE F             ⍝Make sure block falls within original[11]   →(^/E[2 1]≥R[1 2]+¯1+R[3 4])/L0[12]   ⎕ERROR 'READBLOCKa Error: Block to read doesn''t fall within grid.'[13]  [14]  L0:(PATH F) ⎕XNTIE N←-1+0⌈⌈/|⎕XNNUMS[15]   P←1                          ⍝Start at beginning of file[16]   O←|0⌊(¯1+R[1 2]-R[5]),(E[2 1]-R[1 2]-1)-R[3 4]+(R←5↑R)[5]  ⍝Buffer overshoot beyond edges of grid[17]   R[3 4]←R[3 4]+(2×R[5])-O[1 2]+O[3 4][18]   R[1 2]←R[1 2]-R[5]-O[1 2][19]   ⍝R[⍳4]←R[⍳4]+¯1 ¯1 1 1×R[5]-O ⍝Increase tile size by buffer[20]   I←0[21]   T←''[22]   Z←(0,R[4])⍴0[23]  L1:X←DIB T,P NGET N,L         ⍝Read block[24]   →(I>P←0)/L2                  ⍝   If first block[25]   H←(J←(+\X=⎕TCNL)⍳6)↑X        ⍝      Get header[26]   T←VTOM FIRSTCOL H            ⍝      Header labels (we'll assume they're correct)[27]   H←⎕FI,' ',VTOM FIXE REST     ⍝      Header[28]   X←J↓X                        ⍝      Rest of stuff[29]  L2:T←(-+/^\⌽X≠⎕TCNL)↑X        ⍝   Keep partial line at end in buffer[30]   X←(-⍴T)↓X[31]   B←+\X=⎕TCNL                  ⍝   Newlines[32]   C←((⍴X)↑Q[1],Q←R[1]>B+I+1)/X ⍝   Lines before block[33]   X←(⍴C)↓X                     ⍝   Lines containing our block[34]   I←I++/C=⎕TCNL[35]   →(0∊⍴X)/L1                   ⍝Next block[36]   →L4[37]  L3:X←T,NGET N,L               ⍝Repeat: read another block (except first time)[38]   T←(-+/^\⌽X≠⎕TCNL)↑X          ⍝   Keep partial line at end in buffer[39]   X←DEB(-⍴T)↓X[40]  L4:S←+/X=⎕TCNL[41]   X←(S,H[1])⍴⎕FI ('/',⎕TCNL,'/ ') TEXTREPL FIXE X[42]  ⍝ X←(((1↑⍴X)⌈R[4]-1↑⍴Z),1↓⍴X)  ⍝   Don't take too much[43]   Z←Z⍪X[⍳(0⌈R[3]-1↑⍴Z)⌊1↑⍴X;R[2]+¯1+⍳R[4]]   ⍝   Block we're reading[44]   →((1↑⍴Z)<R[3])/L3            ⍝Until we're finished with block[45]   ⎕NUNTIE N[46]   Z←((O[1],1↓⍴Z)⍴E[6])⍪Z⍪(O[3],1↓⍴Z)⍴E[6]      ⍝Fill overshot edges with nodata values[47]   Z←(((1↑⍴Z),O[2])⍴E[6]),Z,((1↑⍴Z),O[4])⍴E[6]    ∇