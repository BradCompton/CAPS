    ∇ Z←P BLOCKRUN M;N;C;Q;block;noread;Z;I;B;L;G;V;R;S;E;T;Y;O;U[1]   ⍝Sets up calls for CAPS metric ⍵ running in blocks across cluster[2]   ⍝⍺ = [1] systems, [2] block size, [3] grid list (for multiple time steps or scenarios)[3]   ⍝B. Compton, 28 Nov 2007[4]   ⍝29 Apr 2008: allow multiple grids; 29 Sep 2008 and 3 Oct 2008: improve multiple grids[5]   ⍝16-21 Jan 2009: work better with scenarios, grid names, buffer, and gridio DLL[6]   ⍝24 Aug 2009: Allow passing through result grids (to kill them) without assembling for call if 1st element is '!'[7]   ⍝17 Feb 2010: Call initialize to all metrics to set up results before run[8]   ⍝1 Jun 2010: if blocks = list of r,c, r,c, run only for these blocks[9]   ⍝7 Jul 2010: move INITIALIZE to CAPSRUN so it happens afer grids are killed[10]  ⍝16 Nov 2010: now uses TILEMAP and block[12][11]  ⍝3 Feb 2011: 5th element from GETINFO is name of include grid (default = include)[12]  ⍝7 Mar 2011: Use toomanyblocks as error threshold[13]  ⍝23 May 2011: Set up calls for Anthill[14]  ⍝22 Jun 2011: pass override_pars; 11 Aug put it in run\temp\[15]  ⍝19 Sep 2011: bug in scenarios: missing include grid[16]  ⍝16 Jan 2012: pass override pars to BLOCKREPS to support temporary directory[17]  ⍝21 Aug 2012: include maskgroup in BLOCKREPS call[18]  ⍝14 Mar 2013: new reps facility[19]  ⍝8 Apr 2014: turn off subtask scrambling if scramble = no[20]  ⍝10 Apr 2014: don't call GRIDNAME up front--it screws up reps calls![21]  [22]  [23]  [24]   S E R B Y ← 0 1 GETINFO M              ⍝Read source names, settings table, result names, buffer size, and name of include grid from metric function[25]  ⍝⍝⍝ S E Y ← GRIDNAME¨ S E Y                ⍝Replace source grids names where available - NO! Breaks reps![26]  ⍝⍝⍝ R ← 0 resultspar GRIDNAME R[27]  [28]  [29]   O←''[30]   T←⎕EX 'allnames_',M[31]   →(0=⎕NC'override_pars')/L0             ⍝If override_pars exists,[32]   override_pars NWRITE O←pathP,'temp\temp',(FRDBL 15 0⍕?1E5),'.tmp'[33]  [34]  L0:Q←Q+(0=Q←2⊃P)×⌈/WINDOW[1 2]          ⍝If block = 0, run in 1[35]   Q←'function',((~scramble)/'!'),':''',O,''' BLOCKREPS ''',Y,''' ',⍕Q,B,MASKGROUP M[36]  [37]   →(~0∊⍴3⊃P)/L1                          ⍝If no reps,[38]   S←GRIDNAME pathG SUBNAME S             ⍝   Replace grid names where available[39]   E←GRIDNAME pathI SUBNAME E[40]   R ← 0 resultspar GRIDNAME pathR SUBNAMER R[41]   Z←,⊂(BUILDPAR S),(BUILDPAR E),(BUILDPAR R),(⍕B),' ',(BUILDPAR Y),(BUILDPAR P[1]),BUILDPAR O   ⍝   build call parameters[42]   U←('!'≡1⊃1↑R)↓R[43]   ⍎(2>≡U)/'U←,⊂U'[44]   →L2[45]  [46]  L1:Z U ← REPSRUN P M S E R B O Y        ⍝Else, fill out reps[47]  [48]  L2:Z←(⊂'BLOCKCALL '),¨(⊂BUILDPAR M),¨Z[49]   Z←Z,[1.5]⊂Q[50]   Z←Z,⊂'metric: ',M[51]   resultgrids←resultgrids OVER MIX (~0∊⍴R)/(⊂pathR)PATH¨((U⍳U)=⍳⍴U)/U    ∇