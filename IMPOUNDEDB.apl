    ∇ A IMPOUNDEDB S;B;X;dams;maskv;strflow;dem;M;Q;tinywatershed;targets;transparent;I;result;Z;buffer[1]   ⍝CAPS Impounded metric, block version to do tiny watersheds[2]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer)[3]   ⍝Note: buffer assumes watershed aspect ratio is less than 1:5.  This is very generous for Massachusetts.[4]   ⍝B. Compton, 3 Jun 2011, from WATERSHEDB and IMPOUNDED[5]   [6]   WRITTEN, NOT TESTED.  SEE IMPOUNDED.[7]   [8]   [9]    READPARS 'IMPOUNDED'                           ⍝Get parameters from main impounded metric[10]   buffer←B←4⊃A[11]  [12]  ⍝Read grids for this block[13]   X←READ 1⊃1⊃A                                   ⍝   Landcover[14]   dams←X=LOOK 'dam'[15]   →(~1∊dams)/L1                                  ⍝   Bail if no dams[16]   maskv←S←1=READ 2⊃1⊃A                           ⍝   Stream centerlines[17]   →(0∊⍴'*' INCLUDE X)/0                          ⍝   Which cells to run metrics for?  Bail if all masked out; otherwise ignore.[18]   strflow←MVREP (S×READ 3⊃1⊃A) (X=MV)            ⍝   D8 flow grid for centerline cells only[19]   dem←READ 4⊃1⊃A                                 ⍝   DEM[20]  [21]  [22]   M←0 1 TABLE pathT PATH targets                 ⍝Read watershed table[23]   M←(M[;2]≠2)⌿M                                  ⍝Drop subwatersheds.  We don't use them.[24]   M←(tinywatershed≥(×/M[;7 8]-M[;5 6])÷cellsize*2)⌿M                     ⍝gather tiny watersheds[25]   Q←(4⍴1 ¯1×cellsize÷2)+(1 FINDPOINT 2⍴B),1 FINDPOINT THISBLOCK[3 4]+B   ⍝Corners for current block[26]   M←((^/M[;3 4]≥((1↑⍴M),2)⍴Q[1 4])^^/M[;3 4]≤((1↑⍴M),2)⍴Q[3 2])⌿M        ⍝Clip watershed outflows for current block[27]   M←M[;1],↑1 FINDCELL¨↓M[;3 4]                   ⍝Convert outflows to cells[28]  [29]   transparent←1[30]   I←0[31]  [32]  L1:→((1↑⍴M)<I←I+1)/L4                           ⍝For each watershed,[33]   BREAKCHECK[34]   ⎕←'Watershed ',(⍕M[I;1]),'...' ⋄ FLUSH[35]   result←(⍴X)⍴MV[36]   IMPOUND M[I;3 4]                               ⍝   Call common recursive subroutine with IMPOUNDEDB to do the do[37]  ⍝⍝⍝ Z←MVREP (lrpars LOGISTIC 0 MVREP result) (X=MV)  ⍝   Do logistic transformation[38]  Z←result[39]   Z WRITE pathR PATH 3⊃A                         ⍝   Write results transparently[40]   →L1[41]  [42]  [43]  what:other (experimental)[44]  type:standard[45]  info:((⊂'land'),(⊂pathS) PATH¨'streams' 'flow' 'dem') ('') ('impounded') (⌊5×tinywatershed*.5) 'include'   ⍝Metric-specific source grids, settings table, result grid, and buffer size, and include grid[46]  check:CHECKVAR 'lrpars'    ∇