    ∇ Z←X TRYFLOW F;M;Q;T;C;K;G;B;H;R[1]   ⍝Try to find a flow path from a neighbor of 1st cell in flow path ⍵ given flow grid 1⊃⍵ and stream cells 2⊃⍵M[2]   ⍝Global: fd - flow directions[3]   ⍝B. Compton, 15 Jul and 5-6-9 Aug 2010[4]   ⍝20 Dec 2011: ugly bug: wrong dimension in [24], was (T/C)[5]   ⍝16 Jan 2013: was setting K←0 too late in the game[6]   ⍝25 Nov 2013: bring in R as a copy of Q that always has 0s removed[7]   [8]   [9]   [10]   X M ← X[11]  [12]   C←fd[;2 3]+8 2⍴F[1;]                   ⍝Now try to fix loop.  Candidate cells.[13]   →(~0∊⍴H←((∨/C≤0)∨∨/C≥(⍴C)⍴⍴X)⌿C)/L9    ⍝If any neighbors are out of bounds, we're good[14]   C←(0≠M SCATI C)⌿C                      ⍝Must be streams[15]   C←↑(↓C)~↓F                             ⍝And can't be part of the flow path we just traveled[16]   C←(T←~(Q←↓X NEXTFLOW C)∊↓F)⌿C          ⍝And can't flow into our flow path[17]   R←T/Q[18]   K←0[19]   →(∨/,↑Q=0)/L4                          ⍝If any paths reach edge, we're done[20]   →(MV∊X SCATI ↑Q)/L4                    ⍝Or if we've reached nodata cells[21]  L1:K←K+1                                ⍝   Nor into our flow path within this block, times removed[22]   G←C                                    ⍝   Save last cell standing[23]   ⍎(0∊C)/'ERROR!'[24]   ⍎(0∊↑R)/'ERROR!'[25]  [26]   →(~∨/T←MV=X SCATI ↑R)/L5               ⍝   done if we've reached nodata cells[27]   Z←(T⌿C) ¯1 (1 2⍴0 0)                   ⍝   Ah.  Return good path.[28]   →0[29]  L5:C←(T←~(R←↓X NEXTFLOW ↑R)∊↓F)⌿C       ⍝   cells that still don't loop[30]   F←F⍪↑R←T/R[31]  L4:→(0∊⍴H←((∨/↑R≤0)∨∨/(↑R)≥(⍴↑R)⍴⍴X)⌿C)/L3     ⍝   If there are any cells for which flow reaches edges of block,[32]  L9:Z←(H[,1;]) ¯1 (1 2⍴0 0)              ⍝      Return 1st good path--we're saved![33]   →0[34]  [35]  L3:→(~0∊⍴C)/L1                          ⍝Until no candidates left that don't loop[36]  [37]  L2:⍎(0∊G)/'ERROR'[38]   Z←C K G                                ⍝Return cells that didn't loop, loop length, and last ones standing    ∇