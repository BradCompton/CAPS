    ∇ MAKEWAVES;C;X;I;Z;N;R;Q;J;P;D;V;M;W;head;B;T;E[1]   ⍝Wave action settings variable[2]   ⍝Run makewaves.aml first[3]   ⍝Afterwards, run setwaves.aml[4]   ⍝Inputs: (all in d:\caps\working\)[5]   ⍝   coastpoints.txt     x,y,16 wind direction values for target points[6]   ⍝   coastlines.txt      x,y,x,y of New England coastline[7]   ⍝Result:[8]   ⍝   waves.txt           x,y,wave value[9]   ⍝Takes ca. 1 day to run on a cluster machine with 20 rays, 500 m separation[10]  ⍝B. Compton, 18-19-24 Mar 2010, 16 Apr 2010[11]  ⍝19 Aug 2010: slight modification for CAPS 3.0[12]  [13]  [14]  [15]   N←60                                   ⍝Number of rays[16]   M←1E5                                  ⍝Maximum distance to look[17]   T←200                                  ⍝Thinning distance: minimum distance between points[18]   E←100                                  ⍝Write results every 100 lines[19]   R←M×⍉1 2∘.○(0,¯1↓⍳N)×(○2)÷N            ⍝Make N rays[20]   V←1+(0,⍳N-1)×16÷N                      ⍝Wind direction interpolation vector[21]  [22]   X←0 1↓MATIN pathW,'coastpoints.txt'[23]   C←0 MATIN pathW,'coastlines.txt'[24]   head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord waves wavesW wavesLW wavesT'[25]  [26]   Q←⌊.5+X[;1 2]÷T                        ⍝Thin to at least T m apart[27]   Q←Q[P←⍋Q;][28]   B←∨/Q≠0⍪¯1 0↓Q[29]   X←B⌿X[P;][30]  [31]   Z←X[;1 2],((1↑⍴X),4)⍴0[32]   I←0[33]  L1:→((1↑⍴X)<I←I+1)/L9                   ⍝For each target point,[34]   P←((N,2)⍴X[I;1 2])+R                   ⍝   ray endpoints[35]   D←N⍴0[36]   J←0[37]  L2:→(N<J←J+1)/L3                        ⍝   For each ray,[38]   Q←(2 2⍴X[I;1 2],P[J;]) CROSSPOINT C    ⍝      crossing points[39]   D[J]←M⌊⌊/,(+/(Q-(⍴Q)⍴X[I;1 2])*2)*.5   ⍝      distance to closest crossing point[40]   →L2[41]  [42]  L3:W←+/(N,2)⍴16×X[I;2+(1+16|¯1+⌊V),1+16|¯1+⌈V]÷2×N×100  ⍝   Interpolated wind proportions[43]   Z[I;3]←+/D÷N                           ⍝   Mean distance, unweighted[44]   Z[I;4]←+/W×D÷N                         ⍝   Mean distance, weighted by wind[45]   Z[I;5]←+/W×(10⍟D)÷N                    ⍝   Mean log distance, weighted by wind[46]   Z[I;6]←+/(~D∊(⌊/,D),⌈/,D)×W×D÷N        ⍝   Trimmed mean distance, weighted by wind[47]   →(I≠E×⌊I÷E)/L1[48]   ⍞←(I=E×⌊I÷E)/(⍕I),(' (',(⍕ROUND 100×I÷1↑⍴Z),'%)'),⎕TCNL ⋄ FLUSH        ⍝   write results every E points[49]   ((I,1↓⍴Z)↑Z) TMATOUT pathW,'waves.txt'[50]   →L1[51]  [52]  L9:⍞←'MAKEWAVES finished.  Results written to '[53]   Z TMATOUT ⎕←pathW,'waves.txt'[54]      ∇