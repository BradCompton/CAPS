    ∇ POSTSOURCE N;W;C;M;Q;B;head;T;warnings;L;I;D[1]   ⍝Resolve inputs to POST or SCENARIOS, depending on ⍵[2]   ⍝Parameters set in parameters.par, [post]:[3]   ⍝   postland    name of landcover[4]   ⍝   landtypes   landcover.par file (if omitted, model uses community classes, not names)[5]   ⍝   model       post-processing community × metric table with weights[6]   ⍝   alt         alternate postfix for postland, landtypes, and model, used by LUMP[7]   ⍝   threshold   threshold for ignoring metrics in models (use 0.001)[8]   ⍝set in [scenarios]:[9]   ⍝   includemetrics  metrics to include (from SCENARIOS), takes precedence over metrics from post[10]  ⍝Results:[11]  ⍝   grid        name of landcover[12]  ⍝   postmetrics names of metrics, corresponds to columns of weights (except 1st)[13]  ⍝   weights     table of grid code, community weights[14]  ⍝   names       names of community classes, corresponds to rows of weights[15]  ⍝   badnames    for POSTFRISK[16]  ⍝   index       vector of result index names corresponding to postmetrics[17]  ⍝   prettymodel version of postmodel in which all rows sum to 100%, for POST to write to postmodel.csv[18]  ⍝Also writes <model>.csv with weights expressed as percentage for each community[19]  ⍝Compatible with both communty-based and gradient rescaling[20]  ⍝B. Compton, 28 Mar 2011 (the garden is still mostly covered with December snow)[21]  ⍝20 Dec 2011: return 'index' to allow multiple IEI-like indices; proportions within each index[22]  ⍝10 Jan 2012: oops--small bug in making weights[23]  ⍝Return prettymodel instead of writing it here--let POST do that[24]  ⍝24 Feb 2012: use GRIDNAME to translate postland if called from POST, but not from SCENARIOS (and do it right)[25]  ⍝10 Jul 2012: if includemetrics are set in [scenarios], they take precedence over metrics in postmodel.par (for CSE)[26]  [27]  [28]  [29]   grid←(¯1×~N≡'post') GRIDNAME pathG PATH  postland←postland,alt      ⍝Land cover grid name - only substitute grid names if called from POST[30]   M←pathI PATH model←(STRIP model),alt,'.par'[31]   ⎕ERROR (~IFEXISTS M)/'Error: table named in model (',M,') doesn''t exist'[32]   W←TABLE M                                  ⍝community × metric table of weights[33]   postmetrics←TOUPPER FRDBL¨1↓↓',' MATRIFY head  ⍝Metrics[34]   index←(¯1+1↓⍴W)⍴⊂'iei'                     ⍝default index is IEI[35]   →(~'index'≡TOLOWER ⊃W[1;1])/L1             ⍝If index is supplied,[36]   index←TOLOWER 1↓W[1;]                      ⍝   return list of indices[37]   W←1 0↓W                                    ⍝   and drop it from weights[38]   W[;1↓⍳1↓⍴W]←NUMBERS W[;1↓⍳1↓⍴W]            ⍝   it will have prevented conversion to numeric in MATIN, so do it now[39]  L1:C←W[;1]                                  ⍝Communities[40]   W←0⌈0 1↓W[41]   D←((D⍳D)=⍳⍴D)/D←index[42]   I←0[43]  L2:→((⍴D)<I←I+1)/L3                         ⍝For each index,[44]   W[;B/⍳1↓⍴W]←T÷⍉(⌽⍴T)⍴+/T←(B←index≡¨D[I])/W ⍝   weights in terms of proportion within index.  All weights forced to ≥0[45]   →L2[46]  L3:W←threshold×⌊W÷threshold                 ⍝Ignore metrics representing <0.1% of a community's model[47]   head←'"CAPS community model, in terms of percent.  Transient version, created by POST, ',NOW,'"',⎕TCNL,head[48]   prettymodel←(pathI PATH (STRIP M),'.csv') head (((⊂''),FRDBL¨⍕¨C),index⍪W×100)[49]  [50]   →(0∊⍴landtypes)/L4                         ⍝If landcover types are supplied,[51]   L←pathI PATH landtypes←(STRIP landtypes),alt,'.par'[52]   ⎕ERROR (~IFEXISTS L)/'Error: table named in landtypes (',L,') doesn''t exist'[53]   landcover←¯1 TABLE L                       ⍝   Read landcover table[54]   warnings←''[55]   Q←1 LOOKUP (⍳⍴C),[1.5]C                    ⍝   Look up communities using synonyms[56]   badnames←warnings[57]   names←landcover[landcover[;1]⍳Q[;1];2]     ⍝   Community names corresponding to weights[58]   W←Q[;1],W[Q[;2];]                          ⍝   Weights[59]   →L5[60]  [61]  L4:W←(NUMBERS ⍕¨C),W                        ⍝Else, no community names used...just have grid codes[62]   names←⍕¨C[63]  [64]  L5:weights←(B←1,~^⌿0=0 1↓W)/W               ⍝Drop any metrics with no weight in any models[65]   postmetrics←(1↓B)/postmetrics[66]   index←(1↓B)/index    ∇