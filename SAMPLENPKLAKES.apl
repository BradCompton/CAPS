    ∇ SAMPLENPKLAKES;X;F;R;P;M;L;D;S;head;loop;test;noread;grids;B;block;Z;I;spread;W;A;J;K;T;Y;C;E;G;U;V;Q;H;H_;O;T1;T2;P1;S1;N;U1;B1;I1;lakes;ids;mix;X1;J1;KK;O1;O2;F2;R2;W1;TX;bad[1]   ⍝Get samples for Betsy Homa's nutrient metric[2]   ⍝Builds resistant watershed for each sampling point, and summarizes several variables across this watershed[3]   ⍝Each variable gets both sum and time-of-flow weighted sum across the watershed[4]   ⍝Input tables:[5]   ⍝   \caps\more\npk\source\npksamples.txt    nutrient sampling points (site, x-coord, y-coord)[6]   ⍝   \caps\more\npk\source\ValidSiteList.txt list of sites from npksamples.txt to run for--subset to these[7]   ⍝   \caps\more\npk\landclasses.txt          classes for landcover[8]   ⍝   \gis\lithology\lithocode.txt            classes for lithology[9]   ⍝Input grids:[10]  ⍝   \caps\grids\land                CAPS landcover (types & groups to include are in .....)[11]  ⍝   \caps\source\flow               D8 flow direction grid[12]  ⍝   \caps\grids\wresist             watershed resistance (time of flow)[13]  ⍝   \caps\source\d8accum            D8 flow accumulation (for snapping points)[14]  ⍝   \caps\settings\raw\imperv       percent impervious[15]  ⍝   \gis\census2010\popdens2010     population density (people/acre) from 2010 census[16]  ⍝   \gis\lithology\lithology        lithology (attribute names are in \gis\lithology\lithocode.txt)[17]  ⍝   \caps\more\npk\source\tmax      max temperature (reprojected from HA)[18]  ⍝   \caps\settings\raw\mintemp      min temperature (from CAPS)[19]  ⍝   \caps\more\npk\source\pptmean   mean precip (reprojected from HA)[20]  ⍝   \caps\more\npk\source\septic    septic system data of some sort[21]  ⍝   \caps\more\ha\source\madischarge.txt  text file from madischarge.shp, point discharges from SYE (million gallons/day)[22]  ⍝Result:[23]  ⍝   \caps\more\npk\results\npklakes.txt  table of values for each nutrient sampling point[24]  ⍝B. Compton, 2 Aug 2012[25]  ⍝23 Aug 2012: subset to sites in ValidSiteList.txt.  Read points for discharge instead of grid, to sum correctly when multiple points in cell.[26]  ⍝31 Aug and 6 Sep 2012: add climate and septic data; 7 Sep: replace characters in header[27]  ⍝26 Nov 2013: diverged from SAMPLENPK to do lakes; write rkernel grids; blur starting point to do watersheds for whole lake[28]  ⍝7 Dec 2013: more changes.  Add lake area.[29]  ⍝10 Dec 2013: write gridpolys\...[30]  ⍝Takes several hours to run.[31]  [32]  [33]  [34]   SETPATHS[35]   CONFIG[36]   INIT[37]   loop←test←noread←0 ⋄ grids←0 0⍴''              ⍝Silly junk for BLOCK, etc.[38]   block←0[39]   spread←1E6[40]   E←2↑path[41]  [42]   F←READ E,'\caps\source\flow'                     ⍝Read these grids statewide[43]   R←1E6 MVREP READ '\caps\grids\wresist'[44]   A←READ E,'\caps\source\d8accum'[45]  [46]   lakes←50=READ E,'\CAPS\GRIDS\LAND'[47]  ⍝ ids←READ E,'\CAPS\SOURCE\PONDIDS'[48]  ⍝ mix←⌊READ E,'\CAPS\SOURCE\MIXWATER'[49]  [50]  [51]   KK←8 2⍴¯1 0 1 0 0 ¯1 0 1 ¯1 ¯1 1 1 ¯1 1 1 ¯1   ⍝   Flow direction grid[52]  [53]  [54]   S←TABLE E,'\CAPS\more\NPKlakes\Lake99v3.txt' ⍝Sampling points               ⍝*** DOING LAKES, NOT STREAMS[55]   S←S[;(',' MATRIFY TOLOWER head) MATIOTA MATRIFY 'site x-coord y-coord'][56]  ⍝ Q←TABLE E,'\caps\more\npk\source\ValidSiteList.txt'[57]  ⍝ S←(S[;1]∊Q[;1])⌿S[58]   ⎕←'Subsetting to ',(⍕1↑⍴S),' sites.'[59]   S[;1]←FRDBL¨12↑¨⍕¨S[;1]  ⍝Shorten too-long name[60]   S[;2 3]←↑FINDCELL¨↓S[;2 3]                     ⍝Convert locations to grid cells[61]  [62]   H←1 ⎕TCHT MATIN E,'\caps\more\ha\source\madischarge.txt' ⍝Read discharge points[63]   H_←⎕TCHT MATRIFY head[64]  [65]   U←0 ⎕TCHT 1 MATIN E,'\gis\lithology\lithocode.txt'[66]   V←0 ⎕TCHT 1 MATIN E,'\caps\more\npk\landclasses.txt'[67]  [68]   Y←MATRIFY 'site area imperv population discharge maxtemp mintemp meanprecip septic lakearea'[69]   Y←Y OVER MIX U[;2],V[;2][70]   Y←VTOM '. ._.-._.(..).' TEXTREPL MTOV Y[71]   Q←Z←S[;1],((1↑⍴S),¯1+1↑⍴Y)⍴0[72]  bad←(1↑⍴S)⍴0[73]   I←0[74]  L1:→((1↑⍴S)<I←I+1)/L2                           ⍝For each sampling point,[75]   BREAKCHECK[76]  [77]   X←M←P←L←T1←T2←P1←S1←0                          ⍝   Make some space so we don't crash[78]  [79]   ⎕←'Point ',(⊃S[I;1]),' (',(⍕I),' of ',(⍕1↑⍴S),')' ⋄ FLUSH[80]   J←¯1 0 1∘.+S[I;2 3]                            ⍝   snap to flow (≤1 cell)[81]   S[I;2 3]←S[I;2 3]+2↑,(,T=⌈/,T←A[J[;1];J[;2]])⌿9 2⍴(3/¯1 0 1),[1.5]9⍴¯1 0 1[82]  [83]  [84]   U1←S[I;2 3]⍪T1⍪T2⍪⊃⍪/(⊂F) FLOWINTO¨↓T2←⊃⍪/(⊂F) FLOWINTO¨↓T1←F FLOWINTO S[I;2 3]       ⍝   Cells that flows into cells that flow into this one, etc.--it should be a lake cell[85]   T←2↑,(lakes SCATI U1)⌿U1     ⍝   Identify our lake[86]   :if 0∊T[87]      bad[I]←1 ⋄ ⎕←'  ***** No lake cells at or near point ',⍕⊃S[I;1][88]      →L1[89]   :end[90]   O1←lakes FIND1PATCH T[91]   W←O1⌈F R RSHED S[I;2 3]                        ⍝   build resistant watershed (everything in the lake is 1)[92]  [93]   TX←1200 CLIP O1                                 ⍝   take a big clip so we don't have so much data[94]   O2←O1[1⊃TX;2⊃TX][95]   F2←F[1⊃TX;2⊃TX][96]   R2←R[1⊃TX;2⊃TX][97]   W←W[1⊃TX;2⊃TX][98]   O1←⍳0[99]  [100]  X1←INDICES O2^(~1⌽O2)∨(~¯1⌽O2)∨(~1⊖O2)∨~¯1⊖O2  ⍝   Indices of edge cells[101] [102]  J←0[103] L98:→((1↑⍴X1)<J←J+1)/L99                        ⍝      Now get watershed for each cell on the edge of our lake[104]  W←W⌈F2 R2 RSHED X1[J;][105]  →L98[106] L99:[107] [108]  W1←(⍴F)⍴0[109]  W1[1⊃TX;2⊃TX]←W                                ⍝   unclip...[110]  W←W1[111]  W1←⍳0[112]  W←W[1⊃K;2⊃K←CLIP W]                            ⍝   clip to watershed[113]  W←(W≠0)×(W-T)÷1-T←⌊/(,W≠0)/,W                  ⍝   rescale 0-1[114]  B←⊃,/(⊃¨K),⍴¨K                                 ⍝   MER[115] [116]  (MVREP W (W=0)) WRITEBLOCK (⊂E,'\CAPS\MORE\NPKLAKES\GRIDS\G',⊃S[I;1]),B       ⍝   Write watershed kernel (0s as missing)[117]  (MVREP ((W≠0)×⎕FI ⊃S[I;]) (W=0)) WRITEBLOCK (⊂E,'\CAPS\MORE\NPKLAKES\GRIDPOLYS\G',⊃S[I;1]),B       ⍝   Write watershed kernel as watershed #[118] [119]  X←0 MVREP READBLOCK (⊂E,'\caps\grids\land'),B  ⍝   Read these grids for watershed's MER[120]  M←0 MVREP READBLOCK (⊂E,'\caps\settings\raw\imperv'),B[121]  P←0 MVREP READBLOCK (⊂E,'\gis\census2010\popdens2010'),B[122] ⍝ D←0 MVREP READBLOCK (⊂E,'\caps\more\ha\source\madisch'),B[123]  L←0 MVREP READBLOCK (⊂E,'\gis\lithology\lithology'),B[124]  T1←0 MVREP READBLOCK  (⊂E,'\caps\more\npk\source\tmax'),B[125]  T2←0 MVREP READBLOCK  (⊂E,'\caps\settings\raw\mintemp'),B[126]  P1←0 MVREP READBLOCK  (⊂E,'\caps\more\npk\source\pptmean'),B[127]  S1←0 MVREP READBLOCK  (⊂E,'\caps\more\npk\source\septic'),B[128] [129] ⍝Now get discharge, from points[130]  T←(FINDPOINT B[1 2]),FINDPOINT B[1 2]+B[3 4]-1        ⍝MER in map units[131]  D←(^/(O≥(⍴O)⍴T[1 4])^O≤(⍴O←H[;H_ COL 'x-coord y-coord'])⍴T[3 2])⌿H[;H_ COL 'x-coord y-coord cfd']      ⍝Discharge points in our grid[132]  D[;1 2]←(↑FINDCELL¨↓D[;1 2])-((1↑⍴D),2)⍴B[1 2]-1      ⍝Convert points to cells[133]  D←D[⍋D;][134]  T←¯1↓∨/(D[;1 2]⍪0)≠0⍪D[;1 2][135]  D←(T⌿D[;1 2]),T pSUM D[;3][136]  D←(B[3 4]⍴0) SCATR (D[;1 2]) (D[;3])           ⍝   discharge grid, finally[137] [138] [139] ⍝Scale by G for mean, or C for per km^2[140] [141] [142]  Z[I;2]←Q[I;2]←C←(G←+/,W>0)×1E¯6×30*2           ⍝   watershed area (km^2)[143] [144]  Z[I;3]←(+/,M×W>0)÷G                            ⍝   mean imperviousness[145]  Q[I;3]←(+/,M×W)÷+/,W                           ⍝   mean weighted imperviousness[146] [147]  Z[I;4]←(+/,P×W>0)÷G                            ⍝   mean population density[148]  Q[I;4]←(+/,P×W)÷+/,W                           ⍝   mean weighted population density[149] [150]  Z[I;5]←(+/,D×W>0)÷C                            ⍝   mean discharge/km^2[151]  Q[I;5]←(+/,D×W)÷+/,W                           ⍝   mean weighted discharge[152] [153]  Z[I;6]←(+/,T1×W>0)÷G                           ⍝   max temperature[154]  Q[I;6]←(+/,T1×W)÷+/,W[155] [156]  Z[I;7]←(+/,T2×W>0)÷G                           ⍝   min temperature[157]  Q[I;7]←(+/,T2×W)÷+/,W[158] [159]  Z[I;8]←(+/,P1×W>0)÷G                           ⍝   mean precip[160]  Q[I;8]←(+/,P1×W)÷+/,W[161] [162]  Z[I;9]←(+/,S1×W>0)÷C                           ⍝   septic systems/km≥2[163]  Q[I;N←9]←(+/,S1×W)÷+/,W[164] [165]  Z[I;10]←(+/,W=1)×(30*2)÷1E4                    ⍝   lake area (ha)[166]  Q[I;N←10]←Z[I;10]                              ⍝   again   (N is last index used)[167] [168] [169] [170]  J←0[171] L3:→((1↑⍴U)<J←J+1)/L4                           ⍝   For each litho class,[172]  Z[I;N+J]←100×+/,((W>0)×L∊⎕FI ⊃U[J;1])÷G        ⍝      percent in this class[173]  Q[I;N+J]←100×+/,(W×L∊⎕FI ⊃U[J;1])÷+/,W         ⍝      weighted percent in this class[174]  →L3[175] [176] L4:J←0[177] L5:→((1↑⍴V)<J←J+1)/L1                           ⍝   For each landcover class (or group),[178]  Z[I;J+N+1↑⍴U]←100×+/,((W>0)×X∊⎕FI ⊃V[J;1])÷G   ⍝      percent in this class[179]  Q[I;J+N+1↑⍴U]←100×+/,(W×X∊⎕FI ⊃V[J;1])÷+/,W    ⍝      weighted percent in this class[180]  →L5[181] [182] L2:head←1↓⊃,/⎕TCHT,¨FRDBL¨↓Y[183]  Z TMATOUT T←E,'\caps\more\npkLAKES\results\npklakes.txt'[184]  Q TMATOUT U←E,'\caps\more\npkLAKES\results\npklakes_weighted.txt'[185]  ⎕←'Results written to ',T,' and ',U[186]  X←'GRID' OVER ((~bad)⌿MIX ((⊂E,'\CAPS\MORE\NPKLAKES\POLYS\P'),¨S[;1]),¨(⊂' = GRIDPOLY(',E,'\CAPS\MORE\NPKLAKES\GRIDPOLYS\G'),¨(S[;1]),¨⊂')') OVER 'Q'[187]  X←X OVER '' OVER (~bad)⌿MIX (⊂'arcshape ',E,'\CAPS\MORE\NPKLAKES\POLYS\P'),¨S[;1],¨(⊂' polys ',E,'\CAPS\MORE\NPKLAKES\SHAPEFILES\P'),¨S[;1][188]  X NWRITE T←E,'\CAPS\MORE\NPKLAKES\MAKEPOLYS.AML'[189]  ⎕←'AML to make watershed polys and shapefiles written to ',TOLOWER T[190]  ⎕←'Bad lakes:'[191]  ⎕←TELPRINT MIX bad/S[;1]    ∇