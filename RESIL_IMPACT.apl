    ∇ A RESIL_IMPACT S;buffer;loop;test;noread;grids;ffile;tilesize;tilemapinclude;skiptilemap;E;scenarios;scenarios_;head;I;N;lc0;Y;Q;V;t0;t1;G;ecogeo;benchpath;bench1;bench2;B;J;R0;D;M;diversity;P;diversemin;resilience;resilmin;R1;lc1;R;land;trim;F;Z2;geoclass;geo;Z;geo0[1]   ⍝Resilience impact for one or more alternate scenarios[2]   ⍝Uses same parameter file as SCENARIOS[3]   ⍝Parameters:[4]   ⍝   scenarios           scenarios file (same as used for SCENARIOS)[5]   ⍝   benchpath           path to benchmark files for Z-scoring traversability (bench_traverse) and resilience (bench_resil)[6]   ⍝   usegroups           supply an optional group file to additionally summarize by ecological system groups (formations)[7]   ⍝   ecogeo              path to ecogeo grid (reclassed from 1..n)[8]   ⍝   geo                 path to geophysical settings grid, for summarizing[9]   ⍝   diversity           path to base landscape diversity grid, z-scored by strata ecogeo (from TNC)[10]  ⍝   diversemin          minimum value for base z-scored diversity, to allow shifting to 0-n[11]  ⍝   trim                trim anything beyond this many SD [12]  ⍝   resilmin            minimum value for base z-scored resilience[13]  ⍝   resilience          path to base final resilience z-scored by strata ecogeo (our version)[14]  ⍝   tilesize            size of tiles (in cells)[15]  ⍝   targets = '1:1'     needs to be in parameters.par to run a single thread[16]  ⍝Source:[17]  ⍝   land, base          base landcover[18]  ⍝   land, alt           alternate (future) landcover[19]  ⍝   diversity           diversity, z-scored stratified by ecogeo, with minimum added so it ranges from 0 to n (from TNC)[20]  ⍝   traverse0z          base traversability, z-scored[21]  ⍝   traverse1           alternate traversability, raw[22]  ⍝   ecogeo              ecoregions × geophysical settings[23]  ⍝   resilience          base resilience, z-scored[24]  ⍝Results:[25]  ⍝   resdelta            delta grid, written to deltas[I]           [26]  ⍝   resimp              impact grid[27]  ⍝   resil_impact.txt    delta and impact summary table, written to deltas[1][28]  ⍝   resil_impact_grouped.txt    ditto, grouped by formation[29]  ⍝Use SUMMARIZE_RESIL_IMPACT 'eco' or 'geo' to make summary tables of results.[30]  ⍝Runs as a CAPS metric, but only uses one thread.  It'll be fastest if you set host = 'w00'.[31]  ⍝B. Compton, 26 May-29 Jun 2017[32]  ⍝16 Nov 2017: d'oh! Was reusing E when I still needed it; crashed on 2nd scenario[33]  ⍝29 Nov 2017: wasn't resetting block within the loop, so only the first scenario was processed[34]  ⍝2 Feb 2018: summarize by geophysical settings as well as formations[35]  [36]  [37]  [38]   READPARS ME[39]   buffer←4⊃A[40]  [41]  [42]   loop←test←noread←0 ⋄ grids←0 0⍴''                  ⍝Silly junk for BLOCK, etc.[43]   ffile←'RESIL_IMPACT '[44]   tilemapinclude←0[45]   skiptilemap←0                                      ⍝Don't let DEBUG sabotage this[46]  [47]  [48]   scenarios←1 TABLE scenarios                        ⍝Read scenarios file[49]   scenarios_←(',',⎕TCHT) MATRIFY '.".' TEXTREPL head ⍝and get header[50]   scenarios←((⍴scenarios)⌈0,1↑⍴scenarios_)↑scenarios,⊂''[51]  [52]   bench1←MATIN benchpath PATH 'bench_traverse.txt'   ⍝Read benchmark files[53]   bench2←MATIN benchpath PATH 'bench_resil.txt'[54]  [55]   geoclass←TABLE pathI,'geophysical settings.txt'    ⍝Read geophysical settings class names[56]  [57]  [58]   I←1                 [59]  L1:→((1↑⍴scenarios)<I←I+1)/L9                       ⍝For each scenario,[60]   ⎕←'Doing scenario ',(⊃scenarios[I;scenarios_ COL 'name']),' (',(⍕I-1),' of ',(⍕¯1+1↑⍴scenarios),')' ⋄ FLUSH[61]   BLOCK (2⍴tilesize),buffer[62]   SETTILE[63]   E←TILEMAP '' tilesize 0 0                          ⍝Get tilemap, building it if necessary. This will only help if there's mask grid.[64]   Z←Z2←0 3⍴0[65]   [66]   N←0[67]  L2: →(~E[N←N+1])/L3                                 ⍝   Repeat: read tile, skip if not in tilemap    --- For each tile ---[68]      BREAKCHECK [69]      DOT   [70]      land←READ GRIDNAME 'land'                               ⍝      Read base landcover with culverts and dams[71]      lc0←READ GRIDNAME ⊃scenarios[1;scenarios_ COL 'land']   ⍝      Read base landcover grid [72]      Y←~land∊LOOKNAMES 'developed,',exclude                  ⍝      Exclude development & excluded systems[73]      [74]      lc1←READ GRIDNAME ⊃scenarios[I;scenarios_ COL 'land']   ⍝      Read alternate landcover grid [75]      V←READ GRIDNAME diversity                               ⍝      Read base diversity (standardized) [maybe should fill in missing roads with focalmean?][76]      V←diversemin MVREP V (lc0≠lc1)                          ⍝      Set all new development to minimum[77]  [78]      t0←READ GRIDNAME (⊃scenarios[1;scenarios_ COL 'results']),'traverse0z'  ⍝      Read base traversability (standardized)[79]      t1←READ GRIDNAME (⊃scenarios[I;scenarios_ COL 'results']),'traverse0'   ⍝      And alternate traversability (raw)[80]      t1←t1×~lc1∊LOOK 'developed'                                             ⍝      Set all developed in alternate landcover to 0 in raw traversability[81]   [82]      G←READ GRIDNAME ecogeo                                  ⍝      Read ecoregion by geophysical setting grid[83]      Y←Y^G≠MV                                                ⍝      we won't run for missing ecogeo[84]      [85]      geo0←READ GRIDNAME geo                                  ⍝      read geophysical settings, for summarizing[86]      [87]      R0←READ GRIDNAME resilience                             ⍝      read base resilience, z-scored[88]  [89]  [90]      B←,Y^~(lc0∊MV)∨(G∊MV)∨(t1∊MV)∨(R0∊MV)∨(V∊MV)∨(land∊LOOK 'developed')∨lc0∊LOOK 'open water'   ⍝      Missing, developed, open water, or excluded anywhere → missing[91]       [92]      ⍝Now z-score alternate traversability, stratified, using benchmarks 1[93]      J←bench1[;1]⍳B/,G                                       ⍝      Index of benchmark for ecogeo setting[94]      t1←((B/,t1)-bench1[J;2])÷bench1[J;3]                    ⍝      Standardize[95]      t1←(-trim)⌈trim⌊t1                                      ⍝      trim to specified SD[96]      t1←MVREP ((⍴lc0)⍴B\t1) ((⍴lc0)⍴~B)                      ⍝      back to original matrix[97]  [98]      R1←(t1+V)÷2                                             ⍝      raw alternate resilience is (diversity + traversabiltiy)÷2[99]  [100]     ⍝Now zscore alternate resilience using benchmarks 2       [101]     J←bench2[;1]⍳B/,G                                       ⍝      Index of benchmark for ecogeo setting[102]     R1←((B/,R1)-bench2[J;2])÷bench2[J;3]                    ⍝      Standardize[103]     R1←(-trim)⌈trim⌊R1                                      ⍝      trim to specified SD[104]     R1←MVREP ((⍴lc0)⍴B\R1) ((⍴lc0)⍴~B)                      ⍝      back to original matrix[105] [106]     R1←resilmin MVREP R1 (lc0≠lc1)                          ⍝      Set newly developed stuff to the minimum z-scored resilience value[107] [108]     D←R1-R0                                                 ⍝      Delta-resilience is resilience1 - resilience0[109]     D←MVREP D ((⍴lc0)⍴~B)                                   ⍝      deal with missing values[110] [111]   ⍝  D←0 MVREP D (land∊LOOK 'developed')                      ⍝      Developed in base gets delta of 0 (only matters for raster results)[112] [113]     R←MVREP (R0-resilmin) (R0=MV)                           ⍝      shift resilience to 0-n...need to do this for impact so we don't multiply negative by negative[114]     M←MVREP (D×R) ((⍴D)⍴~B)                                 ⍝      Impact = shifted base resilience × delta[115]     [116]     P←⊃scenarios[I;scenarios_ COL 'deltas'][117]     (5 ROUND D) WRITE P,'resdelta'[118]     (5 ROUND M) WRITE P,'resimpact'[119]     [120]     ⍝Do aspatial summaries of tile[121]     Z←Z⍪RESIL_ASPATIAL B lc0 D M                    ⍝      do aspatial summary by formation[122]     Z2←Z2⍪RESIL_ASPATIAL B geo0 D M                 ⍝      and by geophysical setting[123]     [124] L3:→(0≠NEXTBLOCK)/L2                                ⍝   Until no more tiles[125] [126]  ⍝Summarize by ecological system[127]  Z←Z[⍋Z;]                                           ⍝   summaries across tiles[128]  B←Z[;1]≠0,¯1↓Z[;1][129]  Z←(B/Z[;1]),(B pSUM Z[;2]),[1.5]B pSUM Z[;3][130] [131]  P←⊃scenarios[1;scenarios_ COL 'deltas'][132]  F←'. ._' TEXTREPL ⊃scenarios[I;scenarios_ COL 'name'][133] [134] ⍝Write aspatial summary for landscape[135]  Q←(landcover[landcover[;1]⍳Z[;1];2]),0 1↓Z[136]  head←1↓⎕TCHT MTOV MATRIFY 'system resil_delta resil_impact'[137]  Q TMATOUT P,'\resil_impact_eco_',F,'.txt'[138]  [139] ⍝Write summary by groups[140]  Z←GROUPSUMMARY Z[141]  →(0∊⍴Z)/L1[142]  head←1↓⎕TCHT MTOV MATRIFY 'formation resil_delta resil_impact'[143]  Z TMATOUT P,'\resil_impact_eco_grouped_',F,'.txt'[144]  [145]  [146]  [147]  ⍝Now summarize by geophysical setting (but don't do by groups, as we don't have good higher-level groups)[148]  Z2←Z2[⍋Z2;]                                           ⍝   summaries across tiles[149]  B←Z2[;1]≠0,¯1↓Z2[;1][150]  Z2←(B/Z2[;1]),(B pSUM Z2[;2]),[1.5]B pSUM Z2[;3][151] [152]  P←⊃scenarios[1;scenarios_ COL 'deltas'][153]  F←'. ._' TEXTREPL ⊃scenarios[I;scenarios_ COL 'name'][154] [155] ⍝Write aspatial summary for landscape[156]  Q←(geoclass[geoclass[;1]⍳Z2[;1];2]),0 1↓Z2[157]  head←1↓⎕TCHT MTOV MATRIFY 'geosetting resil_delta resil_impact'[158]  Q TMATOUT P,'\resil_impact_geo_',F,'.txt'[159]  →L1                                                ⍝Next scenario[160] [161] [162] L9:⎕←''[163]  LOG 'RESIL_IMPACT is done.'[164]  →0[165] [166] [167] [168] what:auxiliary[169] type:table[170] info:('') ('') ('') 0 ''      ⍝Source grid, settings table, result grid, buffer size, and include grid[171] check:CHECKVAR 'scenarios benchpath usegroups ecogeo geo diversity diversemin resilmin trim resilience tilesize targets'    ∇