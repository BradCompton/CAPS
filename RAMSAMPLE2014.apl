    ∇ S RAMSAMPLE2014 W;E;X;Y;U;D;T;M;qt;qtiles;head;K;B;I;H;V;J;Z[1]   ⍝Process CAPS sampling plots for 2014 season[2]   ⍝RAMSAMPLE 1 → create random points; ⍺ = number of random points[3]   ⍝&r ramsample[4]   ⍝RAMSAMPLE 2 → process results; ⍺ = separation distance, points per bin[5]   ⍝B. Compton, 29 Feb-3 Mar 2008[6]   ⍝28 Apr 2008: allow more points, print table, give blind points with randomly assigned bins[7]   ⍝17 Apr 2009: for 2009 season[8]   ⍝10-11 Apr 2014: for 2014, these changes:[9]   ⍝   do 3 watersheds (Deerfield, Westfield, Housatonic)[10]  ⍝   do fowet and ss (separately)[11]  ⍝   no more stratifying by insults[12]  [13]  [14]  [15]  [16]  →(1 2=W)/L1,L2[17]  [18]  L1:⍝Create random points for ramsample.aml[19]   ⍎(0=⎕NC'S')/'S←1E6'[20]   head←''[21]   I←0[22]  L11:→(3<I←I+1)/0                    ⍝For each watershed[23]   E←(3 4⍴34920 867270 73800 929520 70860 913500 113490 944580 63150 861840 110190 929850)[I;][24]   X←E[1]+(UNIFORM S)×(E[3]-E[1])[25]   Y←E[2]+(UNIFORM S)×(E[4]-E[2])[26]   (X,[1.5]Y) CMATOUT 'd:\caps\more\ram2014\',(I⊃'housatonic' 'deerfield' 'westfield'),'PTS.TXT'[27]   →L11[28]  [29]  [30]  [31]  [32]  [33]  L2:⍎(0=⎕NC'S')/'S←500 25'           ⍝Separation distance, points per bin[34]   I←0[35]  L21:→(3<I←I+1)/0                    ⍝For each watershed,[36]   H←(I⊃'housatonic' 'deerfield' 'westfield')[37]   ⎕←'Watershed:',H[38]   ⎕←''[39]   X←MATIN 'd:\caps\more\ram2014\',H,'\sample.txt'[40]   X←0 1↓X                            ⍝X is X, Y, IEI, type, insults, verboten (river buffer), capsland[41]   X←(~(FRDBL¨X[;5])≡¨⊂'MISSING')⌿X[42]   X←(~(FRDBL¨X[;4])≡¨⊂'MISSING')⌿X[43]  [44]   X[;3]←⎕FI ,' ',MIX X[;3]           ⍝IEI[45]   X[;4]←⎕FI ,' ',MIX X[;4]           ⍝Type[46]   X[;5]←⎕FI ,' ',MIX X[;5]           ⍝Verboten[47]   X[;6]←⎕FI ,' ',MIX X[;6]           ⍝Community (from grid)[48]   X←(~X[;5])⌿X                       ⍝Drop out points too close to big rivers[49]   X←(X[;3]≠0)⌿X                      ⍝And drop out IEI = 0 - those are developed[50]   X←(((X[;6]=44)^X[;4]=12)∨(X[;6]=41)^X[;4]∊14 15 16)⌿X  ⍝Drop points in the wrong community (poly vs. grid check)[51]   X←X[;⍳4]                           ⍝and get verboten & community columns out of here![52]  [53]  ⍝X has 4 columns: x, y, IEI, community[54]   X[;4]←(X[;4]=12)+2×X[;4]∊14 15 16  ⍝1 = SS, 2 = FOWET[55]   X←(X[;4]≠0)⌿X[56]  [57]   X←X,X[;3]+.001×UNIFORM 1↑⍴X        ⍝Add a tiny random number to prevent ties in quantiles (5th column)[58]   X[;5]←10×10 QUANTILE X[;5]         ⍝Deciles of IEI (0-9)[59]  [60]  ⍝Now X has 5 columns: 1:x, 2:y, 3:IEI, 4:community (1 = SS, 2 = FOWET), 5:decile[61]   V←X[62]   J←0[63]  L6:→(2<J←J+1)/L21                   ⍝For each community,[64]   X←(V[;4]=J)⌿V                      ⍝   Pull out points in this community[65]   ⎕←'   Community: ',J⊃'ss' 'fowet'[66]   Y←X[67]   K←0[68]  [69]  L3:X←Y,UNIFORM 1↑⍴Y                 ⍝Random number (6th column)[70]  ⍝Now X has 6 columns: 1:x, 2:y, 3:IEI, 4:community (1 = SS, 2 = FOWET), 5:decile, 6:random number[71]  [72]   X←X[⍋X[;5 6];]                     ⍝Sort by decile & random number[73]  [74]   U←((X[;5]⍳X[;5])=⍳1↑⍴X)/X[;5]      ⍝Unique bins[75]   X←X,⊃,/⍳¨+⌿X[;5]∘.=U               ⍝Index[76]  ⍝Now X has 7 columns: 1:x, 2:y, 3:IEI, 4:community (1 = SS, 2 = FOWET), 5:decile, 6:random number, 7:index in bin[77]   X←(X[;7]≤S[2])⌿X                   ⍝Pick ⍺[2] points in each bin[78]  [79]   D←(((X[;1]∘.-X[;1])*2)+(X[;2]∘.-X[;2])*2)*.5[80]   D←((⍳1↑⍴X)∘.<⍳1↑⍴X)×D<S[1]         ⍝Points within ⍺[1] m of others[81]   X←(~∨⌿D)⌿X                         ⍝Drop subsequent points that are too close[82]  [83]   :if J=2                            ⍝If doing fowet,[84]      D←(((X[;1]∘.-Z[;1])*2)+(X[;2]∘.-Z[;2])*2)*.5[85]      X←(~∨/D<S[1])⌿X                 ⍝   don't pick points too close to SS[86]   :end[87]  [88]   U←((X[;5]⍳X[;5])=⍳1↑⍴X)/X[;5][89]   X[;7]←⊃,/⍳¨+⌿X[;5]∘.=U             ⍝Re-index[90]   X←(X[;7]≤S[2])⌿X                   ⍝Pick more points[91]  [92]   :if J=2                            ⍝If doing fowet,[93]      D←(((X[;1]∘.-Z[;1])*2)+(X[;2]∘.-Z[;2])*2)*.5[94]      X←(~∨/D<S[1])⌿X                 ⍝   don't pick points too close to SS[95]   :else[96]      Z←X[97]   :end[98]  [99]   ⎕←'Number of bins with at least 1, 2, ..., n points: ',⍕T←+⌿X[;7]∘.=⍳S[2][100] [101]  →((20>K←K+1)^B←∨/T<S[2])/L3        ⍝Want at least S[2] points in each bin...may not be able to get it[102]                                     ⍝This will be either because IEI and insults are highly correlated and[103]                                     ⍝there simply aren't enough points, or because I'm asking for too great[104]                                     ⍝a spacing.[105] [106]  ⍞←B/'*** Failed to fill all bins in 20 tries.',⎕TCNL[107] [108]  X←X[;1 2 3 5 1 7]                  ⍝1:x, 2:y, 3:IEI, 4:decile, 5:bin, 6:index[109]  X[;5]←(10?10)[1+X[;4]]             ⍝5:Random bin assignments[110]  X←X[⍋X[;5 6];]                     ⍝Sort on bin & index[111] [112]  head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord IEI decile bin index'[113]  X TMATOUT T←'d:\CAPS\more\ram2014\',H,'-',(J⊃'ss' 'fowet'),'-slampoints.txt'[114]  head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord bin index '[115]  X[;1 2 5 6] TMATOUT T←'d:\CAPS\more\ram2014\',H,'-',(J⊃'ss' 'fowet'),'-blindpoints.txt'[116] [117]  ⎕←''[118]  ⎕←'Points written to ',T[119]  ⎕←''[120]  ⎕←'Number of ',(J⊃'ss' 'fowet'),' points per bin:',⎕TCNL[121]  ⎕←⍕((⊂'IEI'),'-',0,⍳9),'|','n'⍪'-'⍪(10 1)⍴+⌿X[;4]∘.=0,⍳9[122]  ⎕←''[123]  →L6    ∇