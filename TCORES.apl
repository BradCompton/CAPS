    ∇ A TCORES S;bandwidth;B;buffer;I;X;W;C;Q;V;R;Z;U;Y;L;systems;slice;expand;toosmall;multiplier;density;M;transparent;dot;barriers;culverts;buf;Y2;logistic;selindex;result[1]   ⍝Build buffered terrestrial reserve cores for LCD using resistant kernel[2]   ⍝Input grids:[3]   ⍝   selindex        value grid (IEI or selection index)[4]   ⍝   land            landcover grid[5]   ⍝Parameters:[6]   ⍝   selindex        name of selection index grid[7]   ⍝   result          name of result grid[8]   ⍝   systems         text file listing names of systems to include (usually terrestrial.txt)[9]   ⍝   slice           include values > slice[1] in patches; slice[2] is used for lakes[10]  ⍝   expand          number of cells to expand to eliminate small gaps (usually 1)[11]  ⍝   toosmall        drop tiny patches with this many cells or fewer[12]  ⍝   multiplier      multiplier on value for costs[13]  ⍝   bandwidth       default bandwidth (h, or s.d. of kernel), in meters[14]  ⍝   density         build kernels for every nth cell to speed things up[15]  ⍝   logistic        inflection & scaling factor to use for resistance (use 0 for no logistic function)[16]  ⍝   barriers        optional list of cover types to treat as absolute barriers, used to keep reserves from spanning highways[17]  ⍝   culverts        optional list of cover types representing culverts or dams, treated as barriers if adjacent to one of 'barriers'[18]  ⍝   buffer          number of cells to buffer tiles - should be radius of largest core + bandwidth÷cellsize[19]  ⍝Results:[20]  ⍝   cores           reserve kernels[21]  ⍝B. Compton, 18-25 Jun 2014, from BUFFERCORES[22]  ⍝22 Aug 2014: bug - lost patches completely surrounded by development[23]  ⍝8 Oct 2014: add logistic resistance scaling for terrestrial cores[24]  ⍝27 Oct 2014: Split from MAKECORES; now applies to terrestrial only[25]  ⍝12 Nov 2014: use RKERNELS to build kernels[26]  ⍝14 Nov 2014: always set SI to 0 for roads (it wasn't where streams overlap roads)[27]  ⍝21 Sep 2015: oops! I'm sampling seeds, but need to treat entire seed as 1.0, not just samples[28]  ⍝12 Jul 2016: specify input & result in parameters.par to avoid inputs.par/results.par confusion[29]  ⍝23 Jan 2016: ugh! change \ back to / in culverts[30]  [31]  [32]  [33]   READPARS ME[34]   X←READ 1⊃1⊃A                                   ⍝Read value grid[35]   W←READ 2⊃1⊃A                                   ⍝And landcover[36]   X←X×~W∊LOOKNAMES 'roads, trains'               ⍝Set selection index for all roads and railroads to 0[37]   Q←W∊LOOKNAMES barriers                         ⍝Set highways to missing so they'll get super-high resistance[38]   X←MVREP X (Q∨(W∊LOOKNAMES '.\./' TEXTREPL culverts)^FOCALMAX Q)⍝Set culverts and dams to missing if adjacent to highways[39]   Q←0 ⎕TCHT MATIN pathI PATH systems,(~'.'∊systems)/'.txt'[40]   Y←X×W∊(LOOKUP 0,Q)[;1]                         ⍝Set everything outside of selected systems in landcover to 0[41]   Y2←Y≥(slice←2↑,slice,0)[1]                     ⍝Take values ≥ slice[1][42]  [43]   Y←((Y2≠0)^W≠MV)×expand BUFFER Y2               ⍝Buffer to merge fragments, but not across value = 0 or landcover = missing[44]   Y←FINDPATCH Y                                  ⍝Build patches (8-neighbor)[45]  [46]   Q←(Q≠0)/Q←,Y[47]   Q←Q[⍋Q][48]   B←Q≠0,¯1↓Q[49]   Q←(B/Q),[1.5]B pSUM (⍴B)⍴1                     ⍝Patch #, number of cells[50]   Y←Y×Y∊U←(Q[;2]>(toosmall←2⍴toosmall)[1])/Q[;1] ⍝Drop tiny patches[51]   Y←MVREP Y ((W=MV)∨X=MV)                        ⍝Carry over missing cells in landcover or value[52]  [53]   buf←1+⌈bandwidth÷cellsize                      ⍝Buffer; take 1 extra cell to deal with rounding[54]   Z←(⍴X)⍴0[55]  [56]   I←0[57]   dot←⍴⍞←'Building kernels for ',(⍕⍴U),' cores',MB ⋄ FLUSH[58]   R←RESIST 1-X                                   ⍝   We'll rescale IEI/selection index into resistance[59]   R←1E6 MVREP R (Y=MV)                           ⍝   missing cells get resistance of a million[60]  L1:→((⍴U)<I←I+1)/L2                             ⍝   For each core,[61]   BREAKCHECK[62]   DOT[63]   L M ← buf CLIP Y=U[I]                          ⍝      Clip to this core plus buffer[64]   C←C×(C≠0)^0=FOCALMIN C←0 MVREP Y[L;M]          ⍝      Edges of core[65]   V←(⍴C)⍴0[66]   S←20<+/,C=U[I]                                 ⍝      If core is small with few edge cells, don't skip any cells[67]  [68]   Q←buf (C=U[I]) (1⌈S×density) 2 RKERNELS R[L;M] ⍝      Build kernels[69]   Z[L;M]←Z[L;M]⌈(Q÷buf)⌈Y[L;M]=U[I]              ⍝      save kernel (combined with entire original seed)[70]   →L1[71]  [72]  L2:transparent←3                                ⍝Use max transparency mode[73]   (MVREP Z ((W=MV)∨Z=0)) WRITE 3⊃A               ⍝Save transparently, with all 0's set to missing[74]   ⎕←''[75]   →0[76]  [77]  [78]  [79]  what:auxiliary[80]  type:standard[81]  info:(selindex 'land') ('') (result) (buffer⌈⌈bandwidth÷cellsize)       ⍝Source grid, settings table, result grid, and buffer size[82]  check:CHECKVAR 'systems slice expand toosmall multiplier bandwidth density barriers culverts buffer logistic selindex result'    ∇