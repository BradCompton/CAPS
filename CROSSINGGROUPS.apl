    ∇ CROSSINGGROUPS;I;X;cross_;head;S;D;J;G;F;T;N;Q;K;B;C[1]   ⍝Build groups for crossings table[2]   ⍝All culverts/bridges in the same roadclass and traffic and within separation distance of each other are put in the same group[3]   ⍝Also, crossings that fall in the same cell are grouped[4]   ⍝Source and result:[5]   ⍝   tables\crossings.txt        crossings table[6]   ⍝Adds new column 'group' or replaces existing one[7]   ⍝B. Compton, 28 Jul 2011[8]   ⍝11 Aug 2011: drop 0,0 crossings[9]   ⍝1 Jul 2014: also group crossings in the same cell, for the sake of LINKAGES[10]  [11]  [12]  [13]  ⍝ S←(0,⍳5),[1.5]200 150 75 75 2 2    ⍝Separation distances for each class (railroad, expressway, primary, secondary, local, unpaved)[14]      ⍝Trains: 200 gets all double/multiple tracks, and most railyards, without picking up too many parallel streams, I think[15]      ⍝Expressway: 150 gets all but 2 or 3 places where separation is 500 m or so[16]      ⍝Primary and secondary: 75 seems plenty safe, picks up cloverleafs, etc.[17]      ⍝Local and unpaved: here I just want to get nearly duplicated points[18]  [19]   S←(0,⍳6),[1.5]150 150 75 75 75 2 2      ⍝For LCC Rt. 11: 0 = Rt. 11, 1 = Expressway, 2 = Primary, 3 = Secondary, 4 = Tertiary, 5 = Local, 6 = Track[20]  [21]   INIT[22]   X←0 1 1 TABLE F←pathT PATH 'crossings.txt'     ⍝Read crossings file[23]   K←(cross_←',' MATRIFY head) COL 'x-coord y-coord roadclass adt' ⍝Indices: K[1] = x, K[2] = y, K[3] = roadclass, K[4] = traffic[24]   X←(∨/X[;K[1 2]]≠0)⌿X                           ⍝Drop 0,0 crossings[25]   →(0≠cross_ COL 'group')/L0                     ⍝If no group varible yet,[26]   X←(X,0),0[27]   cross_←cross_ OVER MATRIFY 'group groupsize'[28]  L0:X[;G←cross_ COL 'group groupsize']←0         ⍝G[1] = group index, G[2] = group size index[29]   N←100⍴0[30]   I←0[31]  L1:→((1↑⍴X)<I←I+1)/L2                           ⍝For each crossing,[32]   DOT[33]   →(X[I;G[1]]≠0)/L1                              ⍝   Skip if we're already in a group[34]   J←S[;1]⍳X[I;K[3]]                              ⍝   Index into separation table[35]   →(S[J;2]=¯1)/L1                                ⍝   If separation is ¯1, skip it[36]   B←(X[;K[3 4]]^.=X[I;K[3 4]])                   ⍝   Culverts in our road class and traffic rate[37]   D←((((X[I;K[1]])∘.-B⌿X[;K[1]])*2)+((X[I;K[2]])∘.-B⌿X[;K[2]])*2)*.5[38]   X[T←(B\D≤S[J;2])/⍳1↑⍴X;G[1]]←I                 ⍝   Assign to group, along with later nearby points in same class/traffic[39]   X[T;G[2]]←⍴T[40]   N[⍴T]←N[⍴T]+1[41]   →L1[42]  [43]  L2:C←C⍳C←FINDCELL¨↓X[;K[1 2]]                   ⍝Find crossings that share a cell[44]   I←0[45]  L3:→((1↑⍴X)<I←I+1)/L4                           ⍝For each crossing,[46]   →(C[I]=I)/L3                                   ⍝   If part of a merged group thanks to shared cells,[47]   B←(X[;G[1]]∊X[I,C[I];G[1]])/⍳1↑⍴X              ⍝      merge the groups[48]   X[B;G[1]]←X[I;G[1]][49]   X[B;G[2]]←+/X[I;G[1]]=X[;G[1]][50]   →L3[51]  [52]  L4:head←1↓⎕TCHT MTOV cross_[53]   X TMATOUT F[54]   ⎕←'Groups written to ',F[55]   ⎕←''[56]   ⎕←'Group size frequencies:'[57]   ⎕←' ',' ',' ',(⍳1↑⍴N),'|',[1.5]N←(-+/^\⌽N=0)↓N    ∇