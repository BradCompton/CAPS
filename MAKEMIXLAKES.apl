    ∇ A MAKEMIXLAKES S;buffer;B;P;F;I;Z;M;D;Q;R;W;N;targets;C;fd[1]   ⍝Set up data for mixing water in big lakes with MIXLAKES[2]   ⍝Runs as a CAPS table metric[3]   ⍝Inputs (all in source\):[4]   ⍝   land            landcover (for clipping)[5]   ⍝   pondids         Grid of IDs for each pond[6]   ⍝   flow            D8 flow grid[7]   ⍝   fd8accum        FD8 flow accumulation grid[8]   ⍝   streams         Stream centerline & off-centerline cells[9]   ⍝Parameters:[10]  ⍝   targets         Target lakes, should be biglakes.txt (table with pond id and xmin, ymin, xmax, ymax describing MER for each lake)[11]  ⍝Results:[12]  ⍝   mixwater        Encoded water mixing grid[13]  ⍝Must also run companion table metric, MAKEMIXWATER, simultaneously (to avoid killing shared result grid)[14]  ⍝B. Compton, 2-3 and 20 Sep 2010[15]  ⍝18 Oct 2010: target inflowing cells just outside of lake[16]  ⍝25 Oct 2010: avoid trouble from rounding errors[17]  ⍝19 Feb 2011: write inflows for watershed metrics[18]  ⍝18 Jul 2011: bug: when 100% of flow came from one cell, we got an integer, thus encoded as centerline mixing[19]  ⍝19 Oct 2011: drop writing inflows - they're not used by watershed metrics any more, and I had a name collision[20]  ⍝27 Oct 2011: oops on output grid.  Fixed.[21]  ⍝20 Jan 2012: Don't allow same flow path to repeatedly visit pond[22]  ⍝24 Jan 2012: trim buffer for lakes on N/W edge of landscape[23]  ⍝24 Jul 2015: clip input grids to landcover[24]  [25]  [26]  [27]   READPARS ME[28]   buffer←B←4⊃A[29]  [30]   M←0 1 1 TABLE pathT PATH targets           ⍝Read target table.  Must enforce sequential ids for all table metrics.[31]   M←0 1↓(M[;1]∊(⊃⊃S)+¯1+⍳2⊃⊃S)⌿M             ⍝Lakes that are our problem now[32]   fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1[33]   I←0[34]  [35]  L1:→((1↑⍴M)<I←I+1)/0                        ⍝For each lake in table,[36]   BREAKCHECK[37]   D←(FINDCELL M[I;2 3]),FINDCELL M[I;4 5]-.01⍝   Convert MER to cells[38]   D[3 2 1 4]←D                               ⍝   and rearrange into upper left R,C, lower right[39]   D[3 4]←1+D[3 4]-D[1 2]                     ⍝   Upper left, number of cells[40]   D←1⌈D+¯1 ¯1 2 2×B                          ⍝   Buffer[41]  [42]   P←0 MVREP READBLOCK (⊂pathG PATH 1⊃1⊃A),D  ⍝   pond ids,[43]   F←READBLOCK (⊂pathG PATH 2⊃1⊃A),D          ⍝   D8 flow,[44]   W←READBLOCK (⊂pathG PATH 3⊃1⊃A),D          ⍝   FD8 flow accumulation,[45]   C←0 MVREP READBLOCK (⊂pathG PATH 4⊃1⊃A),D  ⍝   and streams[46]   Z←(⍴P)⍴MV[47]  [48]   Q←P×P=M[I;1]                               ⍝   Cells in our lake[49]   R←F×(0≠2 BUFFER Q)^Q=0                     ⍝   Ring of flows adjacent to lake[50]   N←W×R DOWNFLOW Q≠0                         ⍝   Mark cells that flow into our basin[51]   N←N×C≠2                                    ⍝   Don't allow off-centerline lotic to flow in[52]   N←F MIXTROUBLE N                           ⍝   Don't allow same flow path to repeatedly visit pond[53]   N←N DIV +/,N                               ⍝   In terms of percent[54]   N←0.9999⌊4 ROUND N                         ⍝   Only keep 4 significant digits - don't allow 1.0[55]   N←(N≠0)×(1000×(M[I;1]÷1000)-⌊M[I;1]÷1000)+N⍝   Encode 3 LSD of pondid, 4 MSD of percent contribution[56]   Z←MVREP N (N=0)[57]   Z WRITEBLOCK (⊂pathG PATH 3⊃A),D,0,1       ⍝     write grid transparently[58]   →L1[59]  [60]  [61]  what:data prep[62]  type:table[63]  info:((⊂pathS),¨'pondids' 'flow' 'fd8accum' 'streams') ('') (pathS PATH 'mixwater') (1) 'luwet'       ⍝Source grid, settings table, result grid, and buffer size[64]  check:CHECKVAR 'targets'[65]  check:pathT CHECKFILE targets    ∇