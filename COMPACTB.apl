    ∇ A COMPACTB S;M;buffer;X;F;maskv;ocean;transparent;Z;Q;C;Y;J;tinywatersheds;fd;bigwatersheds;head;I;K;L;G;T[1]   ⍝Calculate compactness metric for tiny watersheds (used in hydrologic alterations)[2]   ⍝Big watersheds are done in companion metric COMPACT[3]   ⍝B. Compton, 12 and 22 Dec 2014 (from COMPACT and WATERSHEDB)[4]   [5]   ⍝Note: must run COMPACT as a companion, at the same time[6]   [7]   [8]   [9]    READPARS ME[10]   buffer←4⊃A[11]  [12]  ⍝First: read input data & check mask[13]   X←READ pathG PATH 1⊃1⊃A                        ⍝Read landcover[14]   X←MVREP X (X∊⊃,/LOOK¨FRDBL¨↓','MATRIFY ocean)  ⍝Ocean cells → MV; this will blank ocean out of flow & prevent errors when outflows cross islands & capes[15]  [16]   maskv←C←1=READ pathG PATH 2⊃1⊃A                ⍝Read streams grid...we'll run for stream centerlines...[17]   →(0∊⍴('*',0 0 0 1) INCLUDE X)/0                ⍝Which cells to run for? Pretty much all of them, including developed!  Bail if all masked out; otherwise ignore mask[18]   F←READ pathG PATH 3⊃1⊃A                        ⍝Flow[19]   F←0 MVREP F (X=MV)                             ⍝if it's not in landcover, we don't want to flow through it![20]  [21]  [22]   :if 0∊⍴tinywatersheds                          ⍝If tinywatersheds file not supplied, generate them[23]      fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1[24]      M←Q DOWNFLOW Q=0                            ⍝   Find outflows[25]      M←M^(⍴M)↑C                                  ⍝   Don't want any in buffer[26]      M←((,M)/,⍉(⌽⍴M)⍴⍳1↑⍴M),[1.5](,M)/,(⍴M)⍴⍳1↓⍴M⍝      Convert outflows to points[27]      Q←0 1 TABLE pathT PATH bigwatersheds        ⍝   Read big watershed table[28]      Q←Q[;(',' MATRIFY head) COL 'x-coord y-coord'][29]      Q←↑1 FINDCELL¨↓Q                            ⍝   Convert them to cells[30]      M←(~(↓M)∊↓Q)⌿M                              ⍝   and remove these from our list[31]   :else                                          ⍝else, read existing tinywatersheds table[32]      M←0 1↓⊃0 READVEC tinywatersheds             ⍝   Read tinywatersheds without buffer; drop watershed #s, as they're only used in TRPOINTS[33]      M←↑1 FINDCELL¨↓M                            ⍝   Convert outflows to cells[34]   :end[35]   M←(C SCATI M)⌿M                                ⍝Only run for watersheds with streams at the outflow[36]  [37]   Z←(⍴X)⍴MV[38]   I←0[39]  L1:→((1↑⍴M)<I←I+1)/L4                           ⍝For each tiny watershed,[40]   ⎕←'Tiny watershed ',(⍕I),' of ',(⍕1↑⍴M) ⋄ FLUSH[41]   Z[M[I;1];M[I;2]]←COMPACTNESS Q←F POINTSHED M[I;] ⍝   Get watershed and compactness for outflow cell[42]  [43]   K L ← CLIP Q                                   ⍝   Clip to tiny watershed[44]   G←F[K;L][45]   T←(C×Q)[K;L][46]   Y←↑((↓INDICES T)+⊂¯1+⊃¨K L)~⊂M[I;]             ⍝   Targets are stream centerlines in watershed (excluding outflow, which we've already done)[47]   ⎕←'   (',(⍕1+1↑⍴Y),' cells)' ⋄ FLUSH[48]   J←0[49]  L3:→((1↑⍴Y)<J←J+1)/L1                           ⍝   For each target cell,[50]   :if (J÷100)=⌊J÷100[51]      ⎕←(⍕ROUND 100×J÷1↑⍴Y),'%' ⋄ FLUSH ⋄ BREAKCHECK[52]   :end[53]   Z[Y[J;1];Y[J;2]]←COMPACTNESS G POINTSHED Y[J;]-¯1+⊃¨K L ⍝      Get compactness[54]   →L3[55]  [56]  L4:transparent←1[57]   (MVREP Z (F=MV)) WRITE pathG PATH 3⊃A          ⍝Write results[58]   →0[59]  [60]  [61]  [62]  what:data prep[63]  type:standard[64]  info:((⊂'land'),(⊂pathS) PATH¨'streams' 'flow') '' (path,'ha\compact') (⌈1000×buffer÷cellsize) 'include'      ⍝Source grid, settings table, result grid, buffer size, and include grid[65]  check:CHECKVAR 'ocean'[66]  check:1 CHECKCOVER 'ocean'    ∇