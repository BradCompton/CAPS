    ∇ FLOWa I;N;K;Q;J;E[1]   ⍝Recursively calculate flow accumulation for cell R,C ⍵[2]   ⍝Globals:[3]   ⍝   H   FD8 flow grid (8×R×C)[4]   ⍝   D   1 if this cell is done[5]   ⍝   P   Pending flag: 1 if we're already working on this cell[6]   ⍝   Z   result[7]   ⍝B. Compton, 7-13 Mar 2008[8]   [9]   [10]  [11]   I J←I[12]   →(~P[I;J])/L0[13]   bad[I;J]←bad[I;J]+1[14]   →0[15]  L0:P[I;J]←1[16]   N←↑,(I+¯1 0 1)∘.,J+¯1 0 1          ⍝Neighbors[17]   E←D[I+¯1 0 1;J+¯1 0 1]             ⍝Which ones aren't done yet[18]   E[2;2]←1                           ⍝Exclude focal cell[19]   E←(~,E)^H[2 3 4 1 1 5 8 7 6;I;J]≠0 ⍝Only visit cells that flow into this one[20]   N←E⌿N[21]  [22]   K←0[23]  L1:→((1↑⍴N)<K←K+1)/L2               ⍝For each neighbor,[24]   →D[N[K;1];N[K;2]]/L1               ⍝   Bail out if cell has already been done (could happen elsewhere in recursion)[25]   FLOW N[K;]                         ⍝   Recurse[26]   →L1[27]  [28]  L2:→D[I;J]/0                        ⍝If this cell was already done during recursion, get out now[29]   Q←H[;I;J]×Z[I;J-1],Z[I-1;J-1],Z[I-1;J],Z[I-1;J+1],Z[I;J+1],Z[I+1;J+1],Z[I+1;J],Z[I+1;J-1][30]  [31]   Z[I;J]←Z[I;J]++/Q[32]   D[I;J]←1                           ⍝Done with this cell    ∇