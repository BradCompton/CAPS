    ∇ A GRADIENT S;buffer;B;X;F;Z;E;I;J;fd;K;D;U;H;Q;T;V;C;W;R[1]   ⍝Stream gradient settings variable[2]   ⍝Runs as a CAPS block metric.[3]   ⍝Inputs (all in source\):[4]   ⍝   dem_fill    Elevation grid (depressionless)[5]   ⍝   flow        D8 flow grid[6]   ⍝   fd8accum    FD8 flow accumulation grid[7]   ⍝   streams     Stream centerline cells[8]   ⍝Results:[9]   ⍝   gradient    Stream gradient (mean of 1, 2, and 3 cell window around each cell)[10]  ⍝Parameters: none[11]  ⍝Note: horizontal distances are measured directly for 2- and 3-cell windows, because most[12]  ⍝path convolution is probably an artifact of gridding.[13]  ⍝If either up or downstream cells are missing, or if no upstream cells feed in, gradient is[14]  ⍝in nonmissing direction.  Final gradient is mean of of scales that are nonnegative and nonmissing.[15]  ⍝Don't worry that empty blocks come out as NODATA--that gets fixed in setgradient.aml.[16]  ⍝B. Compton, 17 Aug 2010[17]  ⍝20 Jan 2010: use depressionless DEM[18]  [19]  [20]  [21]   READPARS ME[22]   buffer←B←4⊃A[23]   X←READ pathG PATH 1⊃1⊃A                                ⍝Get DEM,[24]   →(^/,MV=(B,B)↓(-B,B)↓X)/0                              ⍝If all missing, bail out[25]   F←READ pathG PATH 2⊃1⊃A                                ⍝slope,[26]   W←READ pathG PATH 3⊃1⊃A                                ⍝flow accumulation,[27]   R←1=READ pathG PATH 4⊃1⊃A                              ⍝and stream centerlines[28]   F←MVREP F (R≠1)                                        ⍝only want gradient among stream cells[29]   Z←(3,⍴X)⍴MV[30]  [31]   fd←(2*¯1+⍳8),8 2⍴0 1 1 1 1 0 1 ¯1 0 ¯1 ¯1 ¯1 ¯1 0 ¯1 1[32]   fd←fd⍪MV,0 0[33]  [34]   K←¯4+⍳7[35]   I←B[36]  L1:→(((1↑⍴X)-B)<I←I+1)/L9                               ⍝For each row,[37]   BREAKCHECK[38]   →(^/X[I;]=MV)/L1                                       ⍝   Skip this row if it's all missing[39]   J←B[40]  L2:→(((1↓⍴X)-B)<J←J+1)/L1                               ⍝   For each column,[41]   →(R[I;J]≠1)/L2                                         ⍝      If this is a stream cell,[42]   U←1 2↑(Q=⌈/Q←W SCATI T)⌿T←F FLOWINTO I,J               ⍝         Major cell flowing into this one[43]   U←U⍪1 2↑(Q=⌈/Q←W SCATI T)⌿T←F FLOWINTO U[1;]           ⍝         and into that[44]   U←U⍪1 2↑(Q=⌈/Q←W SCATI T)⌿T←F FLOWINTO U[2;]           ⍝         and into the next[45]   D←D⍪F NEXTFLOW ¯1 2↑D←D⍪F NEXTFLOW D←F NEXTFLOW I J    ⍝         Next 3 downflows[46]   H←cellsize×(+/((6 2⍴I,J)-U⍪D)*2)*.5                    ⍝         Horizontal distances, up and down[47]   V←(3/¯1 1)×C⍀X[I;J]-X SCATI (C←~∨/(U⍪D)∊0,MV)⌿U⍪D      ⍝         Vertical distances[48]   Z[;I;J]←MVREP (100×.5×+⌿T←2 3⍴V÷H) (∨⌿~2 3⍴C)          ⍝         Results are mean percent slope, upstream and downstream[49]   Z[Q/⍳3;I;J]←(Q←1=+⌿2 3⍴C)/((2 3⍴C)[2;]⊖T)[1;]×100      ⍝         If upstream (or downstream) are missing, just give gradient in one direction[50]   →L2[51]  [52]  L9:Z←(+⌿Z×(Z≠MV)^Z≥0) DIV +⌿(Z≠MV)^Z≥0                  ⍝Take mean across nonmissing/nonnegative scales[53]   Z←MVREP Z (R=MV)[54]   (X REMV Z) WRITE pathR PATH 3⊃A[55]   →0[56]  [57]  what:data prep[58]  type:standard[59]  info:((⊂pathS),¨'dem_fill' 'flow' 'fd8accum' 'streams') ('') (pathS PATH 'rawgradient') (3) 'luwet'      ⍝Source grid, settings table, result grid, and buffer size    ∇