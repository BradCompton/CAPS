    ∇ A TR S;I;M;W;R;J;Z;dams;targets;E;T;tr;trtable;trx;X;tinywatersheds;lc;result;trs;lrpars;B;d8flow;block;transparent;buffer[1]   ⍝CAPS tidal restriction metric[2]   ⍝⍺ = usual metric left arguments[3]   ⍝⍵ = (start-item number-of-items) (systems)[4]   ⍝If watershed # is 0, then do all tiny watersheds[5]   ⍝B. Compton, 24 Jan 2011, 14 Feb 2011 and 11-25 Mar 2011 from WATERSHED2 and TR (8 and 12 Apr 2010)[6]   ⍝27 Jan 2012: adjust if we're against the north or west edge of the grid[7]   ⍝4 Jun 2012: split out tiny watersheds[8]   ⍝7 Aug 2012: push a few lines into MER2CELLS[9]   ⍝17 Dec 2015: new approach: if lrpars[10]  [11]  ⍝Note: must run TRB as a companion, at the same time[12]  [13]  [14]  [15]   READPARS ME[16]   buffer←4⊃A[17]   M←0 1 1 TABLE pathT PATH targets               ⍝Read TR watershed table[18]   tr←TABLE pathT PATH trtable                    ⍝Read tidal restriction points[19]   tr←(tr[;3]>0)⌿tr                               ⍝Tidal restriction of 0 = no restriction, so forget these; also skip empirical negative restrictions[20]  [21]   M←(M[;1]∊(⊃⊃S)+¯1+⍳2⊃⊃S)⌿M                     ⍝Items we're doing[22]   M←0 1↓M                                        ⍝Drop watershed # - we don't care about it[23]  [24]   transparent←1[25]   I←0[26]  L2:→((1↑⍴M)<I←I+1)/0                            ⍝For each watershed,[27]   BREAKCHECK                                     ⍝   Do a single watershed[28]   W←M[I;][29]   →(~∨/trx←(tr[;1]≥W[5])^(tr[;1]≤W[7])^(tr[;2]≥W[6])^tr[;2]≤W[8])/L2     ⍝   If there's a tidal restriction in watershed's MER, it's worth looking...[30]  [31]   W[5 6 7 8]←MER2CELLS W[5 6 7 8]                ⍝Convert MER to cells[32]   W[3 4]←buffer+1+(FINDCELL W[3 4])-W[5 6]       ⍝   Watershed outflow in terms of grid[33]   block←¯1,W[5 6 7 8],buffer                     ⍝   set block to our current window[34]  [35]  [36]   X←READ 1⊃1⊃A                                   ⍝   Tides[37]   →(^/,X∊0,MV)/L2                                ⍝   Bail if no tidally-influenced cells[38]   lc←READ 2⊃1⊃A                                  ⍝   Landcover[39]   E←READ 3⊃1⊃A                                   ⍝   DEM[40]   R←READ 4⊃1⊃A                                   ⍝   tiderange[41]   S←READ 5⊃1⊃A                                   ⍝   south[42]   d8flow←READ 6⊃1⊃A                              ⍝   D8 flow accumulation[43]  [44]   ⎕←'Watershed ',(⍕W[1]),'...' ⋄ FLUSH[45]   dams←lc=LOOK 'dam'[46]   result←(⍴X)⍴MV[47]   J←buffer+↑(FINDCELL¨↓trx⌿tr[;⍳2])-⊂W[5 6]-1[48]   trs←((⍴X)⍴0) SCATR J (trx/tr[;3])                                          ⍝   Create TR grid for this watershed[49]  [50]   X←1-÷1+*-(lrpars[1]×B/,0 MVREP E)+(lrpars[2]×B/,R)+lrpars[3]×(B←,R≠MV)/,S  ⍝   Tides, unrestricted[51]   X←MVREP ((⍴R)⍴B\X) (R=MV)[52]  [53]  ⍝TRr expects globals: result, trs, d8flow, dams[54]   0 TRr W[3 4]                                                               ⍝   Follow watershed up from outflow cell, taking max restriction along the way[55]   :if lrpars≡0                                                               ⍝   If using new approach (just worst marsh loss ratio),[56]      Z←result[57]   :else                                                                      ⍝   otherwise, we're using old regression approach,[58]      R←MVREP (0⌈R-result) ((X=MV)∨(E=MV)∨result=MV)                          ⍝      Subtract restriction from tidal range[59]      Z←1-÷1+*-(lrpars[1]×B/,E)+(lrpars[2]×B/,R)+lrpars[3]×(B←,R≠MV)/,S       ⍝      Logistic regression to tidal regime setting...1-LR b/trs TIDES is backwards[60]   :end[61]   Z←MVREP ((⍴R)⍴B\Z) (R=MV)                                                  ⍝   Expand and replace missing values[62]   Z←MVREP (X-Z) (Z=MV)                                                       ⍝   Difference from tides setting variable is tidal restriction metric[63]   Z←6 ROUND Z                                                                ⍝   Not too many digits[64]  [65]   Z WRITE pathR PATH 3⊃A                         ⍝   Write results transparently[66]   →L2[67]  [68]  [69]  [70]  what:CAPS coastal[71]  type:table[72]  info:((⊂pathU PATH 'tides'),(⊂'land'),(⊂pathS) PATH¨'dem' 'tiderange' 'south' 'flow' 'zeros') ('') ('TR') (1)       ⍝Metric-specific source grids, settings table, result grid, and buffer size[73]  check:CHECKVAR 'lrpars targets'                                     ⍝Logistic regression parameters for dem538, tiderange, south[74]  check:1 CHECKCOVER 'dam'[75]  check:pathT CHECKFILE trtable[76]  check:pathT CHECKFILE targets[77]  init:(GRIDNAME pathS PATH 'zeros') GRIDCOPY pathR PATH 'tr'          ⍝Copy grid of zeros to result so we don't have MVs in unvisited marshes    ∇