    ∇ Z←V CROSSINGSMOD X;I;Q;M;L;Y;R;score;value;Y_;S;B[1]   ⍝Modify values of settings grids ⍵ for road/stream crossings given scores passed in table[2]   ⍝   1⊃⍺     settings table (settings variable, function to modify each)[3]   ⍝   2⊃⍺     crossings table (id, x, y, score) (header) (name of column we're using for score, e.g., 'terrestrial' for CONNECT)[4]   ⍝   3⊃⍺     settings variable names[5]   ⍝Global:[6]   ⍝   ss      table of scales for settings variables, created by GETRANGES[7]   ⍝Functions modify settings variable in original scale using functions like *1-score*.9		[8]   ⍝or +log 1-score*.9, or replacement functions like 0 or score*.5.[9]   ⍝Values are kept between 0 and 1[10]  ⍝Used for CONNECT[11]  ⍝B. Compton, 19-20 and 28 Oct 2010[12]  ⍝29 Jan 2011: Rewrite for continuous functions of settings variable and crossing score[13]  ⍝25 Jul 2011: drop unused score table header[14]  ⍝8 Aug 2011: Replace neighbors to get wide dams & culverts and wide roads/railroads (but only a little wide!); 11 Aug - but only if requested (it's slow!)[15]  ⍝18 Aug 2011: Add value, move score into loop where it belongs. 18 Sep: boy, was that stupid: score doesn't belong in loop![16]  ⍝22 Sep 2011: now that aqconnect follows flow lines, don't widen dams and culverts any more[17]  ⍝26 Jun 2013: expect bankcrossings.txt to have 6 columns plus id - was trashing it before, because I added surveyed column and didn't update here[18]  ⍝4 Dec 2013: pass header of crossings table, and use column names instead of mickymousing it[19]  ⍝1 Jul 2014: deal explicitly with multiple crossings in a cell--always use lowest value[20]  [21]  [22]  [23]   Z←X[24]   →((1 1⍴MV)≡1⊃V)/0                                          ⍝Bail out if no scores[25]   Y Y_ S ← 2⊃V                                               ⍝Crossings table, header, and score column name[26]   Y←Y[;(FRDBL¨↓TOLOWER Y_)⍳FRDBL¨'x-coord' 'y-coord' (TOLOWER S)]      ⍝Pull columns we want out of crossings table[27]  [28]   M←(1⊃V),ss[(TOLOWER¨ss[;1])⍳FRDBL¨TOLOWER (1⊃V)[;1];2 3]   ⍝Settings variable, function, original scale (min, max)[29]   L←(3⊃V)⍳FRDBL¨M[;1]                                        ⍝Indices into target settings variables[30]   Y[;1 2]←↑1 FINDCELL¨↓Y[;1 2]                               ⍝Crossing locations in terms of cells[31]   Y←(^/(Y[;1 2]≥1)^Y[;1 2]≤((1↑⍴Y),2)⍴1↓⍴X)⌿Y                ⍝Clip to extent of current block + buffer[32]   →(0∊⍴Y)/0                                                  ⍝Bail if we've clipped it all away[33]   Y←Y[⍋Y[;1 2];]                                             ⍝Sort locations...[34]   B←∨/Y[;1 2]≠¯1 0↓0⍪Y[;1 2]                                 ⍝Find duplicates in cells[35]   Y←(B⌿Y[;1 2]),B pMIN Y[;3]                                 ⍝and take worst crossing for each cell[36]   score←Y[;3]                                                ⍝score is terrestrial crossings score, used in functions[37]  [38]   I←0[39]  L1:→((⍴L)<I←I+1)/0                                          ⍝For each target settings variable,[40]   X←Z[L[I];;]                                                ⍝   Settings variable[41]   Q←M[I;3]+(X SCATI Y[;1 2])×-/M[I;4 3]                      ⍝   Settings variable at crossings in original scale[42]   R←((LJUST⊃M[I;2])[1]∊'+-*/')/'Q'                           ⍝   If function starts with +-*/, it's modifying settings variable; otherwise it replaces it[43]   value←Q[44]   ⍎'Q←',R,REPLACESYM ⍕⊃M[I;2]                                ⍝   Apply function[45]   Q←(Q-M[I;3])÷-/M[I;4 3]                                    ⍝   back to original scale[46]   X←X SCATR (Y[;1 2]) (0⌈1⌊Q)                                ⍝   replace into grid; don't allow anything out of 0~1 range[47]   Z[L[I];;]←X[48]   →L1    ∇