    ∇ A ROADPOINTS S;X;N;Z;H;V;I;J;R;head;buffer;Q;D;B;W;Y[1]   ⍝Make roads table for LINKAGES[2]   ⍝Parameters:[3]   ⍝   interval    grid size (m) for placing points on roads[4]   ⍝Inputs:[5]   ⍝   grids\roads[6]   ⍝Results:[7]   ⍝   tables\roadpoints[8]   ⍝B. Compton, 26-27 Aug 2010[9]   ⍝NOTE: interval should be a multiple of cell size, and block should be a multiple of interval.[10]  ⍝Otherwise, you may get artifacts at block edges.[11]  ⍝31 Aug 2010: set traffic to zero![12]  [13]  [14]   READPARS ME[15]   buffer←4⊃A[16]  [17]   X←READ 1⊃A                                                 ⍝Get roads,[18]   →(0∊⍴Y←S '' INCLUDE X)/0                                   ⍝Which cells to run for? (ignore include grid)[19]   X←MVREP X (~Y)[20]   N←(cellsize×⍴X)÷interval                                   ⍝Number of horizontal & vertical lines[21]   Z←(⍴X)⍴0[22]   H←⌊(⍳⌊N[1])×interval÷cellsize                              ⍝Horizontal lines (NEED OFFSET!)[23]   V←⌊(⍳⌊N[2])×interval÷cellsize                              ⍝and vertical[24]   Z[H;]←0 MVREP X[H;][25]   Z[;V]←0 MVREP X[;V][26]  [27]   I←⍉(⌽⍴X)⍴⍳1↑⍴X[28]   J←(⍴X)⍴⍳1↓⍴X[29]   Z←(,Z≠0)⌿(,I),(,J),[1.5],Z                                 ⍝Row, column, road type[30]   →(0∊⍴Z)/0[31]  [32]   R←.5×interval÷cellsize                                     ⍝Minimum separation distance[33]   Z←(∨/Q≠0⍪¯1 0↓Q←⌊Z[;1 2]÷R)⌿Z                              ⍝Remove points too close to each other horizontally[34]   Z←Z[⍋Z[;2];][35]   Z←(∨/Q≠0⍪¯1 0↓Q←⌊Z[;1 2]÷R)⌿Z                              ⍝and vertically[36]   Z←Z[⍋Z;][37]  [38]   D←(((Z[;1]∘.-Z[;1])*2)+(Z[;2]∘.-Z[;2])*2)*.5               ⍝Distance matrix[39]  L1:→(R≤Q←⌊/(,D≠0)/,D)/L2                                    ⍝If some points are too close,[40]   B←(⍳1↑⍴D)≠1↑(∨/D=Q)/⍳1↑⍴D[41]   D←B/B⌿D[42]   Z←B⌿Z[43]   →L1[44]  [45]  L2:Z[;1 2]←↑FINDPOINT¨↓(((1↑⍴Z),2)⍴THISBLOCK[1 2]-buffer+1)+Z[;1 2]⍝Points in terms of x,y[46]  ⍝ Z[;3]←10⍟1-traffic                                         ⍝Reduce traffic by traffic×100%[47]   Z[;3]←0                                                    ⍝Set traffic to zero[48]  [49]   W←(FINDPOINT Q[1 2]-.5),FINDPOINT Q[1 2]+(Q←THISBLOCK)[3 4]-.5[50]   Z←((Z[;1]>W[1])^(Z[;2]<W[2])^(Z[;1]<W[3])^Z[;2]>W[4])⌿Z    ⍝Drop buffer[51]   Z LOCKWRITE pathT PATH 'roadpoints.txt'[52]   →0[53]  [54]  [55]  what:auxiliary[56]  type:standard[57]  info:(pathS PATH 'roads') ('') ('') (⌈interval÷cellsize) (pathS PATH 'roads')      ⍝Source grid, settings table, result grid, buffer size, and include grid[58]  check:CHECKVAR 'interval'[59]  init:head←1↓⎕TCHT MTOV MATRIFY 'x-coord y-coord traffic' ⋄ (0 0⍴'') TMATOUT pathT PATH 'roadpoints.txt' ⍝(Re)create points file on start    ∇