    ∇ N NEWMOSAIC G;P;M;Q;T;L[1]   ⍝Create empty new mosaic ⍵, of type ⍺ (1 = integer, 2 = floating point)[2]   ⍝B. Compton, 10 Oct 2013[3]   ⍝11 Oct 2013: use WRITEMOSAICINFO[4]   ⍝21 Oct 2013: don't create empty directories here--they'll be created as needed in WRITEBLOCK[5]   ⍝14-15 Nov 2013: just return if mosaic already exists; okay if empty folder[6]   ⍝12 Dec 2013: don't format mosaicwindow here--it happens in WRITEMOSAICINFO[7]   ⍝16 Dec 2013: call MOSAICINFO; 17 Dec: without locking again!![8]   ⍝20 Dec 2013: minor bug[9]   ⍝1 Apr 2014: make robust to synchronous calls[10]  ⍝28 Apr 2014: suppress local gridinfo caching[11]  ⍝31 Aug 2016: write mosaic name[12]  [13]  [14]  [15]   ⍎(0=⎕NC'N')/'N←2'[16]   P←(G←TOLOWER G),'\'[17]   L←LOCKFILE P                           ⍝Get a lock on the mosaic directory[18]   →(~0∊⍴⊃1 1 MOSAICINFO P)/L2            ⍝If it's already a mosaic, we're done[19]   :if ~''≡T←FILEINFO P                   ⍝If it's not a mosaic but the directory exists[20]   :andif 0≠⊃T                            ⍝   and isn't empty[21]      T←⎕DL 5                             ⍝   wait 5 sec[22]      :if 0∊⍴⊃1 1 MOSAICINFO P            ⍝   and check again for mosaic[23]          UNLOCKFILE L[24]  [25]  [26]  ('Crash in NEWMOSAIC', ⍕?1E6) GETLOCK 0                  ⍝Temporary code to help with debugging ***[27]  STOP[28]  [29]  [30]         ⎕ERROR 'Error creating mosaic: folder ',G,' already exists and is not empty'[31]      :end[32]   :end[33]  [34]   1 MAKEDIR P                            ⍝Create mosaic directory if it doesn't exist yet[35]  [36]   M←mosaic[mosaic_ COL 'rowsize colsize rows cols'][37]   G WRITEMOSAICINFO (STRIP G) 'original' '' '' (mosaicwindow,MV,N) (M[1]) (M[2]) (M[3]) (M[4]) ((Q←×/M[3 4])⍴0)[38]   TRACK ⎕TCNL,'   [Mosaic ',G,' created]'[39]  [40]  L2:UNLOCKFILE L    ∇