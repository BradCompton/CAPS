    ∇ R VECTORMOSAIC F;W;M;S;I;T;X;H;head;Q;J;Y;K;P;A;E;C;dot;L;G[1]   ⍝Make a vector mosaic named 1⊃⍵ from tables in 2⊃⍵ (default path 3⊃⍵) with reference ⍺[2]   ⍝   ⍵[1]    name of vector mosaic to create[3]   ⍝   ⍵[2]    list of tables to include in mosaic (space-delimited)[4]   ⍝   ⍵[3]    default path for ⍵[2] (optional)[5]   ⍝   ⍺[1]    number of cell rows in pane[6]   ⍝   ⍺[2]    number of cell columns in pane[7]   ⍝   ⍺[3]    name of reference grid (supplies extent)[8]   ⍝Vector mosaic format:[9]   ⍝   data are in a folder with the mosaic's name.  Files consist of:[10]  ⍝   vectormosaicdescrip.txt (see docs\vector mosaics for CAPS for details)[11]  ⍝   and tablename<pane number>.txt for each pane[12]  ⍝Once the vector mosaic is created, CAPS metrics can read vector data with[13]  ⍝   window READVEC 'vectortable'[14]  ⍝Default <window> = the current tile.  If <vectortable> is a table, not a[15]  ⍝mosaic, it is read directly.[16]  ⍝*** WARNING: lines and polys may not be larger than a pane, or things will go horribly wrong[17]  ⍝Sample call:[18]  ⍝   1000 2000 'land' VECTORMOSAIC 'test' 'crossings' 'd:\caps\working\'[19]  ⍝B. Compton, 23-24 Oct 2013[20]  ⍝31 Dec 2013: error if no header in file[21]  ⍝7 Jan 2014: do INIT here[22]  ⍝20 Jan 2014: Speedups: do WHICHPANE 10,000 rows at a time--it is massively nonlinear at large numbers of rows; use fast alternative to TMATOUT[23]  [24]  [25]  [26]   INIT[27]   W←5↑GRIDDESCRIBE pathG PATH 3⊃R        ⍝Reference window[28]   M←(¯4×'.txt'≡¯4↑M)↓M←TOLOWER pathT PATH 1⊃F[29]   S←(3↑F,⊂pathT)[3] PATH¨FRDBL¨↓MATRIFY 2⊃F[30]  [31]   ⎕ERROR (IFEXISTS M,'\')/'Error: folder ',M,'\ already exists. Delete it or choose another name'[32]  [33]   E←(×/C←⌈W[2 1]÷R[1 2])⍴0               ⍝Start with empty pane map[34]   I←0[35]  L1:→((⍴S)<I←I+1)/L2                     ⍝For each input table,[36]   dot←0[37]   T←pathT PATH T,(~'.'∊(-+/^\⌽T≠'\')↑T←I⊃S)/'.txt'  ⍝   Default extension is .txt[38]   ⍞←⎕TCNL,'Mosaicking ',T ⋄ FLUSH[39]   X←2 ',' MATIN T                        ⍝   read table, forcing integer[40]   ⎕ERROR (0∊⍴head)/'Error: vector table ',T,' has no headers'[41]   H←FRDBL¨↓',' MATRIFY TOLOWER head[42]   Q←'x-coord y-coord x.coord y.coord x y' 'from-x from-y to-x to-y or x1 y1 x2 y2' 'xmin ymin xmax ymax'[43]   Q←FRDBL¨¨↓¨MATRIFY¨Q[44]   J←(J≤⍴H)×J←(⊂H)⍳¨Q                     ⍝   Indices into headers in coordinates[45]   Y←⌈/(∨/¨J≠0)/⍳⍴J                       ⍝   Type: 1 = point, 2 = line, 3 = poly[46]   K←(K≠0)/K←Y⊃J                          ⍝   Columns with coordinates[47]  [48]   P←((1↑⍴X),4)⍴0                         ⍝   Pane numbers (allow up to 4 per object)[49]   L←1+¯1E4[50]  L5:→((1↑⍴X)<L←L+1E4)/L6                 ⍝      For each batch of 10,000 points,[51]   G←(1↑⍴X)⌊L+0,⍳1E4-1                    ⍝         indices into X[52]  [53]   :if Y=1                                ⍝      If points,[54]      P[G;]←4↑W (R[1 2]) WHICHPANE X[G;K] ⍝         get panes[55]   :else                                  ⍝      Else, lines or polys,[56]      :for J :in ⍳⍴G                      ⍝         For each line/poly,[57]         P[G[J];]←4↑W (R[1 2]) 1 WHICHPANE 4 2⍴X[G[J];K[1 2 1 4 3 2 3 4]] ⍝            get panes[58]      :end[59]   :end[60]   →L5[61]  [62]  L6:MAKEDIR M[63]   A←(A≠0)/A←,P                           ⍝   List of all panes we're writing[64]   A←A[⍋A][65]   A←(A≠¯1↓0,A)/A[66]   E[A]←1                                 ⍝   add these to pane map[67]  [68]   J←0[69]  L3:→((⍴A)<J←J+1)/L1                     ⍝   For each pane with data,[70]   DOT[71]   Q←(∨/P=A[J])⌿X                         ⍝      rows for this pane[72]   T←(¯1↓STRIPPATH PANEPATH M (STRIP M) (A[J]) (⍴E)),'.txt'     ⍝      file name for pane table[73]   :if (⎕DR Q)∊11 323 645                 ⍝      If result is all numeric,[74]      Q←DEB 1↓MTOV LJUST ⍕Q               ⍝         do quick format -- should be much faster than TMATAPPEND[75]      Q←('. .,') TEXTREPL Q[76]      :if ~IFEXISTS T                     ⍝         if file doesn't exist yet,[77]         head NWRITE T                    ⍝            create it and write header[78]      :end[79]      Q NAPPEND T                         ⍝         and write data[80]   :else                                  ⍝      else, mixed table...must use TMATAPPEND[81]      Q TMATAPPEND T                      ⍝         append to pane table[82]   :end[83]   →L3[84]  [85]  L2:Q←'name = ''',(⍕STRIP M),''''[86]   Q←Q OVER 'type = ''',(Y⊃'point' 'line' 'poly'),''''[87]   Q←Q OVER 'timestamp = ''',NOW,''''[88]   Q←Q OVER 'extent = ',HITOLOW ⍕¯1↓⊃,/(⍕¨W),¨','[89]   Q←Q OVER 'rowsize = ',⍕R[1][90]   Q←Q OVER 'colsize = ',⍕R[2][91]   Q←Q OVER 'rows = ',⍕C[1][92]   Q←Q OVER 'cols = ',⍕C[2][93]   Q←Q OVER 'panemap = ''',(1 0⍕E),''''[94]   Q NWRITE (TOLOWER M),'\vectormosaicdescrip.txt'[95]  [96]   ⎕←⎕TCNL,'Vector mosaic ',M,' created.'    ∇