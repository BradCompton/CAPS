    ∇ LINKTABLES P;N;U;I;X;D;C;head;Z;V;W;H;B[1]   ⍝Post-process tables from FINDPATHS given bandwidths ⍵ (km), in preparation for FINDLINKS[2]   ⍝B. Compton, 18 Dec 2012, 15 Jan 2013 and 4 Feb 2013[3]   ⍝29 Mar 2013: make edited list of units; distance matrix is mean(P(distance | bandwidth)); write distance matrix for each ⍵[4]   ⍝1 Apr 2013: Round distance matrices to 5 digits[5]   ⍝27 Feb 2015: if units table doesn't exist, don't worry about it--this is also used for node and link importance[6]   [7]   [8]   [9]    SETPATHS[10]   N←0 1 TABLE pathQ,'tables\nodes.txt'           ⍝List of all nodes[11]   C←MATIN pathQ,'tables\internode.txt'           ⍝List of internodes[12]   C←((1↑⍴C),2+⍴P←,P×1000)↑C                      ⍝Make column for each probability[13]   :if IFEXISTS pathQ,'tables\units.txt' [14]      V←0 1 TABLE pathQ,'tables\units.txt'        ⍝List of units[15]   :else[16]      V←0 1⍴0[17]      ⎕←'Warning: units table does not exist.'[18]   :end[19]   H←',' MATRIFY head[20]   ⍞←(0∊∨/C[;1 2]≠0⍪¯1 0↓C[;1 2])/'Warning: There are duplicates in internode.txt!',⎕TCNL[21]  [22]  ⍝First, build unit index with mean prob/distance between each pair of units[23]   Z←0 3⍴0[24]   W←(1↑⍴V)⍴0[25]   I←0[26]  L1:→((1↑⍴C)<I←I+1)/L2                           ⍝For each internode,[27]   BREAKCHECK[28]   DOT[29]   X←MATIN pathQ,'tables\',(⍕C[I;1]),'-',(⍕C[I;2]),'edges.txt'[30]   X←X[⍋X[;1];][31]   C[I;2+⍳⍴P]←⊃,/MEAN¨↓[2]P ∘.GAUSS (X[;1]≠0,¯1↓X[;1])/X[;3]    ⍝   Get mean P(connect)/distance across edges for each bandwidth[32]   U←UNIQUENZ (U≠MV)/U←X[;2]                      ⍝   Unique units for this internode[33]   Z←Z⍪(U,[1.5]C[I;1]),C[I;2]                     ⍝   Unit index for this internode[34]   W[V[;1]⍳U]←1                                   ⍝   mark units we actually used[35]   →L1[36]  [37]  L2:⎕←''[38]   head←1↓⎕TCHT MTOV MATRIFY 'unit from to'[39]   Z TMATOUT ⎕←pathQ,'tables\unitindex.txt'[40]  [41]  ⍝Second, build distance matrices[42]   head←''[43]   I←0[44]  L3:→((⍴P)<I←I+1)/L5                             ⍝For each bandwidth,[45]   D←((2⍴1↑⍴N)⍴0) SCATR (N[;1]⍳C[;1 2]) (C[;I+2]) ⍝   Probability matrix[46]   D←D+(⍳1↑⍴D)∘.=⍳1↑⍴D                            ⍝   Diagonals are 1[47]   D←5 ROUND D                                    ⍝   Round to 5 digits--that's more than enough precision, and will prevent rounding errors from causing trouble later[48]  L4:D TMATOUT ⎕←pathQ,'tables\distance',(⊃KNAMES P[I]),'.txt'[49]   →L3[50]  [51]  L5:head←1↓⎕TCHT MTOV H[52]   (W⌿V) TMATOUT ⎕←pathQ,'tables\liveunits.txt'   ⍝Write out units we're actually using[53]  [54]   ⎕←'LINKTABLES is done.'    ∇