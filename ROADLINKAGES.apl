    ∇ A ROADLINKAGES S;B;buffer;bandwidth;search;M;head;Z;C;I;P;X;result;Y;scaleby;L;J;K;N;link_example;E;iei;override_pars;split;cross;linkages;linkgrids;G;uncertainty;score;V1;V2;bankcrossings;D;O;scores;V;cross_;W;U;T2;dams;H;T;dam;res;R;aa;t;fd;ss;crossB;W2;Q;extra;Z2[1]   ⍝Critical linkages Phase I scenario analysis, version 2.0. Roads version.[2]   ⍝Runs as a block metric[3]   ⍝⍵ = groups[4]   ⍝⍺ = (landcover grid) (settings) (result grid) (buffer) (include grid)[5]   ⍝Parameters:[6]   ⍝   scores          Name of .par file with formulas for modifying settings variables at focal cells to simulate adding wildlife[7]   ⍝                   underpasses. The format is the same as that used in CROSSINGSMOD (crossscores.par)[8]   ⍝   scales          File with settings variable, raw-min, raw-max to use for rescaling settings variables. Created by MAKESETTINGS/GETRANGES[9]   ⍝                   as part of settings variable creation.[10]  ⍝   bankcrossings   Name of file with bank crossings (typically tables\bankcrossings.txt).  Required.[11]  ⍝   uncertainty     use yes to do best-case analysis; default is best estimate.[12]  ⍝   iei             name of IEI grid excluding connectedness for weighting results (use '' if unavailable)[13]  ⍝   scaleby         1 to return raw deltas, or landscape-wide mean connectedness to give scaled deltas[14]  ⍝   split           table of group names and landcover types to split out results[15]  ⍝   *Uses CONNECT parameters (multiplier, bandwidth, search, resist, and bankcrossings), but can override by providing as [linkages] parameters[16]  ⍝Sources:[17]  ⍝   land            landcover grid[18]  ⍝   roadscli        road blobs, from ROADPREP[19]  ⍝   iei             IEI grid that EXCLUDES connectedness (name specified in parameters.par)[20]  ⍝   bankcrossings   Bank crossings text/vector file[21]  ⍝Result:[22]  ⍝   link_roads      text file with road ID, x, y, base neighborhood connect, alternative neightborhood connect, delta, impact, ln impact[23]  ⍝Notes:[24]  ⍝   1. To do examples, use [linkages] link_example to specify road points.  Results are link<n> (delta), link<n>ln (log delta), link<n>v1[25]  ⍝      (before) and link<n>v2 (after).  To see kernels for specific points, also set [caps] example to focal points--this will give kernels for focal[26]  ⍝      points for specified roads.[27]  ⍝B. Compton, 20-27 Oct 2014, from LINKAGES (road & crossings/dams linkages split)[28]  [29]  [30]  [31]   P←GETINFO 'connect'                                ⍝Construct call to CONNECT & read CONNECT's parameters[32]   READPARS 'connect'[33]   READPARS ME                                        ⍝Uses connectedness parameters by default, but can override them in [linkages][34]   override_pars←'[connect]',⎕TCNL,(T⍳⎕TCNL)↓T←1↓EXTRACTPARS ME     ⍝Override CONNECT parameters with those set for ROADLINKAGES[35]   P[1]←⊂GRIDNAME 1⊃P[36]   P[4]←buffer←(⌈extra*.5)+W←extra+⌈bandwidth×search÷cellsize  ⍝Buffer includes extra for blob size + centroid wiggle[37]   block[3]←buffer                                    ⍝Can't set this from info because it may come from CONNECT, so set it here[38]  [39]  [40]   X←READ 1⊃1⊃A                                       ⍝Read landcover[41]   R←0 MVREP READ 2⊃1⊃A                               ⍝Read road blobs[42]   M←((,R≠0)/,R),INDICES R[43]   B←M[;1]≠¯1↓0,(M←M[⍋M;])[;1][44]   M←(B⌿M[;,1]),B pMEAN M[;2 3]                       ⍝Unique blobs and their centroids (in cells)[45]   M←((^/M[;2 3]≥block[3])^^/M[;2 3]≤((1↑⍴M),2)⍴block[1 2]+block[3])⌿M  ⍝Only do blobs within our tile[46]   M[;2 3]←⌊.5+M[;2 3][47]   →(0∊⍴M)/0                                          ⍝If no items, bail out[48]  [49]   score←TABLE pathM PATH scores                      ⍝Get linkage scores[50]   ss←MATIN pathT PATH scales                         ⍝Get original settings variable scales[51]   L←LOOKUP split                                     ⍝Read group table[52]   N←((Q⍳Q)=⍳⍴Q)/Q←L[;2]                              ⍝Group names[53]   L←(↓[1]L[;2]∘.≡N) SLASHEACH (⍴N)⍴⊂L[;1]            ⍝Cover types in split[54]  [55]   T←example ⋄ example←⍳0                             ⍝We don't want example doing anything here[56]   →(0∊⍴Y←S '' INCLUDE X)/0                           ⍝Get mask, all cells included[57]   M←(M[;1]∊R×Y)⌿M                                    ⍝Drop road blobs that are masked out[58]   →(0∊⍴M)/0[59]   example←T[60]   Y←(0∊⍴example)∨EXAMPLEINIT 0                       ⍝If running example, mask example cells, otherwise no mask[61]  [62]  L1:→(0∊⍴link_example)/L2                           ⍝If doing linkage example,[63]   M←((↓M[;2 3])∊1 FINDCELL¨↓((.5×⍴link_example),2)⍴link_example)⌿M[64]   →(0∊⍴M)/0[65]  [66]  L2:E←0 MVREP READ 3⊃1⊃A                             ⍝Read IEI[67]   cross cross_ ← READVEC pathT PATH bankcrossings    ⍝Read bank crossings table[68]   T←'terrestrial',uncertainty/'LCI'                  ⍝FINDBANKS gives terrestrial and terrestrialLCI - get the right one[69]   Q←(cross[;cross_ COL 'x-coord y-coord ',T]) (MATRIFY 'x-coord y-coord ',T) T[70]   C←TABLE pathM PATH crossscores                     ⍝Get formula for crossing scores[71]   G←(C Q) SETTINGS (2⊃A) 'anthro1' 'resist dist'     ⍝Read ecological settings grids for natural and anthro groups, one-lane version[72]  [73]   D←(DIST 1+2×W)≤⌊W                                  ⍝Circle for mask variable (leave room for centroid wiggle within blobs)[74]   O←(⍳1+2×W)-W+1                                     ⍝Maximum radius possible to travel[75]   Z←(1+⍴L)⌿(M[;1],0 1↓M),((1↑⍴M),6)⍴0                ⍝Result table: id/crossinggroup, x, y, linkgroup, base, alt, delta, impact, ln impact[76]   Z2←(⍴X)⍴0[77]   V←score (2⍴W+1) ((2⊃G)[;1]) ss ((2⊃G)[;3])         ⍝Parameters for LINKAGEMOD[78]   H←'id x-coord y-coord'[79]   linkages←1                                         ⍝Prevent CONNECT from edge correction and reading or writing grids[80]  [81]   I←0[82]  L3:→((1↑⍴M)<I←I+1)/L7                               ⍝For each blob,   -------------------------------------------[83]  aa←⎕AI[2] ⋄ ⍞←'[roads] #',(⍕I),'/',(⍕1↑⍴M),'...' ⋄ FLUSH[84]   BREAKCHECK[85]   T←(MV×~D)+D×X[M[I;2]+O;M[I;3]+O]                   ⍝   Clip landcover to circle[86]   →(^/,X=MV)/L3                                      ⍝   If clipped landcover is all missing, skip this point[87]   Q←D×Y[M[I;2]+O;M[I;3]+O]                           ⍝   And mask[88]   :if 0∊⍴example                                     ⍝      and not doing example,[89]      Q[((1↑⍴Q)⍴1 1 1 0)/⍳1↑⍴Q;]←0                    ⍝         only build kernels for every 4th cell[90]      Q[;((1↓⍴Q)⍴1 1 1 0)/⍳1↓⍴Q]←0[91]   :end[92]   linkgrids ← (T Q) 0                                ⍝   linkgrids is ((clipped X) (clipped Y)) ((clipped sr) (srt) (clipped sd) (sdt))[93]   Q←(1⊃G)[;M[I;2]+O;M[I;3]+O]                        ⍝   Clip resistance settings variables[94]   T←(3⊃G)[;M[I;2]+O;M[I;3]+O]                        ⍝   Clip distance settings variables[95]   linkgrids[2]←⊂Q (2⊃G) T (4⊃G)                      ⍝   these will get passed to CONNECT/AQCONNECT so they won't have to go to disk[96]   P CONNECT S                                        ⍝   call connectedness for base scenario[97]  ⍝      r←(⍴X)⍴0 ⋄ r[M[I;2]+O;M[I;3]+O]←res ⋄ r WRITE 'D:\CAPS\RESULTS\before',⍕I[98]   V1←0 MVREP res                                     ⍝   capture result[99]   linkgrids[2]←⊂(⊂V LINKAGEMOD Q),1↓2⊃linkgrids      ⍝   modify settings values of focal cells[100]  P CONNECT S                                        ⍝   call connectedness for alternative scenario[101] ⍝      r←(⍴X)⍴0 ⋄ r[M[I;2]+O;M[I;3]+O]←res ⋄ r WRITE 'D:\CAPS\RESULTS\after',⍕I[102] L4:V2←0 MVREP res                                   ⍝   capture alternative result[103]  Z[J←(I×1+⍴L)-⍴L;(¯6+⍳6)+1↓⍴Z]←(⊂'all'),6 ROUND (+/,V1),(+/,V2),((+/,V2-V1)÷scaleby),T,⍟1+T←(+/,E[M[I;2]+O;M[I;3]+O]×V2-V1)÷scaleby   ⍝   Result is base, alt, delta, impact (IEI-weighted delta), and ln impact[104]  Z2←Z2+(R=M[I;1])×T                                 ⍝   save to grid result[105]  →(0∊⍴L)/L6                                         ⍝   If any grouped landcover types,[106]  K←0[107] L5:→((⍴L)<K←K+1)/L6                                 ⍝      For each group of landcover types,[108]  Q←((⊃⊃linkgrids)∊K⊃L)×V2 ⋄ T←((⊃⊃linkgrids)∊K⊃L)×V1⍝         Select only landcover types in group[109]  Z[J+K;(¯6+⍳6)+1↓⍴Z]←N[K],6 ROUND (+/,T),(+/,Q),((+/,Q-T)÷scaleby),T2,⍟1+T2←(+/,E[M[I;2]+O;M[I;3]+O]×Q-T)÷scaleby ⍝         Result just for these types[110]  →L5[111] [112] L6:t←⎕AI[2]-aa ⋄ ⎕←(⍕⌊.5+t),' s (est. ',(TIME t×''⍴1↑⍴M),' h:m:s for this tile)' ⋄ FLUSH[113] [114]  →(0∊⍴link_example)/L3                              ⍝   If link example,[115]  Q←(⍴X)⍴MV ⋄ Q[M[I;2]+O;M[I;3]+O]←1E6×V2-V1[116]  Q WRITE T←pathR PATH 'link',⍕Z[J;1]                ⍝      write delta[117]  (LN Q) WRITE pathR PATH 'link',(⍕Z[J;1]),'ln'      ⍝      and log version[118]  Q←(⍴X)⍴MV ⋄ Q[M[I;2]+O;M[I;3]+O]←V1[119]  Q WRITE pathR PATH 'link',(⍕Z[J;1]),'v1'           ⍝      write before[120]  Q←(⍴X)⍴MV ⋄ Q[M[I;2]+O;M[I;3]+O]←V2[121]  Q WRITE pathR PATH 'link',(⍕Z[J;1]),'v2'           ⍝      write after[122]  LOG '⊢[linkages] Examples at item #',(,⍕Z[J;1]),' (point ',(¯1↓⊃,/(⍕¨Z[J;2 3]),¨','),') delta =',(,4⍕Z[J;¯1+1↓⍴Z]÷1E3),'  (written to grids ',T,'...)'[123]  →L3[124] [125] L7:Z[;2 3]←↑1 FINDPOINT¨↓Z[;2 3]                    ⍝Convert points to current projection  (ACUTALLY, WE'LL PROBABLY WRITE A GRID HERE FOR ROADS) ***[126]  head←1↓⎕TCHT MTOV MATRIFY H,' linkgroup base alt delta impact impact_ln'[127]  Z LOCKWRITE pathR PATH result,(0=⍴result)/'link_roads',(uncertainty/'_u'),'.txt'         ⍝Write results to table[128]  (MVREP Z2 (R=0)) WRITE 3⊃A                         ⍝Write result grid[129]  →0[130] [131] [132] what:auxiliary[133] type:standard[134] init:NDROP pathR PATH result,(0=⍴result)/'link_roads',(uncertainty/'_u'),'.txt'     ⍝Erase old result table[135] info:('land' (pathS,'roadscli') iei) ('settings') ('linkroads') (0) 'luwet'         ⍝Source grids, settings table, result grid, and (dummy) buffer size[136] check:CHECKVAR 'scores scales scaleby split uncertainty link_example result extra'[137] check:pathM CHECKFILE scores[138] check:pathT CHECKFILE scales[139] check:CHECKCOVER 'split'    ∇