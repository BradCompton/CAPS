    ∇ FLOW I;V;K;Q;J;E[1]   ⍝Recursively calculate flow accumulation for cell R,C ⍵[2]   ⍝Globals:[3]   ⍝   F   FD8 flow grid (8×R×C)[4]   ⍝   D   1 if this cell is done[5]   ⍝   P   Pending flag: 1 if we're already working on this cell[6]   ⍝   Z   result[7]   ⍝B. Compton, 7-13 Mar 2008[8]   [9]   [10]  [11]   I J←I[12]  ⍝⍎((I=1067)^J=694)/'XXXXXX!'[13]    ⍝⎕←'[',(⍕I),',',(⍕J),']' ⋄ FLUSH[14]   →(~P[I;J])/L0[15]  ⍝ ⎕←'FLOW: Infinite loop in flow grid (',(⍕I),',',(⍕J),'). Is this a depressionless DEM?'[16]   bad[I;J]←bad[I;J]+1[17]   →0[18]  L0:P[I;J]←1[19]   V←↑,(I+¯1 0 1)∘.,J+¯1 0 1          ⍝Neighbors[20]   E←D[I+¯1 0 1;J+¯1 0 1]             ⍝Which ones aren't done yet[21]   E[2;2]←1                           ⍝Exclude focal cell[22]   E←(~,E)^F[2 3 4 1 1 5 8 7 6;I;J]≠0 ⍝Only visit cells that flow into this one[23]   V←E⌿V[24]  [25]   K←0[26]  L1:→((1↑⍴V)<K←K+1)/L2               ⍝For each neighbor,[27]   →D[V[K;1];V[K;2]]/L1               ⍝   Bail out if cell has already been done (could happen elsewhere in recursion)[28]   FLOW V[K;]                         ⍝   Recurse[29]   →L1[30]  [31]  L2:→D[I;J]/0                        ⍝If this cell was already done during recursion, get out now[32]   Q←F[;I;J]×Z[I;J-1],Z[I-1;J-1],Z[I-1;J],Z[I-1;J+1],Z[I;J+1],Z[I+1;J+1],Z[I+1;J],Z[I+1;J-1][33]  [34]   Z[I;J]←Z[I;J]++/Q[35]   D[I;J]←1                           ⍝Done with this cell    ∇