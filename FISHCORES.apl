    ∇ A FISHCORES S;expand;tolerance;fishpath;C;D;F;I;Z;Q;X;E;O;widestuff;W;V[1]   ⍝Transfer NHD+ anadramous fish cores to our stream centerlines[2]   ⍝Step 1. fishcores.py, creates anadflow grid[3]   ⍝Step 2. FISHCORES[4]   ⍝Parameters:[5]   ⍝   expand      Number of cells to expand to account for misalignment, number of cells to expand in wide stuff (expand[2]≥expand[1]!)[6]   ⍝   tolerance   Range of proportional discrepency allowed between NHD+ and our flow accumulation grids [7]   ⍝               1st element is tolerance at 1 cell distance, 2nd element is tolerance at maximum distance (=expand)[8]   ⍝   fishpath    Directory with fish cores[9]   ⍝   widestuff   Ecological systems with super-high tolerance (lakes & estuaries)[10]  ⍝Source:[11]  ⍝   streams     Stream centerline grid[12]  ⍝   anadflow    NHD+ flow accumulation for anadramous fish cores[13]  ⍝   d8accum     Our D8 flow accumulation grid[14]  ⍝   dslland     Final landcover[15]  ⍝Result:[16]  ⍝   anadcores[17]  ⍝Approach: When NHD+ overlaps our streams or misses by 1, pretty much always use them.  Otherwise, search farther away,[18]  ⍝with decreasing tolerance in discrepency in flow accumulation.  For classes in widestuff, use high tolerance[19]  ⍝regardless of distance.[20]  ⍝B. Compton, 23-27 Jun 2016[21]  [22]  [23]  [24]   READPARS ME[25]   X←READ 1⊃1⊃A                           ⍝Read landcover[26]   C←1=READ 2⊃1⊃A                         ⍝Read stream centerlines[27]   D←0 MVREP READ 3⊃1⊃A                   ⍝Read NHD+ flow accumulation for anadramous fish cores[28]   F←READ 4⊃1⊃A                           ⍝and flow accumulation[29]   [30]   E←tolerance[2]+(⌽0,⍳expand[1]-1)×(-/tolerance)÷expand[1]-1    ⍝tolerance vector[31]   O←100×V←D≠0                            ⍝Massive tolerance on overlapping cells[32]   E[1]←100                               ⍝and one cell off[33]   W←X∊⊃,/LOOK¨FRDBL¨↓','MATRIFY widestuff ⍝and massive tolerance for lakes and estuaries[34]  [35]    [36]   I←0[37]  L1:→(expand[2]<I←I+1)/L2                ⍝Iterate up to expand,[38]   :if I≤expand[1]                        ⍝   If still in stream expansion, [39]      D←EXPAND Q←D                        ⍝      expand streams[40]      O←O+E[I]×Q≠D                        ⍝      tolerance band[41]   :end[42]   V←W^EXPAND V                           ⍝   expand lakes[43]   →L1[44]   [45]  L2:Z←D×C                                ⍝Take NHD+ flow at our stream centerlines[46]   Z←C^V∨(Z>F×1-O)^Z<F×1+O                ⍝Keep cores where NHD+ flow accumulation is within x% of ours [47]   [48]   Q←C^EXPAND EXPAND EXPAND EXPAND Z      ⍝Now fill tiny gaps[49]   Z←Q^~C^EXPAND EXPAND EXPAND EXPAND C^~Q[50]  [51]   (MVREP Z (Z=0)) WRITEI 3⊃A [52]   →0[53]   [54]  [55]  what:auxiliary[56]  type:standard[57]  info:('DSLland' 'streams' (fishpath,'working\anadflow_m') 'd8accum') ('') (fishpath,'anadcores') (100⌈expand[2]) (fishpath,'working\anadflow_m')      ⍝Source grid, settings table, result grid, buffer size, and include grid[58]  check:CHECKVAR 'expand tolerance fishpath widestuff'    ∇