    ∇ A MOVE2STREAMS S;F;X;M;N;T;H;head;I;C;B;Q;road;leave;result;source;buffer[1]   ⍝Move points in dams or culverts file ⍵ to nearest stream centerline cell.[2]   ⍝Source data:[3]   ⍝   source\streams, roads, trains[4]   ⍝   tables\⍵, must have valid x-coord,y-coord; if oldx,oldy exist, they will be used instead[5]   ⍝             (to allow rerunning)[6]   ⍝Parameters:[7]   ⍝   source          source text file[8]   ⍝   result          result text file (not the same as source!)[9]   ⍝   road = yes	    move to nearest road (or railroad)/stream intersection? If no, move to nearest stream centerline.[10]  ⍝   leave = yes	    leave points where they are if attempted move fails[11]  ⍝Result:[12]  ⍝   tables\⍵, with x-coord,y-coord updated; new oldx,oldy with original coordinates, and[13]  ⍝             1=okay/not moved, 2=moved, 3=nowhere to move to/set to 0,0[14]  ⍝B. Compton, 9-10 Aug 2011[15]  ⍝16 Sep 2011: if ⍺=2, leave unmovable points where they are (for TR)[16]  ⍝27 Oct 2011: allow specifying streams grid[17]  ⍝23 Jan 2012: do name substitution[18]  ⍝31 Jan 2012: if ⍺=3, move to streams and leave unmovable points where they are (for Jo)[19]  ⍝31 Dec 2013: rewritten as a metric so it can run in tiles; use READVEC; 18 Jan 2014: use READVEC header properly[20]  ⍝21 Jan 2014: cells in terms of tile! need a 1-cell buffer[21]  ⍝23 Jan 2014: use streams, the trimmed streams, not streamgrid[22]  ⍝27 Jan 2014: drop out-of-bounds points right away: they're not in any tile.  This means no 0 results.[23]  ⍝25 Feb 2014: if orthogonal neighbors are no good, try diagonal neighbors.  Necessary because we have been using generalized roads[24]  ⍝   to find crossings, but original roads to create roads grid.[25]  [26]  [27]  [28]   READPARS ME[29]   buffer←4⊃A[30]   S←1=READ 1⊃A                                           ⍝Stream centerlines[31]   :if road                                               ⍝If doing road crossings,[32]      Q←MV≠READ GRIDNAME pathS,'roads'                    ⍝   Intersect streams with roads and trains[33]      S←S^Q∨MV≠READ GRIDNAME pathS,'trains'[34]   :end[35]  [36]   X H ← READVEC pathT PATH source,(~'.'∊source)/'.txt'   ⍝Read table[37]   H←↓H[38]   :if 0∊I←H COL 'oldx oldy'                              ⍝If original coordinates aren't there yet,[39]      X←X,X[;H COL 'x-coord y-coord'],0                   ⍝   copy coordinates[40]      H←H,FRDBL¨↓MATRIFY 'oldx oldy moved'[41]   :end[42]   I←H COL 'oldx oldy x-coord y-coord moved'              ⍝Work with original coordinates[43]   X[;I[3 4]]←X[;I[1 2]]                                  ⍝Copy back original coordinates[44]   C←↑1 FINDCELL¨↓X[;I[⍳2]]                               ⍝Coordinates in terms of cells[45]   C←(B←^/(C>1)^C<(⍴C)⍴(⍴S))⌿C[46]   X←B⌿X[47]  [48]   M←~S SCATI C                                           ⍝Points that miss centerlines (or crossings)[49]   N←((4×+/M),2)⍴T←(M⌿C)[;8⍴⍳2]+((+/M),8)⍴¯1 0 0 1 1 0 0 ¯1  ⍝Othogonal neighbors (N, E, S, W)[50]   N←((2×+/^\~((+/M),4)⍴S SCATI N)⌽(T,0),0)[;⍳2]          ⍝Pick neighbor with stream (or 0 if no neighboring streams)[51]   X[(∨/N≠0)/M/⍳1↑⍴X;I[3 4]]←↑(∨/N≠0)/1 FINDPOINT¨↓N      ⍝Replace with neighboring centerline[52]  [53]   M←M\^/N=0                                              ⍝Points where orthogonal neighbors didn't help[54]   N←((4×+/M),2)⍴T←(M⌿C)[;8⍴⍳2]+((+/M),8)⍴¯1 ¯1 ¯1 1 1 ¯1 1 1  ⍝Now try diagonal neighbors (NE, NW, SW, SE)[55]   N←((2×+/^\~((+/M),4)⍴S SCATI N)⌽(T,0),0)[;⍳2]          ⍝Pick neighbor with stream (or 0 if no neighboring streams)[56]   X[(∨/N≠0)/M/⍳1↑⍴X;I[3 4]]←↑(∨/N≠0)/1 FINDPOINT¨↓N      ⍝Replace with neighboring centerline[57]  [58]   X[(~leave)/(M\Q←^/N=0)/⍳1↑⍴X;I[3 4]]←0                 ⍝Points with nowhere to move (if ⍺∊1 2)[59]   X[;I[5]]←1 9 2 9 9 9 3[1+(2×M)+4×M\Q]                  ⍝1=okay/not moved, 2=moved, 3=nowhere to move to/set to 0,0[60]  [61]   ⎕←'   ',(⍕+/X[;I[5]]=1),' points were okay and not moved (moved = 1)'[62]   ⎕←'   ',(⍕+/X[;I[5]]=2),' points were moved (moved = 2)'[63]   ⎕←'   ',(⍕+/X[;I[5]]=3),' points couldn''t be moved ',((1+leave)⊃'and were set to 0,0' 'and were left where they were'),' (moved = 3)'[64]  [65]   F←pathT PATH F,(~'.'∊F←result)/'.txt'[66]   head←1↓⎕TCHT MTOV MIX H[67]   X LOCKWRITE F[68]   ⎕←'Results written to ',F[69]   →0[70]  [71]  [72]  what:data prep[73]  type:standard[74]  info:(pathS,'streams') ('') ('') 1 'luwet'              ⍝Source grids, settings table, result grid, and buffer size[75]  check:CHECKVAR 'source result road leave'[76]  init:NDROP pathT PATH result,(~'.'∊result)/'.txt'       ⍝Delete result file at start    ∇