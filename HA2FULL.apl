    ∇ Z←HA2FULL;C;V;I;J;E;head;F;N;X;A;W;Q;area_km;V2;V3;V4;V5;V6;V7;V8;V9;V10;V11;V12;V13;V1;T;area_kmi;O[1]   ⍝CAPS 3.0 hydrologic alterations metric, part 2 (calculate results)[2]   ⍝Global variables (set by WATERSHED/WATERSHEDB):[3]   ⍝   flowaccum_v Watershed area, in cells (includes inflows!)[4]   ⍝ X  compact     Compactness of watershed above each point (not mean!)[5]   ⍝ X  tmax_v      Sum of maximum temperature[6]   ⍝   humidity_v  Sum of humidity[7]   ⍝   ppt_dec_v   Sum of December precipitation[8]   ⍝   sand_v      Sum of percent sand[9]   ⍝ X  eastness_v  Sum of eastness[10]  ⍝   impervi_v   Sum of percent impervious[11]  ⍝   damstore_v  Sum of dam storage[12]  ⍝ X  withdraw_v  Sum of water withdrawals (omitted outside of Massachusetts)[13]  ⍝   discharge   Sum of water discharges (omitted outside of Massachusetts)[14]  ⍝   nedinflow_v Sum of watershed area, including out-of-state inflows from 2015 NED   [15]  ⍝Reads ha\source\NEDaccum, which breaks frisking.  Whatever.  Needs to be same flowaccum values as those used to create variables![16]  ⍝Requires regression parameters from Homa et al. (2013) in caps\project\ha_betas.txt.[17]  ⍝   Header is coefficient names; 1st column is exceeedance probabilities[18]  ⍝B. Compton, 23-24 Mar 2015[19]  ⍝27 Mar 2015: drop second stage--Betsy rolled it into betas[20]  ⍝1-3 Apr 2015: adjust input variables as needed and add more test code (***)[21]  ⍝13 Apr 2015: need to use flowaccum, not size for divisor, to handle size correctly[22]  ⍝4 May 2015: match offsets to final version (in APPLYHAFLOW); drop tmax, eastness, and withdraw[23]  ⍝5 May 2015: set everything outside of watershed to 0[24]  ⍝14 May 2015: use NEDaccum instead of flowaccum. New (2015) version if NED is significantly different; was breaking inflows. Also drop compact--it sucks.[25]  ⍝19 May 2015: use nedinflow instead, and do accumulation within WATERSHED/WATERSHEDB[26]  [27]  ⍝Note: this is original development version, with all intermediate results written, etc.[28]  [29]  [30]   C←TABLE path,'project\ha_betas.txt'            ⍝Read betas (these are combined betas and gammas from Table 2 of Homa et al. (2013)[31]   E←C[;1] ⋄ C←0 1↓C                              ⍝Exceedence probabilities[32]   V←1 0↓TOLOWER ',' MATRIFY head                 ⍝Variable names[33]   W←V MATIOTA MATRIFY 'impervi damstore withdraw discharge'  ⍝Anthropogenic variables[34]  [35]   ⍝station←V STATION teststation[1]               ⍝*** (>>> reads text file)[36]  [37]   X←(1↑⍴V)⍴0                                     ⍝Vector for transformed variables[38]   area_km←size×(cellsize*2)÷1E6                  ⍝size is wateshed size in cells, area_km is in km*2[39]   area_kmi←nedinflow_v×(cellsize*2)÷1E6            ⍝area_kmi includes inflows--it's the full watershed size[40]  [41]   O←size≠MV                                      ⍝To set everything outside of watershed to zero (prevents LIMIT ERRORS later)[42]  [43]   X[1]←⊂O×V1←(⍴size)⍴1                           ⍝Intercept   *** Vn← is test code[44]   X[2]←⊂O×LN V2←area_kmi                         ⍝Watershed area, in km*2[45]   X[3]←⊂O×LN V3←¯66+|LONGITUDE                   ⍝Longitude at each cell.  Offset is ¯66.[46]  ⍝ X[4]←⊂O×LN V4←compact                         ⍝Compactness of watershed above each cell (not mean!)[47]   X[4]←⊂O×LN V5←humidity_v÷nedinflow_v           ⍝Mean humidity[48]   X[5]←⊂O×LN V6←ppt_dec_v÷nedinflow_v            ⍝Mean December precipitation[49]   X[6]←⊂O×LN V7←sand_v÷nedinflow_v               ⍝Mean percent sand[50]   X[7]←⊂O×LN 1+V8←impervi_v÷nedinflow_v          ⍝Mean imperviousness; +1 for anthro[51]   X[8]←⊂O×LN 1+V9←damstore_v÷area_kmi            ⍝Dam storage/km*2; +1 for anthro[52]   X[9]←⊂O×LN 1+V10←discharge_v÷area_km           ⍝Water discharges/km*2/y (no inflow!); +1 for anthro[53]  [54]   (MVREP V2 (size=MV)) WRITE pathW,'area'        ⍝Save values for testing[55]   (MVREP V3 (size=MV)) WRITE pathW,'longitude'[56]   (MVREP V5 (size=MV)) WRITE pathW,'humidity'[57]   (MVREP V6 (size=MV)) WRITE pathW,'ppt_dec'[58]   (MVREP V7 (size=MV)) WRITE pathW,'sand'[59]   (MVREP V8 (size=MV)) WRITE pathW,'impervi'[60]   (MVREP V9 (size=MV)) WRITE pathW,'damstore'[61]   (MVREP V10 (size=MV)) WRITE pathW,'discharge'[62]   [63]  [64]   vars←(FRDBL¨↓V),[1.5]0[65]  ⍝ vars[;2]←POPULATE testW                        ⍝***[66]  ⍝ vars←vars,POPULATE2 testW[67]  ⍝ ⎕←'For station ',(⍕teststation[1]),':'[68]  ⍝ ⎕←'var' 'gauges III' 'input' 'input scaled'⍪station,0 1↓vars    ⍝Show Gauges III data and my values for station point ***[69]  [70]  L1:Z←(⍴size)⍴0                                  ⍝Ecochange result[71]  [72]   I←0[73]  L2:→((⍴E)<I←I+1)/L5                             ⍝For each exceeedance probability,[74]   A←N←(⍴size)⍴0                                  ⍝   Fresh anthro and natural predictions for this exceeedance[75]  [76]   J←0[77]  L3:→((1↑⍴V)<J←J+1)/L4                           ⍝   For each variable,[78]   :if J∊W                                        ⍝      If anthropogenic variable,[79]  ⍝    exceed[I;3]←exceed[I;3]+C[I;J]×(J⊃X)[testW[1];testW[2]]   ⍝anthro part ***[80]      A←A+C[I;J]×J⊃X                              ⍝      add to anthro prediction[81]   :else                                          ⍝      Else, natural variable[82]  ⍝    exceed[I;2]←exceed[I;2]+C[I;J]×(J⊃X)[testW[1];testW[2]]   ⍝natural part ***[83]      N←N+T←C[I;J]×J⊃X                            ⍝      add to natural prediction[84]      A←A+T                                       ⍝      and to anthro prediction[85]   :end[86]   →L3[87]  [88]  L4:[89]   (MVREP (0⌈A) ((~streams)∨size=MV)) WRITE pathW,'LNQ',,'ZI2' ⎕FMT E[I]×100   ⍝   Write LN total flow for exceeedance probability ***[90]   (MVREP (0⌈N) ((~streams)∨size=MV)) WRITE pathW,'LNN',,'ZI2' ⎕FMT E[I]×100   ⍝   Write LN natural flow for exceeedance probability ***[91]  [92]  N←N⌊25 ⋄ A←A⌊25 ⍝********** TO KEEP FROM CRASHING IF WE HIT OUTLIERS[93]  [94]   Z←Z+100×(÷⍴E)×|((*N)-*A) DIV *N                  ⍝   Add to percent ecochange for this exceeedance - delta over natural[95]  ⍝ (MVREP (*A) (size=MV)) WRITE pathW,'Q',,'ZI2' ⎕FMT E[I]×100   ⍝   Write total flow for exceeedance probability ***[96]    T←100×(÷⍴E)×|((*N)-*A) DIV *N [97]    (MVREP (0⌈T) ((~streams)∨size=MV)) WRITE pathW,'E',,'ZI2' ⎕FMT E[I]×100   [98]   →L2[99]  [100] L5:Z←MVREP Z ((~streams)∨size=MV)                          ⍝Replace missing values and only return values for streams[101] [102] ⍝ exceed[;4]←exceed[;2]+exceed[;3]               ⍝columns are EP, natural, anthro only, natural+anthro    ***[103] ⍝⍝ exceed[;2 3 4]←*exceed[;2 3 4]                 ⍝take e(values) ***[104] ⍝ ecochange←Z[testW[1];testW[2]]                 ⍝Ecochange for station ***[105] ⍝ ⎕←''[106] ⍝ ⎕←'Exceedence probabilities:'[107] ⍝ ⎕←'EP' 'natural' 'anthro only' 'anthro'⍪exceed[108] ⍝ ⎕←''[109] ⍝ ⎕←'Ecochange percent = ',⍕ecochange    ∇