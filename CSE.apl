    ∇ csedir CSE U;pars;refgrid;T;csbdir;dict;dict_;H;S;X;csb;csb_;M;J;Y;V;D;cse_project;P;smeans;landcover;logfile;pathI;smeans_;crossings;trpoints;crossings_;trpoints_;override_pars;F;A;ieipath;cseproject;buffer;wbuffer;bw;tw;changed;maskbits;ftppath;head;Q;N;p2l;path;framework[1]   ⍝CAPS Scenario Engine for user and project ⍵[1], project # ⍵[2], base directory ⍺[2]   ⍝Launched in Anthill by CAPS Scenario Agent[3]   ⍝Reads CSB projects, prepares data for each scenario, and launches each scenario[4]   ⍝Compiles results in the end[5]   ⍝Parameters:[6]   ⍝   reportonly          If yes, don't actually run anything, just produce report (for testing)[7]   ⍝   ftppath             path to FTP site[8]   [9]   ⍝ GET THE REST OF THEM[10]  [11]  ⍝Inputs (in model\):[12]  ⍝   cse_metrics.par     Metrics control table (from CAPS Scenario Builder Back End.docx)[13]  ⍝                       rows = metrics, columns = scenario types, 'X' marks metrics to run[14]  ⍝   cse_settings.par    Settings control table (from CAPS Scenario Builder Back End.docx)[15]  ⍝                       rows = metrics, columns = scenario types × scenerio subtypes[16]  ⍝                       Values are new landcover type for landcovers, otherwise new value.[17]  ⍝                       "value1" and "value2" come from CSB csv file; T means look up landcover[18]  ⍝                       in model\settingsmeans.txt.[19]  ⍝   settingsmeans.txt   mean for each settings variable, by community[20]  ⍝Source data: (incomplete list)[21]  ⍝   source\watersheds   watershed id grid[22]  ⍝B. Compton, 22 Jun-21 Aug 2012 (This week Roberts court upholds Obamacare)[23]  ⍝23 Apr 2013: pull initialization code into CSE_SETUP[24]  ⍝25 Apr 2013: always use CSB parameters[25]  ⍝26 Apr 2013: update mixmetrics.par[26]  ⍝6 May 2013: pack town numbers in changed; Bob's new nested project scheme[27]  ⍝7 Jun 2013: project name revisions[28]  ⍝25 Jun 2013: pack mitigation discounts[29]  ⍝9 Jul 2013: always force in land and postland[30]  ⍝22 Nov 2013: use new gridio system[31]  ⍝2 Dec 2013: transposition bug in figuring out which grids to copy[32]  [33]  [34]  [35]   framework←'caps'[36]   path←csedir[37]   inputspar←'inputs.par'                     ⍝Default paths for these, if not set in parameters.par[38]   resultspar←'results.par'[39]   synonymspar←'synonyms.par'[40]   landcoverpar←'landcover.par'[41]   SETPATHS[42]   CONFIG                         ⍝Set Anthill variables[43]   pars←NREAD (pathI←csedir PATH 'model\') PATH 'parameters.par'  ⍝All parameters come from CSB version[44]   READPARS 'csa'[45]   READPARS 'watershedb' ⋄ wbuffer←buffer                         ⍝Get tiny watershed buffer from WATERSHEDB[46]   READPARS 'caps'[47]   READPARS ME[48]   refgrid←1 GRIDNAME 'reference'[49]  [50]   CONFIG[51]   1 INITO ''                     ⍝Initialize, but don't muck with paths[52]  [53]   U N ← U[54]  [55]  ⍝---Set up[56]   U V P M S H ← CSE_SETUP U      ⍝U = owner/project, V = scenarios, P = scenario paths, M = metrics table, S = settings table, H = index into dictionary[57]  [58]   Y←MATRIFY 'crossing dam wildlife tr newroad roadchange landcover'[59]   A←(⍴V)⍴0[60]   changed←((⍴V),10)⍴0                                            ⍝matrix to record what's changed for each scenario[61]   changed[;10]←⊂⍳0[62]  [63]   J←0[64]  L1:→((⍴V)<J←J+1)/L2                                             ⍝For each scenario,[65]   LOG '   Scenario: ',J⊃V[66]   X←VTOM ⎕TCNL,'.((.(.)).)' TEXTREPL NREAD csbdir,(1⊃U),'\',(2⊃U),'\',J⊃V  ⍝   Read scenario file[67]   csb csb_ ← PARSECSB X[68]   csb←csb[⍒(FRDBL¨↓Y)⍳csb[;csb_ COL 'type'];]                    ⍝   Sort by feature so lapping happens properly[69]  [70]   Q←⊃A[J]←⊂((1↓M[;M[1;] COL 'run'])^∨/1 0↓M[;M[1;]⍳csb[;csb_ COL 'type']])/1↓M[;1]   ⍝   runnable metrics (not connect buffer cores)[71]   0 ((J⊃P) PATH 'model\') 1 METRICS MIX Q                        ⍝   Set metrics we'll run[72]   T←TABLE F←(J⊃P) PATH 'model\mixmetrics.par'                    ⍝   Update mixmetrics.par: we only want metrics we're actually running[73]   head←1↓⎕TCHT MTOV ',' MATRIFY head[74]   ((T[;1]∊Q)⌿T) TMATOUT F[75]  [76]  ⍝First, copy buffered features for scenario for each grid[77]   LOG '   Copying buffered grids for features...'[78]  [79]   T←S[1;]∘.≡csb[;csb_ COL 'type']                                ⍝   Types in this scenario[80]   T←∨/T^(⍉(⌽⍴T)⍴S[2;]≡¨⊂'')∨S[2;]∘.≡'new' 'mod' 'del'[1++/(((1↑⍴csb),2)⍴⍳2)×csb[;csb_ COL 'altered deleted']≡¨⊂,'y'][81]   D←(2↓S[;1]),(∨/~(T/2 0↓S)≡¨⊂''),2 0↓S[;¯1 0+1↓⍴S]              ⍝   All grids, whether we're copying them, source path, result path[82]   D[D[;1]⍳'land' 'postland';2]←1                                 ⍝   Force land and postland in always[83]   T←MTOV MIX(~D[;2])⌿D[;1],¨⎕TCHT,¨D[;3]                         ⍝   Grids we're not copying[84]   T NAPPEND (J⊃P),'model\inputs.par'                             ⍝   Redirect to base grids in inputs.par[85]   D←D[;2]⌿D                                                      ⍝   Only need to deal with grids we're copying at this point[86]  [87]  ⍝---Create the mask for this scenario, and gather changed information for text description in report[88]   M D CSE_BUFFERS J (J⊃P) (1⊃P)[89]  [90]  ⍝---Now, go through all features and grids again, making modifications (without buffering)[91]   S CSE_MODIFY J (J⊃P)[92]  [93]  ⍝---Launch CAPS run for this scenario[94]   J N CSE_CAPS J⊃P[95]   →L1[96]  [97]  L2:→reportonly/L105[98]  [99]   T←'CAPS' 'launched' NOW UPDATE_STATUS U[100]  F←(⊂cseproject,'finish'),¨⍕¨⍳⍴V                                ⍝List of finish files (one for each CAPS run)[101]  LOG 'Waiting for ',(⍕⍴V),' CAPS run',((1≠⍴V)/'s'),' to finish...'[102] L102:→(^/IFEXISTS¨F)/L101                                       ⍝Wait for CAPS runs to finish[103]  T←⎕DL 10[104]  →L102[105] [106] L101:LOG 'CAPS runs are finished; starting SCENARIOS'[107]  T←'SCENARIOS' UPDATE_STATUS U                                  ⍝CAPS runs are done[108] [109] ⍝---Run SCENARIOS for project[110]  P pathG (pathE PATH ieipath) A N CSE_SCENARIOS V[111] [112] L105:LOG 'SCENARIOS is finished'[113]  head←1↓⎕TCHT MTOV MATRIFY 'community culverts dams passage tr roads modroads landcover newlandcover mitigate'[114]  changed[;1]←'(',¨((⊂'. .,') TEXTREPL¨⍕¨changed[;1]),¨')'       ⍝Pack list of town names as string[115]  changed[;9]←(⊂'. .,') TEXTREPL¨⍕¨changed[;9][116]  changed[;10]←'(',¨((⊂'. .,') TEXTREPL¨⍕¨changed[;10]),¨')'     ⍝Pack list of mitigation discounts as a string[117]  changed TMATOUT cseproject,'post\changed.txt'[118]  T←'reporting' 'metrics' (1↓⊃,/' ',¨(M[;1]∊⊃,/A)/M[;1]) UPDATE_STATUS U ⍝Update status and write metrics called for CSE_REPORT[119]  LOG 'CSE is finished with ',((1⊃U),'/',2⊃U),' - now waiting for CSA to produce report'    ∇