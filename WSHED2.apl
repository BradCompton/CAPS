    ∇ K WSHED2 I;J;N;E;Q;T;L;C[1]   ⍝Recursively calculate flow accumulation for cell R,C ⍵ and influence and calling cell ⍺[2]   ⍝Build influence grid on the way up, and other grids on the way down[3]   ⍝Globals:[4]   ⍝   dem      Depressionless DEM (use FILL in Arc/Grid) ← If not depressionless, all bets are off![5]   ⍝   d8flow   D8 flow direction grid (from FLOWDIRECTION in Arc/Grid)[6]   ⍝   d8accum  D8 flow accumulation grid (from Arc)[7]   ⍝   lc       landcover[8]   ⍝   resist   aquatic resistance grid[9]   ⍝   M        metric parameters[10]  ⍝   Y        intermediate grids (pointers: inf, suminf, mininf, wsize, then two for each metric)[11]  ⍝   inf, suminf, mininf, wsize, mstart     pointers into intermediate grids[12]  ⍝B. Compton, 12 Nov 2009 from QSHED and FLOW[13]  [14]   I J ← I[15]   C←2↑1↓K,I J ⋄ K←''⍴K[16]   Y[inf;I;J]←Y[inf;I;J]+K×T←(1,H[;I;J])[1+(3 3⍴6 7 8 5 0 1 4 3 2)[2+C[1]-I;2+C[2]-J]]    ⍝Influence value as proportion of flow to downflow calling cell[17]   Y[part;I;J]←Y[part;I;J]+T          ⍝Proportion that flows into cell[18]  [19]   →(~P[I;J])/L0                      ⍝Infinite loop due to mismatch in flow grids.  Flag it and drop out.[20]   ⍝So far, these seem to fall only in very minor flows...need to make sure they don't fall in rivers[21]   bad[I;J]←bad[I;J]+1[22]   →0[23]  L0:P[I;J]←1[24]   N←↑,(I+¯1 0 1)∘.,J+¯1 0 1          ⍝Neighbors[25]   E←D[I+¯1 0 1;J+¯1 0 1]             ⍝Which ones aren't done yet[26]   E[2;2]←1                           ⍝Exclude focal cell[27]   E←(~,E)^0≠H[2;I-1;J-1],H[3;I-1;J],H[4;I-1;J+1],H[1;I;J-1],0,H[5;I;J+1],H[8;I+1;J-1],H[7;I+1;J],H[6;I+1;J+1]   ⍝Only visit cells that flow into this one[28]  ⍝ E←(~,E)^1 1 1 1 0 1 1 1 1\H[6 7 8 5 1 4 3 2;I;J]≠0 ⍝Only visit cells that flow into this one         THIS IS STILL NOT RIGHT![29]   N←E⌿N[30]  [31]  ⍝Influence for multple is weighted by proportion of flow[32]   T←E/2*.5 0 .5 0 0 0 .5 0 .5        ⍝Distance correction for diagonal flow[33]   K←K-T×.5×resist[I;J]+E/,resist[I+¯1 0 1;J+¯1 0 1]  ⍝Influence for contributing cells[34]  [35]   L←0[36]  L1:→((1↑⍴N)<L←L+1)/L2               ⍝For each neighbor,[37]  ⍝ →D[N[L;1];N[L;2]]/L1               ⍝   Bail out if cell has already been done (could happen elsewhere in recursion)[38]   (K[L]) I J WSHED2 N[L;]                 ⍝   Recurse up watershed[39]   →L1[40]  [41]  [42]  +++ FROM FLOW, CALCULATES FLOW ACCUMULATION ONLY[43]  ⍝Now, flow back down watershed[44]  L2:⍝→D[I;J]/0                        ⍝If this cell was already done during recursion, get out now[45]  ⍝⍝⍝⍝⍝⍝ D[I;J]←1                           ⍝Done with this cell[46]  [47]  ⍝→0[48]  [49]  ⍝H ON THE FOLLOWING LINE WILL BECOME CONVOLUTED[50]  ⍝ Q←H[;I;J]×Y[I;J-1],Y[I-1;J-1],Y[I-1;J],Y[I-1;J+1],Y[I;J+1],Y[I+1;J+1],Y[I+1;J],Y[I+1;J-1][51]  [52]   ⍝Y[I;J]←Y[I;J]++/Q[53]  ⍝ D[I;J]←1                           ⍝Done with this cell[54]  [55]  [56]  ⍝+++ FROM QSHED2, CALCULATES METRIC VALUES[57]  ⍝Now accumulate results on the way back down[58]   Y[inf;I;J]←Y[inf;I;J]÷Y[part;I;J]*2                ⍝Cells that flow partially into this watershed get scaled by the square of the proportion that flows in[59]   →0[60]   Q←H[;I;J]×Y[I;J-1],Y[I-1;J-1],Y[I-1;J],Y[I-1;J+1],Y[I;J+1],Y[I+1;J+1],Y[I+1;J],Y[I+1;J-1][61]   Y[wsize;I;J]←1++/Y[wsize;;] SCATI Q                  ⍝Watershed size[62]   Y[suminf;I;J]←Y[inf;I;J]++/Y[suminf;;] SCATI Q ⍝Sum of influence[63]   Y[mininf;I;J]←(Y[inf;I;J]-.5×R[I;J])⌊⌊/Y[mininf;;] SCATI Q ⍝Minimum influence: min of contributers & this cell - 1/2 of resistance[64]  [65]  ⍝ L←0[66]  ⍝ Y[inf;I;J],Y[inf;;] SCATI Q                            ⍝Influence of this cell and sources[67]  ⍝L11:[68]  [69]  →0[70]  [71]  →((1↑⍴M)<L←L+1)/0                                            ⍝For each metric,[72]   Y[mstart+2×L;I;J]←(M[L;I;J])++/Y[mstart+2×L;;] SCATI Q    ⍝   Raw metric[73]   Y[mstart+1+2×L;I;J]←(Y[inf;I;J]×M[L;I;J])++/Y[mstart+1+2×L;;] SCATI Q                          ⍝   Influenced metric[74]   →L11[75]  [76]  [77]  [78]      ∇